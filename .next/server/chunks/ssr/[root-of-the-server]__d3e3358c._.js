module.exports=[59664,(a,b,c)=>{b.exports=a.x("jsdom-4cccfac9827ebcfe",()=>require("jsdom-4cccfac9827ebcfe"))},20587,(a,b,c)=>{b.exports=a.x("jsdom-4cccfac9827ebcfe/lib/jsdom/living/generated/utils",()=>require("jsdom-4cccfac9827ebcfe/lib/jsdom/living/generated/utils"))},59705,(a,b,c)=>{b.exports=a.x("jsdom-4cccfac9827ebcfe/lib/jsdom/utils",()=>require("jsdom-4cccfac9827ebcfe/lib/jsdom/utils"))},34980,(a,b,c)=>{var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H=H||{version:"5.5.2"};c.fabric=H;var I=new(a.r(59664)).JSDOM(decodeURIComponent("%3C!DOCTYPE%20html%3E%3Chtml%3E%3Chead%3E%3C%2Fhead%3E%3Cbody%3E%3C%2Fbody%3E%3C%2Fhtml%3E"),{features:{FetchExternalResources:["img"]},resources:"usable"}).window;function J(a,b){if(this.__eventListeners[a]){var c=this.__eventListeners[a];b?c[c.indexOf(b)]=!1:H.util.array.fill(c,!1)}}function K(a,b){var c=(function(){b.apply(this,arguments),this.off(a,c)}).bind(this);this.on(a,c)}H.document=I.document,H.jsdomImplForWrapper=a.r(20587).implForWrapper,H.nodeCanvas=a.r(59705).Canvas,H.window=I,DOMParser=H.window.DOMParser,H.isTouchSupported="ontouchstart"in H.window||"ontouchstart"in H.document||H.window&&H.window.navigator&&H.window.navigator.maxTouchPoints>0,H.isLikelyNode="u">typeof Buffer,H.SHARED_ATTRIBUTES=["display","transform","fill","fill-opacity","fill-rule","opacity","stroke","stroke-dasharray","stroke-linecap","stroke-dashoffset","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","id","paint-order","vector-effect","instantiated_by_use","clip-path"],H.DPI=96,H.reNum="(?:[-+]?(?:\\d+|\\d*\\.\\d+)(?:[eE][-+]?\\d+)?)",H.commaWsp="(?:\\s+,?\\s*|,\\s*)",H.rePathCommand=/([-+]?((\d+\.\d+)|((\d+)|(\.\d+)))(?:[eE][-+]?\d+)?)/ig,H.reNonWord=/[ \n\.,;!\?\-]/,H.fontPaths={},H.iMatrix=[1,0,0,1,0,0],H.svgNS="http://www.w3.org/2000/svg",H.perfLimitSizeTotal=2097152,H.maxCacheSideLimit=4096,H.minCacheSideLimit=256,H.charWidthsCache={},H.textureSize=2048,H.disableStyleCopyPaste=!1,H.enableGLFiltering=!0,H.devicePixelRatio=H.window.devicePixelRatio||H.window.webkitDevicePixelRatio||H.window.mozDevicePixelRatio||1,H.browserShadowBlurConstant=1,H.arcToSegmentsCache={},H.boundsOfCurveCache={},H.cachesBoundsOfCurve=!0,H.forceGLPutImageData=!1,H.initFilterBackend=function(){return H.enableGLFiltering&&H.isWebglSupported&&H.isWebglSupported(H.textureSize)?(console.log("max texture size: "+H.maxTextureSize),new H.WebglFilterBackend({tileSize:H.textureSize})):H.Canvas2dFilterBackend?new H.Canvas2dFilterBackend:void 0},H.Observable={fire:function(a,b){if(!this.__eventListeners)return this;var c=this.__eventListeners[a];if(!c)return this;for(var d=0,e=c.length;d<e;d++)c[d]&&c[d].call(this,b||{});return this.__eventListeners[a]=c.filter(function(a){return!1!==a}),this},on:function(a,b){if(this.__eventListeners||(this.__eventListeners={}),1==arguments.length)for(var c in a)this.on(c,a[c]);else this.__eventListeners[a]||(this.__eventListeners[a]=[]),this.__eventListeners[a].push(b);return this},once:function(a,b){if(1==arguments.length)for(var c in a)K.call(this,c,a[c]);else K.call(this,a,b);return this},off:function(a,b){if(!this.__eventListeners)return this;if(0==arguments.length)for(a in this.__eventListeners)J.call(this,a);else if(1==arguments.length&&"object"==typeof arguments[0])for(var c in a)J.call(this,c,a[c]);else J.call(this,a,b);return this}},H.Collection={_objects:[],add:function(){if(this._objects.push.apply(this._objects,arguments),this._onObjectAdded)for(var a=0,b=arguments.length;a<b;a++)this._onObjectAdded(arguments[a]);return this.renderOnAddRemove&&this.requestRenderAll(),this},insertAt:function(a,b,c){var d=this._objects;return c?d[b]=a:d.splice(b,0,a),this._onObjectAdded&&this._onObjectAdded(a),this.renderOnAddRemove&&this.requestRenderAll(),this},remove:function(){for(var a,b=this._objects,c=!1,d=0,e=arguments.length;d<e;d++)a=b.indexOf(arguments[d]),-1!==a&&(c=!0,b.splice(a,1),this._onObjectRemoved&&this._onObjectRemoved(arguments[d]));return this.renderOnAddRemove&&c&&this.requestRenderAll(),this},forEachObject:function(a,b){for(var c=this.getObjects(),d=0,e=c.length;d<e;d++)a.call(b,c[d],d,c);return this},getObjects:function(a){return void 0===a?this._objects.concat():this._objects.filter(function(b){return b.type===a})},item:function(a){return this._objects[a]},isEmpty:function(){return 0===this._objects.length},size:function(){return this._objects.length},contains:function(a,b){return this._objects.indexOf(a)>-1||!!b&&this._objects.some(function(b){return"function"==typeof b.contains&&b.contains(a,!0)})},complexity:function(){return this._objects.reduce(function(a,b){return a+(b.complexity?b.complexity():0)},0)}},H.CommonMethods={_setOptions:function(a){for(var b in a)this.set(b,a[b])},_initGradient:function(a,b){!a||!a.colorStops||a instanceof H.Gradient||this.set(b,new H.Gradient(a))},_initPattern:function(a,b,c){!a||!a.source||a instanceof H.Pattern?c&&c():this.set(b,new H.Pattern(a,c))},_setObject:function(a){for(var b in a)this._set(b,a[b])},set:function(a,b){return"object"==typeof a?this._setObject(a):this._set(a,b),this},_set:function(a,b){this[a]=b},toggle:function(a){var b=this.get(a);return"boolean"==typeof b&&this.set(a,!b),this},get:function(a){return this[a]}},d=Math.sqrt,e=Math.atan2,f=Math.pow,g=Math.PI/180,h=Math.PI/2,H.util={cos:function(a){if(0===a)return 1;switch(a<0&&(a=-a),a/h){case 1:case 3:return 0;case 2:return -1}return Math.cos(a)},sin:function(a){if(0===a)return 0;var b=1;switch(a<0&&(b=-1),a/h){case 1:return b;case 2:return 0;case 3:return-b}return Math.sin(a)},removeFromArray:function(a,b){var c=a.indexOf(b);return -1!==c&&a.splice(c,1),a},getRandomInt:function(a,b){return Math.floor(Math.random()*(b-a+1))+a},degreesToRadians:function(a){return a*g},radiansToDegrees:function(a){return a/g},rotatePoint:function(a,b,c){var d=new H.Point(a.x-b.x,a.y-b.y),e=H.util.rotateVector(d,c);return new H.Point(e.x,e.y).addEquals(b)},rotateVector:function(a,b){var c=H.util.sin(b),d=H.util.cos(b);return{x:a.x*d-a.y*c,y:a.x*c+a.y*d}},createVector:function(a,b){return new H.Point(b.x-a.x,b.y-a.y)},calcAngleBetweenVectors:function(a,b){return Math.acos((a.x*b.x+a.y*b.y)/(Math.hypot(a.x,a.y)*Math.hypot(b.x,b.y)))},getHatVector:function(a){return new H.Point(a.x,a.y).multiply(1/Math.hypot(a.x,a.y))},getBisector:function(a,b,c){var d=H.util.createVector(a,b),e=H.util.createVector(a,c),f=H.util.calcAngleBetweenVectors(d,e),g=H.util.calcAngleBetweenVectors(H.util.rotateVector(d,f),e);return{vector:H.util.getHatVector(H.util.rotateVector(d,f*(0===g?1:-1)/2)),angle:f}},projectStrokeOnPoints:function(a,b,c){var d=[],e=b.strokeWidth/2,f=b.strokeUniform?new H.Point(1/b.scaleX,1/b.scaleY):new H.Point(1,1),g=function(a){var b=e/Math.hypot(a.x,a.y);return new H.Point(a.x*b*f.x,a.y*b*f.y)};return a.length<=1||a.forEach(function(h,i){var j,k,l=new H.Point(h.x,h.y);0===i?(k=a[i+1],j=c?g(H.util.createVector(k,l)).addEquals(l):a[a.length-1]):i===a.length-1?(j=a[i-1],k=c?g(H.util.createVector(j,l)).addEquals(l):a[0]):(j=a[i-1],k=a[i+1]);var m,n,o=H.util.getBisector(l,j,k),p=o.vector,q=o.angle;if("miter"===b.strokeLineJoin&&(m=-e/Math.sin(q/2),Math.hypot((n=new H.Point(p.x*m*f.x,p.y*m*f.y)).x,n.y)/e<=b.strokeMiterLimit)){d.push(l.add(n)),d.push(l.subtract(n));return}m=-e*Math.SQRT2,n=new H.Point(p.x*m*f.x,p.y*m*f.y),d.push(l.add(n)),d.push(l.subtract(n))}),d},transformPoint:function(a,b,c){return c?new H.Point(b[0]*a.x+b[2]*a.y,b[1]*a.x+b[3]*a.y):new H.Point(b[0]*a.x+b[2]*a.y+b[4],b[1]*a.x+b[3]*a.y+b[5])},makeBoundingBoxFromPoints:function(a,b){if(b)for(var c=0;c<a.length;c++)a[c]=H.util.transformPoint(a[c],b);var d=[a[0].x,a[1].x,a[2].x,a[3].x],e=H.util.array.min(d),f=H.util.array.max(d),g=[a[0].y,a[1].y,a[2].y,a[3].y],h=H.util.array.min(g);return{left:e,top:h,width:f-e,height:H.util.array.max(g)-h}},invertTransform:function(a){var b=1/(a[0]*a[3]-a[1]*a[2]),c=[b*a[3],-b*a[1],-b*a[2],b*a[0]],d=H.util.transformPoint({x:a[4],y:a[5]},c,!0);return c[4]=-d.x,c[5]=-d.y,c},toFixed:function(a,b){return parseFloat(Number(a).toFixed(b))},parseUnit:function(a,b){var c=/\D{0,2}$/.exec(a),d=parseFloat(a);switch(!b&&(b=H.Text.DEFAULT_SVG_FONT_SIZE),c[0]){case"mm":return d*H.DPI/25.4;case"cm":return d*H.DPI/2.54;case"in":return d*H.DPI;case"pt":return d*H.DPI/72;case"pc":return d*H.DPI/72*12;case"em":return d*b;default:return d}},falseFunction:function(){return!1},getKlass:function(a,b){return a=H.util.string.camelize(a.charAt(0).toUpperCase()+a.slice(1)),H.util.resolveNamespace(b)[a]},getSvgAttributes:function(a){var b=["instantiated_by_use","style","id","class"];switch(a){case"linearGradient":b=b.concat(["x1","y1","x2","y2","gradientUnits","gradientTransform"]);break;case"radialGradient":b=b.concat(["gradientUnits","gradientTransform","cx","cy","r","fx","fy","fr"]);break;case"stop":b=b.concat(["offset","stop-color","stop-opacity"])}return b},resolveNamespace:function(a){if(!a)return H;var b,d=a.split("."),e=d.length,f=c||H.window;for(b=0;b<e;++b)f=f[d[b]];return f},loadImage:function(a,b,c,d){if(!a){b&&b.call(c,a);return}var e=H.util.createImage(),f=function(){b&&b.call(c,e,!1),e=e.onload=e.onerror=null};e.onload=f,e.onerror=function(){H.log("Error loading "+e.src),b&&b.call(c,null,!0),e=e.onload=e.onerror=null},0!==a.indexOf("data")&&null!=d&&(e.crossOrigin=d),"data:image/svg"===a.substring(0,14)&&(e.onload=null,H.util.loadImageInDom(e,f)),e.src=a},loadImageInDom:function(a,b){var c=H.document.createElement("div");c.style.width=c.style.height="1px",c.style.left=c.style.top="-100%",c.style.position="absolute",c.appendChild(a),H.document.querySelector("body").appendChild(c),a.onload=function(){b(),c.parentNode.removeChild(c),c=null}},enlivenObjects:function(a,b,c,d){var e=[],f=0,g=(a=a||[]).length;function h(){++f===g&&b&&b(e.filter(function(a){return a}))}if(!g){b&&b(e);return}a.forEach(function(a,b){a&&a.type?H.util.getKlass(a.type,c).fromObject(a,function(c,f){f||(e[b]=c),d&&d(a,c,f),h()}):h()})},enlivenObjectEnlivables:function(a,b,c){var d=H.Object.ENLIVEN_PROPS.filter(function(b){return!!a[b]});H.util.enlivenObjects(d.map(function(b){return a[b]}),function(a){var e={};d.forEach(function(c,d){e[c]=a[d],b&&(b[c]=a[d])}),c&&c(e)})},enlivenPatterns:function(a,b){function c(){++e===f&&b&&b(d)}var d=[],e=0,f=(a=a||[]).length;if(!f){b&&b(d);return}a.forEach(function(a,b){a&&a.source?new H.Pattern(a,function(a){d[b]=a,c()}):(d[b]=a,c())})},groupSVGElements:function(a,b,c){var d;return a&&1===a.length?(void 0!==c&&(a[0].sourcePath=c),a[0]):(b&&(b.width&&b.height?b.centerPoint={x:b.width/2,y:b.height/2}:(delete b.width,delete b.height)),d=new H.Group(a,b),void 0!==c&&(d.sourcePath=c),d)},populateWithProperties:function(a,b,c){if(c&&Array.isArray(c))for(var d=0,e=c.length;d<e;d++)c[d]in a&&(b[c[d]]=a[c[d]])},createCanvasElement:function(){return H.document.createElement("canvas")},copyCanvasElement:function(a){var b=H.util.createCanvasElement();return b.width=a.width,b.height=a.height,b.getContext("2d").drawImage(a,0,0),b},toDataURL:function(a,b,c){return a.toDataURL("image/"+b,c)},createImage:function(){return H.document.createElement("img")},multiplyTransformMatrices:function(a,b,c){return[a[0]*b[0]+a[2]*b[1],a[1]*b[0]+a[3]*b[1],a[0]*b[2]+a[2]*b[3],a[1]*b[2]+a[3]*b[3],c?0:a[0]*b[4]+a[2]*b[5]+a[4],c?0:a[1]*b[4]+a[3]*b[5]+a[5]]},qrDecompose:function(a){var b=e(a[1],a[0]),c=f(a[0],2)+f(a[1],2),h=d(c),i=(a[0]*a[3]-a[2]*a[1])/h;return{angle:b/g,scaleX:h,scaleY:i,skewX:e(a[0]*a[2]+a[1]*a[3],c)/g,skewY:0,translateX:a[4],translateY:a[5]}},calcRotateMatrix:function(a){if(!a.angle)return H.iMatrix.concat();var b=H.util.degreesToRadians(a.angle),c=H.util.cos(b),d=H.util.sin(b);return[c,d,-d,c,0,0]},calcDimensionsMatrix:function(a){var b=void 0===a.scaleX?1:a.scaleX,c=void 0===a.scaleY?1:a.scaleY,d=[a.flipX?-b:b,0,0,a.flipY?-c:c,0,0],e=H.util.multiplyTransformMatrices,f=H.util.degreesToRadians;return a.skewX&&(d=e(d,[1,0,Math.tan(f(a.skewX)),1],!0)),a.skewY&&(d=e(d,[1,Math.tan(f(a.skewY)),0,1],!0)),d},composeMatrix:function(a){var b=[1,0,0,1,a.translateX||0,a.translateY||0],c=H.util.multiplyTransformMatrices;return a.angle&&(b=c(b,H.util.calcRotateMatrix(a))),(1!==a.scaleX||1!==a.scaleY||a.skewX||a.skewY||a.flipX||a.flipY)&&(b=c(b,H.util.calcDimensionsMatrix(a))),b},resetObjectTransform:function(a){a.scaleX=1,a.scaleY=1,a.skewX=0,a.skewY=0,a.flipX=!1,a.flipY=!1,a.rotate(0)},saveObjectTransform:function(a){return{scaleX:a.scaleX,scaleY:a.scaleY,skewX:a.skewX,skewY:a.skewY,angle:a.angle,left:a.left,flipX:a.flipX,flipY:a.flipY,top:a.top}},isTransparent:function(a,b,c,d){d>0&&(b>d?b-=d:b=0,c>d?c-=d:c=0);var e,f=!0,g=a.getImageData(b,c,2*d||1,2*d||1),h=g.data.length;for(e=3;e<h&&!1!=(f=g.data[e]<=0);e+=4);return g=null,f},parsePreserveAspectRatioAttribute:function(a){var b,c="meet",d="Mid",e=a.split(" ");return e&&e.length&&("meet"!==(c=e.pop())&&"slice"!==c?(b=c,c="meet"):e.length&&(b=e.pop())),{meetOrSlice:c,alignX:d="none"!==b?b.slice(1,4):"none",alignY:"none"!==b?b.slice(5,8):"none"}},clearFabricFontCache:function(a){(a=(a||"").toLowerCase())?H.charWidthsCache[a]&&delete H.charWidthsCache[a]:H.charWidthsCache={}},limitDimsByArea:function(a,b){var c=Math.sqrt(b*a),d=Math.floor(b/c);return{x:Math.floor(c),y:d}},capValue:function(a,b,c){return Math.max(a,Math.min(b,c))},findScaleToFit:function(a,b){return Math.min(b.width/a.width,b.height/a.height)},findScaleToCover:function(a,b){return Math.max(b.width/a.width,b.height/a.height)},matrixToSVG:function(a){return"matrix("+a.map(function(a){return H.util.toFixed(a,H.Object.NUM_FRACTION_DIGITS)}).join(" ")+")"},removeTransformFromObject:function(a,b){var c=H.util.invertTransform(b),d=H.util.multiplyTransformMatrices(c,a.calcOwnMatrix());H.util.applyTransformToObject(a,d)},addTransformToObject:function(a,b){H.util.applyTransformToObject(a,H.util.multiplyTransformMatrices(b,a.calcOwnMatrix()))},applyTransformToObject:function(a,b){var c=H.util.qrDecompose(b),d=new H.Point(c.translateX,c.translateY);a.flipX=!1,a.flipY=!1,a.set("scaleX",c.scaleX),a.set("scaleY",c.scaleY),a.skewX=c.skewX,a.skewY=c.skewY,a.angle=c.angle,a.setPositionByOrigin(d,"center","center")},sizeAfterTransform:function(a,b,c){var d=a/2,e=b/2,f=H.util.calcDimensionsMatrix(c),g=H.util.makeBoundingBoxFromPoints([{x:-d,y:-e},{x:d,y:-e},{x:-d,y:e},{x:d,y:e}],f);return{x:g.width,y:g.height}},mergeClipPaths:function(a,b){var c=a,d=b;c.inverted&&!d.inverted&&(c=b,d=a),H.util.applyTransformToObject(d,H.util.multiplyTransformMatrices(H.util.invertTransform(c.calcTransformMatrix()),d.calcTransformMatrix()));var e=c.inverted&&d.inverted;return e&&(c.inverted=d.inverted=!1),new H.Group([c],{clipPath:d,inverted:e})},hasStyleChanged:function(a,b,c){return c=c||!1,a.fill!==b.fill||a.stroke!==b.stroke||a.strokeWidth!==b.strokeWidth||a.fontSize!==b.fontSize||a.fontFamily!==b.fontFamily||a.fontWeight!==b.fontWeight||a.fontStyle!==b.fontStyle||a.textBackgroundColor!==b.textBackgroundColor||a.deltaY!==b.deltaY||c&&(a.overline!==b.overline||a.underline!==b.underline||a.linethrough!==b.linethrough)},stylesToArray:function(a,b){for(var a=H.util.object.clone(a,!0),c=b.split("\n"),d=-1,e={},f=[],g=0;g<c.length;g++){if(!a[g]){d+=c[g].length;continue}for(var h=0;h<c[g].length;h++){d++;var i=a[g][h];i&&Object.keys(i).length>0&&(H.util.hasStyleChanged(e,i,!0)?f.push({start:d,end:d+1,style:i}):f[f.length-1].end++),e=i||{}}}return f},stylesFromArray:function(a,b){if(!Array.isArray(a))return a;for(var c=b.split("\n"),d=-1,e=0,f={},g=0;g<c.length;g++)for(var h=0;h<c[g].length;h++)d++,a[e]&&a[e].start<=d&&d<a[e].end&&(f[g]=f[g]||{},f[g][h]=Object.assign({},a[e].style),d===a[e].end-1&&e++);return f}},function(){var a=Array.prototype.join,b={m:2,l:2,h:1,v:1,c:6,s:4,q:4,t:2,a:7},c={m:"l",M:"L"};function d(a,b,c,d){var e=Math.atan2(b,a),f=Math.atan2(d,c);return f>=e?f-e:2*Math.PI-(e-f)}function e(a,b,c,d){return Math.sqrt((c-a)*(c-a)+(d-b)*(d-b))}function f(a,b,c){var d,f,g={x:b,y:c},h=0;for(f=1;f<=100;f+=1)d=a(f/100),h+=e(g.x,g.y,d.x,d.y),g=d;return h}function g(a){for(var b,c,d,g,h=0,i=a.length,j=0,k=0,l=0,m=0,n=[],o=0;o<i;o++){switch(d={x:j,y:k,command:(b=a[o])[0]},b[0]){case"M":d.length=0,l=j=b[1],m=k=b[2];break;case"L":d.length=e(j,k,b[1],b[2]),j=b[1],k=b[2];break;case"C":c=function(a,b,c,d,e,f,g,h){return function(i){var j=i*i*i,k=3*i*i*(1-i),l=3*i*(1-i)*(1-i),m=(1-i)*(1-i)*(1-i);return{x:g*j+e*k+c*l+a*m,y:h*j+f*k+d*l+b*m}}}(j,k,b[1],b[2],b[3],b[4],b[5],b[6]),g=function(a,b,c,d,e,f,g,h){return function(i){var j=1-i;return Math.atan2(3*j*j*(d-b)+6*j*i*(f-d)+3*i*i*(h-f),3*j*j*(c-a)+6*j*i*(e-c)+3*i*i*(g-e))}}(j,k,b[1],b[2],b[3],b[4],b[5],b[6]),d.iterator=c,d.angleFinder=g,d.length=f(c,j,k),j=b[5],k=b[6];break;case"Q":c=function(a,b,c,d,e,f){return function(g){var h=g*g,i=2*g*(1-g),j=(1-g)*(1-g);return{x:e*h+c*i+a*j,y:f*h+d*i+b*j}}}(j,k,b[1],b[2],b[3],b[4]),g=function(a,b,c,d,e,f){return function(g){var h=1-g;return Math.atan2(2*h*(d-b)+2*g*(f-d),2*h*(c-a)+2*g*(e-c))}}(j,k,b[1],b[2],b[3],b[4]),d.iterator=c,d.angleFinder=g,d.length=f(c,j,k),j=b[3],k=b[4];break;case"Z":case"z":d.destX=l,d.destY=m,d.length=e(j,k,l,m),j=l,k=m}h+=d.length,n.push(d)}return n.push({length:h,x:j,y:k}),n}H.util.joinPath=function(a){return a.map(function(a){return a.join(" ")}).join(" ")},H.util.parsePath=function(a){var d,e,f,g,h,i=[],j=[],k=H.rePathCommand,l="[-+]?(?:\\d*\\.\\d+|\\d+\\.?)(?:[eE][-+]?\\d+)?\\s*",m="("+l+")"+H.commaWsp,n="([01])"+H.commaWsp+"?",o=RegExp(m+"?"+m+"?"+m+n+n+m+"?("+l+")","g");if(!a||!a.match)return i;h=a.match(/[mzlhvcsqta][^mzlhvcsqta]*/gi);for(var p,q=0,r=h.length;q<r;q++){g=(d=h[q]).slice(1).trim(),j.length=0;var s,t=d.charAt(0);if(p=[t],"a"===t.toLowerCase())for(;s=o.exec(g);)for(var u=1;u<s.length;u++)j.push(s[u]);else for(;f=k.exec(g);)j.push(f[0]);for(var u=0,v=j.length;u<v;u++)isNaN(e=parseFloat(j[u]))||p.push(e);var w=b[t.toLowerCase()],x=c[t]||t;if(p.length-1>w)for(var y=1,z=p.length;y<z;y+=w)i.push([t].concat(p.slice(y,y+w))),t=x;else i.push(p)}return i},H.util.makePathSimpler=function(a){var b,c,e,f,g,h,i=0,j=0,k=a.length,l=0,m=0,n=[];for(c=0;c<k;++c){switch(e=!1,(b=a[c].slice(0))[0]){case"l":b[0]="L",b[1]+=i,b[2]+=j;case"L":i=b[1],j=b[2];break;case"h":b[1]+=i;case"H":b[0]="L",b[2]=j,i=b[1];break;case"v":b[1]+=j;case"V":b[0]="L",j=b[1],b[1]=i,b[2]=j;break;case"m":b[0]="M",b[1]+=i,b[2]+=j;case"M":i=b[1],j=b[2],l=b[1],m=b[2];break;case"c":b[0]="C",b[1]+=i,b[2]+=j,b[3]+=i,b[4]+=j,b[5]+=i,b[6]+=j;case"C":g=b[3],h=b[4],i=b[5],j=b[6];break;case"s":b[0]="S",b[1]+=i,b[2]+=j,b[3]+=i,b[4]+=j;case"S":"C"===f?(g=2*i-g,h=2*j-h):(g=i,h=j),i=b[3],j=b[4],b[0]="C",b[5]=b[3],b[6]=b[4],b[3]=b[1],b[4]=b[2],b[1]=g,b[2]=h,g=b[3],h=b[4];break;case"q":b[0]="Q",b[1]+=i,b[2]+=j,b[3]+=i,b[4]+=j;case"Q":g=b[1],h=b[2],i=b[3],j=b[4];break;case"t":b[0]="T",b[1]+=i,b[2]+=j;case"T":"Q"===f?(g=2*i-g,h=2*j-h):(g=i,h=j),b[0]="Q",i=b[1],j=b[2],b[1]=g,b[2]=h,b[3]=i,b[4]=j;break;case"a":b[0]="A",b[6]+=i,b[7]+=j;case"A":e=!0,n=n.concat(function(a,b,c){for(var e=c[1],f=c[2],g=c[3],h=c[4],i=c[5],j=function(a,b,c,e,f,g,h){var i=Math.PI,j=h*i/180,k=H.util.sin(j),l=H.util.cos(j),m=0,n=0,o=-l*a*.5-k*b*.5,p=-l*b*.5+k*a*.5,q=(c=Math.abs(c))*c,r=(e=Math.abs(e))*e,s=p*p,t=o*o,u=q*r-q*s-r*t,v=0;if(u<0){var w=Math.sqrt(1-u/(q*r));c*=w,e*=w}else v=(f===g?-1:1)*Math.sqrt(u/(q*s+r*t));var x=v*c*p/e,y=-v*e*o/c,z=l*x-k*y+.5*a,A=k*x+l*y+.5*b,B=d(1,0,(o-x)/c,(p-y)/e),C=d((o-x)/c,(p-y)/e,(-o-x)/c,(-p-y)/e);0===g&&C>0?C-=2*i:1===g&&C<0&&(C+=2*i);for(var D=Math.ceil(Math.abs(C/i*2)),E=[],F=C/D,G=8/3*Math.sin(F/4)*Math.sin(F/4)/Math.sin(F/2),I=B+F,J=0;J<D;J++)E[J]=function(a,b,c,d,e,f,g,h,i,j,k){var l=H.util.cos(a),m=H.util.sin(a),n=H.util.cos(b),o=H.util.sin(b),p=c*e*n-d*f*o+g,q=d*e*n+c*f*o+h;return["C",j+i*(-c*e*m-d*f*l),k+i*(-d*e*m+c*f*l),p+i*(c*e*o+d*f*n),q+i*(d*e*o-c*f*n),p,q]}(B,I,l,k,c,e,z,A,G,m,n),m=E[J][5],n=E[J][6],B=I,I+=F;return E}(c[6]-a,c[7]-b,e,f,h,i,g),k=0,l=j.length;k<l;k++)j[k][1]+=a,j[k][2]+=b,j[k][3]+=a,j[k][4]+=b,j[k][5]+=a,j[k][6]+=b;return j}(i,j,b)),i=b[6],j=b[7];break;case"z":case"Z":i=l,j=m}e||n.push(b),f=b[0]}return n},H.util.getSmoothPathFromPoints=function(a,b){var c,d=[],e=new H.Point(a[0].x,a[0].y),f=new H.Point(a[1].x,a[1].y),g=a.length,h=1,i=0,j=g>2;for(b=b||0,j&&(h=a[2].x<f.x?-1:+(a[2].x!==f.x),i=a[2].y<f.y?-1:+(a[2].y!==f.y)),d.push(["M",e.x-h*b,e.y-i*b]),c=1;c<g;c++){if(!e.eq(f)){var k=e.midPointFrom(f);d.push(["Q",e.x,e.y,k.x,k.y])}e=a[c],c+1<a.length&&(f=a[c+1])}return j&&(h=e.x>a[c-2].x?1:e.x===a[c-2].x?0:-1,i=e.y>a[c-2].y?1:e.y===a[c-2].y?0:-1),d.push(["L",e.x+h*b,e.y+i*b]),d},H.util.getPathSegmentsInfo=g,H.util.getBoundsOfCurve=function(b,c,d,e,f,g,h,i){if(H.cachesBoundsOfCurve&&(j=a.call(arguments),H.boundsOfCurveCache[j]))return H.boundsOfCurveCache[j];var j,k,l,m,n,o,p,q,r,s=Math.sqrt,t=Math.min,u=Math.max,v=Math.abs,w=[],x=[[],[]];l=6*b-12*d+6*f,k=-3*b+9*d-9*f+3*h,m=3*d-3*b;for(var y=0;y<2;++y){if(y>0&&(l=6*c-12*e+6*g,k=-3*c+9*e-9*g+3*i,m=3*e-3*c),1e-12>v(k)){if(1e-12>v(l))continue;0<(n=-m/l)&&n<1&&w.push(n);continue}!((q=l*l-4*m*k)<0)&&(0<(o=(-l+(r=s(q)))/(2*k))&&o<1&&w.push(o),0<(p=(-l-r)/(2*k))&&p<1&&w.push(p))}for(var z,A,B,C=w.length,D=C;C--;)z=(B=1-(n=w[C]))*B*B*b+3*B*B*n*d+3*B*n*n*f+n*n*n*h,x[0][C]=z,A=B*B*B*c+3*B*B*n*e+3*B*n*n*g+n*n*n*i,x[1][C]=A;x[0][D]=b,x[1][D]=c,x[0][D+1]=h,x[1][D+1]=i;var E=[{x:t.apply(null,x[0]),y:t.apply(null,x[1])},{x:u.apply(null,x[0]),y:u.apply(null,x[1])}];return H.cachesBoundsOfCurve&&(H.boundsOfCurveCache[j]=E),E},H.util.getPointOnPath=function(a,b,c){c||(c=g(a));for(var d=0;b-c[d].length>0&&d<c.length-2;)b-=c[d].length,d++;var f,h=c[d],i=b/h.length,j=h.command,k=a[d];switch(j){case"M":return{x:h.x,y:h.y,angle:0};case"Z":case"z":return(f=new H.Point(h.x,h.y).lerp(new H.Point(h.destX,h.destY),i)).angle=Math.atan2(h.destY-h.y,h.destX-h.x),f;case"L":return(f=new H.Point(h.x,h.y).lerp(new H.Point(k[1],k[2]),i)).angle=Math.atan2(k[2]-h.y,k[1]-h.x),f;case"C":case"Q":return function(a,b){for(var c,d,f,g=0,h=0,i=a.iterator,j={x:a.x,y:a.y},k=.01,l=a.angleFinder;h<b&&k>1e-4;)c=i(g),f=g,(d=e(j.x,j.y,c.x,c.y))+h>b?(g-=k,k/=2):(j=c,g+=k,h+=d);return c.angle=l(f),c}(h,b)}},H.util.transformPath=function(a,b,c){return c&&(b=H.util.multiplyTransformMatrices(b,[1,0,0,1,-c.x,-c.y])),a.map(function(a){for(var c=a.slice(0),d={},e=1;e<a.length-1;e+=2)d.x=a[e],d.y=a[e+1],d=H.util.transformPoint(d,b),c[e]=d.x,c[e+1]=d.y;return c})}}();var L=Array.prototype.slice;function M(a,b,c){if(a&&0!==a.length){var d=a.length-1,e=b?a[d][b]:a[d];if(b)for(;d--;)c(a[d][b],e)&&(e=a[d][b]);else for(;d--;)c(a[d],e)&&(e=a[d]);return e}}function N(a,b,c){if(c)if(!H.isLikelyNode&&b instanceof Element)a=b;else if(b instanceof Array){a=[];for(var d=0,e=b.length;d<e;d++)a[d]=N({},b[d],c)}else if(b&&"object"==typeof b)for(var f in b)"canvas"===f||"group"===f?a[f]=null:b.hasOwnProperty(f)&&(a[f]=N({},b[f],c));else a=b;else for(var f in b)a[f]=b[f];return a}function O(){}function P(a,b,c){var d="rgba("+parseInt(a[0]+c*(b[0]-a[0]),10)+","+parseInt(a[1]+c*(b[1]-a[1]),10)+","+parseInt(a[2]+c*(b[2]-a[2]),10);return d+(","+(a&&b?parseFloat(a[3]+c*(b[3]-a[3])):1)+")")}function Q(a,b,c,d){return a<Math.abs(b)?(a=b,d=c/4):d=0===b&&0===a?c/(2*Math.PI)*Math.asin(1):c/(2*Math.PI)*Math.asin(b/a),{a:a,c:b,p:c,s:d}}function R(a,b,c){return a.a*Math.pow(2,10*(b-=1))*Math.sin((b*c-a.s)*(2*Math.PI)/a.p)}function S(a,b,c,d){return c-T(d-a,0,c,d)+b}function T(a,b,c,d){return(a/=d)<1/2.75?7.5625*a*a*c+b:a<2/2.75?c*(7.5625*(a-=1.5/2.75)*a+.75)+b:a<2.5/2.75?c*(7.5625*(a-=2.25/2.75)*a+.9375)+b:c*(7.5625*(a-=2.625/2.75)*a+.984375)+b}H.util.array={fill:function(a,b){for(var c=a.length;c--;)a[c]=b;return a},invoke:function(a,b){for(var c=L.call(arguments,2),d=[],e=0,f=a.length;e<f;e++)d[e]=c.length?a[e][b].apply(a[e],c):a[e][b].call(a[e]);return d},min:function(a,b){return M(a,b,function(a,b){return a<b})},max:function(a,b){return M(a,b,function(a,b){return a>=b})}},H.util.object={extend:N,clone:function(a,b){return N({},a,b)}},H.util.object.extend(H.util,H.Observable),H.util.string={camelize:function(a){return a.replace(/-+(.)?/g,function(a,b){return b?b.toUpperCase():""})},capitalize:function(a,b){return a.charAt(0).toUpperCase()+(b?a.slice(1):a.slice(1).toLowerCase())},escapeXml:function(a){return a.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},graphemeSplit:function(a){var b,c=0,d=[];for(c=0;c<a.length;c++)!1!==(b=function(a,b){var c=a.charCodeAt(b);if(isNaN(c))return"";if(c<55296||c>57343)return a.charAt(b);if(55296<=c&&c<=56319){if(a.length<=b+1)throw"High surrogate without following low surrogate";var d=a.charCodeAt(b+1);if(56320>d||d>57343)throw"High surrogate without following low surrogate";return a.charAt(b)+a.charAt(b+1)}if(0===b)throw"Low surrogate without preceding high surrogate";var e=a.charCodeAt(b-1);if(55296>e||e>56319)throw"Low surrogate without preceding high surrogate";return!1}(a,c))&&d.push(b);return d}},function(){var a=Array.prototype.slice,b=function(){},c=function(){for(var a in{toString:1})if("toString"===a)return!1;return!0}(),d=function(a,b,d){for(var e in b)e in a.prototype&&"function"==typeof a.prototype[e]&&(b[e]+"").indexOf("callSuper")>-1?a.prototype[e]=function(a){return function(){var c=this.constructor.superclass;this.constructor.superclass=d;var e=b[a].apply(this,arguments);if(this.constructor.superclass=c,"initialize"!==a)return e}}(e):a.prototype[e]=b[e],c&&(b.toString!==Object.prototype.toString&&(a.prototype.toString=b.toString),b.valueOf!==Object.prototype.valueOf&&(a.prototype.valueOf=b.valueOf))};function e(){}function f(b){for(var c=null,d=this;d.constructor.superclass;){var e=d.constructor.superclass.prototype[b];if(d[b]!==e){c=e;break}d=d.constructor.superclass.prototype}return c?arguments.length>1?c.apply(this,a.call(arguments,1)):c.call(this):console.log("tried to callSuper "+b+", method not found in prototype chain",this)}H.util.createClass=function(){var c=null,g=a.call(arguments,0);function h(){this.initialize.apply(this,arguments)}"function"==typeof g[0]&&(c=g.shift()),h.superclass=c,h.subclasses=[],c&&(e.prototype=c.prototype,h.prototype=new e,c.subclasses.push(h));for(var i=0,j=g.length;i<j;i++)d(h,g[i],c);return h.prototype.initialize||(h.prototype.initialize=b),h.prototype.constructor=h,h.prototype.callSuper=f,h}}(),i=!!H.document.createElement("div").attachEvent,j=["touchstart","touchmove","touchend"],H.util.addListener=function(a,b,c,d){a&&a.addEventListener(b,c,!i&&d)},H.util.removeListener=function(a,b,c,d){a&&a.removeEventListener(b,c,!i&&d)},H.util.getPointer=function(a){var b,c=a.target,d=H.util.getScrollLeftTop(c),e=(b=a.changedTouches)&&b[0]?b[0]:a;return{x:e.clientX+d.left,y:e.clientY+d.top}},H.util.isTouchEvent=function(a){return j.indexOf(a.type)>-1||"touch"===a.pointerType},l="string"==typeof(k=H.document.createElement("div")).style.opacity,m="string"==typeof k.style.filter,n=/alpha\s*\(\s*opacity\s*=\s*([^\)]+)\)/,o=function(a){return a},l?o=function(a,b){return a.style.opacity=b,a}:m&&(o=function(a,b){var c=a.style;return a.currentStyle&&!a.currentStyle.hasLayout&&(c.zoom=1),n.test(c.filter)?(b=b>=.9999?"":"alpha(opacity="+100*b+")",c.filter=c.filter.replace(n,b)):c.filter+=" alpha(opacity="+100*b+")",a}),H.util.setStyle=function(a,b){var c=a.style;if(!c)return a;if("string"==typeof b)return a.style.cssText+=";"+b,b.indexOf("opacity")>-1?o(a,b.match(/opacity:\s*(\d?\.?\d*)/)[1]):a;for(var d in b)if("opacity"===d)o(a,b[d]);else{var e="float"===d||"cssFloat"===d?void 0===c.styleFloat?"cssFloat":"styleFloat":d;c.setProperty(e,b[d])}return a},function(){var a,b,c,d,e=Array.prototype.slice,f=function(a){return e.call(a,0)};try{d=f(H.document.childNodes)instanceof Array}catch(a){}function g(a,b){var c=H.document.createElement(a);for(var d in b)"class"===d?c.className=b[d]:"for"===d?c.htmlFor=b[d]:c.setAttribute(d,b[d]);return c}function h(a){for(var b=0,c=0,d=H.document.documentElement,e=H.document.body||{scrollLeft:0,scrollTop:0};a&&(a.parentNode||a.host)&&((a=a.parentNode||a.host)===H.document?(b=e.scrollLeft||d.scrollLeft||0,c=e.scrollTop||d.scrollTop||0):(b+=a.scrollLeft||0,c+=a.scrollTop||0),1!==a.nodeType||"fixed"!==a.style.position););return{left:b,top:c}}d||(f=function(a){for(var b=Array(a.length),c=a.length;c--;)b[c]=a[c];return b}),c=H.document.defaultView&&H.document.defaultView.getComputedStyle?function(a,b){var c=H.document.defaultView.getComputedStyle(a,null);return c?c[b]:void 0}:function(a,b){var c=a.style[b];return!c&&a.currentStyle&&(c=a.currentStyle[b]),c},b="userSelect"in(a=H.document.documentElement.style)?"userSelect":"MozUserSelect"in a?"MozUserSelect":"WebkitUserSelect"in a?"WebkitUserSelect":"KhtmlUserSelect"in a?"KhtmlUserSelect":"",H.util.makeElementUnselectable=function(a){return void 0!==a.onselectstart&&(a.onselectstart=H.util.falseFunction),b?a.style[b]="none":"string"==typeof a.unselectable&&(a.unselectable="on"),a},H.util.makeElementSelectable=function(a){return void 0!==a.onselectstart&&(a.onselectstart=null),b?a.style[b]="":"string"==typeof a.unselectable&&(a.unselectable=""),a},H.util.setImageSmoothing=function(a,b){a.imageSmoothingEnabled=a.imageSmoothingEnabled||a.webkitImageSmoothingEnabled||a.mozImageSmoothingEnabled||a.msImageSmoothingEnabled||a.oImageSmoothingEnabled,a.imageSmoothingEnabled=b},H.util.getById=function(a){return"string"==typeof a?H.document.getElementById(a):a},H.util.toArray=f,H.util.addClass=function(a,b){a&&-1===(" "+a.className+" ").indexOf(" "+b+" ")&&(a.className+=(a.className?" ":"")+b)},H.util.makeElement=g,H.util.wrapElement=function(a,b,c){return"string"==typeof b&&(b=g(b,c)),a.parentNode&&a.parentNode.replaceChild(b,a),b.appendChild(a),b},H.util.getScrollLeftTop=h,H.util.getElementOffset=function(a){var b,d,e=a&&a.ownerDocument,f={left:0,top:0},g={left:0,top:0},i={borderLeftWidth:"left",borderTopWidth:"top",paddingLeft:"left",paddingTop:"top"};if(!e)return g;for(var j in i)g[i[j]]+=parseInt(c(a,j),10)||0;return b=e.documentElement,void 0!==a.getBoundingClientRect&&(f=a.getBoundingClientRect()),d=h(a),{left:f.left+d.left-(b.clientLeft||0)+g.left,top:f.top+d.top-(b.clientTop||0)+g.top}},H.util.getNodeCanvas=function(a){var b=H.jsdomImplForWrapper(a);return b._canvas||b._image},H.util.cleanUpJsdomNode=function(a){if(H.isLikelyNode){var b=H.jsdomImplForWrapper(a);b&&(b._image=null,b._canvas=null,b._currentSrc=null,b._attributes=null,b._classList=null)}}}(),H.util.request=function(a,b){b||(b={});var c,d,e=b.method?b.method.toUpperCase():"GET",f=b.onComplete||function(){},g=new H.window.XMLHttpRequest,h=b.body||b.parameters;return g.onreadystatechange=function(){4===g.readyState&&(f(g),g.onreadystatechange=O)},"GET"===e&&(h=null,"string"==typeof b.parameters&&(c=a,d=b.parameters,a=c+(/\?/.test(c)?"&":"?")+d)),g.open(e,a,!0),("POST"===e||"PUT"===e)&&g.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),g.send(h),g},H.log=console.log,H.warn=console.warn,function(){var a=H.util.object.extend,b=H.util.object.clone,c=[];function d(){return!1}function e(a,b,c,d){return-c*Math.cos(a/d*(Math.PI/2))+c+b}H.util.object.extend(c,{cancelAll:function(){var a=this.splice(0);return a.forEach(function(a){a.cancel()}),a},cancelByCanvas:function(a){if(!a)return[];var b=this.filter(function(b){return"object"==typeof b.target&&b.target.canvas===a});return b.forEach(function(a){a.cancel()}),b},cancelByTarget:function(a){var b=this.findAnimationsByTarget(a);return b.forEach(function(a){a.cancel()}),b},findAnimationIndex:function(a){return this.indexOf(this.findAnimation(a))},findAnimation:function(a){return this.find(function(b){return b.cancel===a})},findAnimationsByTarget:function(a){return a?this.filter(function(b){return b.target===a}):[]}});var f=H.window.requestAnimationFrame||H.window.webkitRequestAnimationFrame||H.window.mozRequestAnimationFrame||H.window.oRequestAnimationFrame||H.window.msRequestAnimationFrame||function(a){return H.window.setTimeout(a,1e3/60)},g=H.window.cancelAnimationFrame||H.window.clearTimeout;function h(){return f.apply(H.window,arguments)}H.util.animate=function(c){c||(c={});var f,g=!1,i=function(){var a=H.runningAnimations.indexOf(f);return a>-1&&H.runningAnimations.splice(a,1)[0]};return f=a(b(c),{cancel:function(){return g=!0,i()},currentValue:"startValue"in c?c.startValue:0,completionRate:0,durationRate:0}),H.runningAnimations.push(f),h(function(a){var b,j=a||+new Date,k=c.duration||500,l=j+k,m=c.onChange||d,n=c.abort||d,o=c.onComplete||d,p=c.easing||e,q="startValue"in c&&c.startValue.length>0,r="startValue"in c?c.startValue:0,s="endValue"in c?c.endValue:100,t=c.byValue||(q?r.map(function(a,b){return s[b]-r[b]}):s-r);c.onStart&&c.onStart(),function a(c){var d=(b=c||+new Date)>l?k:b-j,e=d/k,u=q?r.map(function(a,b){return p(d,r[b],t[b],k)}):p(d,r,t,k),v=q?Math.abs((u[0]-r[0])/t[0]):Math.abs((u-r)/t);if(f.currentValue=q?u.slice():u,f.completionRate=v,f.durationRate=e,!g){if(n(u,v,e))return void i();if(b>l){f.currentValue=q?s.slice():s,f.completionRate=1,f.durationRate=1,m(q?s.slice():s,1,1),o(s,1,1),i();return}m(u,v,e),h(a)}}(j)}),f.cancel},H.util.requestAnimFrame=h,H.util.cancelAnimFrame=function(){return g.apply(H.window,arguments)},H.runningAnimations=c}(),H.util.animateColor=function(a,b,c,d){var e=new H.Color(a).getSource(),f=new H.Color(b).getSource(),g=d.onComplete,h=d.onChange;return d=d||{},H.util.animate(H.util.object.extend(d,{duration:c||500,startValue:e,endValue:f,byValue:f,easing:function(a,b,c,e){return P(b,c,d.colorEasing?d.colorEasing(a,e):1-Math.cos(a/e*(Math.PI/2)))},onComplete:function(a,b,c){if(g)return g(P(f,f,0),b,c)},onChange:function(a,b,c){if(h){if(Array.isArray(a))return h(P(a,a,0),b,c);h(a,b,c)}}}))},H.util.ease={easeInQuad:function(a,b,c,d){return c*(a/=d)*a+b},easeOutQuad:function(a,b,c,d){return-c*(a/=d)*(a-2)+b},easeInOutQuad:function(a,b,c,d){return(a/=d/2)<1?c/2*a*a+b:-c/2*(--a*(a-2)-1)+b},easeInCubic:function(a,b,c,d){return c*(a/=d)*a*a+b},easeOutCubic:function(a,b,c,d){return c*((a=a/d-1)*a*a+1)+b},easeInOutCubic:function(a,b,c,d){return(a/=d/2)<1?c/2*a*a*a+b:c/2*((a-=2)*a*a+2)+b},easeInQuart:function(a,b,c,d){return c*(a/=d)*a*a*a+b},easeOutQuart:function(a,b,c,d){return-c*((a=a/d-1)*a*a*a-1)+b},easeInOutQuart:function(a,b,c,d){return(a/=d/2)<1?c/2*a*a*a*a+b:-c/2*((a-=2)*a*a*a-2)+b},easeInQuint:function(a,b,c,d){return c*(a/=d)*a*a*a*a+b},easeOutQuint:function(a,b,c,d){return c*((a=a/d-1)*a*a*a*a+1)+b},easeInOutQuint:function(a,b,c,d){return(a/=d/2)<1?c/2*a*a*a*a*a+b:c/2*((a-=2)*a*a*a*a+2)+b},easeInSine:function(a,b,c,d){return-c*Math.cos(a/d*(Math.PI/2))+c+b},easeOutSine:function(a,b,c,d){return c*Math.sin(a/d*(Math.PI/2))+b},easeInOutSine:function(a,b,c,d){return-c/2*(Math.cos(Math.PI*a/d)-1)+b},easeInExpo:function(a,b,c,d){return 0===a?b:c*Math.pow(2,10*(a/d-1))+b},easeOutExpo:function(a,b,c,d){return a===d?b+c:c*(-Math.pow(2,-10*a/d)+1)+b},easeInOutExpo:function(a,b,c,d){return 0===a?b:a===d?b+c:(a/=d/2)<1?c/2*Math.pow(2,10*(a-1))+b:c/2*(-Math.pow(2,-10*--a)+2)+b},easeInCirc:function(a,b,c,d){return-c*(Math.sqrt(1-(a/=d)*a)-1)+b},easeOutCirc:function(a,b,c,d){return c*Math.sqrt(1-(a=a/d-1)*a)+b},easeInOutCirc:function(a,b,c,d){return(a/=d/2)<1?-c/2*(Math.sqrt(1-a*a)-1)+b:c/2*(Math.sqrt(1-(a-=2)*a)+1)+b},easeInElastic:function(a,b,c,d){var e=0;return 0===a?b:1==(a/=d)?b+c:(e||(e=.3*d),-R(Q(c,c,e,1.70158),a,d)+b)},easeOutElastic:function(a,b,c,d){var e=0;if(0===a)return b;if(1==(a/=d))return b+c;e||(e=.3*d);var f=Q(c,c,e,1.70158);return f.a*Math.pow(2,-10*a)*Math.sin((a*d-f.s)*(2*Math.PI)/f.p)+f.c+b},easeInOutElastic:function(a,b,c,d){var e=0;if(0===a)return b;if(2==(a/=d/2))return b+c;e||(e=.3*1.5*d);var f=Q(c,c,e,1.70158);return a<1?-.5*R(f,a,d)+b:f.a*Math.pow(2,-10*(a-=1))*Math.sin((a*d-f.s)*(2*Math.PI)/f.p)*.5+f.c+b},easeInBack:function(a,b,c,d,e){return void 0===e&&(e=1.70158),c*(a/=d)*a*((e+1)*a-e)+b},easeOutBack:function(a,b,c,d,e){return void 0===e&&(e=1.70158),c*((a=a/d-1)*a*((e+1)*a+e)+1)+b},easeInOutBack:function(a,b,c,d,e){return(void 0===e&&(e=1.70158),(a/=d/2)<1)?c/2*(a*a*(((e*=1.525)+1)*a-e))+b:c/2*((a-=2)*a*(((e*=1.525)+1)*a+e)+2)+b},easeInBounce:S,easeOutBounce:T,easeInOutBounce:function(a,b,c,d){return a<d/2?.5*S(2*a,0,c,d)+b:.5*T(2*a-d,0,c,d)+.5*c+b}},function(a){"use strict";var b=a.fabric||(a.fabric={}),c=b.util.object.extend,d=b.util.object.clone,e=b.util.toFixed,f=b.util.parseUnit,g=b.util.multiplyTransformMatrices,h={cx:"left",x:"left",r:"radius",cy:"top",y:"top",display:"visible",visibility:"visible",transform:"transformMatrix","fill-opacity":"fillOpacity","fill-rule":"fillRule","font-family":"fontFamily","font-size":"fontSize","font-style":"fontStyle","font-weight":"fontWeight","letter-spacing":"charSpacing","paint-order":"paintFirst","stroke-dasharray":"strokeDashArray","stroke-dashoffset":"strokeDashOffset","stroke-linecap":"strokeLineCap","stroke-linejoin":"strokeLineJoin","stroke-miterlimit":"strokeMiterLimit","stroke-opacity":"strokeOpacity","stroke-width":"strokeWidth","text-decoration":"textDecoration","text-anchor":"textAnchor",opacity:"opacity","clip-path":"clipPath","clip-rule":"clipRule","vector-effect":"strokeUniform","image-rendering":"imageSmoothing"},i={stroke:"strokeOpacity",fill:"fillOpacity"},j="font-size",k="clip-path";function l(a){return RegExp("^("+a.join("|")+")\\b","i")}function m(a,b){var c,d,e,f,g=[];for(e=0,f=b.length;e<f;e++)c=b[e],d=a.getElementsByTagName(c),g=g.concat(Array.prototype.slice.call(d));return g}function n(a,b){var c,d,e=a.nodeName,f=a.getAttribute("class"),g=a.getAttribute("id");if(c=RegExp("^"+e,"i"),b=b.replace(c,""),g&&b.length&&(c=RegExp("#"+g+"(?![a-zA-Z\\-]+)","i"),b=b.replace(c,"")),f&&b.length)for(d=(f=f.split(" ")).length;d--;)c=RegExp("\\."+f[d]+"(?![a-zA-Z\\-]+)","i"),b=b.replace(c,"");return 0===b.length}function o(a,b){if(a.getElementById&&(c=a.getElementById(b)),c)return c;var c,d,e,f,g=a.getElementsByTagName("*");for(e=0,f=g.length;e<f;e++)if(b===(d=g[e]).getAttribute("id"))return d}b.svgValidTagNamesRegEx=l(["path","circle","polygon","polyline","ellipse","rect","line","image","text"]),b.svgViewBoxElementsRegEx=l(["symbol","image","marker","pattern","view","svg"]),b.svgInvalidAncestorsRegEx=l(["pattern","defs","symbol","metadata","clipPath","mask","desc"]),b.svgValidParentsRegEx=l(["symbol","g","a","svg","clipPath","defs"]),b.cssRules={},b.gradientDefs={},b.clipPaths={},b.parseTransformAttribute=function(){function a(a,c,d){a[d]=Math.tan(b.util.degreesToRadians(c[0]))}var c=b.iMatrix,d=b.reNum,e=b.commaWsp,f="(?:(rotate)\\s*\\(\\s*("+d+")(?:"+e+"("+d+")"+e+"("+d+"))?\\s*\\))",g="(?:(scale)\\s*\\(\\s*("+d+")(?:"+e+"("+d+"))?\\s*\\))",h="(?:(translate)\\s*\\(\\s*("+d+")(?:"+e+"("+d+"))?\\s*\\))",i="(?:"+("(?:(matrix)\\s*\\(\\s*("+d+")"+e+"("+d+")"+e+"("+d+")"+e+"("+d+")"+e+"("+d+")"+e+"("+d)+")\\s*\\))|"+h+"|"+g+"|"+f+"|(?:(skewX)\\s*\\(\\s*("+d+")\\s*\\))|(?:(skewY)\\s*\\(\\s*("+d+")\\s*\\)))",j=RegExp("^\\s*(?:"+("(?:"+i+"(?:"+e+"*"+i)+")*)?)\\s*$"),k=RegExp(i,"g");return function(d){var e=c.concat(),f=[];if(!d||d&&!j.test(d))return e;d.replace(k,function(d){var g,h,j,k,l,m,n,o,p,q=new RegExp(i).exec(d).filter(function(a){return!!a}),r=q[1],s=q.slice(2).map(parseFloat);switch(r){case"translate":(g=e)[4]=s[0],2===s.length&&(g[5]=s[1]);break;case"rotate":s[0]=b.util.degreesToRadians(s[0]),h=e,j=b.util.cos(s[0]),k=b.util.sin(s[0]),l=0,m=0,3===s.length&&(l=s[1],m=s[2]),h[0]=j,h[1]=k,h[2]=-k,h[3]=j,h[4]=l-(j*l-k*m),h[5]=m-(k*l+j*m);break;case"scale":n=e,o=s[0],p=2===s.length?s[1]:s[0],n[0]=o,n[3]=p;break;case"skewX":a(e,s,2);break;case"skewY":a(e,s,1);break;case"matrix":e=s}f.push(e.concat()),e=c.concat()});for(var g=f[0];f.length>1;)f.shift(),g=b.util.multiplyTransformMatrices(g,f[0]);return g}}();var p=RegExp("^\\s*("+b.reNum+"+)\\s*,?\\s*("+b.reNum+"+)\\s*,?\\s*("+b.reNum+"+)\\s*,?\\s*("+b.reNum+"+)\\s*$");function q(a){if(!b.svgViewBoxElementsRegEx.test(a.nodeName))return{};var c,d,e,g,h=a.getAttribute("viewBox"),i=1,j=1,k=0,l=0,m=a.getAttribute("width"),n=a.getAttribute("height"),o=a.getAttribute("x")||0,q=a.getAttribute("y")||0,r=a.getAttribute("preserveAspectRatio")||"",s=!h||!(h=h.match(p)),t=!m||!n||"100%"===m||"100%"===n,u=s&&t,v={},w="",x=0,y=0;if(v.width=0,v.height=0,v.toBeParsed=u,s&&(o||q)&&a.parentNode&&"#document"!==a.parentNode.nodeName&&(w=" translate("+f(o)+" "+f(q)+") ",e=(a.getAttribute("transform")||"")+w,a.setAttribute("transform",e),a.removeAttribute("x"),a.removeAttribute("y")),u)return v;if(s)return v.width=f(m),v.height=f(n),v;if(k=-parseFloat(h[1]),l=-parseFloat(h[2]),c=parseFloat(h[3]),d=parseFloat(h[4]),v.minX=k,v.minY=l,v.viewBoxWidth=c,v.viewBoxHeight=d,t?(v.width=c,v.height=d):(v.width=f(m),v.height=f(n),i=v.width/c,j=v.height/d),"none"!==(r=b.util.parsePreserveAspectRatioAttribute(r)).alignX&&("meet"===r.meetOrSlice&&(j=i=i>j?j:i),"slice"===r.meetOrSlice&&(j=i=i>j?i:j),x=v.width-c*i,y=v.height-d*i,"Mid"===r.alignX&&(x/=2),"Mid"===r.alignY&&(y/=2),"Min"===r.alignX&&(x=0),"Min"===r.alignY&&(y=0)),1===i&&1===j&&0===k&&0===l&&0===o&&0===q)return v;if((o||q)&&"#document"!==a.parentNode.nodeName&&(w=" translate("+f(o)+" "+f(q)+") "),e=w+" matrix("+i+" 0 0 "+j+" "+(k*i+x)+" "+(l*j+y)+") ","svg"===a.nodeName){for(g=a.ownerDocument.createElementNS(b.svgNS,"g");a.firstChild;)g.appendChild(a.firstChild);a.appendChild(g)}else(g=a).removeAttribute("x"),g.removeAttribute("y"),e=g.getAttribute("transform")+e;return g.setAttribute("transform",e),v}b.parseSVGDocument=function(a,c,e,f){if(a){!function(a){for(var c=m(a,["use","svg:use"]),d=0;c.length&&d<c.length;){var e=c[d],f=e.getAttribute("xlink:href")||e.getAttribute("href");if(null===f)return;var g,h,i,j,k=f.slice(1),l=e.getAttribute("x")||0,n=e.getAttribute("y")||0,p=o(a,k).cloneNode(!0),r=(p.getAttribute("transform")||"")+" translate("+l+", "+n+")",s=c.length,t=b.svgNS;if(q(p),/^svg$/i.test(p.nodeName)){var u=p.ownerDocument.createElementNS(t,"g");for(h=0,j=(i=p.attributes).length;h<j;h++)g=i.item(h),u.setAttributeNS(t,g.nodeName,g.nodeValue);for(;p.firstChild;)u.appendChild(p.firstChild);p=u}for(h=0,j=(i=e.attributes).length;h<j;h++)"x"!==(g=i.item(h)).nodeName&&"y"!==g.nodeName&&"xlink:href"!==g.nodeName&&"href"!==g.nodeName&&("transform"===g.nodeName?r=g.nodeValue+" "+r:p.setAttribute(g.nodeName,g.nodeValue));p.setAttribute("transform",r),p.setAttribute("instantiated_by_use","1"),p.removeAttribute("id"),e.parentNode.replaceChild(p,e),c.length===s&&d++}}(a);var g,h,i=b.Object.__uid++,j=q(a),k=b.util.toArray(a.getElementsByTagName("*"));if(j.crossOrigin=f&&f.crossOrigin,j.svgUid=i,0===k.length&&b.isLikelyNode){k=a.selectNodes('//*[name(.)!="svg"]');var l=[];for(g=0,h=k.length;g<h;g++)l[g]=k[g];k=l}var n=k.filter(function(a){return q(a),b.svgValidTagNamesRegEx.test(a.nodeName.replace("svg:",""))&&!function(a,b){for(;a&&(a=a.parentNode);)if(a.nodeName&&b.test(a.nodeName.replace("svg:",""))&&!a.getAttribute("instantiated_by_use"))return!0;return!1}(a,b.svgInvalidAncestorsRegEx)});if(!n||n&&!n.length){c&&c([],{});return}var p={};k.filter(function(a){return"clipPath"===a.nodeName.replace("svg:","")}).forEach(function(a){p[a.getAttribute("id")]=b.util.toArray(a.getElementsByTagName("*")).filter(function(a){return b.svgValidTagNamesRegEx.test(a.nodeName.replace("svg:",""))})}),b.gradientDefs[i]=b.getGradientDefs(a),b.cssRules[i]=b.getCSSRules(a),b.clipPaths[i]=p,b.parseElements(n,function(a,d){c&&(c(a,j,d,k),delete b.gradientDefs[i],delete b.cssRules[i],delete b.clipPaths[i])},d(j),e,f)}};var r=RegExp("(normal|italic)?\\s*(normal|small-caps)?\\s*(normal|bold|bolder|lighter|100|200|300|400|500|600|700|800|900)?\\s*("+b.reNum+"(?:px|cm|mm|em|pt|pc|in)*)(?:\\/(normal|"+b.reNum+"))?\\s+(.*)");c(b,{parseFontDeclaration:function(a,b){var c=a.match(r);if(c){var d=c[1],e=c[3],g=c[4],h=c[5],i=c[6];d&&(b.fontStyle=d),e&&(b.fontWeight=isNaN(parseFloat(e))?e:parseFloat(e)),g&&(b.fontSize=f(g)),i&&(b.fontFamily=i),h&&(b.lineHeight="normal"===h?1:h)}},getGradientDefs:function(a){var b,c=m(a,["linearGradient","radialGradient","svg:linearGradient","svg:radialGradient"]),d=0,e={};for(d=c.length;d--;)(b=c[d]).getAttribute("xlink:href")&&function a(b,c){var d="xlink:href",e=o(b,c.getAttribute(d).slice(1));if(e&&e.getAttribute(d)&&a(b,e),["gradientTransform","x1","x2","y1","y2","gradientUnits","cx","cy","r","fx","fy"].forEach(function(a){e&&!c.hasAttribute(a)&&e.hasAttribute(a)&&c.setAttribute(a,e.getAttribute(a))}),!c.children.length)for(var f=e.cloneNode(!0);f.firstChild;)c.appendChild(f.firstChild);c.removeAttribute(d)}(a,b),e[b.getAttribute("id")]=b;return e},parseAttributes:function(a,d,l){if(a){var m,o,p,q={};void 0===l&&(l=a.getAttribute("svgUid")),a.parentNode&&b.svgValidParentsRegEx.test(a.parentNode.nodeName)&&(q=b.parseAttributes(a.parentNode,d,l));var r=d.reduce(function(b,c){return(m=a.getAttribute(c))&&(b[c]=m),b},{}),s=c(function(a,c){var d={};for(var e in b.cssRules[c])if(function(a,b){var c,d=!0;return(c=n(a,b.pop()))&&b.length&&(d=function(a,b){for(var c,d=!0;a.parentNode&&1===a.parentNode.nodeType&&b.length;)d&&(c=b.pop()),d=n(a=a.parentNode,c);return 0===b.length}(a,b)),c&&d&&0===b.length}(a,e.split(" ")))for(var f in b.cssRules[c][e])d[f]=b.cssRules[c][e][f];return d}(a,l),b.parseStyleAttribute(a));r=c(r,s),s[k]&&a.setAttribute(k,s[k]),o=p=q.fontSize||b.Text.DEFAULT_SVG_FONT_SIZE,r[j]&&(r[j]=o=f(r[j],p));var t,u,v={};for(var w in r)u=function(a,c,d,e){var h,i=Array.isArray(c);if(("fill"===a||"stroke"===a)&&"none"===c)c="";else if("strokeUniform"===a)return"non-scaling-stroke"===c;else if("strokeDashArray"===a)c="none"===c?null:c.replace(/,/g," ").split(/\s+/).map(parseFloat);else if("transformMatrix"===a)c=d&&d.transformMatrix?g(d.transformMatrix,b.parseTransformAttribute(c)):b.parseTransformAttribute(c);else if("visible"===a)c="none"!==c&&"hidden"!==c,d&&!1===d.visible&&(c=!1);else if("opacity"===a)c=parseFloat(c),d&&void 0!==d.opacity&&(c*=d.opacity);else if("textAnchor"===a)c="start"===c?"left":"end"===c?"right":"center";else if("charSpacing"===a)h=f(c,e)/e*1e3;else if("paintFirst"===a){var j=c.indexOf("fill"),k=c.indexOf("stroke"),c="fill";j>-1&&k>-1&&k<j?c="stroke":-1===j&&k>-1&&(c="stroke")}else{if("href"===a||"xlink:href"===a||"font"===a)return c;if("imageSmoothing"===a)return"optimizeQuality"===c;h=i?c.map(f):f(c,e)}return!i&&isNaN(h)?c:h}(t=w in h?h[w]:w,r[w],q,o),v[t]=u;v&&v.font&&b.parseFontDeclaration(v.font,v);var x=c(q,v);return b.svgValidParentsRegEx.test(a.nodeName)?x:function(a){for(var c in i)if(void 0!==a[i[c]]&&""!==a[c]){if(void 0===a[c]){if(!b.Object.prototype[c])continue;a[c]=b.Object.prototype[c]}if(0!==a[c].indexOf("url(")){var d=new b.Color(a[c]);a[c]=d.setAlpha(e(d.getAlpha()*a[i[c]],2)).toRgba()}}return a}(x)}},parseElements:function(a,c,d,e,f){new b.ElementsParser(a,c,d,e,f).parse()},parseStyleAttribute:function(a){var b,c,d,e,f={},g=a.getAttribute("style");if(!g)return f;if("string"==typeof g)g.replace(/;\s*$/,"").split(";").forEach(function(a){var d=a.split(":");b=d[0].trim().toLowerCase(),c=d[1].trim(),f[b]=c});else{for(var h in g)void 0!==g[h]&&(d=h.toLowerCase(),e=g[h],f[d]=e)}return f},parsePointsAttribute:function(a){if(!a)return null;a=(a=a.replace(/,/g," ").trim()).split(/\s+/);var b,c,d=[];for(b=0,c=a.length;b<c;b+=2)d.push({x:parseFloat(a[b]),y:parseFloat(a[b+1])});return d},getCSSRules:function(a){var c,d,e=a.getElementsByTagName("style"),f={};for(c=0,d=e.length;c<d;c++){var g=e[c].textContent;""!==(g=g.replace(/\/\*[\s\S]*?\*\//g,"")).trim()&&g.split("}").filter(function(a){return a.trim()}).forEach(function(a){var e=a.split("{"),g={},h=e[1].trim().split(";").filter(function(a){return a.trim()});for(c=0,d=h.length;c<d;c++){var i=h[c].split(":"),j=i[0].trim(),k=i[1].trim();g[j]=k}(a=e[0].trim()).split(",").forEach(function(a){""!==(a=a.replace(/^svg/i,"").trim())&&(f[a]?b.util.object.extend(f[a],g):f[a]=b.util.object.clone(g))})})}return f},loadSVGFromURL:function(a,c,d,e){a=a.replace(/^\n\s*/,"").trim(),new b.util.request(a,{method:"get",onComplete:function(a){var f=a.responseXML;if(!f||!f.documentElement)return c&&c(null),!1;b.parseSVGDocument(f.documentElement,function(a,b,d,e){c&&c(a,b,d,e)},d,e)}})},loadSVGFromString:function(a,c,d,e){var f=new b.window.DOMParser().parseFromString(a.trim(),"text/xml");b.parseSVGDocument(f.documentElement,function(a,b,d,e){c(a,b,d,e)},d,e)}})}(c),H.ElementsParser=function(a,b,c,d,e,f){this.elements=a,this.callback=b,this.options=c,this.reviver=d,this.svgUid=c&&c.svgUid||0,this.parsingOptions=e,this.regexUrl=/^url\(['"]?#([^'"]+)['"]?\)/g,this.doc=f},(p=H.ElementsParser.prototype).parse=function(){this.instances=Array(this.elements.length),this.numElements=this.elements.length,this.createObjects()},p.createObjects=function(){var a=this;this.elements.forEach(function(b,c){b.setAttribute("svgUid",a.svgUid),a.createObject(b,c)})},p.findTag=function(a){return H[H.util.string.capitalize(a.tagName.replace("svg:",""))]},p.createObject=function(a,b){var c=this.findTag(a);if(c&&c.fromElement)try{c.fromElement(a,this.createCallback(b,a),this.options)}catch(a){H.log(a)}else this.checkIfDone()},p.createCallback=function(a,b){var c=this;return function(d){var e;c.resolveGradient(d,b,"fill"),c.resolveGradient(d,b,"stroke"),d instanceof H.Image&&d._originalElement&&(e=d.parsePreserveAspectRatioAttribute(b)),d._removeTransformMatrix(e),c.resolveClipPath(d,b),c.reviver&&c.reviver(b,d),c.instances[a]=d,c.checkIfDone()}},p.extractPropertyDefinition=function(a,b,c){var d=a[b],e=this.regexUrl;if(e.test(d)){e.lastIndex=0;var f=e.exec(d)[1];return e.lastIndex=0,H[c][this.svgUid][f]}},p.resolveGradient=function(a,b,c){var d=this.extractPropertyDefinition(a,c,"gradientDefs");if(d){var e=b.getAttribute(c+"-opacity"),f=H.Gradient.fromElement(d,a,e,this.options);a.set(c,f)}},p.createClipPathCallback=function(a,b){return function(a){a._removeTransformMatrix(),a.fillRule=a.clipRule,b.push(a)}},p.resolveClipPath=function(a,b){var c,d,e,f,g,h=this.extractPropertyDefinition(a,"clipPath","clipPaths");if(h){e=[],d=H.util.invertTransform(a.calcTransformMatrix());for(var i=h[0].parentNode,j=b;j.parentNode&&j.getAttribute("clip-path")!==a.clipPath;)j=j.parentNode;j.parentNode.appendChild(i);for(var k=0;k<h.length;k++)c=h[k],this.findTag(c).fromElement(c,this.createClipPathCallback(a,e),this.options);h=1===e.length?e[0]:new H.Group(e),f=H.util.multiplyTransformMatrices(d,h.calcTransformMatrix()),h.clipPath&&this.resolveClipPath(h,j);var g=H.util.qrDecompose(f);h.flipX=!1,h.flipY=!1,h.set("scaleX",g.scaleX),h.set("scaleY",g.scaleY),h.angle=g.angle,h.skewX=g.skewX,h.skewY=0,h.setPositionByOrigin({x:g.translateX,y:g.translateY},"center","center"),a.clipPath=h}else delete a.clipPath},p.checkIfDone=function(){0==--this.numElements&&(this.instances=this.instances.filter(function(a){return null!=a}),this.callback(this.instances,this.elements))},function(a){"use strict";var b=a.fabric||(a.fabric={});if(b.Point)return b.warn("fabric.Point is already defined");function c(a,b){this.x=a,this.y=b}b.Point=c,c.prototype={type:"point",constructor:c,add:function(a){return new c(this.x+a.x,this.y+a.y)},addEquals:function(a){return this.x+=a.x,this.y+=a.y,this},scalarAdd:function(a){return new c(this.x+a,this.y+a)},scalarAddEquals:function(a){return this.x+=a,this.y+=a,this},subtract:function(a){return new c(this.x-a.x,this.y-a.y)},subtractEquals:function(a){return this.x-=a.x,this.y-=a.y,this},scalarSubtract:function(a){return new c(this.x-a,this.y-a)},scalarSubtractEquals:function(a){return this.x-=a,this.y-=a,this},multiply:function(a){return new c(this.x*a,this.y*a)},multiplyEquals:function(a){return this.x*=a,this.y*=a,this},divide:function(a){return new c(this.x/a,this.y/a)},divideEquals:function(a){return this.x/=a,this.y/=a,this},eq:function(a){return this.x===a.x&&this.y===a.y},lt:function(a){return this.x<a.x&&this.y<a.y},lte:function(a){return this.x<=a.x&&this.y<=a.y},gt:function(a){return this.x>a.x&&this.y>a.y},gte:function(a){return this.x>=a.x&&this.y>=a.y},lerp:function(a,b){return void 0===b&&(b=.5),b=Math.max(Math.min(1,b),0),new c(this.x+(a.x-this.x)*b,this.y+(a.y-this.y)*b)},distanceFrom:function(a){var b=this.x-a.x,c=this.y-a.y;return Math.sqrt(b*b+c*c)},midPointFrom:function(a){return this.lerp(a)},min:function(a){return new c(Math.min(this.x,a.x),Math.min(this.y,a.y))},max:function(a){return new c(Math.max(this.x,a.x),Math.max(this.y,a.y))},toString:function(){return this.x+","+this.y},setXY:function(a,b){return this.x=a,this.y=b,this},setX:function(a){return this.x=a,this},setY:function(a){return this.y=a,this},setFromPoint:function(a){return this.x=a.x,this.y=a.y,this},swap:function(a){var b=this.x,c=this.y;this.x=a.x,this.y=a.y,a.x=b,a.y=c},clone:function(){return new c(this.x,this.y)}}}(c),function(a){"use strict";var b=a.fabric||(a.fabric={});if(b.Intersection)return b.warn("fabric.Intersection is already defined");function c(a){this.status=a,this.points=[]}b.Intersection=c,b.Intersection.prototype={constructor:c,appendPoint:function(a){return this.points.push(a),this},appendPoints:function(a){return this.points=this.points.concat(a),this}},b.Intersection.intersectLineLine=function(a,d,e,f){var g,h=(f.x-e.x)*(a.y-e.y)-(f.y-e.y)*(a.x-e.x),i=(d.x-a.x)*(a.y-e.y)-(d.y-a.y)*(a.x-e.x),j=(f.y-e.y)*(d.x-a.x)-(f.x-e.x)*(d.y-a.y);if(0!==j){var k=h/j,l=i/j;0<=k&&k<=1&&0<=l&&l<=1?(g=new c("Intersection")).appendPoint(new b.Point(a.x+k*(d.x-a.x),a.y+k*(d.y-a.y))):g=new c}else g=new c(0===h||0===i?"Coincident":"Parallel");return g},b.Intersection.intersectLinePolygon=function(a,b,d){var e,f,g,h,i=new c,j=d.length;for(h=0;h<j;h++)e=d[h],f=d[(h+1)%j],g=c.intersectLineLine(a,b,e,f),i.appendPoints(g.points);return i.points.length>0&&(i.status="Intersection"),i},b.Intersection.intersectPolygonPolygon=function(a,b){var d,e=new c,f=a.length;for(d=0;d<f;d++){var g=a[d],h=a[(d+1)%f],i=c.intersectLinePolygon(g,h,b);e.appendPoints(i.points)}return e.points.length>0&&(e.status="Intersection"),e},b.Intersection.intersectPolygonRectangle=function(a,d,e){var f=d.min(e),g=d.max(e),h=new b.Point(g.x,f.y),i=new b.Point(f.x,g.y),j=c.intersectLinePolygon(f,h,a),k=c.intersectLinePolygon(h,g,a),l=c.intersectLinePolygon(g,i,a),m=c.intersectLinePolygon(i,f,a),n=new c;return n.appendPoints(j.points),n.appendPoints(k.points),n.appendPoints(l.points),n.appendPoints(m.points),n.points.length>0&&(n.status="Intersection"),n}}(c),function(a){"use strict";var b=a.fabric||(a.fabric={});if(b.Color)return b.warn("fabric.Color is already defined.");function c(a){a?this._tryParsingColor(a):this.setSource([0,0,0,1])}function d(a,b,c){return(c<0&&(c+=1),c>1&&(c-=1),c<1/6)?a+(b-a)*6*c:c<.5?b:c<2/3?a+(b-a)*(2/3-c)*6:a}b.Color=c,b.Color.prototype={_tryParsingColor:function(a){var b;a in c.colorNameMap&&(a=c.colorNameMap[a]),"transparent"===a&&(b=[255,255,255,0]),b||(b=c.sourceFromHex(a)),b||(b=c.sourceFromRgb(a)),b||(b=c.sourceFromHsl(a)),b||(b=[0,0,0,1]),b&&this.setSource(b)},_rgbToHsl:function(a,c,d){a/=255,c/=255,d/=255;var e,f,g,h=b.util.array.max([a,c,d]),i=b.util.array.min([a,c,d]);if(g=(h+i)/2,h===i)e=f=0;else{var j=h-i;switch(f=g>.5?j/(2-h-i):j/(h+i),h){case a:e=(c-d)/j+6*(c<d);break;case c:e=(d-a)/j+2;break;case d:e=(a-c)/j+4}e/=6}return[Math.round(360*e),Math.round(100*f),Math.round(100*g)]},getSource:function(){return this._source},setSource:function(a){this._source=a},toRgb:function(){var a=this.getSource();return"rgb("+a[0]+","+a[1]+","+a[2]+")"},toRgba:function(){var a=this.getSource();return"rgba("+a[0]+","+a[1]+","+a[2]+","+a[3]+")"},toHsl:function(){var a=this.getSource(),b=this._rgbToHsl(a[0],a[1],a[2]);return"hsl("+b[0]+","+b[1]+"%,"+b[2]+"%)"},toHsla:function(){var a=this.getSource(),b=this._rgbToHsl(a[0],a[1],a[2]);return"hsla("+b[0]+","+b[1]+"%,"+b[2]+"%,"+a[3]+")"},toHex:function(){var a,b,c,d=this.getSource();return a=1===(a=d[0].toString(16)).length?"0"+a:a,b=1===(b=d[1].toString(16)).length?"0"+b:b,c=1===(c=d[2].toString(16)).length?"0"+c:c,a.toUpperCase()+b.toUpperCase()+c.toUpperCase()},toHexa:function(){var a;return a=1===(a=(a=Math.round(255*this.getSource()[3])).toString(16)).length?"0"+a:a,this.toHex()+a.toUpperCase()},getAlpha:function(){return this.getSource()[3]},setAlpha:function(a){var b=this.getSource();return b[3]=a,this.setSource(b),this},toGrayscale:function(){var a=this.getSource(),b=parseInt((.3*a[0]+.59*a[1]+.11*a[2]).toFixed(0),10),c=a[3];return this.setSource([b,b,b,c]),this},toBlackWhite:function(a){var b=this.getSource(),c=(.3*b[0]+.59*b[1]+.11*b[2]).toFixed(0),d=b[3];return a=a||127,c=Number(c)<Number(a)?0:255,this.setSource([c,c,c,d]),this},overlayWith:function(a){a instanceof c||(a=new c(a));var b,d=[],e=this.getAlpha(),f=this.getSource(),g=a.getSource();for(b=0;b<3;b++)d.push(Math.round(.5*f[b]+.5*g[b]));return d[3]=e,this.setSource(d),this}},b.Color.reRGBa=/^rgba?\(\s*(\d{1,3}(?:\.\d+)?\%?)\s*,\s*(\d{1,3}(?:\.\d+)?\%?)\s*,\s*(\d{1,3}(?:\.\d+)?\%?)\s*(?:\s*,\s*((?:\d*\.?\d+)?)\s*)?\)$/i,b.Color.reHSLa=/^hsla?\(\s*(\d{1,3})\s*,\s*(\d{1,3}\%)\s*,\s*(\d{1,3}\%)\s*(?:\s*,\s*(\d+(?:\.\d+)?)\s*)?\)$/i,b.Color.reHex=/^#?([0-9a-f]{8}|[0-9a-f]{6}|[0-9a-f]{4}|[0-9a-f]{3})$/i,b.Color.colorNameMap={aliceblue:"#F0F8FF",antiquewhite:"#FAEBD7",aqua:"#00FFFF",aquamarine:"#7FFFD4",azure:"#F0FFFF",beige:"#F5F5DC",bisque:"#FFE4C4",black:"#000000",blanchedalmond:"#FFEBCD",blue:"#0000FF",blueviolet:"#8A2BE2",brown:"#A52A2A",burlywood:"#DEB887",cadetblue:"#5F9EA0",chartreuse:"#7FFF00",chocolate:"#D2691E",coral:"#FF7F50",cornflowerblue:"#6495ED",cornsilk:"#FFF8DC",crimson:"#DC143C",cyan:"#00FFFF",darkblue:"#00008B",darkcyan:"#008B8B",darkgoldenrod:"#B8860B",darkgray:"#A9A9A9",darkgrey:"#A9A9A9",darkgreen:"#006400",darkkhaki:"#BDB76B",darkmagenta:"#8B008B",darkolivegreen:"#556B2F",darkorange:"#FF8C00",darkorchid:"#9932CC",darkred:"#8B0000",darksalmon:"#E9967A",darkseagreen:"#8FBC8F",darkslateblue:"#483D8B",darkslategray:"#2F4F4F",darkslategrey:"#2F4F4F",darkturquoise:"#00CED1",darkviolet:"#9400D3",deeppink:"#FF1493",deepskyblue:"#00BFFF",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1E90FF",firebrick:"#B22222",floralwhite:"#FFFAF0",forestgreen:"#228B22",fuchsia:"#FF00FF",gainsboro:"#DCDCDC",ghostwhite:"#F8F8FF",gold:"#FFD700",goldenrod:"#DAA520",gray:"#808080",grey:"#808080",green:"#008000",greenyellow:"#ADFF2F",honeydew:"#F0FFF0",hotpink:"#FF69B4",indianred:"#CD5C5C",indigo:"#4B0082",ivory:"#FFFFF0",khaki:"#F0E68C",lavender:"#E6E6FA",lavenderblush:"#FFF0F5",lawngreen:"#7CFC00",lemonchiffon:"#FFFACD",lightblue:"#ADD8E6",lightcoral:"#F08080",lightcyan:"#E0FFFF",lightgoldenrodyellow:"#FAFAD2",lightgray:"#D3D3D3",lightgrey:"#D3D3D3",lightgreen:"#90EE90",lightpink:"#FFB6C1",lightsalmon:"#FFA07A",lightseagreen:"#20B2AA",lightskyblue:"#87CEFA",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#B0C4DE",lightyellow:"#FFFFE0",lime:"#00FF00",limegreen:"#32CD32",linen:"#FAF0E6",magenta:"#FF00FF",maroon:"#800000",mediumaquamarine:"#66CDAA",mediumblue:"#0000CD",mediumorchid:"#BA55D3",mediumpurple:"#9370DB",mediumseagreen:"#3CB371",mediumslateblue:"#7B68EE",mediumspringgreen:"#00FA9A",mediumturquoise:"#48D1CC",mediumvioletred:"#C71585",midnightblue:"#191970",mintcream:"#F5FFFA",mistyrose:"#FFE4E1",moccasin:"#FFE4B5",navajowhite:"#FFDEAD",navy:"#000080",oldlace:"#FDF5E6",olive:"#808000",olivedrab:"#6B8E23",orange:"#FFA500",orangered:"#FF4500",orchid:"#DA70D6",palegoldenrod:"#EEE8AA",palegreen:"#98FB98",paleturquoise:"#AFEEEE",palevioletred:"#DB7093",papayawhip:"#FFEFD5",peachpuff:"#FFDAB9",peru:"#CD853F",pink:"#FFC0CB",plum:"#DDA0DD",powderblue:"#B0E0E6",purple:"#800080",rebeccapurple:"#663399",red:"#FF0000",rosybrown:"#BC8F8F",royalblue:"#4169E1",saddlebrown:"#8B4513",salmon:"#FA8072",sandybrown:"#F4A460",seagreen:"#2E8B57",seashell:"#FFF5EE",sienna:"#A0522D",silver:"#C0C0C0",skyblue:"#87CEEB",slateblue:"#6A5ACD",slategray:"#708090",slategrey:"#708090",snow:"#FFFAFA",springgreen:"#00FF7F",steelblue:"#4682B4",tan:"#D2B48C",teal:"#008080",thistle:"#D8BFD8",tomato:"#FF6347",turquoise:"#40E0D0",violet:"#EE82EE",wheat:"#F5DEB3",white:"#FFFFFF",whitesmoke:"#F5F5F5",yellow:"#FFFF00",yellowgreen:"#9ACD32"},b.Color.fromRgb=function(a){return c.fromSource(c.sourceFromRgb(a))},b.Color.sourceFromRgb=function(a){var b=a.match(c.reRGBa);if(b){var d=parseInt(b[1],10)/(/%$/.test(b[1])?100:1)*(/%$/.test(b[1])?255:1),e=parseInt(b[2],10)/(/%$/.test(b[2])?100:1)*(/%$/.test(b[2])?255:1),f=parseInt(b[3],10)/(/%$/.test(b[3])?100:1)*(/%$/.test(b[3])?255:1);return[parseInt(d,10),parseInt(e,10),parseInt(f,10),b[4]?parseFloat(b[4]):1]}},b.Color.fromRgba=c.fromRgb,b.Color.fromHsl=function(a){return c.fromSource(c.sourceFromHsl(a))},b.Color.sourceFromHsl=function(a){var b=a.match(c.reHSLa);if(b){var e,f,g,h=(parseFloat(b[1])%360+360)%360/360,i=parseFloat(b[2])/(/%$/.test(b[2])?100:1),j=parseFloat(b[3])/(/%$/.test(b[3])?100:1);if(0===i)e=f=g=j;else{var k=j<=.5?j*(i+1):j+i-j*i,l=2*j-k;e=d(l,k,h+1/3),f=d(l,k,h),g=d(l,k,h-1/3)}return[Math.round(255*e),Math.round(255*f),Math.round(255*g),b[4]?parseFloat(b[4]):1]}},b.Color.fromHsla=c.fromHsl,b.Color.fromHex=function(a){return c.fromSource(c.sourceFromHex(a))},b.Color.sourceFromHex=function(a){if(a.match(c.reHex)){var b=a.slice(a.indexOf("#")+1),d=3===b.length||4===b.length,e=8===b.length||4===b.length,f=d?b.charAt(0)+b.charAt(0):b.substring(0,2),g=d?b.charAt(1)+b.charAt(1):b.substring(2,4),h=d?b.charAt(2)+b.charAt(2):b.substring(4,6),i=e?d?b.charAt(3)+b.charAt(3):b.substring(6,8):"FF";return[parseInt(f,16),parseInt(g,16),parseInt(h,16),parseFloat((parseInt(i,16)/255).toFixed(2))]}},b.Color.fromSource=function(a){var b=new c;return b.setSource(a),b}}(c),function(a){"use strict";var b=a.fabric||(a.fabric={}),c=["e","se","s","sw","w","nw","n","ne","e"],d=["ns","nesw","ew","nwse"],e={},f="left",g="right",h="bottom",i="center",j={top:h,bottom:"top",left:g,right:f,center:i},k=b.util.radiansToDegrees,l=Math.sign||function(a){return(a>0)-(a<0)||+a};function m(a,b){return Math.round((a.angle+k(Math.atan2(b.y,b.x))+360)%360/45)}function n(a,c){var d=c.transform.target,e=d.canvas,f=b.util.object.clone(c);f.target=d,e&&e.fire("object:"+a,f),d.fire(a,c)}function o(a,b){var c=b.canvas,d=a[c.uniScaleKey];return c.uniformScaling&&!d||!c.uniformScaling&&d}function p(a){return a.originX===i&&a.originY===i}function q(a,b,c){var d=a.lockScalingX,e=a.lockScalingY;return!!d&&!!e||!b&&(!!d||!!e)&&!!c||!!d&&"x"===b||!!e&&"y"===b||!1}function r(a,b,c,d){return{e:a,transform:b,pointer:{x:c,y:d}}}function s(a){return function(b,c,d,e){var f=c.target,g=f.getCenterPoint(),h=f.translateToOriginPoint(g,c.originX,c.originY),i=a(b,c,d,e);return f.setPositionByOrigin(h,c.originX,c.originY),i}}function t(a,b){return function(c,d,e,f){var g=b(c,d,e,f);return g&&n(a,r(c,d,e,f)),g}}function u(a,c,d,e,f){var g=a.target,h=g.controls[a.corner],i=g.canvas.getZoom(),j=g.padding/i,k=g.toLocalPoint(new b.Point(e,f),c,d);return k.x>=j&&(k.x-=j),k.x<=-j&&(k.x+=j),k.y>=j&&(k.y-=j),k.y<=j&&(k.y+=j),k.x-=h.offsetX,k.y-=h.offsetY,k}function v(a){return a.flipX!==a.flipY}function w(a,b,c,d,e){if(0!==a[b]){var f=e/a._getTransformedDimensions()[d]*a[c];a.set(c,f)}}function x(a,b,c,d){var e,i=b.target,j=i._getTransformedDimensions(0,i.skewY),l=Math.abs(2*u(b,b.originX,b.originY,c,d).x)-j.x,m=i.skewX;l<2?e=0:(e=k(Math.atan2(l/i.scaleX,j.y/i.scaleY)),b.originX===f&&b.originY===h&&(e=-e),b.originX===g&&"top"===b.originY&&(e=-e),v(i)&&(e=-e));var n=m!==e;if(n){var o=i._getTransformedDimensions().y;i.set("skewX",e),w(i,"skewY","scaleY","y",o)}return n}function y(a,b,c,d){var e,i=b.target,j=i._getTransformedDimensions(i.skewX,0),l=Math.abs(2*u(b,b.originX,b.originY,c,d).y)-j.y,m=i.skewY;l<2?e=0:(e=k(Math.atan2(l/i.scaleY,j.x/i.scaleX)),b.originX===f&&b.originY===h&&(e=-e),b.originX===g&&"top"===b.originY&&(e=-e),v(i)&&(e=-e));var n=m!==e;if(n){var o=i._getTransformedDimensions().x;i.set("skewY",e),w(i,"skewX","scaleX","x",o)}return n}function z(a,b,c,d,e){e=e||{};var f,g,h,i,k,m,n=b.target,r=n.lockScalingX,s=n.lockScalingY,t=e.by,v=o(a,n),w=q(n,t,v),x=b.gestureScale;if(w)return!1;if(x)g=b.scaleX*x,h=b.scaleY*x;else{if(f=u(b,b.originX,b.originY,c,d),k="y"!==t?l(f.x):1,m="x"!==t?l(f.y):1,b.signX||(b.signX=k),b.signY||(b.signY=m),n.lockScalingFlip&&(b.signX!==k||b.signY!==m))return!1;if(i=n._getTransformedDimensions(),v&&!t){var y=Math.abs(f.x)+Math.abs(f.y),z=b.original,A=y/(Math.abs(i.x*z.scaleX/n.scaleX)+Math.abs(i.y*z.scaleY/n.scaleY));g=z.scaleX*A,h=z.scaleY*A}else g=Math.abs(f.x*n.scaleX/i.x),h=Math.abs(f.y*n.scaleY/i.y);p(b)&&(g*=2,h*=2),b.signX!==k&&"y"!==t&&(b.originX=j[b.originX],g*=-1,b.signX=k),b.signY!==m&&"x"!==t&&(b.originY=j[b.originY],h*=-1,b.signY=m)}var B=n.scaleX,C=n.scaleY;return t?("x"===t&&n.set("scaleX",g),"y"===t&&n.set("scaleY",h)):(r||n.set("scaleX",g),s||n.set("scaleY",h)),B!==n.scaleX||C!==n.scaleY}e.scaleCursorStyleHandler=function(a,b,d){var e=o(a,d),f="";return(0!==b.x&&0===b.y?f="x":0===b.x&&0!==b.y&&(f="y"),q(d,f,e))?"not-allowed":c[m(d,b)]+"-resize"},e.skewCursorStyleHandler=function(a,b,c){return 0!==b.x&&c.lockSkewingY||0!==b.y&&c.lockSkewingX?"not-allowed":d[m(c,b)%4]+"-resize"},e.scaleSkewCursorStyleHandler=function(a,b,c){return a[c.canvas.altActionKey]?e.skewCursorStyleHandler(a,b,c):e.scaleCursorStyleHandler(a,b,c)},e.rotationWithSnapping=t("rotating",s(function(a,b,c,d){var e=b.target,f=e.translateToOriginPoint(e.getCenterPoint(),b.originX,b.originY);if(e.lockRotation)return!1;var g=Math.atan2(b.ey-f.y,b.ex-f.x),h=k(Math.atan2(d-f.y,c-f.x)-g+b.theta),i=!0;if(e.snapAngle>0){var j=e.snapAngle,l=e.snapThreshold||j,m=Math.ceil(h/j)*j,n=Math.floor(h/j)*j;Math.abs(h-n)<l?h=n:Math.abs(h-m)<l&&(h=m)}return h<0&&(h=360+h),h%=360,i=e.angle!==h,e.angle=h,i})),e.scalingEqually=t("scaling",s(function(a,b,c,d){return z(a,b,c,d)})),e.scalingX=t("scaling",s(function(a,b,c,d){return z(a,b,c,d,{by:"x"})})),e.scalingY=t("scaling",s(function(a,b,c,d){return z(a,b,c,d,{by:"y"})})),e.scalingYOrSkewingX=function(a,b,c,d){return a[b.target.canvas.altActionKey]?e.skewHandlerX(a,b,c,d):e.scalingY(a,b,c,d)},e.scalingXOrSkewingY=function(a,b,c,d){return a[b.target.canvas.altActionKey]?e.skewHandlerY(a,b,c,d):e.scalingX(a,b,c,d)},e.changeWidth=t("resizing",s(function(a,b,c,d){var e=b.target,f=u(b,b.originX,b.originY,c,d),g=e.strokeWidth/(e.strokeUniform?e.scaleX:1),h=p(b)?2:1,i=e.width,j=Math.abs(f.x*h/e.scaleX)-g;return e.set("width",Math.max(j,0)),i!==j})),e.skewHandlerX=function(a,b,c,d){var e,h=b.target,j=h.skewX,k=b.originY;return!h.lockSkewingX&&(0===j?e=u(b,i,i,c,d).x>0?f:g:(j>0&&(e="top"===k?f:g),j<0&&(e="top"===k?g:f),v(h)&&(e=e===f?g:f)),b.originX=e,t("skewing",s(x))(a,b,c,d))},e.skewHandlerY=function(a,b,c,d){var e,g=b.target,j=g.skewY,k=b.originX;return!g.lockSkewingY&&(0===j?e=u(b,i,i,c,d).y>0?"top":h:(j>0&&(e=k===f?"top":h),j<0&&(e=k===f?h:"top"),v(g)&&(e="top"===e?h:"top")),b.originY=e,t("skewing",s(y))(a,b,c,d))},e.dragHandler=function(a,b,c,d){var e=b.target,f=c-b.offsetX,g=d-b.offsetY,h=!e.get("lockMovementX")&&e.left!==f,i=!e.get("lockMovementY")&&e.top!==g;return h&&e.set("left",f),i&&e.set("top",g),(h||i)&&n("moving",r(a,b,c,d)),h||i},e.scaleOrSkewActionName=function(a,b,c){var d=a[c.canvas.altActionKey];return 0===b.x?d?"skewX":"scaleY":0===b.y?d?"skewY":"scaleX":void 0},e.rotationStyleHandler=function(a,b,c){return c.lockRotation?"not-allowed":b.cursorStyle},e.fireEvent=n,e.wrapWithFixedAnchor=s,e.wrapWithFireEvent=t,e.getLocalPoint=u,b.controlsUtils=e}(c),function(a){"use strict";var b=a.fabric||(a.fabric={}),c=b.util.degreesToRadians,d=b.controlsUtils;d.renderCircleControl=function(a,b,c,d,e){d=d||{};var f,g=this.sizeX||d.cornerSize||e.cornerSize,h=this.sizeY||d.cornerSize||e.cornerSize,i=void 0!==d.transparentCorners?d.transparentCorners:e.transparentCorners,j=!i&&(d.cornerStrokeColor||e.cornerStrokeColor),k=b,l=c;a.save(),a.fillStyle=d.cornerColor||e.cornerColor,a.strokeStyle=d.cornerStrokeColor||e.cornerStrokeColor,g>h?(f=g,a.scale(1,h/g),l=c*g/h):h>g?(f=h,a.scale(g/h,1),k=b*h/g):f=g,a.lineWidth=1,a.beginPath(),a.arc(k,l,f/2,0,2*Math.PI,!1),a[i?"stroke":"fill"](),j&&a.stroke(),a.restore()},d.renderSquareControl=function(a,b,d,e,f){e=e||{};var g=this.sizeX||e.cornerSize||f.cornerSize,h=this.sizeY||e.cornerSize||f.cornerSize,i=void 0!==e.transparentCorners?e.transparentCorners:f.transparentCorners,j=!i&&(e.cornerStrokeColor||f.cornerStrokeColor),k=g/2,l=h/2;a.save(),a.fillStyle=e.cornerColor||f.cornerColor,a.strokeStyle=e.cornerStrokeColor||f.cornerStrokeColor,a.lineWidth=1,a.translate(b,d),a.rotate(c(f.angle)),a[(i?"stroke":"fill")+"Rect"](-k,-l,g,h),j&&a.strokeRect(-k,-l,g,h),a.restore()}}(c),function(a){"use strict";var b=a.fabric||(a.fabric={});b.Control=function(a){for(var b in a)this[b]=a[b]},b.Control.prototype={visible:!0,actionName:"scale",angle:0,x:0,y:0,offsetX:0,offsetY:0,sizeX:null,sizeY:null,touchSizeX:null,touchSizeY:null,cursorStyle:"crosshair",withConnection:!1,actionHandler:function(){},mouseDownHandler:function(){},mouseUpHandler:function(){},getActionHandler:function(){return this.actionHandler},getMouseDownHandler:function(){return this.mouseDownHandler},getMouseUpHandler:function(){return this.mouseUpHandler},cursorStyleHandler:function(a,b){return b.cursorStyle},getActionName:function(a,b){return b.actionName},getVisibility:function(a,b){var c=a._controlsVisibility;return c&&void 0!==c[b]?c[b]:this.visible},setVisibility:function(a){this.visible=a},positionHandler:function(a,c){return b.util.transformPoint({x:this.x*a.x+this.offsetX,y:this.y*a.y+this.offsetY},c)},calcCornerCoords:function(a,c,d,e,f){var g,h,i,j,k=f?this.touchSizeX:this.sizeX,l=f?this.touchSizeY:this.sizeY;if(k&&l&&k!==l){var m=Math.atan2(l,k),n=Math.sqrt(k*k+l*l)/2,o=m-b.util.degreesToRadians(a),p=Math.PI/2-m-b.util.degreesToRadians(a);g=n*b.util.cos(o),h=n*b.util.sin(o),i=n*b.util.cos(p),j=n*b.util.sin(p)}else{n=.7071067812*(k&&l?k:c);var o=b.util.degreesToRadians(45-a);g=i=n*b.util.cos(o),h=j=n*b.util.sin(o)}return{tl:{x:d-j,y:e-i},tr:{x:d+g,y:e-h},bl:{x:d-g,y:e+h},br:{x:d+j,y:e+i}}},render:function(a,c,d,e,f){"circle"===((e=e||{}).cornerStyle||f.cornerStyle)?b.controlsUtils.renderCircleControl.call(this,a,c,d,e,f):b.controlsUtils.renderSquareControl.call(this,a,c,d,e,f)}}}(c),q=H.util.object.clone,H.Gradient=H.util.createClass({offsetX:0,offsetY:0,gradientTransform:null,gradientUnits:"pixels",type:"linear",initialize:function(a){a||(a={}),a.coords||(a.coords={});var b,c=this;Object.keys(a).forEach(function(b){c[b]=a[b]}),this.id?this.id+="_"+H.Object.__uid++:this.id=H.Object.__uid++,b={x1:a.coords.x1||0,y1:a.coords.y1||0,x2:a.coords.x2||0,y2:a.coords.y2||0},"radial"===this.type&&(b.r1=a.coords.r1||0,b.r2=a.coords.r2||0),this.coords=b,this.colorStops=a.colorStops.slice()},addColorStop:function(a){for(var b in a){var c=new H.Color(a[b]);this.colorStops.push({offset:parseFloat(b),color:c.toRgb(),opacity:c.getAlpha()})}return this},toObject:function(a){var b={type:this.type,coords:this.coords,colorStops:this.colorStops,offsetX:this.offsetX,offsetY:this.offsetY,gradientUnits:this.gradientUnits,gradientTransform:this.gradientTransform?this.gradientTransform.concat():this.gradientTransform};return H.util.populateWithProperties(this,b,a),b},toSVG:function(a,b){var c,d,e,f,g=q(this.coords,!0),b=b||{},h=q(this.colorStops,!0),i=g.r1>g.r2,j=this.gradientTransform?this.gradientTransform.concat():H.iMatrix.concat(),k=-this.offsetX,l=-this.offsetY,m=!!b.additionalTransform,n="pixels"===this.gradientUnits?"userSpaceOnUse":"objectBoundingBox";if(h.sort(function(a,b){return a.offset-b.offset}),"objectBoundingBox"===n?(k/=a.width,l/=a.height):(k+=a.width/2,l+=a.height/2),"path"===a.type&&"percentage"!==this.gradientUnits&&(k-=a.pathOffset.x,l-=a.pathOffset.y),j[4]-=k,j[5]-=l,f='id="SVGID_'+this.id+'" gradientUnits="'+n+'"'+(' gradientTransform="'+(m?b.additionalTransform+" ":"")+H.util.matrixToSVG(j))+'" ',"linear"===this.type?e=["<linearGradient ",f,' x1="',g.x1,'" y1="',g.y1,'" x2="',g.x2,'" y2="',g.y2,'">\n']:"radial"===this.type&&(e=["<radialGradient ",f,' cx="',i?g.x1:g.x2,'" cy="',i?g.y1:g.y2,'" r="',i?g.r1:g.r2,'" fx="',i?g.x2:g.x1,'" fy="',i?g.y2:g.y1,'">\n']),"radial"===this.type){if(i)for((h=h.concat()).reverse(),c=0,d=h.length;c<d;c++)h[c].offset=1-h[c].offset;var o=Math.min(g.r1,g.r2);if(o>0){var p=o/Math.max(g.r1,g.r2);for(c=0,d=h.length;c<d;c++)h[c].offset+=p*(1-h[c].offset)}}for(c=0,d=h.length;c<d;c++){var r=h[c];e.push("<stop ",'offset="',100*r.offset+"%",'" style="stop-color:',r.color,void 0!==r.opacity?";stop-opacity: "+r.opacity:";",'"/>\n')}return e.push("linear"===this.type?"</linearGradient>\n":"</radialGradient>\n"),e.join("")},toLive:function(a){var b,c,d,e=H.util.object.clone(this.coords);if(this.type){for("linear"===this.type?b=a.createLinearGradient(e.x1,e.y1,e.x2,e.y2):"radial"===this.type&&(b=a.createRadialGradient(e.x1,e.y1,e.r1,e.x2,e.y2,e.r2)),c=0,d=this.colorStops.length;c<d;c++){var f=this.colorStops[c].color,g=this.colorStops[c].opacity,h=this.colorStops[c].offset;void 0!==g&&(f=new H.Color(f).setAlpha(g).toRgba()),b.addColorStop(h,f)}return b}}}),H.util.object.extend(H.Gradient,{fromElement:function(a,b,c,d){var e,f,g,h,i,j,k=parseFloat(c)/(/%$/.test(c)?100:1);isNaN(k=k<0?0:k>1?1:k)&&(k=1);var l,m,n,o,p=a.getElementsByTagName("stop"),q="userSpaceOnUse"===a.getAttribute("gradientUnits")?"pixels":"percentage",r=a.getAttribute("gradientTransform")||"",s=[],t=0,u=0;for("linearGradient"===a.nodeName||"LINEARGRADIENT"===a.nodeName?(l="linear",m={x1:a.getAttribute("x1")||0,y1:a.getAttribute("y1")||0,x2:a.getAttribute("x2")||"100%",y2:a.getAttribute("y2")||0}):(l="radial",m={x1:a.getAttribute("fx")||a.getAttribute("cx")||"50%",y1:a.getAttribute("fy")||a.getAttribute("cy")||"50%",r1:0,x2:a.getAttribute("cx")||"50%",y2:a.getAttribute("cy")||"50%",r2:a.getAttribute("r")||"50%"}),n=p.length;n--;)s.push(function(a,b){var c,d,e,f,g=a.getAttribute("style"),h=a.getAttribute("offset")||0;if(h=(h=parseFloat(h)/(/%$/.test(h)?100:1))<0?0:h>1?1:h,g){var i=g.split(/\s*;\s*/);for(""===i[i.length-1]&&i.pop(),f=i.length;f--;){var j=i[f].split(/\s*:\s*/),k=j[0].trim(),l=j[1].trim();"stop-color"===k?c=l:"stop-opacity"===k&&(e=l)}}return c||(c=a.getAttribute("stop-color")||"rgb(0,0,0)"),e||(e=a.getAttribute("stop-opacity")),d=(c=new H.Color(c)).getAlpha(),e=(isNaN(parseFloat(e))?1:parseFloat(e))*(d*b),{offset:h,color:c.toRgb(),opacity:e}}(p[n],k));return o=H.parseTransformAttribute(r),e=0,f=m,g=d,h=q,Object.keys(f).forEach(function(a){"Infinity"===(i=f[a])?j=1:"-Infinity"===i?j=0:(j=parseFloat(f[a],10),"string"==typeof i&&/^(\d+\.\d+)%|(\d+)%$/.test(i)&&(j*=.01,"pixels"===h&&(("x1"===a||"x2"===a||"r2"===a)&&(j*=g.viewBoxWidth||g.width),("y1"===a||"y2"===a)&&(j*=g.viewBoxHeight||g.height)))),f[a]=j}),"pixels"===q&&(t=-b.left,u=-b.top),new H.Gradient({id:a.getAttribute("id"),type:l,coords:m,colorStops:s,gradientUnits:q,gradientTransform:o,offsetX:t,offsetY:u})}}),function(){"use strict";var a=H.util.toFixed;H.Pattern=H.util.createClass({repeat:"repeat",offsetX:0,offsetY:0,crossOrigin:"",patternTransform:null,initialize:function(a,b){if(a||(a={}),this.id=H.Object.__uid++,this.setOptions(a),!a.source||a.source&&"string"!=typeof a.source){b&&b(this);return}var c=this;this.source=H.util.createImage(),H.util.loadImage(a.source,function(a,d){c.source=a,b&&b(c,d)},null,this.crossOrigin)},toObject:function(b){var c,d,e=H.Object.NUM_FRACTION_DIGITS;return"string"==typeof this.source.src?c=this.source.src:"object"==typeof this.source&&this.source.toDataURL&&(c=this.source.toDataURL()),d={type:"pattern",source:c,repeat:this.repeat,crossOrigin:this.crossOrigin,offsetX:a(this.offsetX,e),offsetY:a(this.offsetY,e),patternTransform:this.patternTransform?this.patternTransform.concat():null},H.util.populateWithProperties(this,d,b),d},toSVG:function(a){var b="function"==typeof this.source?this.source():this.source,c=b.width/a.width,d=b.height/a.height,e=this.offsetX/a.width,f=this.offsetY/a.height,g="";return("repeat-x"===this.repeat||"no-repeat"===this.repeat)&&(d=1,f&&(d+=Math.abs(f))),("repeat-y"===this.repeat||"no-repeat"===this.repeat)&&(c=1,e&&(c+=Math.abs(e))),b.src?g=b.src:b.toDataURL&&(g=b.toDataURL()),'<pattern id="SVGID_'+this.id+'" x="'+e+'" y="'+f+'" width="'+c+'" height="'+d+'">\n<image x="0" y="0" width="'+b.width+'" height="'+b.height+'" xlink:href="'+g+'"></image>\n</pattern>\n'},setOptions:function(a){for(var b in a)this[b]=a[b]},toLive:function(a){var b=this.source;return b&&(void 0===b.src||b.complete&&0!==b.naturalWidth&&0!==b.naturalHeight)?a.createPattern(b,this.repeat):""}})}(),function(a){"use strict";var b=a.fabric||(a.fabric={}),c=b.util.toFixed;if(b.Shadow)return b.warn("fabric.Shadow is already defined.");b.Shadow=b.util.createClass({color:"rgb(0,0,0)",blur:0,offsetX:0,offsetY:0,affectStroke:!1,includeDefaultValues:!0,nonScaling:!1,initialize:function(a){for(var c in"string"==typeof a&&(a=this._parseShadow(a)),a)this[c]=a[c];this.id=b.Object.__uid++},_parseShadow:function(a){var c=a.trim(),d=b.Shadow.reOffsetsAndBlur.exec(c)||[];return{color:(c.replace(b.Shadow.reOffsetsAndBlur,"")||"rgb(0,0,0)").trim(),offsetX:parseFloat(d[1],10)||0,offsetY:parseFloat(d[2],10)||0,blur:parseFloat(d[3],10)||0}},toString:function(){return[this.offsetX,this.offsetY,this.blur,this.color].join("px ")},toSVG:function(a){var d=40,e=40,f=b.Object.NUM_FRACTION_DIGITS,g=b.util.rotateVector({x:this.offsetX,y:this.offsetY},b.util.degreesToRadians(-a.angle)),h=new b.Color(this.color);return a.width&&a.height&&(d=100*c((Math.abs(g.x)+this.blur)/a.width,f)+20,e=100*c((Math.abs(g.y)+this.blur)/a.height,f)+20),a.flipX&&(g.x*=-1),a.flipY&&(g.y*=-1),'<filter id="SVGID_'+this.id+'" y="-'+e+'%" height="'+(100+2*e)+'%" x="-'+d+'%" width="'+(100+2*d)+'%" >\n	<feGaussianBlur in="SourceAlpha" stdDeviation="'+c(this.blur?this.blur/2:0,f)+'"></feGaussianBlur>\n	<feOffset dx="'+c(g.x,f)+'" dy="'+c(g.y,f)+'" result="oBlur" ></feOffset>\n	<feFlood flood-color="'+h.toRgb()+'" flood-opacity="'+h.getAlpha()+'"/>\n	<feComposite in2="oBlur" operator="in" />\n	<feMerge>\n		<feMergeNode></feMergeNode>\n		<feMergeNode in="SourceGraphic"></feMergeNode>\n	</feMerge>\n</filter>\n'},toObject:function(){if(this.includeDefaultValues)return{color:this.color,blur:this.blur,offsetX:this.offsetX,offsetY:this.offsetY,affectStroke:this.affectStroke,nonScaling:this.nonScaling};var a={},c=b.Shadow.prototype;return["color","blur","offsetX","offsetY","affectStroke","nonScaling"].forEach(function(b){this[b]!==c[b]&&(a[b]=this[b])},this),a}}),b.Shadow.reOffsetsAndBlur=/(?:\s|^)(-?\d+(?:\.\d*)?(?:px)?(?:\s?|$))?(-?\d+(?:\.\d*)?(?:px)?(?:\s?|$))?(\d+(?:\.\d*)?(?:px)?)?(?:\s?|$)(?:$|\s)/}(c),function(){"use strict";if(H.StaticCanvas)return H.warn("fabric.StaticCanvas is already defined.");var a=H.util.object.extend,b=H.util.getElementOffset,c=H.util.removeFromArray,d=H.util.toFixed,e=H.util.transformPoint,f=H.util.invertTransform,g=H.util.getNodeCanvas,h=H.util.createCanvasElement,i=Error("Could not initialize `canvas` element");H.StaticCanvas=H.util.createClass(H.CommonMethods,{initialize:function(a,b){b||(b={}),this.renderAndResetBound=this.renderAndReset.bind(this),this.requestRenderAllBound=this.requestRenderAll.bind(this),this._initStatic(a,b)},backgroundColor:"",backgroundImage:null,overlayColor:"",overlayImage:null,includeDefaultValues:!0,stateful:!1,renderOnAddRemove:!0,controlsAboveOverlay:!1,allowTouchScrolling:!1,imageSmoothingEnabled:!0,viewportTransform:H.iMatrix.concat(),backgroundVpt:!0,overlayVpt:!0,enableRetinaScaling:!0,vptCoords:{},skipOffscreen:!0,clipPath:void 0,_initStatic:function(a,b){var c=this.requestRenderAllBound;this._objects=[],this._createLowerCanvas(a),this._initOptions(b),this.interactive||this._initRetinaScaling(),b.overlayImage&&this.setOverlayImage(b.overlayImage,c),b.backgroundImage&&this.setBackgroundImage(b.backgroundImage,c),b.backgroundColor&&this.setBackgroundColor(b.backgroundColor,c),b.overlayColor&&this.setOverlayColor(b.overlayColor,c),this.calcOffset()},_isRetinaScaling:function(){return H.devicePixelRatio>1&&this.enableRetinaScaling},getRetinaScaling:function(){return this._isRetinaScaling()?Math.max(1,H.devicePixelRatio):1},_initRetinaScaling:function(){if(this._isRetinaScaling()){var a=H.devicePixelRatio;this.__initRetinaScaling(a,this.lowerCanvasEl,this.contextContainer),this.upperCanvasEl&&this.__initRetinaScaling(a,this.upperCanvasEl,this.contextTop)}},__initRetinaScaling:function(a,b,c){b.setAttribute("width",this.width*a),b.setAttribute("height",this.height*a),c.scale(a,a)},calcOffset:function(){return this._offset=b(this.lowerCanvasEl),this},setOverlayImage:function(a,b,c){return this.__setBgOverlayImage("overlayImage",a,b,c)},setBackgroundImage:function(a,b,c){return this.__setBgOverlayImage("backgroundImage",a,b,c)},setOverlayColor:function(a,b){return this.__setBgOverlayColor("overlayColor",a,b)},setBackgroundColor:function(a,b){return this.__setBgOverlayColor("backgroundColor",a,b)},__setBgOverlayImage:function(a,b,c,d){return"string"==typeof b?H.util.loadImage(b,function(b,e){if(b){var f=new H.Image(b,d);this[a]=f,f.canvas=this}c&&c(b,e)},this,d&&d.crossOrigin):(d&&b.setOptions(d),this[a]=b,b&&(b.canvas=this),c&&c(b,!1)),this},__setBgOverlayColor:function(a,b,c){return this[a]=b,this._initGradient(b,a),this._initPattern(b,a,c),this},_createCanvasElement:function(){var a=h();if(!a||(a.style||(a.style={}),void 0===a.getContext))throw i;return a},_initOptions:function(a){var b=this.lowerCanvasEl;this._setOptions(a),this.width=this.width||parseInt(b.width,10)||0,this.height=this.height||parseInt(b.height,10)||0,this.lowerCanvasEl.style&&(b.width=this.width,b.height=this.height,b.style.width=this.width+"px",b.style.height=this.height+"px",this.viewportTransform=this.viewportTransform.slice())},_createLowerCanvas:function(a){a&&a.getContext?this.lowerCanvasEl=a:this.lowerCanvasEl=H.util.getById(a)||this._createCanvasElement(),H.util.addClass(this.lowerCanvasEl,"lower-canvas"),this._originalCanvasStyle=this.lowerCanvasEl.style,this.interactive&&this._applyCanvasStyle(this.lowerCanvasEl),this.contextContainer=this.lowerCanvasEl.getContext("2d")},getWidth:function(){return this.width},getHeight:function(){return this.height},setWidth:function(a,b){return this.setDimensions({width:a},b)},setHeight:function(a,b){return this.setDimensions({height:a},b)},setDimensions:function(a,b){var c;for(var d in b=b||{},a)c=a[d],b.cssOnly||(this._setBackstoreDimension(d,a[d]),c+="px",this.hasLostContext=!0),b.backstoreOnly||this._setCssDimension(d,c);return this._isCurrentlyDrawing&&this.freeDrawingBrush&&this.freeDrawingBrush._setBrushStyles(this.contextTop),this._initRetinaScaling(),this.calcOffset(),b.cssOnly||this.requestRenderAll(),this},_setBackstoreDimension:function(a,b){return this.lowerCanvasEl[a]=b,this.upperCanvasEl&&(this.upperCanvasEl[a]=b),this.cacheCanvasEl&&(this.cacheCanvasEl[a]=b),this[a]=b,this},_setCssDimension:function(a,b){return this.lowerCanvasEl.style[a]=b,this.upperCanvasEl&&(this.upperCanvasEl.style[a]=b),this.wrapperEl&&(this.wrapperEl.style[a]=b),this},getZoom:function(){return this.viewportTransform[0]},setViewportTransform:function(a){var b,c,d,e=this._activeObject,f=this.backgroundImage,g=this.overlayImage;for(c=0,this.viewportTransform=a,d=this._objects.length;c<d;c++)(b=this._objects[c]).group||b.setCoords(!0);return e&&e.setCoords(),f&&f.setCoords(!0),g&&g.setCoords(!0),this.calcViewportBoundaries(),this.renderOnAddRemove&&this.requestRenderAll(),this},zoomToPoint:function(a,b){var c=a,d=this.viewportTransform.slice(0);a=e(a,f(this.viewportTransform)),d[0]=b,d[3]=b;var g=e(a,d);return d[4]+=c.x-g.x,d[5]+=c.y-g.y,this.setViewportTransform(d)},setZoom:function(a){return this.zoomToPoint(new H.Point(0,0),a),this},absolutePan:function(a){var b=this.viewportTransform.slice(0);return b[4]=-a.x,b[5]=-a.y,this.setViewportTransform(b)},relativePan:function(a){return this.absolutePan(new H.Point(-a.x-this.viewportTransform[4],-a.y-this.viewportTransform[5]))},getElement:function(){return this.lowerCanvasEl},_onObjectAdded:function(a){this.stateful&&a.setupState(),a._set("canvas",this),a.setCoords(),this.fire("object:added",{target:a}),a.fire("added")},_onObjectRemoved:function(a){this.fire("object:removed",{target:a}),a.fire("removed"),delete a.canvas},clearContext:function(a){return a.clearRect(0,0,this.width,this.height),this},getContext:function(){return this.contextContainer},clear:function(){return this.remove.apply(this,this.getObjects()),this.backgroundImage=null,this.overlayImage=null,this.backgroundColor="",this.overlayColor="",this._hasITextHandlers&&(this.off("mouse:up",this._mouseUpITextHandler),this._iTextInstances=null,this._hasITextHandlers=!1),this.clearContext(this.contextContainer),this.fire("canvas:cleared"),this.renderOnAddRemove&&this.requestRenderAll(),this},renderAll:function(){var a=this.contextContainer;return this.renderCanvas(a,this._objects),this},renderAndReset:function(){this.isRendering=0,this.renderAll()},requestRenderAll:function(){return this.isRendering||(this.isRendering=H.util.requestAnimFrame(this.renderAndResetBound)),this},calcViewportBoundaries:function(){var a={},b=this.width,c=this.height,d=f(this.viewportTransform);return a.tl=e({x:0,y:0},d),a.br=e({x:b,y:c},d),a.tr=new H.Point(a.br.x,a.tl.y),a.bl=new H.Point(a.tl.x,a.br.y),this.vptCoords=a,a},cancelRequestedRender:function(){this.isRendering&&(H.util.cancelAnimFrame(this.isRendering),this.isRendering=0)},renderCanvas:function(a,b){var c=this.viewportTransform,d=this.clipPath;this.cancelRequestedRender(),this.calcViewportBoundaries(),this.clearContext(a),H.util.setImageSmoothing(a,this.imageSmoothingEnabled),this.fire("before:render",{ctx:a}),this._renderBackground(a),a.save(),a.transform(c[0],c[1],c[2],c[3],c[4],c[5]),this._renderObjects(a,b),a.restore(),!this.controlsAboveOverlay&&this.interactive&&this.drawControls(a),d&&(d.canvas=this,d.shouldCache(),d._transformDone=!0,d.renderCache({forClipping:!0}),this.drawClipPathOnCanvas(a)),this._renderOverlay(a),this.controlsAboveOverlay&&this.interactive&&this.drawControls(a),this.fire("after:render",{ctx:a})},drawClipPathOnCanvas:function(a){var b=this.viewportTransform,c=this.clipPath;a.save(),a.transform(b[0],b[1],b[2],b[3],b[4],b[5]),a.globalCompositeOperation="destination-in",c.transform(a),a.scale(1/c.zoomX,1/c.zoomY),a.drawImage(c._cacheCanvas,-c.cacheTranslationX,-c.cacheTranslationY),a.restore()},_renderObjects:function(a,b){var c,d;for(c=0,d=b.length;c<d;++c)b[c]&&b[c].render(a)},_renderBackgroundOrOverlay:function(a,b){var c=this[b+"Color"],d=this[b+"Image"],e=this.viewportTransform,f=this[b+"Vpt"];if(c||d){if(c){a.save(),a.beginPath(),a.moveTo(0,0),a.lineTo(this.width,0),a.lineTo(this.width,this.height),a.lineTo(0,this.height),a.closePath(),a.fillStyle=c.toLive?c.toLive(a,this):c,f&&a.transform(e[0],e[1],e[2],e[3],e[4],e[5]),a.transform(1,0,0,1,c.offsetX||0,c.offsetY||0);var g=c.gradientTransform||c.patternTransform;g&&a.transform(g[0],g[1],g[2],g[3],g[4],g[5]),a.fill(),a.restore()}if(d){a.save();var h=this.skipOffscreen;this.skipOffscreen=f,f&&a.transform(e[0],e[1],e[2],e[3],e[4],e[5]),d.render(a),this.skipOffscreen=h,a.restore()}}},_renderBackground:function(a){this._renderBackgroundOrOverlay(a,"background")},_renderOverlay:function(a){this._renderBackgroundOrOverlay(a,"overlay")},getCenter:function(){return{top:this.height/2,left:this.width/2}},getCenterPoint:function(){return new H.Point(this.width/2,this.height/2)},centerObjectH:function(a){return this._centerObject(a,new H.Point(this.getCenterPoint().x,a.getCenterPoint().y))},centerObjectV:function(a){return this._centerObject(a,new H.Point(a.getCenterPoint().x,this.getCenterPoint().y))},centerObject:function(a){var b=this.getCenterPoint();return this._centerObject(a,b)},viewportCenterObject:function(a){var b=this.getVpCenter();return this._centerObject(a,b)},viewportCenterObjectH:function(a){var b=this.getVpCenter();return this._centerObject(a,new H.Point(b.x,a.getCenterPoint().y)),this},viewportCenterObjectV:function(a){var b=this.getVpCenter();return this._centerObject(a,new H.Point(a.getCenterPoint().x,b.y))},getVpCenter:function(){return e(this.getCenterPoint(),f(this.viewportTransform))},_centerObject:function(a,b){return a.setPositionByOrigin(b,"center","center"),a.setCoords(),this.renderOnAddRemove&&this.requestRenderAll(),this},toDatalessJSON:function(a){return this.toDatalessObject(a)},toObject:function(a){return this._toObjectMethod("toObject",a)},toDatalessObject:function(a){return this._toObjectMethod("toDatalessObject",a)},_toObjectMethod:function(b,c){var d=this.clipPath,e={version:H.version,objects:this._toObjects(b,c)};return d&&!d.excludeFromExport&&(e.clipPath=this._toObject(this.clipPath,b,c)),a(e,this.__serializeBgOverlay(b,c)),H.util.populateWithProperties(this,e,c),e},_toObjects:function(a,b){return this._objects.filter(function(a){return!a.excludeFromExport}).map(function(c){return this._toObject(c,a,b)},this)},_toObject:function(a,b,c){this.includeDefaultValues||(d=a.includeDefaultValues,a.includeDefaultValues=!1);var d,e=a[b](c);return this.includeDefaultValues||(a.includeDefaultValues=d),e},__serializeBgOverlay:function(a,b){var c={},d=this.backgroundImage,e=this.overlayImage,f=this.backgroundColor,g=this.overlayColor;return f&&f.toObject?f.excludeFromExport||(c.background=f.toObject(b)):f&&(c.background=f),g&&g.toObject?g.excludeFromExport||(c.overlay=g.toObject(b)):g&&(c.overlay=g),d&&!d.excludeFromExport&&(c.backgroundImage=this._toObject(d,a,b)),e&&!e.excludeFromExport&&(c.overlayImage=this._toObject(e,a,b)),c},svgViewportTransformation:!0,toSVG:function(a,b){a||(a={}),a.reviver=b;var c=[];return this._setSVGPreamble(c,a),this._setSVGHeader(c,a),this.clipPath&&c.push('<g clip-path="url(#'+this.clipPath.clipPathId+')" >\n'),this._setSVGBgOverlayColor(c,"background"),this._setSVGBgOverlayImage(c,"backgroundImage",b),this._setSVGObjects(c,b),this.clipPath&&c.push("</g>\n"),this._setSVGBgOverlayColor(c,"overlay"),this._setSVGBgOverlayImage(c,"overlayImage",b),c.push("</svg>"),c.join("")},_setSVGPreamble:function(a,b){b.suppressPreamble||a.push('<?xml version="1.0" encoding="',b.encoding||"UTF-8",'" standalone="no" ?>\n','<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" ','"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">\n')},_setSVGHeader:function(a,b){var c,e=b.width||this.width,f=b.height||this.height,g='viewBox="0 0 '+this.width+" "+this.height+'" ',h=H.Object.NUM_FRACTION_DIGITS;b.viewBox?g='viewBox="'+b.viewBox.x+" "+b.viewBox.y+" "+b.viewBox.width+" "+b.viewBox.height+'" ':this.svgViewportTransformation&&(g='viewBox="'+d(-(c=this.viewportTransform)[4]/c[0],h)+" "+d(-c[5]/c[3],h)+" "+d(this.width/c[0],h)+" "+d(this.height/c[3],h)+'" '),a.push("<svg ",'xmlns="http://www.w3.org/2000/svg" ','xmlns:xlink="http://www.w3.org/1999/xlink" ','version="1.1" ','width="',e,'" ','height="',f,'" ',g,'xml:space="preserve">\n',"<desc>Created with Fabric.js ",H.version,"</desc>\n","<defs>\n",this.createSVGFontFacesMarkup(),this.createSVGRefElementsMarkup(),this.createSVGClipPathMarkup(b),"</defs>\n")},createSVGClipPathMarkup:function(a){var b=this.clipPath;return b?(b.clipPathId="CLIPPATH_"+H.Object.__uid++,'<clipPath id="'+b.clipPathId+'" >\n'+this.clipPath.toClipPathSVG(a.reviver)+"</clipPath>\n"):""},createSVGRefElementsMarkup:function(){var a=this;return["background","overlay"].map(function(b){var c=a[b+"Color"];if(c&&c.toLive){var d=a[b+"Vpt"],e=a.viewportTransform,f={width:a.width/(d?e[0]:1),height:a.height/(d?e[3]:1)};return c.toSVG(f,{additionalTransform:d?H.util.matrixToSVG(e):""})}}).join("")},createSVGFontFacesMarkup:function(){var a,b,c,d,e,f,g,h,i="",j={},k=H.fontPaths,l=[];for(this._objects.forEach(function a(b){l.push(b),b._objects&&b._objects.forEach(a)}),g=0,h=l.length;g<h;g++)if((b=(a=l[g]).fontFamily,-1!==a.type.indexOf("text")&&!j[b]&&k[b])&&(j[b]=!0,a.styles))for(e in c=a.styles)for(f in d=c[e])!j[b=d[f].fontFamily]&&k[b]&&(j[b]=!0);for(var m in j)i+="		@font-face {\n			font-family: '"+m+"';\n			src: url('"+k[m]+"');\n		}\n";return i&&(i='	<style type="text/css"><![CDATA[\n'+i+"]]></style>\n"),i},_setSVGObjects:function(a,b){var c,d,e,f=this._objects;for(d=0,e=f.length;d<e;d++)(c=f[d]).excludeFromExport||this._setSVGObject(a,c,b)},_setSVGObject:function(a,b,c){a.push(b.toSVG(c))},_setSVGBgOverlayImage:function(a,b,c){this[b]&&!this[b].excludeFromExport&&this[b].toSVG&&a.push(this[b].toSVG(c))},_setSVGBgOverlayColor:function(a,b){var c=this[b+"Color"],d=this.viewportTransform,e=this.width,f=this.height;if(c)if(c.toLive){var g=c.repeat,h=H.util.invertTransform(d),i=this[b+"Vpt"]?H.util.matrixToSVG(h):"";a.push('<rect transform="'+i+" translate(",e/2,",",f/2,')"',' x="',c.offsetX-e/2,'" y="',c.offsetY-f/2,'" ','width="',"repeat-y"===g||"no-repeat"===g?c.source.width:e,'" height="',"repeat-x"===g||"no-repeat"===g?c.source.height:f,'" fill="url(#SVGID_'+c.id+')"',"></rect>\n")}else a.push('<rect x="0" y="0" width="100%" height="100%" ','fill="',c,'"',"></rect>\n")},sendToBack:function(a){if(!a)return this;var b,d,e,f=this._activeObject;if(a===f&&"activeSelection"===a.type)for(b=(e=f._objects).length;b--;)d=e[b],c(this._objects,d),this._objects.unshift(d);else c(this._objects,a),this._objects.unshift(a);return this.renderOnAddRemove&&this.requestRenderAll(),this},bringToFront:function(a){if(!a)return this;var b,d,e,f=this._activeObject;if(a===f&&"activeSelection"===a.type)for(b=0,e=f._objects;b<e.length;b++)d=e[b],c(this._objects,d),this._objects.push(d);else c(this._objects,a),this._objects.push(a);return this.renderOnAddRemove&&this.requestRenderAll(),this},sendBackwards:function(a,b){if(!a)return this;var d,e,f,g,h,i=this._activeObject,j=0;if(a===i&&"activeSelection"===a.type)for(d=0,h=i._objects;d<h.length;d++)e=h[d],(f=this._objects.indexOf(e))>0+j&&(g=f-1,c(this._objects,e),this._objects.splice(g,0,e)),j++;else 0!==(f=this._objects.indexOf(a))&&(g=this._findNewLowerIndex(a,f,b),c(this._objects,a),this._objects.splice(g,0,a));return this.renderOnAddRemove&&this.requestRenderAll(),this},_findNewLowerIndex:function(a,b,c){var d,e;if(c){for(d=b,e=b-1;e>=0;--e)if(a.intersectsWithObject(this._objects[e])||a.isContainedWithinObject(this._objects[e])||this._objects[e].isContainedWithinObject(a)){d=e;break}}else d=b-1;return d},bringForward:function(a,b){if(!a)return this;var d,e,f,g,h,i=this._activeObject,j=0;if(a===i&&"activeSelection"===a.type)for(d=(h=i._objects).length;d--;)e=h[d],(f=this._objects.indexOf(e))<this._objects.length-1-j&&(g=f+1,c(this._objects,e),this._objects.splice(g,0,e)),j++;else(f=this._objects.indexOf(a))!==this._objects.length-1&&(g=this._findNewUpperIndex(a,f,b),c(this._objects,a),this._objects.splice(g,0,a));return this.renderOnAddRemove&&this.requestRenderAll(),this},_findNewUpperIndex:function(a,b,c){var d,e,f;if(c){for(d=b,e=b+1,f=this._objects.length;e<f;++e)if(a.intersectsWithObject(this._objects[e])||a.isContainedWithinObject(this._objects[e])||this._objects[e].isContainedWithinObject(a)){d=e;break}}else d=b+1;return d},moveTo:function(a,b){return c(this._objects,a),this._objects.splice(b,0,a),this.renderOnAddRemove&&this.requestRenderAll()},dispose:function(){return this.isRendering&&(H.util.cancelAnimFrame(this.isRendering),this.isRendering=0),this.forEachObject(function(a){a.dispose&&a.dispose()}),this._objects=[],this.backgroundImage&&this.backgroundImage.dispose&&this.backgroundImage.dispose(),this.backgroundImage=null,this.overlayImage&&this.overlayImage.dispose&&this.overlayImage.dispose(),this.overlayImage=null,this._iTextInstances=null,this.contextContainer=null,this.lowerCanvasEl.classList.remove("lower-canvas"),H.util.setStyle(this.lowerCanvasEl,this._originalCanvasStyle),delete this._originalCanvasStyle,this.lowerCanvasEl.setAttribute("width",this.width),this.lowerCanvasEl.setAttribute("height",this.height),H.util.cleanUpJsdomNode(this.lowerCanvasEl),this.lowerCanvasEl=void 0,this},toString:function(){return"#<fabric.Canvas ("+this.complexity()+"): { objects: "+this._objects.length+" }>"}}),a(H.StaticCanvas.prototype,H.Observable),a(H.StaticCanvas.prototype,H.Collection),a(H.StaticCanvas.prototype,H.DataURLExporter),a(H.StaticCanvas,{EMPTY_JSON:'{"objects": [], "background": "white"}',supports:function(a){var b=h();if(!b||!b.getContext)return null;var c=b.getContext("2d");return c&&"setLineDash"===a?void 0!==c.setLineDash:null}}),H.StaticCanvas.prototype.toJSON=H.StaticCanvas.prototype.toObject,H.isLikelyNode&&(H.StaticCanvas.prototype.createPNGStream=function(){var a=g(this.lowerCanvasEl);return a&&a.createPNGStream()},H.StaticCanvas.prototype.createJPEGStream=function(a){var b=g(this.lowerCanvasEl);return b&&b.createJPEGStream(a)})}(),H.BaseBrush=H.util.createClass({color:"rgb(0, 0, 0)",width:1,shadow:null,strokeLineCap:"round",strokeLineJoin:"round",strokeMiterLimit:10,strokeDashArray:null,limitedToCanvasSize:!1,_setBrushStyles:function(a){a.strokeStyle=this.color,a.lineWidth=this.width,a.lineCap=this.strokeLineCap,a.miterLimit=this.strokeMiterLimit,a.lineJoin=this.strokeLineJoin,a.setLineDash(this.strokeDashArray||[])},_saveAndTransform:function(a){var b=this.canvas.viewportTransform;a.save(),a.transform(b[0],b[1],b[2],b[3],b[4],b[5])},_setShadow:function(){if(this.shadow){var a=this.canvas,b=this.shadow,c=a.contextTop,d=a.getZoom();a&&a._isRetinaScaling()&&(d*=H.devicePixelRatio),c.shadowColor=b.color,c.shadowBlur=b.blur*d,c.shadowOffsetX=b.offsetX*d,c.shadowOffsetY=b.offsetY*d}},needsFullRender:function(){return 1>new H.Color(this.color).getAlpha()||!!this.shadow},_resetShadow:function(){var a=this.canvas.contextTop;a.shadowColor="",a.shadowBlur=a.shadowOffsetX=a.shadowOffsetY=0},_isOutSideCanvas:function(a){return a.x<0||a.x>this.canvas.getWidth()||a.y<0||a.y>this.canvas.getHeight()}}),H.PencilBrush=H.util.createClass(H.BaseBrush,{decimate:.4,drawStraightLine:!1,straightLineKey:"shiftKey",initialize:function(a){this.canvas=a,this._points=[]},needsFullRender:function(){return this.callSuper("needsFullRender")||this._hasStraightLine},_drawSegment:function(a,b,c){var d=b.midPointFrom(c);return a.quadraticCurveTo(b.x,b.y,d.x,d.y),d},onMouseDown:function(a,b){this.canvas._isMainEvent(b.e)&&(this.drawStraightLine=b.e[this.straightLineKey],this._prepareForDrawing(a),this._captureDrawingPath(a),this._render())},onMouseMove:function(a,b){if(this.canvas._isMainEvent(b.e)&&(this.drawStraightLine=b.e[this.straightLineKey],!(!0===this.limitedToCanvasSize&&this._isOutSideCanvas(a))&&this._captureDrawingPath(a)&&this._points.length>1))if(this.needsFullRender())this.canvas.clearContext(this.canvas.contextTop),this._render();else{var c=this._points,d=c.length,e=this.canvas.contextTop;this._saveAndTransform(e),this.oldEnd&&(e.beginPath(),e.moveTo(this.oldEnd.x,this.oldEnd.y)),this.oldEnd=this._drawSegment(e,c[d-2],c[d-1],!0),e.stroke(),e.restore()}},onMouseUp:function(a){return!this.canvas._isMainEvent(a.e)||(this.drawStraightLine=!1,this.oldEnd=void 0,this._finalizeAndAddPath(),!1)},_prepareForDrawing:function(a){var b=new H.Point(a.x,a.y);this._reset(),this._addPoint(b),this.canvas.contextTop.moveTo(b.x,b.y)},_addPoint:function(a){return!(this._points.length>1&&a.eq(this._points[this._points.length-1]))&&(this.drawStraightLine&&this._points.length>1&&(this._hasStraightLine=!0,this._points.pop()),this._points.push(a),!0)},_reset:function(){this._points=[],this._setBrushStyles(this.canvas.contextTop),this._setShadow(),this._hasStraightLine=!1},_captureDrawingPath:function(a){var b=new H.Point(a.x,a.y);return this._addPoint(b)},_render:function(a){var b,c,d=this._points[0],e=this._points[1];if(a=a||this.canvas.contextTop,this._saveAndTransform(a),a.beginPath(),2===this._points.length&&d.x===e.x&&d.y===e.y){var f=this.width/1e3;d=new H.Point(d.x,d.y),e=new H.Point(e.x,e.y),d.x-=f,e.x+=f}for(a.moveTo(d.x,d.y),b=1,c=this._points.length;b<c;b++)this._drawSegment(a,d,e),d=this._points[b],e=this._points[b+1];a.lineTo(d.x,d.y),a.stroke(),a.restore()},convertPointsToSVGPath:function(a){var b=this.width/1e3;return H.util.getSmoothPathFromPoints(a,b)},_isEmptySVGPath:function(a){return"M 0 0 Q 0 0 0 0 L 0 0"===H.util.joinPath(a)},createPath:function(a){var b=new H.Path(a,{fill:null,stroke:this.color,strokeWidth:this.width,strokeLineCap:this.strokeLineCap,strokeMiterLimit:this.strokeMiterLimit,strokeLineJoin:this.strokeLineJoin,strokeDashArray:this.strokeDashArray});return this.shadow&&(this.shadow.affectStroke=!0,b.shadow=new H.Shadow(this.shadow)),b},decimatePoints:function(a,b){if(a.length<=2)return a;var c,d=Math.pow(b/this.canvas.getZoom(),2),e=a.length-1,f=a[0],g=[f];for(c=1;c<e-1;c++)Math.pow(f.x-a[c].x,2)+Math.pow(f.y-a[c].y,2)>=d&&g.push(f=a[c]);return g.push(a[e]),g},_finalizeAndAddPath:function(){this.canvas.contextTop.closePath(),this.decimate&&(this._points=this.decimatePoints(this._points,this.decimate));var a=this.convertPointsToSVGPath(this._points);if(this._isEmptySVGPath(a))return void this.canvas.requestRenderAll();var b=this.createPath(a);this.canvas.clearContext(this.canvas.contextTop),this.canvas.fire("before:path:created",{path:b}),this.canvas.add(b),this.canvas.requestRenderAll(),b.setCoords(),this._resetShadow(),this.canvas.fire("path:created",{path:b})}}),H.CircleBrush=H.util.createClass(H.BaseBrush,{width:10,initialize:function(a){this.canvas=a,this.points=[]},drawDot:function(a){var b=this.addPoint(a),c=this.canvas.contextTop;this._saveAndTransform(c),this.dot(c,b),c.restore()},dot:function(a,b){a.fillStyle=b.fill,a.beginPath(),a.arc(b.x,b.y,b.radius,0,2*Math.PI,!1),a.closePath(),a.fill()},onMouseDown:function(a){this.points.length=0,this.canvas.clearContext(this.canvas.contextTop),this._setShadow(),this.drawDot(a)},_render:function(){var a,b,c=this.canvas.contextTop,d=this.points;for(this._saveAndTransform(c),a=0,b=d.length;a<b;a++)this.dot(c,d[a]);c.restore()},onMouseMove:function(a){!0===this.limitedToCanvasSize&&this._isOutSideCanvas(a)||(this.needsFullRender()?(this.canvas.clearContext(this.canvas.contextTop),this.addPoint(a),this._render()):this.drawDot(a))},onMouseUp:function(){var a,b,c=this.canvas.renderOnAddRemove;this.canvas.renderOnAddRemove=!1;var d=[];for(a=0,b=this.points.length;a<b;a++){var e=this.points[a],f=new H.Circle({radius:e.radius,left:e.x,top:e.y,originX:"center",originY:"center",fill:e.fill});this.shadow&&(f.shadow=new H.Shadow(this.shadow)),d.push(f)}var g=new H.Group(d);g.canvas=this.canvas,this.canvas.fire("before:path:created",{path:g}),this.canvas.add(g),this.canvas.fire("path:created",{path:g}),this.canvas.clearContext(this.canvas.contextTop),this._resetShadow(),this.canvas.renderOnAddRemove=c,this.canvas.requestRenderAll()},addPoint:function(a){var b=new H.Point(a.x,a.y),c=H.util.getRandomInt(Math.max(0,this.width-20),this.width+20)/2,d=new H.Color(this.color).setAlpha(H.util.getRandomInt(0,100)/100).toRgba();return b.radius=c,b.fill=d,this.points.push(b),b}}),H.SprayBrush=H.util.createClass(H.BaseBrush,{width:10,density:20,dotWidth:1,dotWidthVariance:1,randomOpacity:!1,optimizeOverlapping:!0,initialize:function(a){this.canvas=a,this.sprayChunks=[]},onMouseDown:function(a){this.sprayChunks.length=0,this.canvas.clearContext(this.canvas.contextTop),this._setShadow(),this.addSprayChunk(a),this.render(this.sprayChunkPoints)},onMouseMove:function(a){!0===this.limitedToCanvasSize&&this._isOutSideCanvas(a)||(this.addSprayChunk(a),this.render(this.sprayChunkPoints))},onMouseUp:function(){var a=this.canvas.renderOnAddRemove;this.canvas.renderOnAddRemove=!1;for(var b=[],c=0,d=this.sprayChunks.length;c<d;c++)for(var e=this.sprayChunks[c],f=0,g=e.length;f<g;f++){var h=new H.Rect({width:e[f].width,height:e[f].width,left:e[f].x+1,top:e[f].y+1,originX:"center",originY:"center",fill:this.color});b.push(h)}this.optimizeOverlapping&&(b=this._getOptimizedRects(b));var i=new H.Group(b);this.shadow&&i.set("shadow",new H.Shadow(this.shadow)),this.canvas.fire("before:path:created",{path:i}),this.canvas.add(i),this.canvas.fire("path:created",{path:i}),this.canvas.clearContext(this.canvas.contextTop),this._resetShadow(),this.canvas.renderOnAddRemove=a,this.canvas.requestRenderAll()},_getOptimizedRects:function(a){var b,c,d,e={};for(c=0,d=a.length;c<d;c++)e[b=a[c].left+""+a[c].top]||(e[b]=a[c]);var f=[];for(b in e)f.push(e[b]);return f},render:function(a){var b,c,d=this.canvas.contextTop;for(d.fillStyle=this.color,this._saveAndTransform(d),b=0,c=a.length;b<c;b++){var e=a[b];void 0!==e.opacity&&(d.globalAlpha=e.opacity),d.fillRect(e.x,e.y,e.width,e.width)}d.restore()},_render:function(){var a,b,c=this.canvas.contextTop;for(c.fillStyle=this.color,this._saveAndTransform(c),a=0,b=this.sprayChunks.length;a<b;a++)this.render(this.sprayChunks[a]);c.restore()},addSprayChunk:function(a){this.sprayChunkPoints=[];var b,c,d,e,f=this.width/2;for(e=0;e<this.density;e++){b=H.util.getRandomInt(a.x-f,a.x+f),c=H.util.getRandomInt(a.y-f,a.y+f),d=this.dotWidthVariance?H.util.getRandomInt(Math.max(1,this.dotWidth-this.dotWidthVariance),this.dotWidth+this.dotWidthVariance):this.dotWidth;var g=new H.Point(b,c);g.width=d,this.randomOpacity&&(g.opacity=H.util.getRandomInt(0,100)/100),this.sprayChunkPoints.push(g)}this.sprayChunks.push(this.sprayChunkPoints)}}),H.PatternBrush=H.util.createClass(H.PencilBrush,{getPatternSrc:function(){var a=H.util.createCanvasElement(),b=a.getContext("2d");return a.width=a.height=25,b.fillStyle=this.color,b.beginPath(),b.arc(10,10,10,0,2*Math.PI,!1),b.closePath(),b.fill(),a},getPatternSrcFunction:function(){return String(this.getPatternSrc).replace("this.color",'"'+this.color+'"')},getPattern:function(a){return a.createPattern(this.source||this.getPatternSrc(),"repeat")},_setBrushStyles:function(a){this.callSuper("_setBrushStyles",a),a.strokeStyle=this.getPattern(a)},createPath:function(a){var b=this.callSuper("createPath",a),c=b._getLeftTopCoords().scalarAdd(b.strokeWidth/2);return b.stroke=new H.Pattern({source:this.source||this.getPatternSrcFunction(),offsetX:-c.x,offsetY:-c.y}),b}});var U=H.util.getPointer,V=H.util.degreesToRadians,W=H.util.isTouchEvent;for(var X in H.Canvas=H.util.createClass(H.StaticCanvas,{initialize:function(a,b){b||(b={}),this.renderAndResetBound=this.renderAndReset.bind(this),this.requestRenderAllBound=this.requestRenderAll.bind(this),this._initStatic(a,b),this._initInteractive(),this._createCacheCanvas()},uniformScaling:!0,uniScaleKey:"shiftKey",centeredScaling:!1,centeredRotation:!1,centeredKey:"altKey",altActionKey:"shiftKey",interactive:!0,selection:!0,selectionKey:"shiftKey",altSelectionKey:null,selectionColor:"rgba(100, 100, 255, 0.3)",selectionDashArray:[],selectionBorderColor:"rgba(255, 255, 255, 0.3)",selectionLineWidth:1,selectionFullyContained:!1,hoverCursor:"move",moveCursor:"move",defaultCursor:"default",freeDrawingCursor:"crosshair",notAllowedCursor:"not-allowed",containerClass:"canvas-container",perPixelTargetFind:!1,targetFindTolerance:0,skipTargetFind:!1,isDrawingMode:!1,preserveObjectStacking:!1,snapAngle:0,snapThreshold:null,stopContextMenu:!1,fireRightClick:!1,fireMiddleClick:!1,targets:[],enablePointerEvents:!1,_hoveredTarget:null,_hoveredTargets:[],_initInteractive:function(){this._currentTransform=null,this._groupSelector=null,this._initWrapperElement(),this._createUpperCanvas(),this._initEventListeners(),this._initRetinaScaling(),this.freeDrawingBrush=H.PencilBrush&&new H.PencilBrush(this),this.calcOffset()},_chooseObjectsToRender:function(){var a,b,c,d=this.getActiveObjects();if(d.length>0&&!this.preserveObjectStacking){b=[],c=[];for(var e=0,f=this._objects.length;e<f;e++)a=this._objects[e],-1===d.indexOf(a)?b.push(a):c.push(a);d.length>1&&(this._activeObject._objects=c),b.push.apply(b,c)}else b=this._objects;return b},renderAll:function(){!this.contextTopDirty||this._groupSelector||this.isDrawingMode||(this.clearContext(this.contextTop),this.contextTopDirty=!1),this.hasLostContext&&(this.renderTopLayer(this.contextTop),this.hasLostContext=!1);var a=this.contextContainer;return this.renderCanvas(a,this._chooseObjectsToRender()),this},renderTopLayer:function(a){a.save(),this.isDrawingMode&&this._isCurrentlyDrawing&&(this.freeDrawingBrush&&this.freeDrawingBrush._render(),this.contextTopDirty=!0),this.selection&&this._groupSelector&&(this._drawSelection(a),this.contextTopDirty=!0),a.restore()},renderTop:function(){var a=this.contextTop;return this.clearContext(a),this.renderTopLayer(a),this.fire("after:render"),this},_normalizePointer:function(a,b){var c=a.calcTransformMatrix(),d=H.util.invertTransform(c),e=this.restorePointerVpt(b);return H.util.transformPoint(e,d)},isTargetTransparent:function(a,b,c){if(a.shouldCache()&&a._cacheCanvas&&a!==this._activeObject){var d=this._normalizePointer(a,{x:b,y:c}),e=Math.max(a.cacheTranslationX+d.x*a.zoomX,0),f=Math.max(a.cacheTranslationY+d.y*a.zoomY,0),g=H.util.isTransparent(a._cacheContext,Math.round(e),Math.round(f),this.targetFindTolerance);return g}var h=this.contextCache,i=a.selectionBackgroundColor,j=this.viewportTransform;a.selectionBackgroundColor="",this.clearContext(h),h.save(),h.transform(j[0],j[1],j[2],j[3],j[4],j[5]),a.render(h),h.restore(),a.selectionBackgroundColor=i;var g=H.util.isTransparent(h,b,c,this.targetFindTolerance);return g},_isSelectionKeyPressed:function(a){return Array.isArray(this.selectionKey)?!!this.selectionKey.find(function(b){return!0===a[b]}):a[this.selectionKey]},_shouldClearSelection:function(a,b){var c=this.getActiveObjects(),d=this._activeObject;return!b||b&&d&&c.length>1&&-1===c.indexOf(b)&&d!==b&&!this._isSelectionKeyPressed(a)||b&&!b.evented||b&&!b.selectable&&d&&d!==b},_shouldCenterTransform:function(a,b,c){var d;if(a)return"scale"===b||"scaleX"===b||"scaleY"===b||"resizing"===b?d=this.centeredScaling||a.centeredScaling:"rotate"===b&&(d=this.centeredRotation||a.centeredRotation),d?!c:c},_getOriginFromCorner:function(a,b){var c={x:a.originX,y:a.originY};return"ml"===b||"tl"===b||"bl"===b?c.x="right":("mr"===b||"tr"===b||"br"===b)&&(c.x="left"),"tl"===b||"mt"===b||"tr"===b?c.y="bottom":("bl"===b||"mb"===b||"br"===b)&&(c.y="top"),c},_getActionFromCorner:function(a,b,c,d){if(!b||!a)return"drag";var e=d.controls[b];return e.getActionName(c,e,d)},_setupCurrentTransform:function(a,b,c){if(b){var d=this.getPointer(a),e=b.__corner,f=b.controls[e],g=c&&e?f.getActionHandler(a,b,f):H.controlsUtils.dragHandler,h=this._getActionFromCorner(c,e,a,b),i=this._getOriginFromCorner(b,e),j=a[this.centeredKey],k={target:b,action:h,actionHandler:g,corner:e,scaleX:b.scaleX,scaleY:b.scaleY,skewX:b.skewX,skewY:b.skewY,offsetX:d.x-b.left,offsetY:d.y-b.top,originX:i.x,originY:i.y,ex:d.x,ey:d.y,lastX:d.x,lastY:d.y,theta:V(b.angle),width:b.width*b.scaleX,shiftKey:a.shiftKey,altKey:j,original:H.util.saveObjectTransform(b)};this._shouldCenterTransform(b,h,j)&&(k.originX="center",k.originY="center"),k.original.originX=i.x,k.original.originY=i.y,this._currentTransform=k,this._beforeTransform(a)}},setCursor:function(a){this.upperCanvasEl.style.cursor=a},_drawSelection:function(a){var b=this._groupSelector,c=new H.Point(b.ex,b.ey),d=H.util.transformPoint(c,this.viewportTransform),e=new H.Point(b.ex+b.left,b.ey+b.top),f=H.util.transformPoint(e,this.viewportTransform),g=Math.min(d.x,f.x),h=Math.min(d.y,f.y),i=Math.max(d.x,f.x),j=Math.max(d.y,f.y),k=this.selectionLineWidth/2;this.selectionColor&&(a.fillStyle=this.selectionColor,a.fillRect(g,h,i-g,j-h)),this.selectionLineWidth&&this.selectionBorderColor&&(a.lineWidth=this.selectionLineWidth,a.strokeStyle=this.selectionBorderColor,g+=k,h+=k,i-=k,j-=k,H.Object.prototype._setLineDash.call(this,a,this.selectionDashArray),a.strokeRect(g,h,i-g,j-h))},findTarget:function(a,b){if(!this.skipTargetFind){var c,d,e=this.getPointer(a,!0),f=this._activeObject,g=this.getActiveObjects(),h=W(a),i=g.length>1&&!b||1===g.length;if(this.targets=[],i&&f._findTargetCorner(e,h)||g.length>1&&!b&&f===this._searchPossibleTargets([f],e))return f;if(1===g.length&&f===this._searchPossibleTargets([f],e))if(!this.preserveObjectStacking)return f;else c=f,d=this.targets,this.targets=[];var j=this._searchPossibleTargets(this._objects,e);return a[this.altSelectionKey]&&j&&c&&j!==c&&(j=c,this.targets=d),j}},_checkTarget:function(a,b,c){if(b&&b.visible&&b.evented&&b.containsPoint(a)){if(!this.perPixelTargetFind&&!b.perPixelTargetFind||b.isEditing)return!0;else if(!this.isTargetTransparent(b,c.x,c.y))return!0}},_searchPossibleTargets:function(a,b){for(var c,d,e=a.length;e--;){var f=a[e],g=f.group?this._normalizePointer(f.group,b):b;if(this._checkTarget(g,f,b)){(c=a[e]).subTargetCheck&&c instanceof H.Group&&(d=this._searchPossibleTargets(c._objects,b))&&this.targets.push(d);break}}return c},restorePointerVpt:function(a){return H.util.transformPoint(a,H.util.invertTransform(this.viewportTransform))},getPointer:function(a,b){if(this._absolutePointer&&!b)return this._absolutePointer;if(this._pointer&&b)return this._pointer;var c,d=U(a),e=this.upperCanvasEl,f=e.getBoundingClientRect(),g=f.width||0,h=f.height||0;(!g||!h)&&("top"in f&&"bottom"in f&&(h=Math.abs(f.top-f.bottom)),"right"in f&&"left"in f&&(g=Math.abs(f.right-f.left))),this.calcOffset(),d.x=d.x-this._offset.left,d.y=d.y-this._offset.top,b||(d=this.restorePointerVpt(d));var i=this.getRetinaScaling();return 1!==i&&(d.x/=i,d.y/=i),c=0===g||0===h?{width:1,height:1}:{width:e.width/g,height:e.height/h},{x:d.x*c.width,y:d.y*c.height}},_createUpperCanvas:function(){var a=this.lowerCanvasEl.className.replace(/\s*lower-canvas\s*/,""),b=this.lowerCanvasEl,c=this.upperCanvasEl;c?c.className="":(c=this._createCanvasElement(),this.upperCanvasEl=c),H.util.addClass(c,"upper-canvas "+a),this.wrapperEl.appendChild(c),this._copyCanvasStyle(b,c),this._applyCanvasStyle(c),this.contextTop=c.getContext("2d")},getTopContext:function(){return this.contextTop},_createCacheCanvas:function(){this.cacheCanvasEl=this._createCanvasElement(),this.cacheCanvasEl.setAttribute("width",this.width),this.cacheCanvasEl.setAttribute("height",this.height),this.contextCache=this.cacheCanvasEl.getContext("2d")},_initWrapperElement:function(){this.wrapperEl=H.util.wrapElement(this.lowerCanvasEl,"div",{class:this.containerClass}),H.util.setStyle(this.wrapperEl,{width:this.width+"px",height:this.height+"px",position:"relative"}),H.util.makeElementUnselectable(this.wrapperEl)},_applyCanvasStyle:function(a){var b=this.width||a.width,c=this.height||a.height;H.util.setStyle(a,{position:"absolute",width:b+"px",height:c+"px",left:0,top:0,"touch-action":this.allowTouchScrolling?"manipulation":"none","-ms-touch-action":this.allowTouchScrolling?"manipulation":"none"}),a.width=b,a.height=c,H.util.makeElementUnselectable(a)},_copyCanvasStyle:function(a,b){b.style.cssText=a.style.cssText},getSelectionContext:function(){return this.contextTop},getSelectionElement:function(){return this.upperCanvasEl},getActiveObject:function(){return this._activeObject},getActiveObjects:function(){var a=this._activeObject;if(a)if("activeSelection"===a.type&&a._objects)return a._objects.slice(0);else return[a];return[]},_onObjectRemoved:function(a){a===this._activeObject&&(this.fire("before:selection:cleared",{target:a}),this._discardActiveObject(),this.fire("selection:cleared",{target:a}),a.fire("deselected")),a===this._hoveredTarget&&(this._hoveredTarget=null,this._hoveredTargets=[]),this.callSuper("_onObjectRemoved",a)},_fireSelectionEvents:function(a,b){var c=!1,d=this.getActiveObjects(),e=[],f=[];a.forEach(function(a){-1===d.indexOf(a)&&(c=!0,a.fire("deselected",{e:b,target:a}),f.push(a))}),d.forEach(function(d){-1===a.indexOf(d)&&(c=!0,d.fire("selected",{e:b,target:d}),e.push(d))}),a.length>0&&d.length>0?c&&this.fire("selection:updated",{e:b,selected:e,deselected:f}):d.length>0?this.fire("selection:created",{e:b,selected:e}):a.length>0&&this.fire("selection:cleared",{e:b,deselected:f})},setActiveObject:function(a,b){var c=this.getActiveObjects();return this._setActiveObject(a,b),this._fireSelectionEvents(c,b),this},_setActiveObject:function(a,b){return!(this._activeObject===a||!this._discardActiveObject(b,a)||a.onSelect({e:b}))&&(this._activeObject=a,!0)},_discardActiveObject:function(a,b){var c=this._activeObject;if(c){if(c.onDeselect({e:a,object:b}))return!1;this._activeObject=null}return!0},discardActiveObject:function(a){var b=this.getActiveObjects(),c=this.getActiveObject();return b.length&&this.fire("before:selection:cleared",{target:c,e:a}),this._discardActiveObject(a),this._fireSelectionEvents(b,a),this},dispose:function(){var a=this.wrapperEl;return this.removeListeners(),a.removeChild(this.upperCanvasEl),a.removeChild(this.lowerCanvasEl),this.contextCache=null,this.contextTop=null,["upperCanvasEl","cacheCanvasEl"].forEach((function(a){H.util.cleanUpJsdomNode(this[a]),this[a]=void 0}).bind(this)),a.parentNode&&a.parentNode.replaceChild(this.lowerCanvasEl,this.wrapperEl),delete this.wrapperEl,H.StaticCanvas.prototype.dispose.call(this),this},clear:function(){return this.discardActiveObject(),this.clearContext(this.contextTop),this.callSuper("clear")},drawControls:function(a){var b=this._activeObject;b&&b._renderControls(a)},_toObject:function(a,b,c){var d=this._realizeGroupTransformOnObject(a),e=this.callSuper("_toObject",a,b,c);return this._unwindGroupTransformOnObject(a,d),e},_realizeGroupTransformOnObject:function(a){if(!a.group||"activeSelection"!==a.group.type||this._activeObject!==a.group)return null;var b={};return["angle","flipX","flipY","left","scaleX","scaleY","skewX","skewY","top"].forEach(function(c){b[c]=a[c]}),H.util.addTransformToObject(a,this._activeObject.calcOwnMatrix()),b},_unwindGroupTransformOnObject:function(a,b){b&&a.set(b)},_setSVGObject:function(a,b,c){var d=this._realizeGroupTransformOnObject(b);this.callSuper("_setSVGObject",a,b,c),this._unwindGroupTransformOnObject(b,d)},setViewportTransform:function(a){this.renderOnAddRemove&&this._activeObject&&this._activeObject.isEditing&&this._activeObject.clearContextTop(),H.StaticCanvas.prototype.setViewportTransform.call(this,a)}}),H.StaticCanvas)"prototype"!==X&&(H.Canvas[X]=H.StaticCanvas[X]);var Y=H.util.addListener,Z=H.util.removeListener,$={passive:!1};function _(a,b){return a.button&&a.button===b-1}function aa(a,b){if(!b)return a+": none; ";if(b.toLive)return a+": url(#SVGID_"+b.id+"); ";var c=new H.Color(b),d=a+": "+c.toRgb()+"; ",e=c.getAlpha();return 1!==e&&(d+=a+"-opacity: "+e.toString()+"; "),d}H.util.object.extend(H.Canvas.prototype,{mainTouchId:null,_initEventListeners:function(){this.removeListeners(),this._bindEvents(),this.addOrRemove(Y,"add")},_getEventPrefix:function(){return this.enablePointerEvents?"pointer":"mouse"},addOrRemove:function(a,b){var c=this.upperCanvasEl,d=this._getEventPrefix();a(H.window,"resize",this._onResize),a(c,d+"down",this._onMouseDown),a(c,d+"move",this._onMouseMove,$),a(c,d+"out",this._onMouseOut),a(c,d+"enter",this._onMouseEnter),a(c,"wheel",this._onMouseWheel),a(c,"contextmenu",this._onContextMenu),a(c,"dblclick",this._onDoubleClick),a(c,"dragover",this._onDragOver),a(c,"dragenter",this._onDragEnter),a(c,"dragleave",this._onDragLeave),a(c,"drop",this._onDrop),this.enablePointerEvents||a(c,"touchstart",this._onTouchStart,$),"u">typeof eventjs&&b in eventjs&&(eventjs[b](c,"gesture",this._onGesture),eventjs[b](c,"drag",this._onDrag),eventjs[b](c,"orientation",this._onOrientationChange),eventjs[b](c,"shake",this._onShake),eventjs[b](c,"longpress",this._onLongPress))},removeListeners:function(){this.addOrRemove(Z,"remove");var a=this._getEventPrefix();Z(H.document,a+"up",this._onMouseUp),Z(H.document,"touchend",this._onTouchEnd,$),Z(H.document,a+"move",this._onMouseMove,$),Z(H.document,"touchmove",this._onMouseMove,$)},_bindEvents:function(){this.eventsBound||(this._onMouseDown=this._onMouseDown.bind(this),this._onTouchStart=this._onTouchStart.bind(this),this._onMouseMove=this._onMouseMove.bind(this),this._onMouseUp=this._onMouseUp.bind(this),this._onTouchEnd=this._onTouchEnd.bind(this),this._onResize=this._onResize.bind(this),this._onGesture=this._onGesture.bind(this),this._onDrag=this._onDrag.bind(this),this._onShake=this._onShake.bind(this),this._onLongPress=this._onLongPress.bind(this),this._onOrientationChange=this._onOrientationChange.bind(this),this._onMouseWheel=this._onMouseWheel.bind(this),this._onMouseOut=this._onMouseOut.bind(this),this._onMouseEnter=this._onMouseEnter.bind(this),this._onContextMenu=this._onContextMenu.bind(this),this._onDoubleClick=this._onDoubleClick.bind(this),this._onDragOver=this._onDragOver.bind(this),this._onDragEnter=this._simpleEventHandler.bind(this,"dragenter"),this._onDragLeave=this._simpleEventHandler.bind(this,"dragleave"),this._onDrop=this._onDrop.bind(this),this.eventsBound=!0)},_onGesture:function(a,b){this.__onTransformGesture&&this.__onTransformGesture(a,b)},_onDrag:function(a,b){this.__onDrag&&this.__onDrag(a,b)},_onMouseWheel:function(a){this.__onMouseWheel(a)},_onMouseOut:function(a){var b=this._hoveredTarget;this.fire("mouse:out",{target:b,e:a}),this._hoveredTarget=null,b&&b.fire("mouseout",{e:a});var c=this;this._hoveredTargets.forEach(function(b){c.fire("mouse:out",{target:b,e:a}),b&&b.fire("mouseout",{e:a})}),this._hoveredTargets=[]},_onMouseEnter:function(a){this._currentTransform||this.findTarget(a)||(this.fire("mouse:over",{target:null,e:a}),this._hoveredTarget=null,this._hoveredTargets=[])},_onOrientationChange:function(a,b){this.__onOrientationChange&&this.__onOrientationChange(a,b)},_onShake:function(a,b){this.__onShake&&this.__onShake(a,b)},_onLongPress:function(a,b){this.__onLongPress&&this.__onLongPress(a,b)},_onDragOver:function(a){a.preventDefault();var b=this._simpleEventHandler("dragover",a);this._fireEnterLeaveEvents(b,a)},_onDrop:function(a){return this._simpleEventHandler("drop:before",a),this._simpleEventHandler("drop",a)},_onContextMenu:function(a){return this.stopContextMenu&&(a.stopPropagation(),a.preventDefault()),!1},_onDoubleClick:function(a){this._cacheTransformEventData(a),this._handleEvent(a,"dblclick"),this._resetTransformEventData(a)},getPointerId:function(a){var b=a.changedTouches;return b?b[0]&&b[0].identifier:this.enablePointerEvents?a.pointerId:-1},_isMainEvent:function(a){return!0===a.isPrimary||!1!==a.isPrimary&&("touchend"===a.type&&0===a.touches.length||!a.changedTouches||a.changedTouches[0].identifier===this.mainTouchId)},_onTouchStart:function(a){a.preventDefault(),null===this.mainTouchId&&(this.mainTouchId=this.getPointerId(a)),this.__onMouseDown(a),this._resetTransformEventData();var b=this.upperCanvasEl,c=this._getEventPrefix();Y(H.document,"touchend",this._onTouchEnd,$),Y(H.document,"touchmove",this._onMouseMove,$),Z(b,c+"down",this._onMouseDown)},_onMouseDown:function(a){this.__onMouseDown(a),this._resetTransformEventData();var b=this.upperCanvasEl,c=this._getEventPrefix();Z(b,c+"move",this._onMouseMove,$),Y(H.document,c+"up",this._onMouseUp),Y(H.document,c+"move",this._onMouseMove,$)},_onTouchEnd:function(a){if(!(a.touches.length>0)){this.__onMouseUp(a),this._resetTransformEventData(),this.mainTouchId=null;var b=this._getEventPrefix();Z(H.document,"touchend",this._onTouchEnd,$),Z(H.document,"touchmove",this._onMouseMove,$);var c=this;this._willAddMouseDown&&clearTimeout(this._willAddMouseDown),this._willAddMouseDown=setTimeout(function(){Y(c.upperCanvasEl,b+"down",c._onMouseDown),c._willAddMouseDown=0},400)}},_onMouseUp:function(a){this.__onMouseUp(a),this._resetTransformEventData();var b=this.upperCanvasEl,c=this._getEventPrefix();this._isMainEvent(a)&&(Z(H.document,c+"up",this._onMouseUp),Z(H.document,c+"move",this._onMouseMove,$),Y(b,c+"move",this._onMouseMove,$))},_onMouseMove:function(a){!this.allowTouchScrolling&&a.preventDefault&&a.preventDefault(),this.__onMouseMove(a)},_onResize:function(){this.calcOffset()},_shouldRender:function(a){var b=this._activeObject;return!!b!=!!a||!!b&&!!a&&b!==a||(b&&b.isEditing,!1)},__onMouseUp:function(a){var b,c,d,e=this._currentTransform,f=this._groupSelector,g=!1,h=!f||0===f.left&&0===f.top;if(this._cacheTransformEventData(a),d=this._target,this._handleEvent(a,"up:before"),_(a,3)){this.fireRightClick&&this._handleEvent(a,"up",3,h);return}if(_(a,2)){this.fireMiddleClick&&this._handleEvent(a,"up",2,h),this._resetTransformEventData();return}if(this.isDrawingMode&&this._isCurrentlyDrawing)return void this._onMouseUpInDrawingMode(a);if(this._isMainEvent(a)){if(e&&(this._finalizeCurrentTransform(a),g=e.actionPerformed),!h){var i=d===this._activeObject;this._maybeGroupObjects(a),g||(g=this._shouldRender(d)||!i&&d===this._activeObject)}if(d){if(b=d._findTargetCorner(this.getPointer(a,!0),H.util.isTouchEvent(a)),d.selectable&&d!==this._activeObject&&"up"===d.activeOn)this.setActiveObject(d,a),g=!0;else{var j=d.controls[b],k=j&&j.getMouseUpHandler(a,d,j);k&&(c=this.getPointer(a),k(a,e,c.x,c.y))}d.isMoving=!1}if(e&&(e.target!==d||e.corner!==b)){var l=e.target&&e.target.controls[e.corner],m=l&&l.getMouseUpHandler(a,d,j);c=c||this.getPointer(a),m&&m(a,e,c.x,c.y)}this._setCursorFromEvent(a,d),this._handleEvent(a,"up",1,h),this._groupSelector=null,this._currentTransform=null,d&&(d.__corner=0),g?this.requestRenderAll():h||this.renderTop()}},_simpleEventHandler:function(a,b){var c=this.findTarget(b),d=this.targets,e={e:b,target:c,subTargets:d};if(this.fire(a,e),c&&c.fire(a,e),!d)return c;for(var f=0;f<d.length;f++)d[f].fire(a,e);return c},_handleEvent:function(a,b,c,d){var e=this._target,f=this.targets||[],g={e:a,target:e,subTargets:f,button:c||1,isClick:d||!1,pointer:this._pointer,absolutePointer:this._absolutePointer,transform:this._currentTransform};"up"===b&&(g.currentTarget=this.findTarget(a),g.currentSubTargets=this.targets),this.fire("mouse:"+b,g),e&&e.fire("mouse"+b,g);for(var h=0;h<f.length;h++)f[h].fire("mouse"+b,g)},_finalizeCurrentTransform:function(a){var b=this._currentTransform,c=b.target,d={e:a,target:c,transform:b,action:b.action};c._scaling&&(c._scaling=!1),c.setCoords(),(b.actionPerformed||this.stateful&&c.hasStateChanged())&&this._fire("modified",d)},_onMouseDownInDrawingMode:function(a){this._isCurrentlyDrawing=!0,this.getActiveObject()&&this.discardActiveObject(a).requestRenderAll();var b=this.getPointer(a);this.freeDrawingBrush.onMouseDown(b,{e:a,pointer:b}),this._handleEvent(a,"down")},_onMouseMoveInDrawingMode:function(a){if(this._isCurrentlyDrawing){var b=this.getPointer(a);this.freeDrawingBrush.onMouseMove(b,{e:a,pointer:b})}this.setCursor(this.freeDrawingCursor),this._handleEvent(a,"move")},_onMouseUpInDrawingMode:function(a){var b=this.getPointer(a);this._isCurrentlyDrawing=this.freeDrawingBrush.onMouseUp({e:a,pointer:b}),this._handleEvent(a,"up")},__onMouseDown:function(a){this._cacheTransformEventData(a),this._handleEvent(a,"down:before");var b=this._target;if(_(a,3)){this.fireRightClick&&this._handleEvent(a,"down",3);return}if(_(a,2)){this.fireMiddleClick&&this._handleEvent(a,"down",2);return}if(this.isDrawingMode)return void this._onMouseDownInDrawingMode(a);if(this._isMainEvent(a)&&!this._currentTransform){var c=this._pointer;this._previousPointer=c;var d=this._shouldRender(b),e=this._shouldGroup(a,b);if(this._shouldClearSelection(a,b)?this.discardActiveObject(a):e&&(this._handleGrouping(a,b),b=this._activeObject),!this.selection||b&&(b.selectable||b.isEditing||b===this._activeObject)||(this._groupSelector={ex:this._absolutePointer.x,ey:this._absolutePointer.y,top:0,left:0}),b){var f=b===this._activeObject;b.selectable&&"down"===b.activeOn&&this.setActiveObject(b,a);var g=b._findTargetCorner(this.getPointer(a,!0),H.util.isTouchEvent(a));if(b.__corner=g,b===this._activeObject&&(g||!e)){this._setupCurrentTransform(a,b,f);var h=b.controls[g],c=this.getPointer(a),i=h&&h.getMouseDownHandler(a,b,h);i&&i(a,this._currentTransform,c.x,c.y)}}this._handleEvent(a,"down"),(d||e)&&this.requestRenderAll()}},_resetTransformEventData:function(){this._target=null,this._pointer=null,this._absolutePointer=null},_cacheTransformEventData:function(a){this._resetTransformEventData(),this._pointer=this.getPointer(a,!0),this._absolutePointer=this.restorePointerVpt(this._pointer),this._target=this._currentTransform?this._currentTransform.target:this.findTarget(a)||null},_beforeTransform:function(a){var b=this._currentTransform;this.stateful&&b.target.saveState(),this.fire("before:transform",{e:a,transform:b})},__onMouseMove:function(a){if(this._handleEvent(a,"move:before"),this._cacheTransformEventData(a),this.isDrawingMode)return void this._onMouseMoveInDrawingMode(a);if(this._isMainEvent(a)){var b,c,d=this._groupSelector;d?(d.left=(c=this._absolutePointer).x-d.ex,d.top=c.y-d.ey,this.renderTop()):this._currentTransform?this._transformObject(a):(b=this.findTarget(a)||null,this._setCursorFromEvent(a,b),this._fireOverOutEvents(b,a)),this._handleEvent(a,"move"),this._resetTransformEventData()}},_fireOverOutEvents:function(a,b){var c=this._hoveredTarget,d=this._hoveredTargets,e=this.targets,f=Math.max(d.length,e.length);this.fireSyntheticInOutEvents(a,b,{oldTarget:c,evtOut:"mouseout",canvasEvtOut:"mouse:out",evtIn:"mouseover",canvasEvtIn:"mouse:over"});for(var g=0;g<f;g++)this.fireSyntheticInOutEvents(e[g],b,{oldTarget:d[g],evtOut:"mouseout",evtIn:"mouseover"});this._hoveredTarget=a,this._hoveredTargets=this.targets.concat()},_fireEnterLeaveEvents:function(a,b){var c=this._draggedoverTarget,d=this._hoveredTargets,e=this.targets,f=Math.max(d.length,e.length);this.fireSyntheticInOutEvents(a,b,{oldTarget:c,evtOut:"dragleave",evtIn:"dragenter"});for(var g=0;g<f;g++)this.fireSyntheticInOutEvents(e[g],b,{oldTarget:d[g],evtOut:"dragleave",evtIn:"dragenter"});this._draggedoverTarget=a},fireSyntheticInOutEvents:function(a,b,c){var d,e,f,g=c.oldTarget,h=g!==a,i=c.canvasEvtIn,j=c.canvasEvtOut;h&&(d={e:b,target:a,previousTarget:g},e={e:b,target:g,nextTarget:a}),f=a&&h,g&&h&&(j&&this.fire(j,e),g.fire(c.evtOut,e)),f&&(i&&this.fire(i,d),a.fire(c.evtIn,d))},__onMouseWheel:function(a){this._cacheTransformEventData(a),this._handleEvent(a,"wheel"),this._resetTransformEventData()},_transformObject:function(a){var b=this.getPointer(a),c=this._currentTransform;c.reset=!1,c.shiftKey=a.shiftKey,c.altKey=a[this.centeredKey],this._performTransformAction(a,c,b),c.actionPerformed&&this.requestRenderAll()},_performTransformAction:function(a,b,c){var d=c.x,e=c.y,f=b.action,g=!1,h=b.actionHandler;h&&(g=h(a,b,d,e)),"drag"===f&&g&&(b.target.isMoving=!0,this.setCursor(b.target.moveCursor||this.moveCursor)),b.actionPerformed=b.actionPerformed||g},_fire:H.controlsUtils.fireEvent,_setCursorFromEvent:function(a,b){if(!b)return this.setCursor(this.defaultCursor),!1;var c=b.hoverCursor||this.hoverCursor,d=this._activeObject&&"activeSelection"===this._activeObject.type?this._activeObject:null,e=(!d||!d.contains(b))&&b._findTargetCorner(this.getPointer(a,!0));e?this.setCursor(this.getCornerCursor(e,b,a)):(b.subTargetCheck&&this.targets.concat().reverse().map(function(a){c=a.hoverCursor||c}),this.setCursor(c))},getCornerCursor:function(a,b,c){var d=b.controls[a];return d.cursorStyleHandler(c,d,b)}}),r=Math.min,s=Math.max,H.util.object.extend(H.Canvas.prototype,{_shouldGroup:function(a,b){var c=this._activeObject;return c&&this._isSelectionKeyPressed(a)&&b&&b.selectable&&this.selection&&(c!==b||"activeSelection"===c.type)&&!b.onSelect({e:a})},_handleGrouping:function(a,b){var c=this._activeObject;if(!c.__corner){if(b===c&&(!(b=this.findTarget(a,!0))||!b.selectable))return;c&&"activeSelection"===c.type?this._updateActiveSelection(b,a):this._createActiveSelection(b,a)}},_updateActiveSelection:function(a,b){var c=this._activeObject,d=c._objects.slice(0);c.contains(a)?(c.removeWithUpdate(a),this._hoveredTarget=a,this._hoveredTargets=this.targets.concat(),1===c.size()&&this._setActiveObject(c.item(0),b)):(c.addWithUpdate(a),this._hoveredTarget=c,this._hoveredTargets=this.targets.concat()),this._fireSelectionEvents(d,b)},_createActiveSelection:function(a,b){var c=this.getActiveObjects(),d=this._createGroup(a);this._hoveredTarget=d,this._setActiveObject(d,b),this._fireSelectionEvents(c,b)},_createGroup:function(a){var b=this._objects,c=b.indexOf(this._activeObject)<b.indexOf(a)?[this._activeObject,a]:[a,this._activeObject];return this._activeObject.isEditing&&this._activeObject.exitEditing(),new H.ActiveSelection(c,{canvas:this})},_groupSelectedObjects:function(a){var b,c=this._collectObjects(a);1===c.length?this.setActiveObject(c[0],a):c.length>1&&(b=new H.ActiveSelection(c.reverse(),{canvas:this}),this.setActiveObject(b,a))},_collectObjects:function(a){for(var b,c=[],d=this._groupSelector.ex,e=this._groupSelector.ey,f=d+this._groupSelector.left,g=e+this._groupSelector.top,h=new H.Point(r(d,f),r(e,g)),i=new H.Point(s(d,f),s(e,g)),j=!this.selectionFullyContained,k=d===f&&e===g,l=this._objects.length;l--&&!((b=this._objects[l])&&b.selectable&&b.visible&&(j&&b.intersectsWithRect(h,i,!0)||b.isContainedWithinRect(h,i,!0)||j&&b.containsPoint(h,null,!0)||j&&b.containsPoint(i,null,!0))&&(c.push(b),k)););return c.length>1&&(c=c.filter(function(b){return!b.onSelect({e:a})})),c},_maybeGroupObjects:function(a){this.selection&&this._groupSelector&&this._groupSelectedObjects(a),this.setCursor(this.defaultCursor),this._groupSelector=null}}),H.util.object.extend(H.StaticCanvas.prototype,{toDataURL:function(a){a||(a={});var b=a.format||"png",c=a.quality||1,d=(a.multiplier||1)*(a.enableRetinaScaling?this.getRetinaScaling():1),e=this.toCanvasElement(d,a);return H.util.toDataURL(e,b,c)},toCanvasElement:function(a,b){a=a||1;var c=((b=b||{}).width||this.width)*a,d=(b.height||this.height)*a,e=this.getZoom(),f=this.width,g=this.height,h=e*a,i=this.viewportTransform,j=(i[4]-(b.left||0))*a,k=(i[5]-(b.top||0))*a,l=this.interactive,m=this.enableRetinaScaling,n=H.util.createCanvasElement(),o=this.contextTop;return n.width=c,n.height=d,this.contextTop=null,this.enableRetinaScaling=!1,this.interactive=!1,this.viewportTransform=[h,0,0,h,j,k],this.width=c,this.height=d,this.calcViewportBoundaries(),this.renderCanvas(n.getContext("2d"),this._objects),this.viewportTransform=i,this.width=f,this.height=g,this.calcViewportBoundaries(),this.interactive=l,this.enableRetinaScaling=m,this.contextTop=o,n}}),H.util.object.extend(H.StaticCanvas.prototype,{loadFromJSON:function(a,b,c){if(a){var d="string"==typeof a?JSON.parse(a):H.util.object.clone(a),e=this,f=d.clipPath,g=this.renderOnAddRemove;return this.renderOnAddRemove=!1,delete d.clipPath,this._enlivenObjects(d.objects,function(a){e.clear(),e._setBgOverlay(d,function(){f?e._enlivenObjects([f],function(c){e.clipPath=c[0],e.__setupCanvas.call(e,d,a,g,b)}):e.__setupCanvas.call(e,d,a,g,b)})},c),this}},__setupCanvas:function(a,b,c,d){var e=this;b.forEach(function(a,b){e.insertAt(a,b)}),this.renderOnAddRemove=c,delete a.objects,delete a.backgroundImage,delete a.overlayImage,delete a.background,delete a.overlay,this._setOptions(a),this.renderAll(),d&&d()},_setBgOverlay:function(a,b){var c={backgroundColor:!1,overlayColor:!1,backgroundImage:!1,overlayImage:!1};if(!a.backgroundImage&&!a.overlayImage&&!a.background&&!a.overlay){b&&b();return}var d=function(){c.backgroundImage&&c.overlayImage&&c.backgroundColor&&c.overlayColor&&b&&b()};this.__setBgOverlay("backgroundImage",a.backgroundImage,c,d),this.__setBgOverlay("overlayImage",a.overlayImage,c,d),this.__setBgOverlay("backgroundColor",a.background,c,d),this.__setBgOverlay("overlayColor",a.overlay,c,d)},__setBgOverlay:function(a,b,c,d){var e=this;if(!b){c[a]=!0,d&&d();return}"backgroundImage"===a||"overlayImage"===a?H.util.enlivenObjects([b],function(b){e[a]=b[0],c[a]=!0,d&&d()}):this["set"+H.util.string.capitalize(a,!0)](b,function(){c[a]=!0,d&&d()})},_enlivenObjects:function(a,b,c){if(!a||0===a.length){b&&b([]);return}H.util.enlivenObjects(a,function(a){b&&b(a)},null,c)},_toDataURL:function(a,b){this.clone(function(c){b(c.toDataURL(a))})},_toDataURLWithMultiplier:function(a,b,c){this.clone(function(d){c(d.toDataURLWithMultiplier(a,b))})},clone:function(a,b){var c=JSON.stringify(this.toJSON(b));this.cloneWithoutData(function(b){b.loadFromJSON(c,function(){a&&a(b)})})},cloneWithoutData:function(a){var b=H.util.createCanvasElement();b.width=this.width,b.height=this.height;var c=new H.Canvas(b);this.backgroundImage?(c.setBackgroundImage(this.backgroundImage.src,function(){c.renderAll(),a&&a(c)}),c.backgroundImageOpacity=this.backgroundImageOpacity,c.backgroundImageStretch=this.backgroundImageStretch):a&&a(c)}}),function(a){"use strict";var b=a.fabric||(a.fabric={}),c=b.util.object.extend,d=b.util.object.clone,e=b.util.toFixed,f=b.util.string.capitalize,g=b.util.degreesToRadians,h=!b.isLikelyNode;b.Object||(b.Object=b.util.createClass(b.CommonMethods,{type:"object",originX:"left",originY:"top",top:0,left:0,width:0,height:0,scaleX:1,scaleY:1,flipX:!1,flipY:!1,opacity:1,angle:0,skewX:0,skewY:0,cornerSize:13,touchCornerSize:24,transparentCorners:!0,hoverCursor:null,moveCursor:null,padding:0,borderColor:"rgb(178,204,255)",borderDashArray:null,cornerColor:"rgb(178,204,255)",cornerStrokeColor:null,cornerStyle:"rect",cornerDashArray:null,centeredScaling:!1,centeredRotation:!0,fill:"rgb(0,0,0)",fillRule:"nonzero",globalCompositeOperation:"source-over",backgroundColor:"",selectionBackgroundColor:"",stroke:null,strokeWidth:1,strokeDashArray:null,strokeDashOffset:0,strokeLineCap:"butt",strokeLineJoin:"miter",strokeMiterLimit:4,shadow:null,borderOpacityWhenMoving:.4,borderScaleFactor:1,minScaleLimit:0,selectable:!0,evented:!0,visible:!0,hasControls:!0,hasBorders:!0,perPixelTargetFind:!1,includeDefaultValues:!0,lockMovementX:!1,lockMovementY:!1,lockRotation:!1,lockScalingX:!1,lockScalingY:!1,lockSkewingX:!1,lockSkewingY:!1,lockScalingFlip:!1,excludeFromExport:!1,objectCaching:h,statefullCache:!1,noScaleCache:!0,strokeUniform:!1,dirty:!0,__corner:0,paintFirst:"fill",activeOn:"down",stateProperties:"top left width height scaleX scaleY flipX flipY originX originY transformMatrix stroke strokeWidth strokeDashArray strokeLineCap strokeDashOffset strokeLineJoin strokeMiterLimit angle opacity fill globalCompositeOperation shadow visible backgroundColor skewX skewY fillRule paintFirst clipPath strokeUniform".split(" "),cacheProperties:"fill stroke strokeWidth strokeDashArray width height paintFirst strokeUniform strokeLineCap strokeDashOffset strokeLineJoin strokeMiterLimit backgroundColor clipPath".split(" "),colorProperties:"fill stroke backgroundColor".split(" "),clipPath:void 0,inverted:!1,absolutePositioned:!1,initialize:function(a){a&&this.setOptions(a)},_createCacheCanvas:function(){this._cacheProperties={},this._cacheCanvas=b.util.createCanvasElement(),this._cacheContext=this._cacheCanvas.getContext("2d"),this._updateCacheCanvas(),this.dirty=!0},_limitCacheSize:function(a){var c=b.perfLimitSizeTotal,d=a.width,e=a.height,f=b.maxCacheSideLimit,g=b.minCacheSideLimit;if(d<=f&&e<=f&&d*e<=c)return d<g&&(a.width=g),e<g&&(a.height=g),a;var h=b.util.limitDimsByArea(d/e,c),i=b.util.capValue,j=i(g,h.x,f),k=i(g,h.y,f);return d>j&&(a.zoomX/=d/j,a.width=j,a.capped=!0),e>k&&(a.zoomY/=e/k,a.height=k,a.capped=!0),a},_getCacheCanvasDimensions:function(){var a=this.getTotalObjectScaling(),b=this._getTransformedDimensions(0,0),c=b.x*a.scaleX/this.scaleX,d=b.y*a.scaleY/this.scaleY;return{width:Math.ceil(c+2),height:Math.ceil(d+2),zoomX:a.scaleX,zoomY:a.scaleY,x:c,y:d}},_updateCacheCanvas:function(){var a=this.canvas;if(this.noScaleCache&&a&&a._currentTransform){var b=a._currentTransform.target,c=a._currentTransform.action;if(this===b&&c.slice&&"scale"===c.slice(0,5))return!1}var d,e,f=this._cacheCanvas,g=this._limitCacheSize(this._getCacheCanvasDimensions()),h=g.width,i=g.height,j=g.zoomX,k=g.zoomY,l=h!==this.cacheWidth||i!==this.cacheHeight,m=this.zoomX!==j||this.zoomY!==k;return(!!l||!!m)&&(l?(f.width=h,f.height=i):(this._cacheContext.setTransform(1,0,0,1,0,0),this._cacheContext.clearRect(0,0,f.width,f.height)),d=g.x/2,e=g.y/2,this.cacheTranslationX=Math.round(f.width/2-d)+d,this.cacheTranslationY=Math.round(f.height/2-e)+e,this.cacheWidth=h,this.cacheHeight=i,this._cacheContext.translate(this.cacheTranslationX,this.cacheTranslationY),this._cacheContext.scale(j,k),this.zoomX=j,this.zoomY=k,!0)},setOptions:function(a){this._setOptions(a),this._initGradient(a.fill,"fill"),this._initGradient(a.stroke,"stroke"),this._initPattern(a.fill,"fill"),this._initPattern(a.stroke,"stroke")},transform:function(a){var b=this.group&&!this.group._transformDone||this.group&&this.canvas&&a===this.canvas.contextTop,c=this.calcTransformMatrix(!b);a.transform(c[0],c[1],c[2],c[3],c[4],c[5])},toObject:function(a){var c=b.Object.NUM_FRACTION_DIGITS,d={type:this.type,version:b.version,originX:this.originX,originY:this.originY,left:e(this.left,c),top:e(this.top,c),width:e(this.width,c),height:e(this.height,c),fill:this.fill&&this.fill.toObject?this.fill.toObject():this.fill,stroke:this.stroke&&this.stroke.toObject?this.stroke.toObject():this.stroke,strokeWidth:e(this.strokeWidth,c),strokeDashArray:this.strokeDashArray?this.strokeDashArray.concat():this.strokeDashArray,strokeLineCap:this.strokeLineCap,strokeDashOffset:this.strokeDashOffset,strokeLineJoin:this.strokeLineJoin,strokeUniform:this.strokeUniform,strokeMiterLimit:e(this.strokeMiterLimit,c),scaleX:e(this.scaleX,c),scaleY:e(this.scaleY,c),angle:e(this.angle,c),flipX:this.flipX,flipY:this.flipY,opacity:e(this.opacity,c),shadow:this.shadow&&this.shadow.toObject?this.shadow.toObject():this.shadow,visible:this.visible,backgroundColor:this.backgroundColor,fillRule:this.fillRule,paintFirst:this.paintFirst,globalCompositeOperation:this.globalCompositeOperation,skewX:e(this.skewX,c),skewY:e(this.skewY,c)};return this.clipPath&&!this.clipPath.excludeFromExport&&(d.clipPath=this.clipPath.toObject(a),d.clipPath.inverted=this.clipPath.inverted,d.clipPath.absolutePositioned=this.clipPath.absolutePositioned),b.util.populateWithProperties(this,d,a),this.includeDefaultValues||(d=this._removeDefaultValues(d)),d},toDatalessObject:function(a){return this.toObject(a)},_removeDefaultValues:function(a){var c=b.util.getKlass(a.type).prototype;return c.stateProperties.forEach(function(b){"left"!==b&&"top"!==b&&(a[b]===c[b]&&delete a[b],Array.isArray(a[b])&&Array.isArray(c[b])&&0===a[b].length&&0===c[b].length&&delete a[b])}),a},toString:function(){return"#<fabric."+f(this.type)+">"},getObjectScaling:function(){if(!this.group)return{scaleX:this.scaleX,scaleY:this.scaleY};var a=b.util.qrDecompose(this.calcTransformMatrix());return{scaleX:Math.abs(a.scaleX),scaleY:Math.abs(a.scaleY)}},getTotalObjectScaling:function(){var a=this.getObjectScaling(),b=a.scaleX,c=a.scaleY;if(this.canvas){var d=this.canvas.getZoom(),e=this.canvas.getRetinaScaling();b*=d*e,c*=d*e}return{scaleX:b,scaleY:c}},getObjectOpacity:function(){var a=this.opacity;return this.group&&(a*=this.group.getObjectOpacity()),a},_set:function(a,c){var d="scaleX"===a||"scaleY"===a,e=this[a]!==c,f=!1;return d&&(c=this._constrainScale(c)),"scaleX"===a&&c<0?(this.flipX=!this.flipX,c*=-1):"scaleY"===a&&c<0?(this.flipY=!this.flipY,c*=-1):"shadow"!==a||!c||c instanceof b.Shadow?"dirty"===a&&this.group&&this.group.set("dirty",c):c=new b.Shadow(c),this[a]=c,e&&(f=this.group&&this.group.isOnACache(),this.cacheProperties.indexOf(a)>-1?(this.dirty=!0,f&&this.group.set("dirty",!0)):f&&this.stateProperties.indexOf(a)>-1&&this.group.set("dirty",!0)),this},setOnGroup:function(){},getViewportTransform:function(){return this.canvas&&this.canvas.viewportTransform?this.canvas.viewportTransform:b.iMatrix.concat()},isNotVisible:function(){return 0===this.opacity||!this.width&&!this.height&&0===this.strokeWidth||!this.visible},render:function(a){this.isNotVisible()||(!this.canvas||!this.canvas.skipOffscreen||this.group||this.isOnScreen())&&(a.save(),this._setupCompositeOperation(a),this.drawSelectionBackground(a),this.transform(a),this._setOpacity(a),this._setShadow(a,this),this.shouldCache()?(this.renderCache(),this.drawCacheOnCanvas(a)):(this._removeCacheCanvas(),this.dirty=!1,this.drawObject(a),this.objectCaching&&this.statefullCache&&this.saveState({propertySet:"cacheProperties"})),a.restore())},renderCache:function(a){a=a||{},this._cacheCanvas&&this._cacheContext||this._createCacheCanvas(),this.isCacheDirty()&&(this.statefullCache&&this.saveState({propertySet:"cacheProperties"}),this.drawObject(this._cacheContext,a.forClipping),this.dirty=!1)},_removeCacheCanvas:function(){this._cacheCanvas=null,this._cacheContext=null,this.cacheWidth=0,this.cacheHeight=0},hasStroke:function(){return this.stroke&&"transparent"!==this.stroke&&0!==this.strokeWidth},hasFill:function(){return this.fill&&"transparent"!==this.fill},needsItsOwnCache:function(){return!!("stroke"===this.paintFirst&&this.hasFill()&&this.hasStroke())&&"object"==typeof this.shadow||!!this.clipPath},shouldCache:function(){return this.ownCaching=this.needsItsOwnCache()||this.objectCaching&&(!this.group||!this.group.isOnACache()),this.ownCaching},willDrawShadow:function(){return!!this.shadow&&(0!==this.shadow.offsetX||0!==this.shadow.offsetY)},drawClipPathOnCache:function(a,c){if(a.save(),c.inverted?a.globalCompositeOperation="destination-out":a.globalCompositeOperation="destination-in",c.absolutePositioned){var d=b.util.invertTransform(this.calcTransformMatrix());a.transform(d[0],d[1],d[2],d[3],d[4],d[5])}c.transform(a),a.scale(1/c.zoomX,1/c.zoomY),a.drawImage(c._cacheCanvas,-c.cacheTranslationX,-c.cacheTranslationY),a.restore()},drawObject:function(a,b){var c=this.fill,d=this.stroke;b?(this.fill="black",this.stroke="",this._setClippingProperties(a)):this._renderBackground(a),this._render(a),this._drawClipPath(a,this.clipPath),this.fill=c,this.stroke=d},_drawClipPath:function(a,b){b&&(b.canvas=this.canvas,b.shouldCache(),b._transformDone=!0,b.renderCache({forClipping:!0}),this.drawClipPathOnCache(a,b))},drawCacheOnCanvas:function(a){a.scale(1/this.zoomX,1/this.zoomY),a.drawImage(this._cacheCanvas,-this.cacheTranslationX,-this.cacheTranslationY)},isCacheDirty:function(a){if(this.isNotVisible())return!1;if(this._cacheCanvas&&this._cacheContext&&!a&&this._updateCacheCanvas())return!0;if(this.dirty||this.clipPath&&this.clipPath.absolutePositioned||this.statefullCache&&this.hasStateChanged("cacheProperties")){if(this._cacheCanvas&&this._cacheContext&&!a){var b=this.cacheWidth/this.zoomX,c=this.cacheHeight/this.zoomY;this._cacheContext.clearRect(-b/2,-c/2,b,c)}return!0}return!1},_renderBackground:function(a){if(this.backgroundColor){var b=this._getNonTransformedDimensions();a.fillStyle=this.backgroundColor,a.fillRect(-b.x/2,-b.y/2,b.x,b.y),this._removeShadow(a)}},_setOpacity:function(a){this.group&&!this.group._transformDone?a.globalAlpha=this.getObjectOpacity():a.globalAlpha*=this.opacity},_setStrokeStyles:function(a,b){var c=b.stroke;c&&(a.lineWidth=b.strokeWidth,a.lineCap=b.strokeLineCap,a.lineDashOffset=b.strokeDashOffset,a.lineJoin=b.strokeLineJoin,a.miterLimit=b.strokeMiterLimit,c.toLive?"percentage"===c.gradientUnits||c.gradientTransform||c.patternTransform?this._applyPatternForTransformedGradient(a,c):(a.strokeStyle=c.toLive(a,this),this._applyPatternGradientTransform(a,c)):a.strokeStyle=b.stroke)},_setFillStyles:function(a,b){var c=b.fill;c&&(c.toLive?(a.fillStyle=c.toLive(a,this),this._applyPatternGradientTransform(a,b.fill)):a.fillStyle=c)},_setClippingProperties:function(a){a.globalAlpha=1,a.strokeStyle="transparent",a.fillStyle="#000000"},_setLineDash:function(a,b){b&&0!==b.length&&(1&b.length&&b.push.apply(b,b),a.setLineDash(b))},_renderControls:function(a,c){var d,e,f,h=this.getViewportTransform(),i=this.calcTransformMatrix();e=void 0!==(c=c||{}).hasBorders?c.hasBorders:this.hasBorders,f=void 0!==c.hasControls?c.hasControls:this.hasControls,i=b.util.multiplyTransformMatrices(h,i),d=b.util.qrDecompose(i),a.save(),a.translate(d.translateX,d.translateY),a.lineWidth=+this.borderScaleFactor,this.group||(a.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1),this.flipX&&(d.angle-=180),a.rotate(g(this.group?d.angle:this.angle)),c.forActiveSelection||this.group?e&&this.drawBordersInGroup(a,d,c):e&&this.drawBorders(a,c),f&&this.drawControls(a,c),a.restore()},_setShadow:function(a){if(this.shadow){var c,d=this.shadow,e=this.canvas,f=e&&e.viewportTransform[0]||1,g=e&&e.viewportTransform[3]||1;c=d.nonScaling?{scaleX:1,scaleY:1}:this.getObjectScaling(),e&&e._isRetinaScaling()&&(f*=b.devicePixelRatio,g*=b.devicePixelRatio),a.shadowColor=d.color,a.shadowBlur=d.blur*b.browserShadowBlurConstant*(f+g)*(c.scaleX+c.scaleY)/4,a.shadowOffsetX=d.offsetX*f*c.scaleX,a.shadowOffsetY=d.offsetY*g*c.scaleY}},_removeShadow:function(a){this.shadow&&(a.shadowColor="",a.shadowBlur=a.shadowOffsetX=a.shadowOffsetY=0)},_applyPatternGradientTransform:function(a,b){if(!b||!b.toLive)return{offsetX:0,offsetY:0};var c=b.gradientTransform||b.patternTransform,d=-this.width/2+b.offsetX||0,e=-this.height/2+b.offsetY||0;return"percentage"===b.gradientUnits?a.transform(this.width,0,0,this.height,d,e):a.transform(1,0,0,1,d,e),c&&a.transform(c[0],c[1],c[2],c[3],c[4],c[5]),{offsetX:d,offsetY:e}},_renderPaintInOrder:function(a){"stroke"===this.paintFirst?(this._renderStroke(a),this._renderFill(a)):(this._renderFill(a),this._renderStroke(a))},_render:function(){},_renderFill:function(a){this.fill&&(a.save(),this._setFillStyles(a,this),"evenodd"===this.fillRule?a.fill("evenodd"):a.fill(),a.restore())},_renderStroke:function(a){if(this.stroke&&0!==this.strokeWidth){if(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(a),a.save(),this.strokeUniform&&this.group){var b=this.getObjectScaling();a.scale(1/b.scaleX,1/b.scaleY)}else this.strokeUniform&&a.scale(1/this.scaleX,1/this.scaleY);this._setLineDash(a,this.strokeDashArray),this._setStrokeStyles(a,this),a.stroke(),a.restore()}},_applyPatternForTransformedGradient:function(a,c){var d,e=this._limitCacheSize(this._getCacheCanvasDimensions()),f=b.util.createCanvasElement(),g=this.canvas.getRetinaScaling(),h=e.x/this.scaleX/g,i=e.y/this.scaleY/g;f.width=Math.ceil(h),f.height=Math.ceil(i),(d=f.getContext("2d")).beginPath(),d.moveTo(0,0),d.lineTo(h,0),d.lineTo(h,i),d.lineTo(0,i),d.closePath(),d.translate(h/2,i/2),d.scale(e.zoomX/this.scaleX/g,e.zoomY/this.scaleY/g),this._applyPatternGradientTransform(d,c),d.fillStyle=c.toLive(a),d.fill(),a.translate(-this.width/2-this.strokeWidth/2,-this.height/2-this.strokeWidth/2),a.scale(g*this.scaleX/e.zoomX,g*this.scaleY/e.zoomY),a.strokeStyle=d.createPattern(f,"no-repeat")},_findCenterFromElement:function(){return{x:this.left+this.width/2,y:this.top+this.height/2}},_assignTransformMatrixProps:function(){if(this.transformMatrix){var a=b.util.qrDecompose(this.transformMatrix);this.flipX=!1,this.flipY=!1,this.set("scaleX",a.scaleX),this.set("scaleY",a.scaleY),this.angle=a.angle,this.skewX=a.skewX,this.skewY=0}},_removeTransformMatrix:function(a){var c=this._findCenterFromElement();this.transformMatrix&&(this._assignTransformMatrixProps(),c=b.util.transformPoint(c,this.transformMatrix)),this.transformMatrix=null,a&&(this.scaleX*=a.scaleX,this.scaleY*=a.scaleY,this.cropX=a.cropX,this.cropY=a.cropY,c.x+=a.offsetLeft,c.y+=a.offsetTop,this.width=a.width,this.height=a.height),this.setPositionByOrigin(c,"center","center")},clone:function(a,c){var d=this.toObject(c);this.constructor.fromObject?this.constructor.fromObject(d,a):b.Object._fromObject("Object",d,a)},cloneAsImage:function(a,c){var d=this.toCanvasElement(c);return a&&a(new b.Image(d)),this},toCanvasElement:function(a){a||(a={});var c=b.util,d=c.saveObjectTransform(this),e=this.group,f=this.shadow,g=Math.abs,h=(a.multiplier||1)*(a.enableRetinaScaling?b.devicePixelRatio:1);delete this.group,a.withoutTransform&&c.resetObjectTransform(this),a.withoutShadow&&(this.shadow=null);var i,j,k,l,m=b.util.createCanvasElement(),n=this.getBoundingRect(!0,!0),o=this.shadow,p={x:0,y:0};o&&(j=o.blur,i=o.nonScaling?{scaleX:1,scaleY:1}:this.getObjectScaling(),p.x=2*Math.round(g(o.offsetX)+j)*g(i.scaleX),p.y=2*Math.round(g(o.offsetY)+j)*g(i.scaleY)),k=n.width+p.x,l=n.height+p.y,m.width=Math.ceil(k),m.height=Math.ceil(l);var q=new b.StaticCanvas(m,{enableRetinaScaling:!1,renderOnAddRemove:!1,skipOffscreen:!1});"jpeg"===a.format&&(q.backgroundColor="#fff"),this.setPositionByOrigin(new b.Point(q.width/2,q.height/2),"center","center");var r=this.canvas;q.add(this);var s=q.toCanvasElement(h||1,a);return this.shadow=f,this.set("canvas",r),e&&(this.group=e),this.set(d).setCoords(),q._objects=[],q.dispose(),q=null,s},toDataURL:function(a){return a||(a={}),b.util.toDataURL(this.toCanvasElement(a),a.format||"png",a.quality||1)},isType:function(a){return arguments.length>1?Array.from(arguments).includes(this.type):this.type===a},complexity:function(){return 1},toJSON:function(a){return this.toObject(a)},rotate:function(a){var b=("center"!==this.originX||"center"!==this.originY)&&this.centeredRotation;return b&&this._setOriginToCenter(),this.set("angle",a),b&&this._resetOrigin(),this},centerH:function(){return this.canvas&&this.canvas.centerObjectH(this),this},viewportCenterH:function(){return this.canvas&&this.canvas.viewportCenterObjectH(this),this},centerV:function(){return this.canvas&&this.canvas.centerObjectV(this),this},viewportCenterV:function(){return this.canvas&&this.canvas.viewportCenterObjectV(this),this},center:function(){return this.canvas&&this.canvas.centerObject(this),this},viewportCenter:function(){return this.canvas&&this.canvas.viewportCenterObject(this),this},getLocalPointer:function(a,c){c=c||this.canvas.getPointer(a);var d=new b.Point(c.x,c.y),e=this._getLeftTopCoords();return this.angle&&(d=b.util.rotatePoint(d,e,g(-this.angle))),{x:d.x-e.x,y:d.y-e.y}},_setupCompositeOperation:function(a){this.globalCompositeOperation&&(a.globalCompositeOperation=this.globalCompositeOperation)},dispose:function(){b.runningAnimations&&b.runningAnimations.cancelByTarget(this)}}),b.util.createAccessors&&b.util.createAccessors(b.Object),c(b.Object.prototype,b.Observable),b.Object.NUM_FRACTION_DIGITS=2,b.Object.ENLIVEN_PROPS=["clipPath"],b.Object._fromObject=function(a,c,e,f){var g=b[a];c=d(c,!0),b.util.enlivenPatterns([c.fill,c.stroke],function(a){void 0!==a[0]&&(c.fill=a[0]),void 0!==a[1]&&(c.stroke=a[1]),b.util.enlivenObjectEnlivables(c,c,function(){var a=f?new g(c[f],c):new g(c);e&&e(a)})})},b.Object.__uid=0)}(c),t=H.util.degreesToRadians,u={left:-.5,center:0,right:.5},v={top:-.5,center:0,bottom:.5},H.util.object.extend(H.Object.prototype,{translateToGivenOrigin:function(a,b,c,d,e){var f,g,h,i=a.x,j=a.y;return"string"==typeof b?b=u[b]:b-=.5,"string"==typeof d?d=u[d]:d-=.5,f=d-b,"string"==typeof c?c=v[c]:c-=.5,"string"==typeof e?e=v[e]:e-=.5,g=e-c,(f||g)&&(h=this._getTransformedDimensions(),i=a.x+f*h.x,j=a.y+g*h.y),new H.Point(i,j)},translateToCenterPoint:function(a,b,c){var d=this.translateToGivenOrigin(a,b,c,"center","center");return this.angle?H.util.rotatePoint(d,a,t(this.angle)):d},translateToOriginPoint:function(a,b,c){var d=this.translateToGivenOrigin(a,"center","center",b,c);return this.angle?H.util.rotatePoint(d,a,t(this.angle)):d},getCenterPoint:function(){var a=new H.Point(this.left,this.top);return this.translateToCenterPoint(a,this.originX,this.originY)},getPointByOrigin:function(a,b){var c=this.getCenterPoint();return this.translateToOriginPoint(c,a,b)},toLocalPoint:function(a,b,c){var d,e,f=this.getCenterPoint();return d=void 0!==b&&void 0!==c?this.translateToGivenOrigin(f,"center","center",b,c):new H.Point(this.left,this.top),e=new H.Point(a.x,a.y),this.angle&&(e=H.util.rotatePoint(e,f,-t(this.angle))),e.subtractEquals(d)},setPositionByOrigin:function(a,b,c){var d=this.translateToCenterPoint(a,b,c),e=this.translateToOriginPoint(d,this.originX,this.originY);this.set("left",e.x),this.set("top",e.y)},adjustPosition:function(a){var b,c,d=t(this.angle),e=this.getScaledWidth(),f=H.util.cos(d)*e,g=H.util.sin(d)*e;b="string"==typeof this.originX?u[this.originX]:this.originX-.5,c="string"==typeof a?u[a]:a-.5,this.left+=f*(c-b),this.top+=g*(c-b),this.setCoords(),this.originX=a},_setOriginToCenter:function(){this._originalOriginX=this.originX,this._originalOriginY=this.originY;var a=this.getCenterPoint();this.originX="center",this.originY="center",this.left=a.x,this.top=a.y},_resetOrigin:function(){var a=this.translateToOriginPoint(this.getCenterPoint(),this._originalOriginX,this._originalOriginY);this.originX=this._originalOriginX,this.originY=this._originalOriginY,this.left=a.x,this.top=a.y,this._originalOriginX=null,this._originalOriginY=null},_getLeftTopCoords:function(){return this.translateToOriginPoint(this.getCenterPoint(),"left","top")}}),x=(w=H.util).degreesToRadians,y=w.multiplyTransformMatrices,z=w.transformPoint,w.object.extend(H.Object.prototype,{oCoords:null,aCoords:null,lineCoords:null,ownMatrixCache:null,matrixCache:null,controls:{},_getCoords:function(a,b){return b?a?this.calcACoords():this.calcLineCoords():(this.aCoords&&this.lineCoords||this.setCoords(!0),a?this.aCoords:this.lineCoords)},getCoords:function(a,b){var c;return c=this._getCoords(a,b),[new H.Point(c.tl.x,c.tl.y),new H.Point(c.tr.x,c.tr.y),new H.Point(c.br.x,c.br.y),new H.Point(c.bl.x,c.bl.y)]},intersectsWithRect:function(a,b,c,d){var e=this.getCoords(c,d);return"Intersection"===H.Intersection.intersectPolygonRectangle(e,a,b).status},intersectsWithObject:function(a,b,c){return"Intersection"===H.Intersection.intersectPolygonPolygon(this.getCoords(b,c),a.getCoords(b,c)).status||a.isContainedWithinObject(this,b,c)||this.isContainedWithinObject(a,b,c)},isContainedWithinObject:function(a,b,c){for(var d=this.getCoords(b,c),e=b?a.aCoords:a.lineCoords,f=0,g=a._getImageLines(e);f<4;f++)if(!a.containsPoint(d[f],g))return!1;return!0},isContainedWithinRect:function(a,b,c,d){var e=this.getBoundingRect(c,d);return e.left>=a.x&&e.left+e.width<=b.x&&e.top>=a.y&&e.top+e.height<=b.y},containsPoint:function(a,b,c,d){var e=this._getCoords(c,d),b=b||this._getImageLines(e),f=this._findCrossPoints(a,b);return 0!==f&&f%2==1},isOnScreen:function(a){if(!this.canvas)return!1;var b=this.canvas.vptCoords.tl,c=this.canvas.vptCoords.br;return!!(this.getCoords(!0,a).some(function(a){return a.x<=c.x&&a.x>=b.x&&a.y<=c.y&&a.y>=b.y})||this.intersectsWithRect(b,c,!0,a))||this._containsCenterOfCanvas(b,c,a)},_containsCenterOfCanvas:function(a,b,c){var d={x:(a.x+b.x)/2,y:(a.y+b.y)/2};return!!this.containsPoint(d,null,!0,c)},isPartiallyOnScreen:function(a){if(!this.canvas)return!1;var b=this.canvas.vptCoords.tl,c=this.canvas.vptCoords.br;return!!this.intersectsWithRect(b,c,!0,a)||this.getCoords(!0,a).every(function(a){return(a.x>=c.x||a.x<=b.x)&&(a.y>=c.y||a.y<=b.y)})&&this._containsCenterOfCanvas(b,c,a)},_getImageLines:function(a){return{topline:{o:a.tl,d:a.tr},rightline:{o:a.tr,d:a.br},bottomline:{o:a.br,d:a.bl},leftline:{o:a.bl,d:a.tl}}},_findCrossPoints:function(a,b){var c,d,e,f=0;for(var g in b)if((!((e=b[g]).o.y<a.y)||!(e.d.y<a.y))&&(!(e.o.y>=a.y)||!(e.d.y>=a.y))&&(e.o.x===e.d.x&&e.o.x>=a.x?d=e.o.x:(c=(e.d.y-e.o.y)/(e.d.x-e.o.x),d=-(a.y-0*a.x-(e.o.y-c*e.o.x))/(0-c)),d>=a.x&&(f+=1),2===f))break;return f},getBoundingRect:function(a,b){var c=this.getCoords(a,b);return w.makeBoundingBoxFromPoints(c)},getScaledWidth:function(){return this._getTransformedDimensions().x},getScaledHeight:function(){return this._getTransformedDimensions().y},_constrainScale:function(a){if(Math.abs(a)<this.minScaleLimit)if(a<0)return-this.minScaleLimit;else return this.minScaleLimit;return 0===a?1e-4:a},scale:function(a){return this._set("scaleX",a),this._set("scaleY",a),this.setCoords()},scaleToWidth:function(a,b){var c=this.getBoundingRect(b).width/this.getScaledWidth();return this.scale(a/this.width/c)},scaleToHeight:function(a,b){var c=this.getBoundingRect(b).height/this.getScaledHeight();return this.scale(a/this.height/c)},calcLineCoords:function(){var a=this.getViewportTransform(),b=this.padding,c=x(this.angle),d=w.cos(c),e=w.sin(c),f=d*b,g=e*b,h=f+g,i=f-g,j=this.calcACoords(),k={tl:z(j.tl,a),tr:z(j.tr,a),bl:z(j.bl,a),br:z(j.br,a)};return b&&(k.tl.x-=i,k.tl.y-=h,k.tr.x+=h,k.tr.y-=i,k.bl.x-=h,k.bl.y+=i,k.br.x+=i,k.br.y+=h),k},calcOCoords:function(){var a=this._calcRotateMatrix(),b=this._calcTranslateMatrix(),c=this.getViewportTransform(),d=y(c,b),e=y(d,a),e=y(e,[1/c[0],0,0,1/c[3],0,0]),f=this._calculateCurrentDimensions(),g={};return this.forEachControl(function(a,b,c){g[b]=a.positionHandler(f,e,c)}),g},calcACoords:function(){var a=this._calcRotateMatrix(),b=y(this._calcTranslateMatrix(),a),c=this._getTransformedDimensions(),d=c.x/2,e=c.y/2;return{tl:z({x:-d,y:-e},b),tr:z({x:d,y:-e},b),bl:z({x:-d,y:e},b),br:z({x:d,y:e},b)}},setCoords:function(a){return this.aCoords=this.calcACoords(),this.lineCoords=this.group?this.aCoords:this.calcLineCoords(),a||(this.oCoords=this.calcOCoords(),this._setCornerCoords&&this._setCornerCoords()),this},_calcRotateMatrix:function(){return w.calcRotateMatrix(this)},_calcTranslateMatrix:function(){var a=this.getCenterPoint();return[1,0,0,1,a.x,a.y]},transformMatrixKey:function(a){var b="";return!a&&this.group&&(b=this.group.transformMatrixKey(a)+"_"),b+this.top+"_"+this.left+"_"+this.scaleX+"_"+this.scaleY+"_"+this.skewX+"_"+this.skewY+"_"+this.angle+"_"+this.originX+"_"+this.originY+"_"+this.width+"_"+this.height+"_"+this.strokeWidth+this.flipX+this.flipY},calcTransformMatrix:function(a){var b=this.calcOwnMatrix();if(a||!this.group)return b;var c=this.transformMatrixKey(a),d=this.matrixCache||(this.matrixCache={});return d.key===c?d.value:(this.group&&(b=y(this.group.calcTransformMatrix(!1),b)),d.key=c,d.value=b,b)},calcOwnMatrix:function(){var a=this.transformMatrixKey(!0),b=this.ownMatrixCache||(this.ownMatrixCache={});if(b.key===a)return b.value;var c=this._calcTranslateMatrix(),d={angle:this.angle,translateX:c[4],translateY:c[5],scaleX:this.scaleX,scaleY:this.scaleY,skewX:this.skewX,skewY:this.skewY,flipX:this.flipX,flipY:this.flipY};return b.key=a,b.value=w.composeMatrix(d),b.value},_getNonTransformedDimensions:function(){var a=this.strokeWidth;return{x:this.width+a,y:this.height+a}},_getTransformedDimensions:function(a,b){void 0===a&&(a=this.skewX),void 0===b&&(b=this.skewY);var c,d,e,f=0===a&&0===b;if(this.strokeUniform?(d=this.width,e=this.height):(d=(c=this._getNonTransformedDimensions()).x,e=c.y),f)return this._finalizeDimensions(d*this.scaleX,e*this.scaleY);var g=w.sizeAfterTransform(d,e,{scaleX:this.scaleX,scaleY:this.scaleY,skewX:a,skewY:b});return this._finalizeDimensions(g.x,g.y)},_finalizeDimensions:function(a,b){return this.strokeUniform?{x:a+this.strokeWidth,y:b+this.strokeWidth}:{x:a,y:b}},_calculateCurrentDimensions:function(){var a=this.getViewportTransform();return z(this._getTransformedDimensions(),a,!0).scalarAdd(2*this.padding)}}),H.util.object.extend(H.Object.prototype,{sendToBack:function(){return this.group?H.StaticCanvas.prototype.sendToBack.call(this.group,this):this.canvas&&this.canvas.sendToBack(this),this},bringToFront:function(){return this.group?H.StaticCanvas.prototype.bringToFront.call(this.group,this):this.canvas&&this.canvas.bringToFront(this),this},sendBackwards:function(a){return this.group?H.StaticCanvas.prototype.sendBackwards.call(this.group,this,a):this.canvas&&this.canvas.sendBackwards(this,a),this},bringForward:function(a){return this.group?H.StaticCanvas.prototype.bringForward.call(this.group,this,a):this.canvas&&this.canvas.bringForward(this,a),this},moveTo:function(a){return this.group&&"activeSelection"!==this.group.type?H.StaticCanvas.prototype.moveTo.call(this.group,this,a):this.canvas&&this.canvas.moveTo(this,a),this}});var ab=H.util.toFixed;H.util.object.extend(H.Object.prototype,{getSvgStyles:function(a){var b=this.fillRule?this.fillRule:"nonzero",c=this.strokeWidth?this.strokeWidth:"0",d=this.strokeDashArray?this.strokeDashArray.join(" "):"none",e=this.strokeDashOffset?this.strokeDashOffset:"0",f=this.strokeLineCap?this.strokeLineCap:"butt",g=this.strokeLineJoin?this.strokeLineJoin:"miter",h=this.strokeMiterLimit?this.strokeMiterLimit:"4",i=void 0!==this.opacity?this.opacity:"1",j=this.visible?"":" visibility: hidden;",k=a?"":this.getSvgFilter(),l=aa("fill",this.fill);return aa("stroke",this.stroke)+"stroke-width: "+c+"; stroke-dasharray: "+d+"; stroke-linecap: "+f+"; stroke-dashoffset: "+e+"; stroke-linejoin: "+g+"; stroke-miterlimit: "+h+"; "+l+"fill-rule: "+b+"; opacity: "+i+";"+k+j},getSvgSpanStyles:function(a,b){var c=a.fontFamily?"font-family: "+(-1===a.fontFamily.indexOf("'")&&-1===a.fontFamily.indexOf('"')?"'"+a.fontFamily+"'":a.fontFamily)+"; ":"",d=a.strokeWidth?"stroke-width: "+a.strokeWidth+"; ":"",c=c,e=a.fontSize?"font-size: "+a.fontSize+"px; ":"",f=a.fontStyle?"font-style: "+a.fontStyle+"; ":"",g=a.fontWeight?"font-weight: "+a.fontWeight+"; ":"",h=a.fill?aa("fill",a.fill):"",i=a.stroke?aa("stroke",a.stroke):"",j=this.getSvgTextDecoration(a);return j&&(j="text-decoration: "+j+"; "),[i,d,c,e,f,g,j,h,a.deltaY?"baseline-shift: "+-a.deltaY+"; ":"",b?"white-space: pre; ":""].join("")},getSvgTextDecoration:function(a){return["overline","underline","line-through"].filter(function(b){return a[b.replace("-","")]}).join(" ")},getSvgFilter:function(){return this.shadow?"filter: url(#SVGID_"+this.shadow.id+");":""},getSvgCommons:function(){return[this.id?'id="'+this.id+'" ':"",this.clipPath?'clip-path="url(#'+this.clipPath.clipPathId+')" ':""].join("")},getSvgTransform:function(a,b){var c=a?this.calcTransformMatrix():this.calcOwnMatrix();return'transform="'+H.util.matrixToSVG(c)+(b||"")+'" '},_setSVGBg:function(a){if(this.backgroundColor){var b=H.Object.NUM_FRACTION_DIGITS;a.push("		<rect ",this._getFillAttributes(this.backgroundColor),' x="',ab(-this.width/2,b),'" y="',ab(-this.height/2,b),'" width="',ab(this.width,b),'" height="',ab(this.height,b),'"></rect>\n')}},toSVG:function(a){return this._createBaseSVGMarkup(this._toSVG(a),{reviver:a})},toClipPathSVG:function(a){return"	"+this._createBaseClipPathSVGMarkup(this._toSVG(a),{reviver:a})},_createBaseClipPathSVGMarkup:function(a,b){var c=(b=b||{}).reviver,d=b.additionalTransform||"",e=[this.getSvgTransform(!0,d),this.getSvgCommons()].join(""),f=a.indexOf("COMMON_PARTS");return a[f]=e,c?c(a.join("")):a.join("")},_createBaseSVGMarkup:function(a,b){var c,d,e=(b=b||{}).noStyle,f=b.reviver,g=e?"":'style="'+this.getSvgStyles()+'" ',h=b.withShadow?'style="'+this.getSvgFilter()+'" ':"",i=this.clipPath,j=this.strokeUniform?'vector-effect="non-scaling-stroke" ':"",k=i&&i.absolutePositioned,l=this.stroke,m=this.fill,n=this.shadow,o=[],p=a.indexOf("COMMON_PARTS"),q=b.additionalTransform;return i&&(i.clipPathId="CLIPPATH_"+H.Object.__uid++,d='<clipPath id="'+i.clipPathId+'" >\n'+i.toClipPathSVG(f)+"</clipPath>\n"),k&&o.push("<g ",h,this.getSvgCommons()," >\n"),o.push("<g ",this.getSvgTransform(!1),k?"":h+this.getSvgCommons()," >\n"),c=""+g+j+(e?"":this.addPaintOrder())+" "+(q?'transform="'+q+'" ':""),a[p]=c,m&&m.toLive&&o.push(m.toSVG(this)),l&&l.toLive&&o.push(l.toSVG(this)),n&&o.push(n.toSVG(this)),i&&o.push(d),o.push(a.join("")),o.push("</g>\n"),k&&o.push("</g>\n"),f?f(o.join("")):o.join("")},addPaintOrder:function(){return"fill"!==this.paintFirst?' paint-order="'+this.paintFirst+'" ':""}});var ac=H.util.object.extend,ad="stateProperties";function ae(a,b,c){var d={};c.forEach(function(b){d[b]=a[b]}),ac(a[b],d,!0)}function af(a,b){var c=a.canvas,d=b.targetCanvas,e=d.getContext("2d");e.translate(0,d.height),e.scale(1,-1);var f=c.height-d.height;e.drawImage(c,0,f,d.width,d.height,0,0,d.width,d.height)}function ag(a,b){var c=b.targetCanvas.getContext("2d"),d=b.destinationWidth,e=b.destinationHeight,f=d*e*4,g=new Uint8Array(this.imageBuffer,0,f),h=new Uint8ClampedArray(this.imageBuffer,0,f);a.readPixels(0,0,d,e,a.RGBA,a.UNSIGNED_BYTE,g);var i=new ImageData(h,d,e);c.putImageData(i,0,0)}function ah(a){a.textDecoration&&(a.textDecoration.indexOf("underline")>-1&&(a.underline=!0),a.textDecoration.indexOf("line-through")>-1&&(a.linethrough=!0),a.textDecoration.indexOf("overline")>-1&&(a.overline=!0),delete a.textDecoration)}H.util.object.extend(H.Object.prototype,{hasStateChanged:function(a){var b="_"+(a=a||ad);return Object.keys(this[b]).length<this[a].length||!function a(b,c,d){if(b===c)return!0;if(Array.isArray(b)){if(!Array.isArray(c)||b.length!==c.length)return!1;for(var e=0,f=b.length;e<f;e++)if(!a(b[e],c[e]))return!1;return!0}if(b&&"object"==typeof b){var g,h=Object.keys(b);if(!c||"object"!=typeof c||!d&&h.length!==Object.keys(c).length)return!1;for(var e=0,f=h.length;e<f;e++)if("canvas"!==(g=h[e])&&"group"!==g&&!a(b[g],c[g]))return!1;return!0}}(this[b],this,!0)},saveState:function(a){var b=a&&a.propertySet||ad,c="_"+b;return this[c]?(ae(this,c,this[b]),a&&a.stateProperties&&ae(this,c,a.stateProperties),this):this.setupState(a)},setupState:function(a){var b=(a=a||{}).propertySet||ad;return a.propertySet=b,this["_"+b]={},this.saveState(a),this}}),A=H.util.degreesToRadians,H.util.object.extend(H.Object.prototype,{_findTargetCorner:function(a,b){if(!this.hasControls||this.group||!this.canvas||this.canvas._activeObject!==this)return!1;var c,d,e,f=a.x,g=a.y,h=Object.keys(this.oCoords),i=h.length-1;for(this.__corner=0;i>=0;i--)if(e=h[i],this.isControlVisible(e)&&(d=this._getImageLines(b?this.oCoords[e].touchCorner:this.oCoords[e].corner),0!==(c=this._findCrossPoints({x:f,y:g},d))&&c%2==1))return this.__corner=e,e;return!1},forEachControl:function(a){for(var b in this.controls)a(this.controls[b],b,this)},_setCornerCoords:function(){var a=this.oCoords;for(var b in a){var c=this.controls[b];a[b].corner=c.calcCornerCoords(this.angle,this.cornerSize,a[b].x,a[b].y,!1),a[b].touchCorner=c.calcCornerCoords(this.angle,this.touchCornerSize,a[b].x,a[b].y,!0)}},drawSelectionBackground:function(a){if(!this.selectionBackgroundColor||this.canvas&&!this.canvas.interactive||this.canvas&&this.canvas._activeObject!==this)return this;a.save();var b=this.getCenterPoint(),c=this._calculateCurrentDimensions(),d=this.canvas.viewportTransform;return a.translate(b.x,b.y),a.scale(1/d[0],1/d[3]),a.rotate(A(this.angle)),a.fillStyle=this.selectionBackgroundColor,a.fillRect(-c.x/2,-c.y/2,c.x,c.y),a.restore(),this},drawBorders:function(a,b){b=b||{};var c=this._calculateCurrentDimensions(),d=this.borderScaleFactor,e=c.x+d,f=c.y+d,g=void 0!==b.hasControls?b.hasControls:this.hasControls,h=!1;return a.save(),a.strokeStyle=b.borderColor||this.borderColor,this._setLineDash(a,b.borderDashArray||this.borderDashArray),a.strokeRect(-e/2,-f/2,e,f),g&&(a.beginPath(),this.forEachControl(function(b,c,d){b.withConnection&&b.getVisibility(d,c)&&(h=!0,a.moveTo(b.x*e,b.y*f),a.lineTo(b.x*e+b.offsetX,b.y*f+b.offsetY))}),h&&a.stroke()),a.restore(),this},drawBordersInGroup:function(a,b,c){c=c||{};var d=H.util.sizeAfterTransform(this.width,this.height,b),e=this.strokeWidth,f=this.strokeUniform,g=this.borderScaleFactor,h=d.x+e*(f?this.canvas.getZoom():b.scaleX)+g,i=d.y+e*(f?this.canvas.getZoom():b.scaleY)+g;return a.save(),this._setLineDash(a,c.borderDashArray||this.borderDashArray),a.strokeStyle=c.borderColor||this.borderColor,a.strokeRect(-h/2,-i/2,h,i),a.restore(),this},drawControls:function(a,b){b=b||{},a.save();var c,d,e=1;return this.canvas&&(e=this.canvas.getRetinaScaling()),a.setTransform(e,0,0,e,0,0),a.strokeStyle=a.fillStyle=b.cornerColor||this.cornerColor,this.transparentCorners||(a.strokeStyle=b.cornerStrokeColor||this.cornerStrokeColor),this._setLineDash(a,b.cornerDashArray||this.cornerDashArray),this.setCoords(),this.group&&(c=this.group.calcTransformMatrix()),this.forEachControl(function(e,f,g){d=g.oCoords[f],e.getVisibility(g,f)&&(c&&(d=H.util.transformPoint(d,c)),e.render(a,d.x,d.y,b,g))}),a.restore(),this},isControlVisible:function(a){return this.controls[a]&&this.controls[a].getVisibility(this,a)},setControlVisible:function(a,b){return this._controlsVisibility||(this._controlsVisibility={}),this._controlsVisibility[a]=b,this},setControlsVisibility:function(a){for(var b in a||(a={}),a)this.setControlVisible(b,a[b]);return this},onDeselect:function(){},onSelect:function(){}}),H.util.object.extend(H.StaticCanvas.prototype,{FX_DURATION:500,fxCenterObjectH:function(a,b){var c=function(){},d=(b=b||{}).onComplete||c,e=b.onChange||c,f=this;return H.util.animate({target:this,startValue:a.left,endValue:this.getCenterPoint().x,duration:this.FX_DURATION,onChange:function(b){a.set("left",b),f.requestRenderAll(),e()},onComplete:function(){a.setCoords(),d()}})},fxCenterObjectV:function(a,b){var c=function(){},d=(b=b||{}).onComplete||c,e=b.onChange||c,f=this;return H.util.animate({target:this,startValue:a.top,endValue:this.getCenterPoint().y,duration:this.FX_DURATION,onChange:function(b){a.set("top",b),f.requestRenderAll(),e()},onComplete:function(){a.setCoords(),d()}})},fxRemove:function(a,b){var c=function(){},d=(b=b||{}).onComplete||c,e=b.onChange||c,f=this;return H.util.animate({target:this,startValue:a.opacity,endValue:0,duration:this.FX_DURATION,onChange:function(b){a.set("opacity",b),f.requestRenderAll(),e()},onComplete:function(){f.remove(a),d()}})}}),H.util.object.extend(H.Object.prototype,{animate:function(){if(!arguments[0]||"object"!=typeof arguments[0])return this._animate.apply(this,arguments);var a,b,c=[],d=[];for(a in arguments[0])c.push(a);for(var e=0,f=c.length;e<f;e++)a=c[e],b=e!==f-1,d.push(this._animate(a,arguments[0][a],arguments[1],b));return d},_animate:function(a,b,c,d){var e,f=this;b=b.toString(),c=c?H.util.object.clone(c):{},~a.indexOf(".")&&(e=a.split("."));var g=f.colorProperties.indexOf(a)>-1||e&&f.colorProperties.indexOf(e[1])>-1,h=e?this.get(e[0])[e[1]]:this.get(a);"from"in c||(c.from=h),g||(b=~b.indexOf("=")?h+parseFloat(b.replace("=","")):parseFloat(b));var i={target:this,startValue:c.from,endValue:b,byValue:c.by,easing:c.easing,duration:c.duration,abort:c.abort&&function(a,b,d){return c.abort.call(f,a,b,d)},onChange:function(b,g,h){e?f[e[0]][e[1]]=b:f.set(a,b),!d&&c.onChange&&c.onChange(b,g,h)},onComplete:function(a,b,e){!d&&(f.setCoords(),c.onComplete&&c.onComplete(a,b,e))}};return g?H.util.animateColor(i.startValue,i.endValue,i.duration,i):H.util.animate(i)}}),function(a){"use strict";var b=a.fabric||(a.fabric={}),c=b.util.object.extend,d=b.util.object.clone,e={x1:1,x2:1,y1:1,y2:1};if(b.Line)return b.warn("fabric.Line is already defined");function f(a,b){var c=a.origin,d=a.axis1,e=a.axis2,f=a.dimension,g=b.nearest,h=b.center,i=b.farthest;return function(){switch(this.get(c)){case g:return Math.min(this.get(d),this.get(e));case h:return Math.min(this.get(d),this.get(e))+.5*this.get(f);case i:return Math.max(this.get(d),this.get(e))}}}b.Line=b.util.createClass(b.Object,{type:"line",x1:0,y1:0,x2:0,y2:0,cacheProperties:b.Object.prototype.cacheProperties.concat("x1","x2","y1","y2"),initialize:function(a,b){a||(a=[0,0,0,0]),this.callSuper("initialize",b),this.set("x1",a[0]),this.set("y1",a[1]),this.set("x2",a[2]),this.set("y2",a[3]),this._setWidthHeight(b)},_setWidthHeight:function(a){a||(a={}),this.width=Math.abs(this.x2-this.x1),this.height=Math.abs(this.y2-this.y1),this.left="left"in a?a.left:this._getLeftToOriginX(),this.top="top"in a?a.top:this._getTopToOriginY()},_set:function(a,b){return this.callSuper("_set",a,b),void 0!==e[a]&&this._setWidthHeight(),this},_getLeftToOriginX:f({origin:"originX",axis1:"x1",axis2:"x2",dimension:"width"},{nearest:"left",center:"center",farthest:"right"}),_getTopToOriginY:f({origin:"originY",axis1:"y1",axis2:"y2",dimension:"height"},{nearest:"top",center:"center",farthest:"bottom"}),_render:function(a){a.beginPath();var b=this.calcLinePoints();a.moveTo(b.x1,b.y1),a.lineTo(b.x2,b.y2),a.lineWidth=this.strokeWidth;var c=a.strokeStyle;a.strokeStyle=this.stroke||a.fillStyle,this.stroke&&this._renderStroke(a),a.strokeStyle=c},_findCenterFromElement:function(){return{x:(this.x1+this.x2)/2,y:(this.y1+this.y2)/2}},toObject:function(a){return c(this.callSuper("toObject",a),this.calcLinePoints())},_getNonTransformedDimensions:function(){var a=this.callSuper("_getNonTransformedDimensions");return"butt"===this.strokeLineCap&&(0===this.width&&(a.y-=this.strokeWidth),0===this.height&&(a.x-=this.strokeWidth)),a},calcLinePoints:function(){var a=this.x1<=this.x2?-1:1,b=this.y1<=this.y2?-1:1,c=a*this.width*.5,d=b*this.height*.5;return{x1:c,x2:-(a*this.width*.5),y1:d,y2:-(b*this.height*.5)}},_toSVG:function(){var a=this.calcLinePoints();return["<line ","COMMON_PARTS",'x1="',a.x1,'" y1="',a.y1,'" x2="',a.x2,'" y2="',a.y2,'" />\n']}}),b.Line.ATTRIBUTE_NAMES=b.SHARED_ATTRIBUTES.concat("x1 y1 x2 y2".split(" ")),b.Line.fromElement=function(a,d,e){e=e||{};var f=b.parseAttributes(a,b.Line.ATTRIBUTE_NAMES),g=[f.x1||0,f.y1||0,f.x2||0,f.y2||0];d(new b.Line(g,c(f,e)))},b.Line.fromObject=function(a,c){var e=d(a,!0);e.points=[a.x1,a.y1,a.x2,a.y2],b.Object._fromObject("Line",e,function(a){delete a.points,c&&c(a)},"points")}}(c),function(a){"use strict";var b=a.fabric||(a.fabric={}),c=b.util.degreesToRadians;if(b.Circle)return b.warn("fabric.Circle is already defined.");b.Circle=b.util.createClass(b.Object,{type:"circle",radius:0,startAngle:0,endAngle:360,cacheProperties:b.Object.prototype.cacheProperties.concat("radius","startAngle","endAngle"),_set:function(a,b){return this.callSuper("_set",a,b),"radius"===a&&this.setRadius(b),this},toObject:function(a){return this.callSuper("toObject",["radius","startAngle","endAngle"].concat(a))},_toSVG:function(){var a,d=(this.endAngle-this.startAngle)%360;if(0===d)a=["<circle ","COMMON_PARTS",'cx="0" cy="0" ','r="',this.radius,'" />\n'];else{var e=c(this.startAngle),f=c(this.endAngle),g=this.radius,h=b.util.cos(e)*g,i=b.util.sin(e)*g,j=b.util.cos(f)*g,k=b.util.sin(f)*g;a=['<path d="M '+h+" "+i," A "+g+" "+g," 0 ",+(d>180?"1":"0")+" 1"," "+j+" "+k,'" ',"COMMON_PARTS"," />\n"]}return a},_render:function(a){a.beginPath(),a.arc(0,0,this.radius,c(this.startAngle),c(this.endAngle),!1),this._renderPaintInOrder(a)},getRadiusX:function(){return this.get("radius")*this.get("scaleX")},getRadiusY:function(){return this.get("radius")*this.get("scaleY")},setRadius:function(a){return this.radius=a,this.set("width",2*a).set("height",2*a)}}),b.Circle.ATTRIBUTE_NAMES=b.SHARED_ATTRIBUTES.concat("cx cy r".split(" ")),b.Circle.fromElement=function(a,c){var d,e=b.parseAttributes(a,b.Circle.ATTRIBUTE_NAMES);if(!("radius"in(d=e)&&d.radius>=0))throw Error("value of `r` attribute is required and can not be negative");e.left=(e.left||0)-e.radius,e.top=(e.top||0)-e.radius,c(new b.Circle(e))},b.Circle.fromObject=function(a,c){b.Object._fromObject("Circle",a,c)}}(c),function(a){"use strict";var b=a.fabric||(a.fabric={});if(b.Triangle)return b.warn("fabric.Triangle is already defined");b.Triangle=b.util.createClass(b.Object,{type:"triangle",width:100,height:100,_render:function(a){var b=this.width/2,c=this.height/2;a.beginPath(),a.moveTo(-b,c),a.lineTo(0,-c),a.lineTo(b,c),a.closePath(),this._renderPaintInOrder(a)},_toSVG:function(){var a=this.width/2,b=this.height/2;return["<polygon ","COMMON_PARTS",'points="',[-a+" "+b,"0 "+-b,a+" "+b].join(","),'" />']}}),b.Triangle.fromObject=function(a,c){return b.Object._fromObject("Triangle",a,c)}}(c),function(a){"use strict";var b=a.fabric||(a.fabric={}),c=2*Math.PI;if(b.Ellipse)return b.warn("fabric.Ellipse is already defined.");b.Ellipse=b.util.createClass(b.Object,{type:"ellipse",rx:0,ry:0,cacheProperties:b.Object.prototype.cacheProperties.concat("rx","ry"),initialize:function(a){this.callSuper("initialize",a),this.set("rx",a&&a.rx||0),this.set("ry",a&&a.ry||0)},_set:function(a,b){switch(this.callSuper("_set",a,b),a){case"rx":this.rx=b,this.set("width",2*b);break;case"ry":this.ry=b,this.set("height",2*b)}return this},getRx:function(){return this.get("rx")*this.get("scaleX")},getRy:function(){return this.get("ry")*this.get("scaleY")},toObject:function(a){return this.callSuper("toObject",["rx","ry"].concat(a))},_toSVG:function(){return["<ellipse ","COMMON_PARTS",'cx="0" cy="0" ','rx="',this.rx,'" ry="',this.ry,'" />\n']},_render:function(a){a.beginPath(),a.save(),a.transform(1,0,0,this.ry/this.rx,0,0),a.arc(0,0,this.rx,0,c,!1),a.restore(),this._renderPaintInOrder(a)}}),b.Ellipse.ATTRIBUTE_NAMES=b.SHARED_ATTRIBUTES.concat("cx cy rx ry".split(" ")),b.Ellipse.fromElement=function(a,c){var d=b.parseAttributes(a,b.Ellipse.ATTRIBUTE_NAMES);d.left=(d.left||0)-d.rx,d.top=(d.top||0)-d.ry,c(new b.Ellipse(d))},b.Ellipse.fromObject=function(a,c){b.Object._fromObject("Ellipse",a,c)}}(c),function(a){"use strict";var b=a.fabric||(a.fabric={}),c=b.util.object.extend;if(b.Rect)return b.warn("fabric.Rect is already defined");b.Rect=b.util.createClass(b.Object,{stateProperties:b.Object.prototype.stateProperties.concat("rx","ry"),type:"rect",rx:0,ry:0,cacheProperties:b.Object.prototype.cacheProperties.concat("rx","ry"),initialize:function(a){this.callSuper("initialize",a),this._initRxRy()},_initRxRy:function(){this.rx&&!this.ry?this.ry=this.rx:this.ry&&!this.rx&&(this.rx=this.ry)},_render:function(a){var b=this.rx?Math.min(this.rx,this.width/2):0,c=this.ry?Math.min(this.ry,this.height/2):0,d=this.width,e=this.height,f=-this.width/2,g=-this.height/2,h=0!==b||0!==c;a.beginPath(),a.moveTo(f+b,g),a.lineTo(f+d-b,g),h&&a.bezierCurveTo(f+d-.4477152502*b,g,f+d,g+.4477152502*c,f+d,g+c),a.lineTo(f+d,g+e-c),h&&a.bezierCurveTo(f+d,g+e-.4477152502*c,f+d-.4477152502*b,g+e,f+d-b,g+e),a.lineTo(f+b,g+e),h&&a.bezierCurveTo(f+.4477152502*b,g+e,f,g+e-.4477152502*c,f,g+e-c),a.lineTo(f,g+c),h&&a.bezierCurveTo(f,g+.4477152502*c,f+.4477152502*b,g,f+b,g),a.closePath(),this._renderPaintInOrder(a)},toObject:function(a){return this.callSuper("toObject",["rx","ry"].concat(a))},_toSVG:function(){return["<rect ","COMMON_PARTS",'x="',-this.width/2,'" y="',-this.height/2,'" rx="',this.rx,'" ry="',this.ry,'" width="',this.width,'" height="',this.height,'" />\n']}}),b.Rect.ATTRIBUTE_NAMES=b.SHARED_ATTRIBUTES.concat("x y rx ry width height".split(" ")),b.Rect.fromElement=function(a,d,e){if(!a)return d(null);e=e||{};var f=b.parseAttributes(a,b.Rect.ATTRIBUTE_NAMES);f.left=f.left||0,f.top=f.top||0,f.height=f.height||0,f.width=f.width||0;var g=new b.Rect(c(e?b.util.object.clone(e):{},f));g.visible=g.visible&&g.width>0&&g.height>0,d(g)},b.Rect.fromObject=function(a,c){return b.Object._fromObject("Rect",a,c)}}(c),function(a){"use strict";var b=a.fabric||(a.fabric={}),c=b.util.object.extend,d=b.util.array.min,e=b.util.array.max,f=b.util.toFixed,g=b.util.projectStrokeOnPoints;if(b.Polyline)return b.warn("fabric.Polyline is already defined");b.Polyline=b.util.createClass(b.Object,{type:"polyline",points:null,exactBoundingBox:!1,cacheProperties:b.Object.prototype.cacheProperties.concat("points"),initialize:function(a,b){b=b||{},this.points=a||[],this.callSuper("initialize",b),this._setPositionDimensions(b)},_projectStrokeOnPoints:function(){return g(this.points,this,!0)},_setPositionDimensions:function(a){var b,c=this._calcDimensions(a),d=this.exactBoundingBox?this.strokeWidth:0;this.width=c.width-d,this.height=c.height-d,a.fromSVG||(b=this.translateToGivenOrigin({x:c.left-this.strokeWidth/2+d/2,y:c.top-this.strokeWidth/2+d/2},"left","top",this.originX,this.originY)),void 0===a.left&&(this.left=a.fromSVG?c.left:b.x),void 0===a.top&&(this.top=a.fromSVG?c.top:b.y),this.pathOffset={x:c.left+this.width/2+d/2,y:c.top+this.height/2+d/2}},_calcDimensions:function(){var a=this.exactBoundingBox?this._projectStrokeOnPoints():this.points,b=d(a,"x")||0,c=d(a,"y")||0;return{left:b,top:c,width:(e(a,"x")||0)-b,height:(e(a,"y")||0)-c}},toObject:function(a){return c(this.callSuper("toObject",a),{points:this.points.concat()})},_toSVG:function(){for(var a=[],c=this.pathOffset.x,d=this.pathOffset.y,e=b.Object.NUM_FRACTION_DIGITS,g=0,h=this.points.length;g<h;g++)a.push(f(this.points[g].x-c,e),",",f(this.points[g].y-d,e)," ");return["<"+this.type+" ","COMMON_PARTS",'points="',a.join(""),'" />\n']},commonRender:function(a){var b,c=this.points.length,d=this.pathOffset.x,e=this.pathOffset.y;if(!c||isNaN(this.points[c-1].y))return!1;a.beginPath(),a.moveTo(this.points[0].x-d,this.points[0].y-e);for(var f=0;f<c;f++)b=this.points[f],a.lineTo(b.x-d,b.y-e);return!0},_render:function(a){this.commonRender(a)&&this._renderPaintInOrder(a)},complexity:function(){return this.get("points").length}}),b.Polyline.ATTRIBUTE_NAMES=b.SHARED_ATTRIBUTES.concat(),b.Polyline.fromElementGenerator=function(a){return function(d,e,f){if(!d)return e(null);f||(f={});var g=b.parsePointsAttribute(d.getAttribute("points")),h=b.parseAttributes(d,b[a].ATTRIBUTE_NAMES);h.fromSVG=!0,e(new b[a](g,c(h,f)))}},b.Polyline.fromElement=b.Polyline.fromElementGenerator("Polyline"),b.Polyline.fromObject=function(a,c){return b.Object._fromObject("Polyline",a,c,"points")}}(c),function(a){"use strict";var b=a.fabric||(a.fabric={}),c=b.util.projectStrokeOnPoints;if(b.Polygon)return b.warn("fabric.Polygon is already defined");b.Polygon=b.util.createClass(b.Polyline,{type:"polygon",_projectStrokeOnPoints:function(){return c(this.points,this)},_render:function(a){this.commonRender(a)&&(a.closePath(),this._renderPaintInOrder(a))}}),b.Polygon.ATTRIBUTE_NAMES=b.SHARED_ATTRIBUTES.concat(),b.Polygon.fromElement=b.Polyline.fromElementGenerator("Polygon"),b.Polygon.fromObject=function(a,c){b.Object._fromObject("Polygon",a,c,"points")}}(c),function(a){"use strict";var b=a.fabric||(a.fabric={}),c=b.util.array.min,d=b.util.array.max,e=b.util.object.extend,f=b.util.object.clone,g=b.util.toFixed;if(b.Path)return b.warn("fabric.Path is already defined");b.Path=b.util.createClass(b.Object,{type:"path",path:null,cacheProperties:b.Object.prototype.cacheProperties.concat("path","fillRule"),stateProperties:b.Object.prototype.stateProperties.concat("path"),initialize:function(a,b){b=f(b||{}),delete b.path,this.callSuper("initialize",b),this._setPath(a||[],b)},_setPath:function(a,c){this.path=b.util.makePathSimpler(Array.isArray(a)?a:b.util.parsePath(a)),b.Polyline.prototype._setPositionDimensions.call(this,c||{})},_renderPathCommands:function(a){var b,c=0,d=0,e=0,f=0,g=0,h=0,i=-this.pathOffset.x,j=-this.pathOffset.y;a.beginPath();for(var k=0,l=this.path.length;k<l;++k)switch((b=this.path[k])[0]){case"L":e=b[1],f=b[2],a.lineTo(e+i,f+j);break;case"M":e=b[1],f=b[2],c=e,d=f,a.moveTo(e+i,f+j);break;case"C":e=b[5],f=b[6],g=b[3],h=b[4],a.bezierCurveTo(b[1]+i,b[2]+j,g+i,h+j,e+i,f+j);break;case"Q":a.quadraticCurveTo(b[1]+i,b[2]+j,b[3]+i,b[4]+j),e=b[3],f=b[4],g=b[1],h=b[2];break;case"z":case"Z":e=c,f=d,a.closePath()}},_render:function(a){this._renderPathCommands(a),this._renderPaintInOrder(a)},toString:function(){return"#<fabric.Path ("+this.complexity()+'): { "top": '+this.top+', "left": '+this.left+" }>"},toObject:function(a){return e(this.callSuper("toObject",a),{path:this.path.map(function(a){return a.slice()})})},toDatalessObject:function(a){var b=this.toObject(["sourcePath"].concat(a));return b.sourcePath&&delete b.path,b},_toSVG:function(){return["<path ","COMMON_PARTS",'d="',b.util.joinPath(this.path),'" stroke-linecap="round" ',"/>\n"]},_getOffsetTransform:function(){var a=b.Object.NUM_FRACTION_DIGITS;return" translate("+g(-this.pathOffset.x,a)+", "+g(-this.pathOffset.y,a)+")"},toClipPathSVG:function(a){var b=this._getOffsetTransform();return"	"+this._createBaseClipPathSVGMarkup(this._toSVG(),{reviver:a,additionalTransform:b})},toSVG:function(a){var b=this._getOffsetTransform();return this._createBaseSVGMarkup(this._toSVG(),{reviver:a,additionalTransform:b})},complexity:function(){return this.path.length},_calcDimensions:function(){for(var a,e,f=[],g=[],h=0,i=0,j=0,k=0,l=0,m=this.path.length;l<m;++l){switch((a=this.path[l])[0]){case"L":j=a[1],k=a[2],e=[];break;case"M":j=a[1],k=a[2],h=j,i=k,e=[];break;case"C":e=b.util.getBoundsOfCurve(j,k,a[1],a[2],a[3],a[4],a[5],a[6]),j=a[5],k=a[6];break;case"Q":e=b.util.getBoundsOfCurve(j,k,a[1],a[2],a[1],a[2],a[3],a[4]),j=a[3],k=a[4];break;case"z":case"Z":j=h,k=i}e.forEach(function(a){f.push(a.x),g.push(a.y)}),f.push(j),g.push(k)}var n=c(f)||0,o=c(g)||0;return{left:n,top:o,width:(d(f)||0)-n,height:(d(g)||0)-o}}}),b.Path.fromObject=function(a,c){if("string"==typeof a.sourcePath){var d=a.sourcePath;b.loadSVGFromURL(d,function(d){var e=d[0];e.setOptions(a),a.clipPath?b.util.enlivenObjects([a.clipPath],function(a){e.clipPath=a[0],c&&c(e)}):c&&c(e)})}else b.Object._fromObject("Path",a,c,"path")},b.Path.ATTRIBUTE_NAMES=b.SHARED_ATTRIBUTES.concat(["d"]),b.Path.fromElement=function(a,c,d){var f=b.parseAttributes(a,b.Path.ATTRIBUTE_NAMES);f.fromSVG=!0,c(new b.Path(f.d,e(f,d)))}}(c),function(a){"use strict";var b=a.fabric||(a.fabric={}),c=b.util.array.min,d=b.util.array.max;b.Group||(b.Group=b.util.createClass(b.Object,b.Collection,{type:"group",strokeWidth:0,subTargetCheck:!1,cacheProperties:[],useSetOnGroup:!1,initialize:function(a,b,c){b=b||{},this._objects=[],c&&this.callSuper("initialize",b),this._objects=a||[];for(var d=this._objects.length;d--;)this._objects[d].group=this;if(c)this._updateObjectsACoords();else{var e=b&&b.centerPoint;void 0!==b.originX&&(this.originX=b.originX),void 0!==b.originY&&(this.originY=b.originY),e||this._calcBounds(),this._updateObjectsCoords(e),delete b.centerPoint,this.callSuper("initialize",b)}this.setCoords()},_updateObjectsACoords:function(){for(var a=this._objects.length;a--;)this._objects[a].setCoords(!0)},_updateObjectsCoords:function(a){for(var a=a||this.getCenterPoint(),b=this._objects.length;b--;)this._updateObjectCoords(this._objects[b],a)},_updateObjectCoords:function(a,b){var c=a.left,d=a.top;a.set({left:c-b.x,top:d-b.y}),a.group=this,a.setCoords(!0)},toString:function(){return"#<fabric.Group: ("+this.complexity()+")>"},addWithUpdate:function(a){var c=!!this.group;return this._restoreObjectsState(),b.util.resetObjectTransform(this),a&&(c&&b.util.removeTransformFromObject(a,this.group.calcTransformMatrix()),this._objects.push(a),a.group=this,a._set("canvas",this.canvas)),this._calcBounds(),this._updateObjectsCoords(),this.dirty=!0,c?this.group.addWithUpdate():this.setCoords(),this},removeWithUpdate:function(a){return this._restoreObjectsState(),b.util.resetObjectTransform(this),this.remove(a),this._calcBounds(),this._updateObjectsCoords(),this.setCoords(),this.dirty=!0,this},_onObjectAdded:function(a){this.dirty=!0,a.group=this,a._set("canvas",this.canvas)},_onObjectRemoved:function(a){this.dirty=!0,delete a.group},_set:function(a,c){var d=this._objects.length;if(this.useSetOnGroup)for(;d--;)this._objects[d].setOnGroup(a,c);if("canvas"===a)for(;d--;)this._objects[d]._set(a,c);b.Object.prototype._set.call(this,a,c)},toObject:function(a){var c=this.includeDefaultValues,d=this._objects.filter(function(a){return!a.excludeFromExport}).map(function(b){var d=b.includeDefaultValues;b.includeDefaultValues=c;var e=b.toObject(a);return b.includeDefaultValues=d,e}),e=b.Object.prototype.toObject.call(this,a);return e.objects=d,e},toDatalessObject:function(a){var c,d=this.sourcePath;if(d)c=d;else{var e=this.includeDefaultValues;c=this._objects.map(function(b){var c=b.includeDefaultValues;b.includeDefaultValues=e;var d=b.toDatalessObject(a);return b.includeDefaultValues=c,d})}var f=b.Object.prototype.toDatalessObject.call(this,a);return f.objects=c,f},render:function(a){this._transformDone=!0,this.callSuper("render",a),this._transformDone=!1},shouldCache:function(){var a=b.Object.prototype.shouldCache.call(this);if(a){for(var c=0,d=this._objects.length;c<d;c++)if(this._objects[c].willDrawShadow())return this.ownCaching=!1,!1}return a},willDrawShadow:function(){if(b.Object.prototype.willDrawShadow.call(this))return!0;for(var a=0,c=this._objects.length;a<c;a++)if(this._objects[a].willDrawShadow())return!0;return!1},isOnACache:function(){return this.ownCaching||this.group&&this.group.isOnACache()},drawObject:function(a){for(var b=0,c=this._objects.length;b<c;b++)this._objects[b].render(a);this._drawClipPath(a,this.clipPath)},isCacheDirty:function(a){if(this.callSuper("isCacheDirty",a))return!0;if(!this.statefullCache)return!1;for(var b=0,c=this._objects.length;b<c;b++)if(this._objects[b].isCacheDirty(!0)){if(this._cacheCanvas){var d=this.cacheWidth/this.zoomX,e=this.cacheHeight/this.zoomY;this._cacheContext.clearRect(-d/2,-e/2,d,e)}return!0}return!1},_restoreObjectsState:function(){var a=this.calcOwnMatrix();return this._objects.forEach(function(c){b.util.addTransformToObject(c,a),delete c.group,c.setCoords()}),this},destroy:function(){return this._objects.forEach(function(a){a.set("dirty",!0)}),this._restoreObjectsState()},dispose:function(){this.callSuper("dispose"),this.forEachObject(function(a){a.dispose&&a.dispose()}),this._objects=[]},toActiveSelection:function(){if(this.canvas){var a=this._objects,c=this.canvas;this._objects=[];var d=this.toObject();delete d.objects;var e=new b.ActiveSelection([]);return e.set(d),e.type="activeSelection",c.remove(this),a.forEach(function(a){a.group=e,a.dirty=!0,c.add(a)}),e.canvas=c,e._objects=a,c._activeObject=e,e.setCoords(),e}},ungroupOnCanvas:function(){return this._restoreObjectsState()},setObjectsCoords:function(){return this.forEachObject(function(a){a.setCoords(!0)}),this},_calcBounds:function(a){for(var b,c,d,e,f=[],g=[],h=["tr","br","bl","tl"],i=0,j=this._objects.length,k=h.length;i<j;++i){for(e=0,d=(b=this._objects[i]).calcACoords();e<k;e++)c=h[e],f.push(d[c].x),g.push(d[c].y);b.aCoords=d}this._getBounds(f,g,a)},_getBounds:function(a,e,f){var g=new b.Point(c(a),c(e)),h=new b.Point(d(a),d(e)),i=g.y||0,j=g.x||0,k=h.x-g.x||0,l=h.y-g.y||0;this.width=k,this.height=l,f||this.setPositionByOrigin({x:j,y:i},"left","top")},_toSVG:function(a){for(var b=["<g ","COMMON_PARTS"," >\n"],c=0,d=this._objects.length;c<d;c++)b.push("		",this._objects[c].toSVG(a));return b.push("</g>\n"),b},getSvgStyles:function(){var a=void 0!==this.opacity&&1!==this.opacity?"opacity: "+this.opacity+";":"",b=this.visible?"":" visibility: hidden;";return[a,this.getSvgFilter(),b].join("")},toClipPathSVG:function(a){for(var b=[],c=0,d=this._objects.length;c<d;c++)b.push("	",this._objects[c].toClipPathSVG(a));return this._createBaseClipPathSVGMarkup(b,{reviver:a})}}),b.Group.fromObject=function(a,c){var d=a.objects,e=b.util.object.clone(a,!0);(delete e.objects,"string"==typeof d)?b.loadSVGFromURL(d,function(f){var g=b.util.groupSVGElements(f,a,d),h=e.clipPath;delete e.clipPath,g.set(e),h?b.util.enlivenObjects([h],function(a){g.clipPath=a[0],c&&c(g)}):c&&c(g)}):b.util.enlivenObjects(d,function(d){b.util.enlivenObjectEnlivables(a,e,function(){c&&c(new b.Group(d,e,!0))})})})}(c),function(a){"use strict";var b=a.fabric||(a.fabric={});b.ActiveSelection||(b.ActiveSelection=b.util.createClass(b.Group,{type:"activeSelection",initialize:function(a,c){c=c||{},this._objects=a||[];for(var d=this._objects.length;d--;)this._objects[d].group=this;c.originX&&(this.originX=c.originX),c.originY&&(this.originY=c.originY),this._calcBounds(),this._updateObjectsCoords(),b.Object.prototype.initialize.call(this,c),this.setCoords()},toGroup:function(){var a=this._objects.concat();this._objects=[];var c=b.Object.prototype.toObject.call(this),d=new b.Group([]);if(delete c.type,d.set(c),a.forEach(function(a){a.canvas.remove(a),a.group=d}),d._objects=a,!this.canvas)return d;var e=this.canvas;return e.add(d),e._activeObject=d,d.setCoords(),d},onDeselect:function(){return this.destroy(),!1},toString:function(){return"#<fabric.ActiveSelection: ("+this.complexity()+")>"},shouldCache:function(){return!1},isOnACache:function(){return!1},_renderControls:function(a,b,c){a.save(),a.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1,void 0===(c=c||{}).hasControls&&(c.hasControls=!1),c.forActiveSelection=!0;for(var d=0,e=this._objects.length;d<e;d++)this._objects[d]._renderControls(a,c);this.callSuper("_renderControls",a,b),a.restore()}}),b.ActiveSelection.fromObject=function(a,c){b.util.enlivenObjects(a.objects,function(d){delete a.objects,c&&c(new b.ActiveSelection(d,a,!0))})})}(c),function(a){"use strict";var b=H.util.object.extend;if(a.fabric||(a.fabric={}),a.fabric.Image)return H.warn("fabric.Image is already defined.");H.Image=H.util.createClass(H.Object,{type:"image",strokeWidth:0,srcFromAttribute:!1,_lastScaleX:1,_lastScaleY:1,_filterScalingX:1,_filterScalingY:1,minimumScaleTrigger:.5,stateProperties:H.Object.prototype.stateProperties.concat("cropX","cropY"),cacheProperties:H.Object.prototype.cacheProperties.concat("cropX","cropY"),cacheKey:"",cropX:0,cropY:0,imageSmoothing:!0,initialize:function(a,b){b||(b={}),this.filters=[],this.cacheKey="texture"+H.Object.__uid++,this.callSuper("initialize",b),this._initElement(a,b)},getElement:function(){return this._element||{}},setElement:function(a,b){return this.removeTexture(this.cacheKey),this.removeTexture(this.cacheKey+"_filtered"),this._element=a,this._originalElement=a,this._initConfig(b),0!==this.filters.length&&this.applyFilters(),this.resizeFilter&&this.applyResizeFilters(),this},removeTexture:function(a){var b=H.filterBackend;b&&b.evictCachesForKey&&b.evictCachesForKey(a)},dispose:function(){this.callSuper("dispose"),this.removeTexture(this.cacheKey),this.removeTexture(this.cacheKey+"_filtered"),this._cacheContext=void 0,["_originalElement","_element","_filteredEl","_cacheCanvas"].forEach((function(a){H.util.cleanUpJsdomNode(this[a]),this[a]=void 0}).bind(this))},getCrossOrigin:function(){return this._originalElement&&(this._originalElement.crossOrigin||null)},getOriginalSize:function(){var a=this.getElement();return{width:a.naturalWidth||a.width,height:a.naturalHeight||a.height}},_stroke:function(a){if(this.stroke&&0!==this.strokeWidth){var b=this.width/2,c=this.height/2;a.beginPath(),a.moveTo(-b,-c),a.lineTo(b,-c),a.lineTo(b,c),a.lineTo(-b,c),a.lineTo(-b,-c),a.closePath()}},toObject:function(a){var c=[];this.filters.forEach(function(a){a&&c.push(a.toObject())});var d=b(this.callSuper("toObject",["cropX","cropY"].concat(a)),{src:this.getSrc(),crossOrigin:this.getCrossOrigin(),filters:c});return this.resizeFilter&&(d.resizeFilter=this.resizeFilter.toObject()),d},hasCrop:function(){return this.cropX||this.cropY||this.width<this._element.width||this.height<this._element.height},_toSVG:function(){var a,b=[],c=[],d=this._element,e=-this.width/2,f=-this.height/2,g="",h="";if(!d)return[];if(this.hasCrop()){var i=H.Object.__uid++;b.push('<clipPath id="imageCrop_'+i+'">\n','	<rect x="'+e+'" y="'+f+'" width="'+this.width+'" height="'+this.height+'" />\n',"</clipPath>\n"),g=' clip-path="url(#imageCrop_'+i+')" '}if(this.imageSmoothing||(h='" image-rendering="optimizeSpeed'),c.push("	<image ","COMMON_PARTS",'xlink:href="',this.getSvgSrc(!0),'" x="',e-this.cropX,'" y="',f-this.cropY,'" width="',d.width||d.naturalWidth,'" height="',d.height||d.height,h,'"',g,"></image>\n"),this.stroke||this.strokeDashArray){var j=this.fill;this.fill=null,a=["	<rect ",'x="',e,'" y="',f,'" width="',this.width,'" height="',this.height,'" style="',this.getSvgStyles(),'"/>\n'],this.fill=j}return"fill"!==this.paintFirst?b.concat(a,c):b.concat(c,a)},getSrc:function(a){var b=a?this._element:this._originalElement;return b?b.toDataURL?b.toDataURL():this.srcFromAttribute?b.getAttribute("src"):b.src:this.src||""},setSrc:function(a,b,c){return H.util.loadImage(a,function(a,d){this.setElement(a,c),this._setWidthHeight(),b&&b(this,d)},this,c&&c.crossOrigin),this},toString:function(){return'#<fabric.Image: { src: "'+this.getSrc()+'" }>'},applyResizeFilters:function(){var a=this.resizeFilter,b=this.minimumScaleTrigger,c=this.getTotalObjectScaling(),d=c.scaleX,e=c.scaleY,f=this._filteredEl||this._originalElement;if(this.group&&this.set("dirty",!0),!a||d>b&&e>b){this._element=f,this._filterScalingX=1,this._filterScalingY=1,this._lastScaleX=d,this._lastScaleY=e;return}H.filterBackend||(H.filterBackend=H.initFilterBackend());var g=H.util.createCanvasElement(),h=this._filteredEl?this.cacheKey+"_filtered":this.cacheKey,i=f.width,j=f.height;g.width=i,g.height=j,this._element=g,this._lastScaleX=a.scaleX=d,this._lastScaleY=a.scaleY=e,H.filterBackend.applyFilters([a],f,i,j,this._element,h),this._filterScalingX=g.width/this._originalElement.width,this._filterScalingY=g.height/this._originalElement.height},applyFilters:function(a){if(a=(a=a||this.filters||[]).filter(function(a){return a&&!a.isNeutralState()}),this.set("dirty",!0),this.removeTexture(this.cacheKey+"_filtered"),0===a.length)return this._element=this._originalElement,this._filteredEl=null,this._filterScalingX=1,this._filterScalingY=1,this;var b=this._originalElement,c=b.naturalWidth||b.width,d=b.naturalHeight||b.height;if(this._element===this._originalElement){var e=H.util.createCanvasElement();e.width=c,e.height=d,this._element=e,this._filteredEl=e}else this._element=this._filteredEl,this._filteredEl.getContext("2d").clearRect(0,0,c,d),this._lastScaleX=1,this._lastScaleY=1;return H.filterBackend||(H.filterBackend=H.initFilterBackend()),H.filterBackend.applyFilters(a,this._originalElement,c,d,this._element,this.cacheKey),(this._originalElement.width!==this._element.width||this._originalElement.height!==this._element.height)&&(this._filterScalingX=this._element.width/this._originalElement.width,this._filterScalingY=this._element.height/this._originalElement.height),this},_render:function(a){H.util.setImageSmoothing(a,this.imageSmoothing),!0!==this.isMoving&&this.resizeFilter&&this._needsResize()&&this.applyResizeFilters(),this._stroke(a),this._renderPaintInOrder(a)},drawCacheOnCanvas:function(a){H.util.setImageSmoothing(a,this.imageSmoothing),H.Object.prototype.drawCacheOnCanvas.call(this,a)},shouldCache:function(){return this.needsItsOwnCache()},_renderFill:function(a){var b=this._element;if(b){var c=this._filterScalingX,d=this._filterScalingY,e=this.width,f=this.height,g=Math.min,h=Math.max,i=h(this.cropX,0),j=h(this.cropY,0),k=b.naturalWidth||b.width,l=b.naturalHeight||b.height,m=i*c,n=j*d,o=g(e*c,k-m),p=g(f*d,l-n),q=-e/2,r=-f/2,s=g(e,k/c-i),t=g(f,l/d-j);b&&a.drawImage(b,m,n,o,p,q,r,s,t)}},_needsResize:function(){var a=this.getTotalObjectScaling();return a.scaleX!==this._lastScaleX||a.scaleY!==this._lastScaleY},_resetWidthHeight:function(){this.set(this.getOriginalSize())},_initElement:function(a,b){this.setElement(H.util.getById(a),b),H.util.addClass(this.getElement(),H.Image.CSS_CANVAS)},_initConfig:function(a){a||(a={}),this.setOptions(a),this._setWidthHeight(a)},_initFilters:function(a,b){a&&a.length?H.util.enlivenObjects(a,function(a){b&&b(a)},"fabric.Image.filters"):b&&b()},_setWidthHeight:function(a){a||(a={});var b=this.getElement();this.width=a.width||b.naturalWidth||b.width||0,this.height=a.height||b.naturalHeight||b.height||0},parsePreserveAspectRatioAttribute:function(){var a,b=H.util.parsePreserveAspectRatioAttribute(this.preserveAspectRatio||""),c=this._element.width,d=this._element.height,e=1,f=1,g=0,h=0,i=0,j=0,k=this.width,l=this.height,m={width:k,height:l};return b&&("none"!==b.alignX||"none"!==b.alignY)?("meet"===b.meetOrSlice&&(a=(k-c*(e=f=H.util.findScaleToFit(this._element,m)))/2,"Min"===b.alignX&&(g=-a),"Max"===b.alignX&&(g=a),a=(l-d*f)/2,"Min"===b.alignY&&(h=-a),"Max"===b.alignY&&(h=a)),"slice"===b.meetOrSlice&&(a=c-k/(e=f=H.util.findScaleToCover(this._element,m)),"Mid"===b.alignX&&(i=a/2),"Max"===b.alignX&&(i=a),a=d-l/f,"Mid"===b.alignY&&(j=a/2),"Max"===b.alignY&&(j=a),c=k/e,d=l/f)):(e=k/c,f=l/d),{width:c,height:d,scaleX:e,scaleY:f,offsetLeft:g,offsetTop:h,cropX:i,cropY:j}}}),H.Image.CSS_CANVAS="canvas-img",H.Image.prototype.getSvgSrc=H.Image.prototype.getSrc,H.Image.fromObject=function(a,b){var c=H.util.object.clone(a);H.util.loadImage(c.src,function(a,d){if(d){b&&b(null,!0);return}H.Image.prototype._initFilters.call(c,c.filters,function(d){c.filters=d||[],H.Image.prototype._initFilters.call(c,[c.resizeFilter],function(d){c.resizeFilter=d[0],H.util.enlivenObjectEnlivables(c,c,function(){b(new H.Image(a,c),!1)})})})},null,c.crossOrigin)},H.Image.fromURL=function(a,b,c){H.util.loadImage(a,function(a,d){b&&b(new H.Image(a,c),d)},null,c&&c.crossOrigin)},H.Image.ATTRIBUTE_NAMES=H.SHARED_ATTRIBUTES.concat("x y width height preserveAspectRatio xlink:href crossOrigin image-rendering".split(" ")),H.Image.fromElement=function(a,c,d){var e=H.parseAttributes(a,H.Image.ATTRIBUTE_NAMES);H.Image.fromURL(e["xlink:href"],c,b(d?H.util.object.clone(d):{},e))}}(c),H.util.object.extend(H.Object.prototype,{_getAngleValueForStraighten:function(){var a=this.angle%360;return a>0?90*Math.round((a-1)/90):90*Math.round(a/90)},straighten:function(){return this.rotate(this._getAngleValueForStraighten())},fxStraighten:function(a){var b=function(){},c=(a=a||{}).onComplete||b,d=a.onChange||b,e=this;return H.util.animate({target:this,startValue:this.get("angle"),endValue:this._getAngleValueForStraighten(),duration:this.FX_DURATION,onChange:function(a){e.rotate(a),d()},onComplete:function(){e.setCoords(),c()}})}}),H.util.object.extend(H.StaticCanvas.prototype,{straightenObject:function(a){return a.straighten(),this.requestRenderAll(),this},fxStraightenObject:function(a){return a.fxStraighten({onChange:this.requestRenderAllBound})}}),function(){"use strict";function a(a){a&&a.tileSize&&(this.tileSize=a.tileSize),this.setupGLContext(this.tileSize,this.tileSize),this.captureGPUInfo()}H.isWebglSupported=function(a){if(H.isLikelyNode)return!1;a=a||H.WebglFilterBackend.prototype.tileSize;var b=document.createElement("canvas"),c=b.getContext("webgl")||b.getContext("experimental-webgl"),d=!1;if(c){H.maxTextureSize=c.getParameter(c.MAX_TEXTURE_SIZE),d=H.maxTextureSize>=a;for(var e=["highp","mediump","lowp"],f=0;f<3;f++)if(function(a,b){var c=a.createShader(a.FRAGMENT_SHADER);return a.shaderSource(c,"precision "+b+" float;\nvoid main(){}"),a.compileShader(c),!!a.getShaderParameter(c,a.COMPILE_STATUS)}(c,e[f])){H.webGlPrecision=e[f];break}}return this.isSupported=d,d},H.WebglFilterBackend=a,a.prototype={tileSize:2048,resources:{},setupGLContext:function(a,b){this.dispose(),this.createWebGLCanvas(a,b),this.aPosition=new Float32Array([0,0,0,1,1,0,1,1]),this.chooseFastestCopyGLTo2DMethod(a,b)},chooseFastestCopyGLTo2DMethod:function(a,b){var c,d,e,f=void 0!==window.performance;try{new ImageData(1,1),e=!0}catch(a){e=!1}var g="u">typeof ArrayBuffer,h="u">typeof Uint8ClampedArray;if(f&&e&&g&&h){var i=H.util.createCanvasElement(),j=new ArrayBuffer(a*b*4);if(H.forceGLPutImageData){this.imageBuffer=j,this.copyGLTo2D=ag;return}var k={imageBuffer:j,destinationWidth:a,destinationHeight:b,targetCanvas:i};i.width=a,i.height=b,c=window.performance.now(),af.call(k,this.gl,k),d=window.performance.now()-c,c=window.performance.now(),ag.call(k,this.gl,k),d>window.performance.now()-c?(this.imageBuffer=j,this.copyGLTo2D=ag):this.copyGLTo2D=af}},createWebGLCanvas:function(a,b){var c=H.util.createCanvasElement();c.width=a,c.height=b;var d={alpha:!0,premultipliedAlpha:!1,depth:!1,stencil:!1,antialias:!1},e=c.getContext("webgl",d);e||(e=c.getContext("experimental-webgl",d)),e&&(e.clearColor(0,0,0,0),this.canvas=c,this.gl=e)},applyFilters:function(a,b,c,d,e,f){var g,h,i,j,k,l,m,n=this.gl;f&&(m=this.getCachedTexture(f,b));var o={originalWidth:b.width||b.originalWidth,originalHeight:b.height||b.originalHeight,sourceWidth:c,sourceHeight:d,destinationWidth:c,destinationHeight:d,context:n,sourceTexture:this.createTexture(n,c,d,!m&&b),targetTexture:this.createTexture(n,c,d),originalTexture:m||this.createTexture(n,c,d,!m&&b),passes:a.length,webgl:!0,aPosition:this.aPosition,programCache:this.programCache,pass:0,filterBackend:this,targetCanvas:e},p=n.createFramebuffer();return n.bindFramebuffer(n.FRAMEBUFFER,p),a.forEach(function(a){a&&a.applyTo(o)}),i=(h=(g=o).targetCanvas).width,j=h.height,k=g.destinationWidth,l=g.destinationHeight,(i!==k||j!==l)&&(h.width=k,h.height=l),this.copyGLTo2D(n,o),n.bindTexture(n.TEXTURE_2D,null),n.deleteTexture(o.sourceTexture),n.deleteTexture(o.targetTexture),n.deleteFramebuffer(p),e.getContext("2d").setTransform(1,0,0,1,0,0),o},dispose:function(){this.canvas&&(this.canvas=null,this.gl=null),this.clearWebGLCaches()},clearWebGLCaches:function(){this.programCache={},this.textureCache={}},createTexture:function(a,b,c,d,e){var f=a.createTexture();return a.bindTexture(a.TEXTURE_2D,f),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,e||a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,e||a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),d?a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,d):a.texImage2D(a.TEXTURE_2D,0,a.RGBA,b,c,0,a.RGBA,a.UNSIGNED_BYTE,null),f},getCachedTexture:function(a,b){if(this.textureCache[a])return this.textureCache[a];var c=this.createTexture(this.gl,b.width,b.height,b);return this.textureCache[a]=c,c},evictCachesForKey:function(a){this.textureCache[a]&&(this.gl.deleteTexture(this.textureCache[a]),delete this.textureCache[a])},copyGLTo2D:af,captureGPUInfo:function(){if(this.gpuInfo)return this.gpuInfo;var a=this.gl,b={renderer:"",vendor:""};if(!a)return b;var c=a.getExtension("WEBGL_debug_renderer_info");if(c){var d=a.getParameter(c.UNMASKED_RENDERER_WEBGL),e=a.getParameter(c.UNMASKED_VENDOR_WEBGL);d&&(b.renderer=d.toLowerCase()),e&&(b.vendor=e.toLowerCase())}return this.gpuInfo=b,b}}}(),!function(){"use strict";var a=function(){};function b(){}H.Canvas2dFilterBackend=b,b.prototype={evictCachesForKey:a,dispose:a,clearWebGLCaches:a,resources:{},applyFilters:function(a,b,c,d,e){var f=e.getContext("2d");f.drawImage(b,0,0,c,d);var g=f.getImageData(0,0,c,d),h=f.getImageData(0,0,c,d),i={sourceWidth:c,sourceHeight:d,imageData:g,originalEl:b,originalImageData:h,canvasEl:e,ctx:f,filterBackend:this};return a.forEach(function(a){a.applyTo(i)}),(i.imageData.width!==c||i.imageData.height!==d)&&(e.width=i.imageData.width,e.height=i.imageData.height),f.putImageData(i.imageData,0,0),i}}}(),H.Image=H.Image||{},H.Image.filters=H.Image.filters||{},H.Image.filters.BaseFilter=H.util.createClass({type:"BaseFilter",vertexSource:"attribute vec2 aPosition;\nvarying vec2 vTexCoord;\nvoid main() {\nvTexCoord = aPosition;\ngl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);\n}",fragmentSource:"precision highp float;\nvarying vec2 vTexCoord;\nuniform sampler2D uTexture;\nvoid main() {\ngl_FragColor = texture2D(uTexture, vTexCoord);\n}",initialize:function(a){a&&this.setOptions(a)},setOptions:function(a){for(var b in a)this[b]=a[b]},createProgram:function(a,b,c){b=b||this.fragmentSource,c=c||this.vertexSource,"highp"!==H.webGlPrecision&&(b=b.replace(/precision highp float/g,"precision "+H.webGlPrecision+" float"));var d=a.createShader(a.VERTEX_SHADER);if(a.shaderSource(d,c),a.compileShader(d),!a.getShaderParameter(d,a.COMPILE_STATUS))throw Error("Vertex shader compile error for "+this.type+": "+a.getShaderInfoLog(d));var e=a.createShader(a.FRAGMENT_SHADER);if(a.shaderSource(e,b),a.compileShader(e),!a.getShaderParameter(e,a.COMPILE_STATUS))throw Error("Fragment shader compile error for "+this.type+": "+a.getShaderInfoLog(e));var f=a.createProgram();if(a.attachShader(f,d),a.attachShader(f,e),a.linkProgram(f),!a.getProgramParameter(f,a.LINK_STATUS))throw Error('Shader link error for "${this.type}" '+a.getProgramInfoLog(f));var g=this.getAttributeLocations(a,f),h=this.getUniformLocations(a,f)||{};return h.uStepW=a.getUniformLocation(f,"uStepW"),h.uStepH=a.getUniformLocation(f,"uStepH"),{program:f,attributeLocations:g,uniformLocations:h}},getAttributeLocations:function(a,b){return{aPosition:a.getAttribLocation(b,"aPosition")}},getUniformLocations:function(){return{}},sendAttributeData:function(a,b,c){var d=b.aPosition,e=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,e),a.enableVertexAttribArray(d),a.vertexAttribPointer(d,2,a.FLOAT,!1,0,0),a.bufferData(a.ARRAY_BUFFER,c,a.STATIC_DRAW)},_setupFrameBuffer:function(a){var b,c,d=a.context;a.passes>1?(b=a.destinationWidth,c=a.destinationHeight,(a.sourceWidth!==b||a.sourceHeight!==c)&&(d.deleteTexture(a.targetTexture),a.targetTexture=a.filterBackend.createTexture(d,b,c)),d.framebufferTexture2D(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.TEXTURE_2D,a.targetTexture,0)):(d.bindFramebuffer(d.FRAMEBUFFER,null),d.finish())},_swapTextures:function(a){a.passes--,a.pass++;var b=a.targetTexture;a.targetTexture=a.sourceTexture,a.sourceTexture=b},isNeutralState:function(){var a=this.mainParameter,b=H.Image.filters[this.type].prototype;if(!a)return!1;if(!Array.isArray(b[a]))return b[a]===this[a];for(var c=b[a].length;c--;)if(this[a][c]!==b[a][c])return!1;return!0},applyTo:function(a){a.webgl?(this._setupFrameBuffer(a),this.applyToWebGL(a),this._swapTextures(a)):this.applyTo2d(a)},retrieveShader:function(a){return a.programCache.hasOwnProperty(this.type)||(a.programCache[this.type]=this.createProgram(a.context)),a.programCache[this.type]},applyToWebGL:function(a){var b=a.context,c=this.retrieveShader(a);0===a.pass&&a.originalTexture?b.bindTexture(b.TEXTURE_2D,a.originalTexture):b.bindTexture(b.TEXTURE_2D,a.sourceTexture),b.useProgram(c.program),this.sendAttributeData(b,c.attributeLocations,a.aPosition),b.uniform1f(c.uniformLocations.uStepW,1/a.sourceWidth),b.uniform1f(c.uniformLocations.uStepH,1/a.sourceHeight),this.sendUniformData(b,c.uniformLocations),b.viewport(0,0,a.destinationWidth,a.destinationHeight),b.drawArrays(b.TRIANGLE_STRIP,0,4)},bindAdditionalTexture:function(a,b,c){a.activeTexture(c),a.bindTexture(a.TEXTURE_2D,b),a.activeTexture(a.TEXTURE0)},unbindAdditionalTexture:function(a,b){a.activeTexture(b),a.bindTexture(a.TEXTURE_2D,null),a.activeTexture(a.TEXTURE0)},getMainParameter:function(){return this[this.mainParameter]},setMainParameter:function(a){this[this.mainParameter]=a},sendUniformData:function(){},createHelpLayer:function(a){if(!a.helpLayer){var b=document.createElement("canvas");b.width=a.sourceWidth,b.height=a.sourceHeight,a.helpLayer=b}},toObject:function(){var a={type:this.type},b=this.mainParameter;return b&&(a[b]=this[b]),a},toJSON:function(){return this.toObject()}}),H.Image.filters.BaseFilter.fromObject=function(a,b){var c=new H.Image.filters[a.type](a);return b&&b(c),c},function(a){"use strict";var b=a.fabric||(a.fabric={}),c=b.Image.filters;c.ColorMatrix=(0,b.util.createClass)(c.BaseFilter,{type:"ColorMatrix",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nvarying vec2 vTexCoord;\nuniform mat4 uColorMatrix;\nuniform vec4 uConstants;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\ncolor *= uColorMatrix;\ncolor += uConstants;\ngl_FragColor = color;\n}",matrix:[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],mainParameter:"matrix",colorsOnly:!0,initialize:function(a){this.callSuper("initialize",a),this.matrix=this.matrix.slice(0)},applyTo2d:function(a){var b,c,d,e,f,g=a.imageData.data,h=g.length,i=this.matrix,j=this.colorsOnly;for(f=0;f<h;f+=4)b=g[f],c=g[f+1],d=g[f+2],j?(g[f]=b*i[0]+c*i[1]+d*i[2]+255*i[4],g[f+1]=b*i[5]+c*i[6]+d*i[7]+255*i[9],g[f+2]=b*i[10]+c*i[11]+d*i[12]+255*i[14]):(e=g[f+3],g[f]=b*i[0]+c*i[1]+d*i[2]+e*i[3]+255*i[4],g[f+1]=b*i[5]+c*i[6]+d*i[7]+e*i[8]+255*i[9],g[f+2]=b*i[10]+c*i[11]+d*i[12]+e*i[13]+255*i[14],g[f+3]=b*i[15]+c*i[16]+d*i[17]+e*i[18]+255*i[19])},getUniformLocations:function(a,b){return{uColorMatrix:a.getUniformLocation(b,"uColorMatrix"),uConstants:a.getUniformLocation(b,"uConstants")}},sendUniformData:function(a,b){var c=this.matrix,d=[c[0],c[1],c[2],c[3],c[5],c[6],c[7],c[8],c[10],c[11],c[12],c[13],c[15],c[16],c[17],c[18]],e=[c[4],c[9],c[14],c[19]];a.uniformMatrix4fv(b.uColorMatrix,!1,d),a.uniform4fv(b.uConstants,e)}}),b.Image.filters.ColorMatrix.fromObject=b.Image.filters.BaseFilter.fromObject}(c),function(a){"use strict";var b=a.fabric||(a.fabric={}),c=b.Image.filters;c.Brightness=(0,b.util.createClass)(c.BaseFilter,{type:"Brightness",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uBrightness;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\ncolor.rgb += uBrightness;\ngl_FragColor = color;\n}",brightness:0,mainParameter:"brightness",applyTo2d:function(a){if(0!==this.brightness){var b,c=a.imageData.data,d=c.length,e=Math.round(255*this.brightness);for(b=0;b<d;b+=4)c[b]=c[b]+e,c[b+1]=c[b+1]+e,c[b+2]=c[b+2]+e}},getUniformLocations:function(a,b){return{uBrightness:a.getUniformLocation(b,"uBrightness")}},sendUniformData:function(a,b){a.uniform1f(b.uBrightness,this.brightness)}}),b.Image.filters.Brightness.fromObject=b.Image.filters.BaseFilter.fromObject}(c),function(a){"use strict";var b=a.fabric||(a.fabric={}),c=b.util.object.extend,d=b.Image.filters;d.Convolute=(0,b.util.createClass)(d.BaseFilter,{type:"Convolute",opaque:!1,matrix:[0,0,0,0,1,0,0,0,0],fragmentSource:{Convolute_3_1:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[9];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 0);\nfor (float h = 0.0; h < 3.0; h+=1.0) {\nfor (float w = 0.0; w < 3.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 1), uStepH * (h - 1));\ncolor += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 3.0 + w)];\n}\n}\ngl_FragColor = color;\n}",Convolute_3_0:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[9];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 1);\nfor (float h = 0.0; h < 3.0; h+=1.0) {\nfor (float w = 0.0; w < 3.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 1.0), uStepH * (h - 1.0));\ncolor.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 3.0 + w)];\n}\n}\nfloat alpha = texture2D(uTexture, vTexCoord).a;\ngl_FragColor = color;\ngl_FragColor.a = alpha;\n}",Convolute_5_1:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[25];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 0);\nfor (float h = 0.0; h < 5.0; h+=1.0) {\nfor (float w = 0.0; w < 5.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));\ncolor += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 5.0 + w)];\n}\n}\ngl_FragColor = color;\n}",Convolute_5_0:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[25];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 1);\nfor (float h = 0.0; h < 5.0; h+=1.0) {\nfor (float w = 0.0; w < 5.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));\ncolor.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 5.0 + w)];\n}\n}\nfloat alpha = texture2D(uTexture, vTexCoord).a;\ngl_FragColor = color;\ngl_FragColor.a = alpha;\n}",Convolute_7_1:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[49];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 0);\nfor (float h = 0.0; h < 7.0; h+=1.0) {\nfor (float w = 0.0; w < 7.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));\ncolor += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 7.0 + w)];\n}\n}\ngl_FragColor = color;\n}",Convolute_7_0:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[49];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 1);\nfor (float h = 0.0; h < 7.0; h+=1.0) {\nfor (float w = 0.0; w < 7.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));\ncolor.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 7.0 + w)];\n}\n}\nfloat alpha = texture2D(uTexture, vTexCoord).a;\ngl_FragColor = color;\ngl_FragColor.a = alpha;\n}",Convolute_9_1:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[81];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 0);\nfor (float h = 0.0; h < 9.0; h+=1.0) {\nfor (float w = 0.0; w < 9.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));\ncolor += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 9.0 + w)];\n}\n}\ngl_FragColor = color;\n}",Convolute_9_0:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[81];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 1);\nfor (float h = 0.0; h < 9.0; h+=1.0) {\nfor (float w = 0.0; w < 9.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));\ncolor.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 9.0 + w)];\n}\n}\nfloat alpha = texture2D(uTexture, vTexCoord).a;\ngl_FragColor = color;\ngl_FragColor.a = alpha;\n}"},retrieveShader:function(a){var b=Math.sqrt(this.matrix.length),c=this.type+"_"+b+"_"+ +!!this.opaque,d=this.fragmentSource[c];return a.programCache.hasOwnProperty(c)||(a.programCache[c]=this.createProgram(a.context,d)),a.programCache[c]},applyTo2d:function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o=a.imageData,p=o.data,q=this.matrix,r=Math.round(Math.sqrt(q.length)),s=Math.floor(r/2),t=o.width,u=o.height,v=a.ctx.createImageData(t,u),w=v.data,x=+!!this.opaque;for(l=0;l<u;l++)for(k=0;k<t;k++){for(n=0,f=(l*t+k)*4,b=0,c=0,d=0,e=0;n<r;n++)for(m=0;m<r;m++)h=l+n-s,g=k+m-s,h<0||h>=u||g<0||g>=t||(i=(h*t+g)*4,j=q[n*r+m],b+=p[i]*j,c+=p[i+1]*j,d+=p[i+2]*j,x||(e+=p[i+3]*j));w[f]=b,w[f+1]=c,w[f+2]=d,x?w[f+3]=p[f+3]:w[f+3]=e}a.imageData=v},getUniformLocations:function(a,b){return{uMatrix:a.getUniformLocation(b,"uMatrix"),uOpaque:a.getUniformLocation(b,"uOpaque"),uHalfSize:a.getUniformLocation(b,"uHalfSize"),uSize:a.getUniformLocation(b,"uSize")}},sendUniformData:function(a,b){a.uniform1fv(b.uMatrix,this.matrix)},toObject:function(){return c(this.callSuper("toObject"),{opaque:this.opaque,matrix:this.matrix})}}),b.Image.filters.Convolute.fromObject=b.Image.filters.BaseFilter.fromObject}(c),function(a){"use strict";var b=a.fabric||(a.fabric={}),c=b.Image.filters;c.Grayscale=(0,b.util.createClass)(c.BaseFilter,{type:"Grayscale",fragmentSource:{average:"precision highp float;\nuniform sampler2D uTexture;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nfloat average = (color.r + color.b + color.g) / 3.0;\ngl_FragColor = vec4(average, average, average, color.a);\n}",lightness:"precision highp float;\nuniform sampler2D uTexture;\nuniform int uMode;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 col = texture2D(uTexture, vTexCoord);\nfloat average = (max(max(col.r, col.g),col.b) + min(min(col.r, col.g),col.b)) / 2.0;\ngl_FragColor = vec4(average, average, average, col.a);\n}",luminosity:"precision highp float;\nuniform sampler2D uTexture;\nuniform int uMode;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 col = texture2D(uTexture, vTexCoord);\nfloat average = 0.21 * col.r + 0.72 * col.g + 0.07 * col.b;\ngl_FragColor = vec4(average, average, average, col.a);\n}"},mode:"average",mainParameter:"mode",applyTo2d:function(a){var b,c,d=a.imageData.data,e=d.length,f=this.mode;for(b=0;b<e;b+=4)"average"===f?c=(d[b]+d[b+1]+d[b+2])/3:"lightness"===f?c=(Math.min(d[b],d[b+1],d[b+2])+Math.max(d[b],d[b+1],d[b+2]))/2:"luminosity"===f&&(c=.21*d[b]+.72*d[b+1]+.07*d[b+2]),d[b]=c,d[b+1]=c,d[b+2]=c},retrieveShader:function(a){var b=this.type+"_"+this.mode;if(!a.programCache.hasOwnProperty(b)){var c=this.fragmentSource[this.mode];a.programCache[b]=this.createProgram(a.context,c)}return a.programCache[b]},getUniformLocations:function(a,b){return{uMode:a.getUniformLocation(b,"uMode")}},sendUniformData:function(a,b){a.uniform1i(b.uMode,1)},isNeutralState:function(){return!1}}),b.Image.filters.Grayscale.fromObject=b.Image.filters.BaseFilter.fromObject}(c),function(a){"use strict";var b=a.fabric||(a.fabric={}),c=b.Image.filters;c.Invert=(0,b.util.createClass)(c.BaseFilter,{type:"Invert",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform int uInvert;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nif (uInvert == 1) {\ngl_FragColor = vec4(1.0 - color.r,1.0 -color.g,1.0 -color.b,color.a);\n} else {\ngl_FragColor = color;\n}\n}",invert:!0,mainParameter:"invert",applyTo2d:function(a){var b,c=a.imageData.data,d=c.length;for(b=0;b<d;b+=4)c[b]=255-c[b],c[b+1]=255-c[b+1],c[b+2]=255-c[b+2]},isNeutralState:function(){return!this.invert},getUniformLocations:function(a,b){return{uInvert:a.getUniformLocation(b,"uInvert")}},sendUniformData:function(a,b){a.uniform1i(b.uInvert,this.invert)}}),b.Image.filters.Invert.fromObject=b.Image.filters.BaseFilter.fromObject}(c),function(a){"use strict";var b=a.fabric||(a.fabric={}),c=b.util.object.extend,d=b.Image.filters;d.Noise=(0,b.util.createClass)(d.BaseFilter,{type:"Noise",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uStepH;\nuniform float uNoise;\nuniform float uSeed;\nvarying vec2 vTexCoord;\nfloat rand(vec2 co, float seed, float vScale) {\nreturn fract(sin(dot(co.xy * vScale ,vec2(12.9898 , 78.233))) * 43758.5453 * (seed + 0.01) / 2.0);\n}\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\ncolor.rgb += (0.5 - rand(vTexCoord, uSeed, 0.1 / uStepH)) * uNoise;\ngl_FragColor = color;\n}",mainParameter:"noise",noise:0,applyTo2d:function(a){if(0!==this.noise){var b,c,d=a.imageData.data,e=d.length,f=this.noise;for(b=0,e=d.length;b<e;b+=4)c=(.5-Math.random())*f,d[b]+=c,d[b+1]+=c,d[b+2]+=c}},getUniformLocations:function(a,b){return{uNoise:a.getUniformLocation(b,"uNoise"),uSeed:a.getUniformLocation(b,"uSeed")}},sendUniformData:function(a,b){a.uniform1f(b.uNoise,this.noise/255),a.uniform1f(b.uSeed,Math.random())},toObject:function(){return c(this.callSuper("toObject"),{noise:this.noise})}}),b.Image.filters.Noise.fromObject=b.Image.filters.BaseFilter.fromObject}(c),function(a){"use strict";var b=a.fabric||(a.fabric={}),c=b.Image.filters;c.Pixelate=(0,b.util.createClass)(c.BaseFilter,{type:"Pixelate",blocksize:4,mainParameter:"blocksize",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uBlocksize;\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nfloat blockW = uBlocksize * uStepW;\nfloat blockH = uBlocksize * uStepW;\nint posX = int(vTexCoord.x / blockW);\nint posY = int(vTexCoord.y / blockH);\nfloat fposX = float(posX);\nfloat fposY = float(posY);\nvec2 squareCoords = vec2(fposX * blockW, fposY * blockH);\nvec4 color = texture2D(uTexture, squareCoords);\ngl_FragColor = color;\n}",applyTo2d:function(a){var b,c,d,e,f,g,h,i,j,k,l,m=a.imageData,n=m.data,o=m.height,p=m.width;for(c=0;c<o;c+=this.blocksize)for(d=0;d<p;d+=this.blocksize)for(e=n[b=4*c*p+4*d],f=n[b+1],g=n[b+2],h=n[b+3],k=Math.min(c+this.blocksize,o),l=Math.min(d+this.blocksize,p),i=c;i<k;i++)for(j=d;j<l;j++)n[b=4*i*p+4*j]=e,n[b+1]=f,n[b+2]=g,n[b+3]=h},isNeutralState:function(){return 1===this.blocksize},getUniformLocations:function(a,b){return{uBlocksize:a.getUniformLocation(b,"uBlocksize"),uStepW:a.getUniformLocation(b,"uStepW"),uStepH:a.getUniformLocation(b,"uStepH")}},sendUniformData:function(a,b){a.uniform1f(b.uBlocksize,this.blocksize)}}),b.Image.filters.Pixelate.fromObject=b.Image.filters.BaseFilter.fromObject}(c),function(a){"use strict";var b=a.fabric||(a.fabric={}),c=b.util.object.extend,d=b.Image.filters;d.RemoveColor=(0,b.util.createClass)(d.BaseFilter,{type:"RemoveColor",color:"#FFFFFF",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform vec4 uLow;\nuniform vec4 uHigh;\nvarying vec2 vTexCoord;\nvoid main() {\ngl_FragColor = texture2D(uTexture, vTexCoord);\nif(all(greaterThan(gl_FragColor.rgb,uLow.rgb)) && all(greaterThan(uHigh.rgb,gl_FragColor.rgb))) {\ngl_FragColor.a = 0.0;\n}\n}",distance:.02,useAlpha:!1,applyTo2d:function(a){var c,d,e,f,g=a.imageData.data,h=255*this.distance,i=new b.Color(this.color).getSource(),j=[i[0]-h,i[1]-h,i[2]-h],k=[i[0]+h,i[1]+h,i[2]+h];for(c=0;c<g.length;c+=4)d=g[c],e=g[c+1],f=g[c+2],d>j[0]&&e>j[1]&&f>j[2]&&d<k[0]&&e<k[1]&&f<k[2]&&(g[c+3]=0)},getUniformLocations:function(a,b){return{uLow:a.getUniformLocation(b,"uLow"),uHigh:a.getUniformLocation(b,"uHigh")}},sendUniformData:function(a,c){var d=new b.Color(this.color).getSource(),e=parseFloat(this.distance),f=[0+d[0]/255-e,0+d[1]/255-e,0+d[2]/255-e,1],g=[d[0]/255+e,d[1]/255+e,d[2]/255+e,1];a.uniform4fv(c.uLow,f),a.uniform4fv(c.uHigh,g)},toObject:function(){return c(this.callSuper("toObject"),{color:this.color,distance:this.distance})}}),b.Image.filters.RemoveColor.fromObject=b.Image.filters.BaseFilter.fromObject}(c),function(a){"use strict";var b=a.fabric||(a.fabric={}),c=b.Image.filters,d=b.util.createClass,e={Brownie:[.5997,.34553,-.27082,0,.186,-.0377,.86095,.15059,0,-.1449,.24113,-.07441,.44972,0,-.02965,0,0,0,1,0],Vintage:[.62793,.32021,-.03965,0,.03784,.02578,.64411,.03259,0,.02926,.0466,-.08512,.52416,0,.02023,0,0,0,1,0],Kodachrome:[1.12855,-.39673,-.03992,0,.24991,-.16404,1.08352,-.05498,0,.09698,-.16786,-.56034,1.60148,0,.13972,0,0,0,1,0],Technicolor:[1.91252,-.85453,-.09155,0,.04624,-.30878,1.76589,-.10601,0,-.27589,-.2311,-.75018,1.84759,0,.12137,0,0,0,1,0],Polaroid:[1.438,-.062,-.062,0,0,-.122,1.378,-.122,0,0,-.016,-.016,1.483,0,0,0,0,0,1,0],Sepia:[.393,.769,.189,0,0,.349,.686,.168,0,0,.272,.534,.131,0,0,0,0,0,1,0],BlackWhite:[1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,0,0,0,1,0]};for(var f in e)c[f]=d(c.ColorMatrix,{type:f,matrix:e[f],mainParameter:!1,colorsOnly:!0}),b.Image.filters[f].fromObject=b.Image.filters.BaseFilter.fromObject}(c),function(a){"use strict";var b=a.fabric,c=b.Image.filters;c.BlendColor=(0,b.util.createClass)(c.BaseFilter,{type:"BlendColor",color:"#F95C63",mode:"multiply",alpha:1,fragmentSource:{multiply:"gl_FragColor.rgb *= uColor.rgb;\n",screen:"gl_FragColor.rgb = 1.0 - (1.0 - gl_FragColor.rgb) * (1.0 - uColor.rgb);\n",add:"gl_FragColor.rgb += uColor.rgb;\n",diff:"gl_FragColor.rgb = abs(gl_FragColor.rgb - uColor.rgb);\n",subtract:"gl_FragColor.rgb -= uColor.rgb;\n",lighten:"gl_FragColor.rgb = max(gl_FragColor.rgb, uColor.rgb);\n",darken:"gl_FragColor.rgb = min(gl_FragColor.rgb, uColor.rgb);\n",exclusion:"gl_FragColor.rgb += uColor.rgb - 2.0 * (uColor.rgb * gl_FragColor.rgb);\n",overlay:"if (uColor.r < 0.5) {\ngl_FragColor.r *= 2.0 * uColor.r;\n} else {\ngl_FragColor.r = 1.0 - 2.0 * (1.0 - gl_FragColor.r) * (1.0 - uColor.r);\n}\nif (uColor.g < 0.5) {\ngl_FragColor.g *= 2.0 * uColor.g;\n} else {\ngl_FragColor.g = 1.0 - 2.0 * (1.0 - gl_FragColor.g) * (1.0 - uColor.g);\n}\nif (uColor.b < 0.5) {\ngl_FragColor.b *= 2.0 * uColor.b;\n} else {\ngl_FragColor.b = 1.0 - 2.0 * (1.0 - gl_FragColor.b) * (1.0 - uColor.b);\n}\n",tint:"gl_FragColor.rgb *= (1.0 - uColor.a);\ngl_FragColor.rgb += uColor.rgb;\n"},buildSource:function(a){return"precision highp float;\nuniform sampler2D uTexture;\nuniform vec4 uColor;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\ngl_FragColor = color;\nif (color.a > 0.0) {\n"+this.fragmentSource[a]+"}\n}"},retrieveShader:function(a){var b,c=this.type+"_"+this.mode;return a.programCache.hasOwnProperty(c)||(b=this.buildSource(this.mode),a.programCache[c]=this.createProgram(a.context,b)),a.programCache[c]},applyTo2d:function(a){var c,d,e,f,g,h,i,j=a.imageData.data,k=j.length,l=1-this.alpha;c=(i=new b.Color(this.color).getSource())[0]*this.alpha,d=i[1]*this.alpha,e=i[2]*this.alpha;for(var m=0;m<k;m+=4)switch(f=j[m],g=j[m+1],h=j[m+2],this.mode){case"multiply":j[m]=f*c/255,j[m+1]=g*d/255,j[m+2]=h*e/255;break;case"screen":j[m]=255-(255-f)*(255-c)/255,j[m+1]=255-(255-g)*(255-d)/255,j[m+2]=255-(255-h)*(255-e)/255;break;case"add":j[m]=f+c,j[m+1]=g+d,j[m+2]=h+e;break;case"diff":case"difference":j[m]=Math.abs(f-c),j[m+1]=Math.abs(g-d),j[m+2]=Math.abs(h-e);break;case"subtract":j[m]=f-c,j[m+1]=g-d,j[m+2]=h-e;break;case"darken":j[m]=Math.min(f,c),j[m+1]=Math.min(g,d),j[m+2]=Math.min(h,e);break;case"lighten":j[m]=Math.max(f,c),j[m+1]=Math.max(g,d),j[m+2]=Math.max(h,e);break;case"overlay":j[m]=c<128?2*f*c/255:255-2*(255-f)*(255-c)/255,j[m+1]=d<128?2*g*d/255:255-2*(255-g)*(255-d)/255,j[m+2]=e<128?2*h*e/255:255-2*(255-h)*(255-e)/255;break;case"exclusion":j[m]=c+f-2*c*f/255,j[m+1]=d+g-2*d*g/255,j[m+2]=e+h-2*e*h/255;break;case"tint":j[m]=c+f*l,j[m+1]=d+g*l,j[m+2]=e+h*l}},getUniformLocations:function(a,b){return{uColor:a.getUniformLocation(b,"uColor")}},sendUniformData:function(a,c){var d=new b.Color(this.color).getSource();d[0]=this.alpha*d[0]/255,d[1]=this.alpha*d[1]/255,d[2]=this.alpha*d[2]/255,d[3]=this.alpha,a.uniform4fv(c.uColor,d)},toObject:function(){return{type:this.type,color:this.color,mode:this.mode,alpha:this.alpha}}}),b.Image.filters.BlendColor.fromObject=b.Image.filters.BaseFilter.fromObject}(c),function(a){"use strict";var b=a.fabric,c=b.Image.filters;c.BlendImage=(0,b.util.createClass)(c.BaseFilter,{type:"BlendImage",image:null,mode:"multiply",alpha:1,vertexSource:"attribute vec2 aPosition;\nvarying vec2 vTexCoord;\nvarying vec2 vTexCoord2;\nuniform mat3 uTransformMatrix;\nvoid main() {\nvTexCoord = aPosition;\nvTexCoord2 = (uTransformMatrix * vec3(aPosition, 1.0)).xy;\ngl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);\n}",fragmentSource:{multiply:"precision highp float;\nuniform sampler2D uTexture;\nuniform sampler2D uImage;\nuniform vec4 uColor;\nvarying vec2 vTexCoord;\nvarying vec2 vTexCoord2;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nvec4 color2 = texture2D(uImage, vTexCoord2);\ncolor.rgba *= color2.rgba;\ngl_FragColor = color;\n}",mask:"precision highp float;\nuniform sampler2D uTexture;\nuniform sampler2D uImage;\nuniform vec4 uColor;\nvarying vec2 vTexCoord;\nvarying vec2 vTexCoord2;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nvec4 color2 = texture2D(uImage, vTexCoord2);\ncolor.a = color2.a;\ngl_FragColor = color;\n}"},retrieveShader:function(a){var b=this.type+"_"+this.mode,c=this.fragmentSource[this.mode];return a.programCache.hasOwnProperty(b)||(a.programCache[b]=this.createProgram(a.context,c)),a.programCache[b]},applyToWebGL:function(a){var b=a.context,c=this.createTexture(a.filterBackend,this.image);this.bindAdditionalTexture(b,c,b.TEXTURE1),this.callSuper("applyToWebGL",a),this.unbindAdditionalTexture(b,b.TEXTURE1)},createTexture:function(a,b){return a.getCachedTexture(b.cacheKey,b._element)},calculateMatrix:function(){var a=this.image,b=a._element.width,c=a._element.height;return[1/a.scaleX,0,0,0,1/a.scaleY,0,-a.left/b,-a.top/c,1]},applyTo2d:function(a){var c,d,e,f,g,h,i,j,k,l,m,n=a.imageData,o=a.filterBackend.resources,p=n.data,q=p.length,r=n.width,s=n.height,t=this.image;o.blendImage||(o.blendImage=b.util.createCanvasElement()),l=(k=o.blendImage).getContext("2d"),k.width!==r||k.height!==s?(k.width=r,k.height=s):l.clearRect(0,0,r,s),l.setTransform(t.scaleX,0,0,t.scaleY,t.left,t.top),l.drawImage(t._element,0,0,r,s),m=l.getImageData(0,0,r,s).data;for(var u=0;u<q;u+=4)switch(g=p[u],h=p[u+1],i=p[u+2],j=p[u+3],c=m[u],d=m[u+1],e=m[u+2],f=m[u+3],this.mode){case"multiply":p[u]=g*c/255,p[u+1]=h*d/255,p[u+2]=i*e/255,p[u+3]=j*f/255;break;case"mask":p[u+3]=f}},getUniformLocations:function(a,b){return{uTransformMatrix:a.getUniformLocation(b,"uTransformMatrix"),uImage:a.getUniformLocation(b,"uImage")}},sendUniformData:function(a,b){var c=this.calculateMatrix();a.uniform1i(b.uImage,1),a.uniformMatrix3fv(b.uTransformMatrix,!1,c)},toObject:function(){return{type:this.type,image:this.image&&this.image.toObject(),mode:this.mode,alpha:this.alpha}}}),b.Image.filters.BlendImage.fromObject=function(a,c){b.Image.fromObject(a.image,function(d){var e=b.util.object.clone(a);e.image=d,c(new b.Image.filters.BlendImage(e))})}}(c),function(a){"use strict";var b=a.fabric||(a.fabric={}),c=Math.pow,d=Math.floor,e=Math.sqrt,f=Math.abs,g=Math.round,h=Math.sin,i=Math.ceil,j=b.Image.filters;j.Resize=(0,b.util.createClass)(j.BaseFilter,{type:"Resize",resizeType:"hermite",scaleX:1,scaleY:1,lanczosLobes:3,getUniformLocations:function(a,b){return{uDelta:a.getUniformLocation(b,"uDelta"),uTaps:a.getUniformLocation(b,"uTaps")}},sendUniformData:function(a,b){a.uniform2fv(b.uDelta,this.horizontal?[1/this.width,0]:[0,1/this.height]),a.uniform1fv(b.uTaps,this.taps)},retrieveShader:function(a){var b=this.getFilterWindow(),c=this.type+"_"+b;if(!a.programCache.hasOwnProperty(c)){var d=this.generateShader(b);a.programCache[c]=this.createProgram(a.context,d)}return a.programCache[c]},getFilterWindow:function(){var a=this.tempScale;return Math.ceil(this.lanczosLobes/a)},getTaps:function(){for(var a=this.lanczosCreate(this.lanczosLobes),b=this.tempScale,c=this.getFilterWindow(),d=Array(c),e=1;e<=c;e++)d[e-1]=a(e*b);return d},generateShader:function(a){for(var b=Array(a),c=this.fragmentSourceTOP,d=1;d<=a;d++)b[d-1]=d+".0 * uDelta";return c+="uniform float uTaps["+a+"];\n",c+="void main() {\n",c+="  vec4 color = texture2D(uTexture, vTexCoord);\n",c+="  float sum = 1.0;\n",b.forEach(function(a,b){c+="  color += texture2D(uTexture, vTexCoord + "+a+") * uTaps["+b+"];\n",c+="  color += texture2D(uTexture, vTexCoord - "+a+") * uTaps["+b+"];\n",c+="  sum += 2.0 * uTaps["+b+"];\n"}),c+="  gl_FragColor = color / sum;\n",c+="}"},fragmentSourceTOP:"precision highp float;\nuniform sampler2D uTexture;\nuniform vec2 uDelta;\nvarying vec2 vTexCoord;\n",applyTo:function(a){a.webgl?(a.passes++,this.width=a.sourceWidth,this.horizontal=!0,this.dW=Math.round(this.width*this.scaleX),this.dH=a.sourceHeight,this.tempScale=this.dW/this.width,this.taps=this.getTaps(),a.destinationWidth=this.dW,this._setupFrameBuffer(a),this.applyToWebGL(a),this._swapTextures(a),a.sourceWidth=a.destinationWidth,this.height=a.sourceHeight,this.horizontal=!1,this.dH=Math.round(this.height*this.scaleY),this.tempScale=this.dH/this.height,this.taps=this.getTaps(),a.destinationHeight=this.dH,this._setupFrameBuffer(a),this.applyToWebGL(a),this._swapTextures(a),a.sourceHeight=a.destinationHeight):this.applyTo2d(a)},isNeutralState:function(){return 1===this.scaleX&&1===this.scaleY},lanczosCreate:function(a){return function(b){if(b>=a||b<=-a)return 0;if(b<11920929e-14&&b>-11920929e-14)return 1;var c=(b*=Math.PI)/a;return h(b)/b*h(c)/c}},applyTo2d:function(a){var b=a.imageData,c=this.scaleX,d=this.scaleY;this.rcpScaleX=1/c,this.rcpScaleY=1/d;var e,f=b.width,h=b.height,i=g(f*c),j=g(h*d);"sliceHack"===this.resizeType?e=this.sliceByTwo(a,f,h,i,j):"hermite"===this.resizeType?e=this.hermiteFastResize(a,f,h,i,j):"bilinear"===this.resizeType?e=this.bilinearFiltering(a,f,h,i,j):"lanczos"===this.resizeType&&(e=this.lanczosResize(a,f,h,i,j)),a.imageData=e},sliceByTwo:function(a,c,e,f,g){var h,i,j=a.imageData,k=!1,l=!1,m=.5*c,n=.5*e,o=b.filterBackend.resources,p=0,q=0,r=c,s=0;for(o.sliceByTwo||(o.sliceByTwo=document.createElement("canvas")),((h=o.sliceByTwo).width<1.5*c||h.height<e)&&(h.width=1.5*c,h.height=e),(i=h.getContext("2d")).clearRect(0,0,1.5*c,e),i.putImageData(j,0,0),f=d(f),g=d(g);!k||!l;)c=m,e=n,f<d(.5*m)?m=d(.5*m):(m=f,k=!0),g<d(.5*n)?n=d(.5*n):(n=g,l=!0),i.drawImage(h,p,q,c,e,r,s,m,n),p=r,q=s,s+=n;return i.getImageData(p,q,f,g)},lanczosResize:function(a,b,g,h,j){var k=a.imageData.data,l=a.ctx.createImageData(h,j),m=l.data,n=this.lanczosCreate(this.lanczosLobes),o=this.rcpScaleX,p=this.rcpScaleY,q=2/this.rcpScaleX,r=2/this.rcpScaleY,s=i(o*this.lanczosLobes/2),t=i(p*this.lanczosLobes/2),u={},v={},w={};return function a(i){var x,y,z,A,B,C,D,E,F,G,H;for(x=0,v.x=(i+.5)*o,w.x=d(v.x);x<j;x++){for(v.y=(x+.5)*p,w.y=d(v.y),B=0,C=0,D=0,E=0,F=0,y=w.x-s;y<=w.x+s;y++)if(!(y<0)&&!(y>=b)){u[G=d(1e3*f(y-v.x))]||(u[G]={});for(var I=w.y-t;I<=w.y+t;I++)I<0||I>=g||(H=d(1e3*f(I-v.y)),u[G][H]||(u[G][H]=n(e(c(G*q,2)+c(H*r,2))/1e3)),(z=u[G][H])>0&&(A=(I*b+y)*4,B+=z,C+=z*k[A],D+=z*k[A+1],E+=z*k[A+2],F+=z*k[A+3]))}m[A=(x*h+i)*4]=C/B,m[A+1]=D/B,m[A+2]=E/B,m[A+3]=F/B}return++i<h?a(i):l}(0)},bilinearFiltering:function(a,b,c,e,f){var g,h,i,j,k,l,m,n,o,p,q,r=0,s=this.rcpScaleX,t=this.rcpScaleY,u=4*(b-1),v=a.imageData.data,w=a.ctx.createImageData(e,f),x=w.data;for(k=0;k<f;k++)for(l=0;l<e;l++)for(o=0,i=d(s*l),j=d(t*k),m=s*l-i,n=t*k-j,q=4*(j*b+i);o<4;o++)g=v[q+o],h=v[q+4+o],p=g*(1-m)*(1-n)+h*m*(1-n)+v[q+u+o]*n*(1-m)+v[q+u+4+o]*m*n,x[r++]=p;return w},hermiteFastResize:function(a,b,c,g,h){for(var j=this.rcpScaleX,k=this.rcpScaleY,l=i(j/2),m=i(k/2),n=a.imageData.data,o=a.ctx.createImageData(g,h),p=o.data,q=0;q<h;q++)for(var r=0;r<g;r++){for(var s=(r+q*g)*4,t=0,u=0,v=0,w=0,x=0,y=0,z=0,A=(q+.5)*k,B=d(q*k);B<(q+1)*k;B++)for(var C=f(A-(B+.5))/m,D=(r+.5)*j,E=C*C,F=d(r*j);F<(r+1)*j;F++){var G=f(D-(F+.5))/l,H=e(E+G*G);H>1&&H<-1||(t=2*H*H*H-3*H*H+1)>0&&(z+=t*n[(G=4*(F+B*b))+3],v+=t,n[G+3]<255&&(t=t*n[G+3]/250),w+=t*n[G],x+=t*n[G+1],y+=t*n[G+2],u+=t)}p[s]=w/u,p[s+1]=x/u,p[s+2]=y/u,p[s+3]=z/v}return o},toObject:function(){return{type:this.type,scaleX:this.scaleX,scaleY:this.scaleY,resizeType:this.resizeType,lanczosLobes:this.lanczosLobes}}}),b.Image.filters.Resize.fromObject=b.Image.filters.BaseFilter.fromObject}(c),function(a){"use strict";var b=a.fabric||(a.fabric={}),c=b.Image.filters;c.Contrast=(0,b.util.createClass)(c.BaseFilter,{type:"Contrast",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uContrast;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nfloat contrastF = 1.015 * (uContrast + 1.0) / (1.0 * (1.015 - uContrast));\ncolor.rgb = contrastF * (color.rgb - 0.5) + 0.5;\ngl_FragColor = color;\n}",contrast:0,mainParameter:"contrast",applyTo2d:function(a){if(0!==this.contrast){var b,c,d=a.imageData.data,c=d.length,e=Math.floor(255*this.contrast),f=259*(e+255)/(255*(259-e));for(b=0;b<c;b+=4)d[b]=f*(d[b]-128)+128,d[b+1]=f*(d[b+1]-128)+128,d[b+2]=f*(d[b+2]-128)+128}},getUniformLocations:function(a,b){return{uContrast:a.getUniformLocation(b,"uContrast")}},sendUniformData:function(a,b){a.uniform1f(b.uContrast,this.contrast)}}),b.Image.filters.Contrast.fromObject=b.Image.filters.BaseFilter.fromObject}(c),function(a){"use strict";var b=a.fabric||(a.fabric={}),c=b.Image.filters;c.Saturation=(0,b.util.createClass)(c.BaseFilter,{type:"Saturation",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uSaturation;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nfloat rgMax = max(color.r, color.g);\nfloat rgbMax = max(rgMax, color.b);\ncolor.r += rgbMax != color.r ? (rgbMax - color.r) * uSaturation : 0.00;\ncolor.g += rgbMax != color.g ? (rgbMax - color.g) * uSaturation : 0.00;\ncolor.b += rgbMax != color.b ? (rgbMax - color.b) * uSaturation : 0.00;\ngl_FragColor = color;\n}",saturation:0,mainParameter:"saturation",applyTo2d:function(a){if(0!==this.saturation){var b,c,d=a.imageData.data,e=d.length,f=-this.saturation;for(b=0;b<e;b+=4)c=Math.max(d[b],d[b+1],d[b+2]),d[b]+=c!==d[b]?(c-d[b])*f:0,d[b+1]+=c!==d[b+1]?(c-d[b+1])*f:0,d[b+2]+=c!==d[b+2]?(c-d[b+2])*f:0}},getUniformLocations:function(a,b){return{uSaturation:a.getUniformLocation(b,"uSaturation")}},sendUniformData:function(a,b){a.uniform1f(b.uSaturation,-this.saturation)}}),b.Image.filters.Saturation.fromObject=b.Image.filters.BaseFilter.fromObject}(c),function(a){"use strict";var b=a.fabric||(a.fabric={}),c=b.Image.filters;c.Vibrance=(0,b.util.createClass)(c.BaseFilter,{type:"Vibrance",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uVibrance;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nfloat max = max(color.r, max(color.g, color.b));\nfloat avg = (color.r + color.g + color.b) / 3.0;\nfloat amt = (abs(max - avg) * 2.0) * uVibrance;\ncolor.r += max != color.r ? (max - color.r) * amt : 0.00;\ncolor.g += max != color.g ? (max - color.g) * amt : 0.00;\ncolor.b += max != color.b ? (max - color.b) * amt : 0.00;\ngl_FragColor = color;\n}",vibrance:0,mainParameter:"vibrance",applyTo2d:function(a){if(0!==this.vibrance){var b,c,d,e=a.imageData.data,f=e.length,g=-this.vibrance;for(b=0;b<f;b+=4)d=2*Math.abs((c=Math.max(e[b],e[b+1],e[b+2]))-(e[b]+e[b+1]+e[b+2])/3)/255*g,e[b]+=c!==e[b]?(c-e[b])*d:0,e[b+1]+=c!==e[b+1]?(c-e[b+1])*d:0,e[b+2]+=c!==e[b+2]?(c-e[b+2])*d:0}},getUniformLocations:function(a,b){return{uVibrance:a.getUniformLocation(b,"uVibrance")}},sendUniformData:function(a,b){a.uniform1f(b.uVibrance,-this.vibrance)}}),b.Image.filters.Vibrance.fromObject=b.Image.filters.BaseFilter.fromObject}(c),function(a){"use strict";var b=a.fabric||(a.fabric={}),c=b.Image.filters;c.Blur=(0,b.util.createClass)(c.BaseFilter,{type:"Blur",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform vec2 uDelta;\nvarying vec2 vTexCoord;\nconst float nSamples = 15.0;\nvec3 v3offset = vec3(12.9898, 78.233, 151.7182);\nfloat random(vec3 scale) {\nreturn fract(sin(dot(gl_FragCoord.xyz, scale)) * 43758.5453);\n}\nvoid main() {\nvec4 color = vec4(0.0);\nfloat total = 0.0;\nfloat offset = random(v3offset);\nfor (float t = -nSamples; t <= nSamples; t++) {\nfloat percent = (t + offset - 0.5) / nSamples;\nfloat weight = 1.0 - abs(percent);\ncolor += texture2D(uTexture, vTexCoord + uDelta * percent) * weight;\ntotal += weight;\n}\ngl_FragColor = color / total;\n}",blur:0,mainParameter:"blur",applyTo:function(a){a.webgl?(this.aspectRatio=a.sourceWidth/a.sourceHeight,a.passes++,this._setupFrameBuffer(a),this.horizontal=!0,this.applyToWebGL(a),this._swapTextures(a),this._setupFrameBuffer(a),this.horizontal=!1,this.applyToWebGL(a),this._swapTextures(a)):this.applyTo2d(a)},applyTo2d:function(a){a.imageData=this.simpleBlur(a)},simpleBlur:function(a){var c,d,e=a.filterBackend.resources,f=a.imageData.width,g=a.imageData.height;e.blurLayer1||(e.blurLayer1=b.util.createCanvasElement(),e.blurLayer2=b.util.createCanvasElement()),c=e.blurLayer1,d=e.blurLayer2,(c.width!==f||c.height!==g)&&(d.width=c.width=f,d.height=c.height=g);var h,i,j,k,l=c.getContext("2d"),m=d.getContext("2d"),n=.06*this.blur*.5;for(l.putImageData(a.imageData,0,0),m.clearRect(0,0,f,g),k=-15;k<=15;k++)h=(Math.random()-.5)/4,j=n*(i=k/15)*f+h,m.globalAlpha=1-Math.abs(i),m.drawImage(c,j,h),l.drawImage(d,0,0),m.globalAlpha=1,m.clearRect(0,0,d.width,d.height);for(k=-15;k<=15;k++)h=(Math.random()-.5)/4,j=n*(i=k/15)*g+h,m.globalAlpha=1-Math.abs(i),m.drawImage(c,h,j),l.drawImage(d,0,0),m.globalAlpha=1,m.clearRect(0,0,d.width,d.height);a.ctx.drawImage(c,0,0);var o=a.ctx.getImageData(0,0,c.width,c.height);return l.globalAlpha=1,l.clearRect(0,0,c.width,c.height),o},getUniformLocations:function(a,b){return{delta:a.getUniformLocation(b,"uDelta")}},sendUniformData:function(a,b){var c=this.chooseRightDelta();a.uniform2fv(b.delta,c)},chooseRightDelta:function(){var a,b=1,c=[0,0];return this.horizontal?this.aspectRatio>1&&(b=1/this.aspectRatio):this.aspectRatio<1&&(b=this.aspectRatio),a=b*this.blur*.12,this.horizontal?c[0]=a:c[1]=a,c}}),c.Blur.fromObject=b.Image.filters.BaseFilter.fromObject}(c),function(a){"use strict";var b=a.fabric||(a.fabric={}),c=b.Image.filters;c.Gamma=(0,b.util.createClass)(c.BaseFilter,{type:"Gamma",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform vec3 uGamma;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nvec3 correction = (1.0 / uGamma);\ncolor.r = pow(color.r, correction.r);\ncolor.g = pow(color.g, correction.g);\ncolor.b = pow(color.b, correction.b);\ngl_FragColor = color;\ngl_FragColor.rgb *= color.a;\n}",gamma:[1,1,1],mainParameter:"gamma",initialize:function(a){this.gamma=[1,1,1],c.BaseFilter.prototype.initialize.call(this,a)},applyTo2d:function(a){var b,c=a.imageData.data,d=this.gamma,e=c.length,f=1/d[0],g=1/d[1],h=1/d[2];for(this.rVals||(this.rVals=new Uint8Array(256),this.gVals=new Uint8Array(256),this.bVals=new Uint8Array(256)),b=0,e=256;b<e;b++)this.rVals[b]=255*Math.pow(b/255,f),this.gVals[b]=255*Math.pow(b/255,g),this.bVals[b]=255*Math.pow(b/255,h);for(b=0,e=c.length;b<e;b+=4)c[b]=this.rVals[c[b]],c[b+1]=this.gVals[c[b+1]],c[b+2]=this.bVals[c[b+2]]},getUniformLocations:function(a,b){return{uGamma:a.getUniformLocation(b,"uGamma")}},sendUniformData:function(a,b){a.uniform3fv(b.uGamma,this.gamma)}}),b.Image.filters.Gamma.fromObject=b.Image.filters.BaseFilter.fromObject}(c),function(a){"use strict";var b=a.fabric||(a.fabric={}),c=b.Image.filters;c.Composed=(0,b.util.createClass)(c.BaseFilter,{type:"Composed",subFilters:[],initialize:function(a){this.callSuper("initialize",a),this.subFilters=this.subFilters.slice(0)},applyTo:function(a){a.passes+=this.subFilters.length-1,this.subFilters.forEach(function(b){b.applyTo(a)})},toObject:function(){return b.util.object.extend(this.callSuper("toObject"),{subFilters:this.subFilters.map(function(a){return a.toObject()})})},isNeutralState:function(){return!this.subFilters.some(function(a){return!a.isNeutralState()})}}),b.Image.filters.Composed.fromObject=function(a,c){var d=(a.subFilters||[]).map(function(a){return new b.Image.filters[a.type](a)}),e=new b.Image.filters.Composed({subFilters:d});return c&&c(e),e}}(c),function(a){"use strict";var b=a.fabric||(a.fabric={}),c=b.Image.filters;c.HueRotation=(0,b.util.createClass)(c.ColorMatrix,{type:"HueRotation",rotation:0,mainParameter:"rotation",calculateMatrix:function(){var a=this.rotation*Math.PI,c=b.util.cos(a),d=b.util.sin(a),e=1/3,f=Math.sqrt(1/3)*d,g=1-c;this.matrix=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],this.matrix[0]=c+g/3,this.matrix[1]=e*g-f,this.matrix[2]=e*g+f,this.matrix[5]=e*g+f,this.matrix[6]=c+e*g,this.matrix[7]=e*g-f,this.matrix[10]=e*g-f,this.matrix[11]=e*g+f,this.matrix[12]=c+e*g},isNeutralState:function(a){return this.calculateMatrix(),c.BaseFilter.prototype.isNeutralState.call(this,a)},applyTo:function(a){this.calculateMatrix(),c.BaseFilter.prototype.applyTo.call(this,a)}}),b.Image.filters.HueRotation.fromObject=b.Image.filters.BaseFilter.fromObject}(c),function(a){"use strict";var b=a.fabric||(a.fabric={}),c=b.util.object.clone;if(b.Text)return b.warn("fabric.Text is already defined");var d="fontFamily fontWeight fontSize text underline overline linethrough textAlign fontStyle lineHeight textBackgroundColor charSpacing styles direction path pathStartOffset pathSide pathAlign".split(" ");b.Text=b.util.createClass(b.Object,{_dimensionAffectingProps:["fontSize","fontWeight","fontFamily","fontStyle","lineHeight","text","charSpacing","textAlign","styles","path","pathStartOffset","pathSide","pathAlign"],_reNewline:/\r?\n/,_reSpacesAndTabs:/[ \t\r]/g,_reSpaceAndTab:/[ \t\r]/,_reWords:/\S+/g,type:"text",fontSize:40,fontWeight:"normal",fontFamily:"Times New Roman",underline:!1,overline:!1,linethrough:!1,textAlign:"left",fontStyle:"normal",lineHeight:1.16,superscript:{size:.6,baseline:-.35},subscript:{size:.6,baseline:.11},textBackgroundColor:"",stateProperties:b.Object.prototype.stateProperties.concat(d),cacheProperties:b.Object.prototype.cacheProperties.concat(d),stroke:null,shadow:null,path:null,pathStartOffset:0,pathSide:"left",pathAlign:"baseline",_fontSizeFraction:.222,offsets:{underline:.1,linethrough:-.315,overline:-.88},_fontSizeMult:1.13,charSpacing:0,styles:null,_measuringContext:null,deltaY:0,direction:"ltr",_styleProperties:["stroke","strokeWidth","fill","fontFamily","fontSize","fontWeight","fontStyle","underline","overline","linethrough","deltaY","textBackgroundColor"],__charBounds:[],CACHE_FONT_SIZE:400,MIN_TEXT_WIDTH:2,initialize:function(a,b){this.styles=b&&b.styles||{},this.text=a,this.__skipDimension=!0,this.callSuper("initialize",b),this.path&&this.setPathInfo(),this.__skipDimension=!1,this.initDimensions(),this.setCoords(),this.setupState({propertySet:"_dimensionAffectingProps"})},setPathInfo:function(){var a=this.path;a&&(a.segmentsInfo=b.util.getPathSegmentsInfo(a.path))},getMeasuringContext:function(){return b._measuringContext||(b._measuringContext=this.canvas&&this.canvas.contextCache||b.util.createCanvasElement().getContext("2d")),b._measuringContext},_splitText:function(){var a=this._splitTextIntoLines(this.text);return this.textLines=a.lines,this._textLines=a.graphemeLines,this._unwrappedTextLines=a._unwrappedLines,this._text=a.graphemeText,a},initDimensions:function(){if(!this.__skipDimension){if(this._splitText(),this._clearCache(),this.path){var a=1.1*this.getHeightOfLine(0);this.width=this.path.width+a,this.height=this.path.height+a}else this.width=this.calcTextWidth()||this.cursorWidth||this.MIN_TEXT_WIDTH,this.height=this.calcTextHeight();-1!==this.textAlign.indexOf("justify")&&this.enlargeSpaces(),this.saveState({propertySet:"_dimensionAffectingProps"})}},enlargeSpaces:function(){for(var a,b,c,d,e,f,g,h=0,i=this._textLines.length;h<i;h++)if(!("justify"!==this.textAlign&&(h===i-1||this.isEndOfWrapping(h)))&&(d=0,e=this._textLines[h],(b=this.getLineWidth(h))<this.width&&(g=this.textLines[h].match(this._reSpacesAndTabs)))){c=g.length,a=(this.width-b)/c;for(var j=0,k=e.length;j<=k;j++)f=this.__charBounds[h][j],this._reSpaceAndTab.test(e[j])?(f.width+=a,f.kernedWidth+=a,f.left+=d,d+=a):f.left+=d}},isEndOfWrapping:function(a){return a===this._textLines.length-1},missingNewlineOffset:function(){return 1},toString:function(){return"#<fabric.Text ("+this.complexity()+'): { "text": "'+this.text+'", "fontFamily": "'+this.fontFamily+'" }>'},_getCacheCanvasDimensions:function(){var a=this.callSuper("_getCacheCanvasDimensions"),b=this.fontSize;return a.width+=b*a.zoomX,a.height+=b*a.zoomY,a},_render:function(a){var b=this.path;b&&!b.isNotVisible()&&b._render(a),this._setTextStyles(a),this._renderTextLinesBackground(a),this._renderTextDecoration(a,"underline"),this._renderText(a),this._renderTextDecoration(a,"overline"),this._renderTextDecoration(a,"linethrough")},_renderText:function(a){"stroke"===this.paintFirst?(this._renderTextStroke(a),this._renderTextFill(a)):(this._renderTextFill(a),this._renderTextStroke(a))},_setTextStyles:function(a,b,c){if(a.textBaseline="alphabetic",this.path)switch(this.pathAlign){case"center":a.textBaseline="middle";break;case"ascender":a.textBaseline="top";break;case"descender":a.textBaseline="bottom"}a.font=this._getFontDeclaration(b,c)},calcTextWidth:function(){for(var a=this.getLineWidth(0),b=1,c=this._textLines.length;b<c;b++){var d=this.getLineWidth(b);d>a&&(a=d)}return a},_renderTextLine:function(a,b,c,d,e,f){this._renderChars(a,b,c,d,e,f)},_renderTextLinesBackground:function(a){if(this.textBackgroundColor||this.styleHas("textBackgroundColor")){for(var b,c,d,e,f,g,h,i=a.fillStyle,j=this._getLeftOffset(),k=this._getTopOffset(),l=0,m=0,n=this.path,o=0,p=this._textLines.length;o<p;o++){if(b=this.getHeightOfLine(o),!this.textBackgroundColor&&!this.styleHas("textBackgroundColor",o)){k+=b;continue}d=this._textLines[o],c=this._getLineLeftOffset(o),m=0,l=0,e=this.getValueOfPropertyAt(o,0,"textBackgroundColor");for(var q=0,r=d.length;q<r;q++)f=this.__charBounds[o][q],g=this.getValueOfPropertyAt(o,q,"textBackgroundColor"),n?(a.save(),a.translate(f.renderLeft,f.renderTop),a.rotate(f.angle),a.fillStyle=g,g&&a.fillRect(-f.width/2,-b/this.lineHeight*(1-this._fontSizeFraction),f.width,b/this.lineHeight),a.restore()):g!==e?(h=j+c+l,"rtl"===this.direction&&(h=this.width-h-m),a.fillStyle=e,e&&a.fillRect(h,k,m,b/this.lineHeight),l=f.left,m=f.width,e=g):m+=f.kernedWidth;g&&!n&&(h=j+c+l,"rtl"===this.direction&&(h=this.width-h-m),a.fillStyle=g,a.fillRect(h,k,m,b/this.lineHeight)),k+=b}a.fillStyle=i,this._removeShadow(a)}},getFontCache:function(a){var c=a.fontFamily.toLowerCase();b.charWidthsCache[c]||(b.charWidthsCache[c]={});var d=b.charWidthsCache[c],e=a.fontStyle.toLowerCase()+"_"+(a.fontWeight+"").toLowerCase();return d[e]||(d[e]={}),d[e]},_measureChar:function(a,b,c,d){var e,f,g,h,i=this.getFontCache(b),j=this._getFontDeclaration(b),k=this._getFontDeclaration(d),l=c+a,m=j===k,n=b.fontSize/this.CACHE_FONT_SIZE;if(c&&void 0!==i[c]&&(g=i[c]),void 0!==i[a]&&(h=e=i[a]),m&&void 0!==i[l]&&(h=(f=i[l])-g),void 0===e||void 0===g||void 0===f){var o=this.getMeasuringContext();this._setTextStyles(o,b,!0)}return void 0===e&&(h=e=o.measureText(a).width,i[a]=e),void 0===g&&m&&c&&(g=o.measureText(c).width,i[c]=g),m&&void 0===f&&(f=o.measureText(l).width,i[l]=f,h=f-g),{width:e*n,kernedWidth:h*n}},getHeightOfChar:function(a,b){return this.getValueOfPropertyAt(a,b,"fontSize")},measureLine:function(a){var b=this._measureLine(a);return 0!==this.charSpacing&&(b.width-=this._getWidthOfCharSpacing()),b.width<0&&(b.width=0),b},_measureLine:function(a){var c,d,e,f,g,h,i=0,j=this._textLines[a],k=Array(j.length),l=0,m=this.path,n="right"===this.pathSide;for(c=0,this.__charBounds[a]=k;c<j.length;c++)d=j[c],f=this._getGraphemeBox(d,a,c,e),k[c]=f,i+=f.kernedWidth,e=d;if(k[c]={left:f?f.left+f.width:0,width:0,kernedWidth:0,height:this.fontSize},m){switch(h=m.segmentsInfo[m.segmentsInfo.length-1].length,g=b.util.getPointOnPath(m.path,0,m.segmentsInfo),g.x+=m.pathOffset.x,g.y+=m.pathOffset.y,this.textAlign){case"left":l=n?h-i:0;break;case"center":l=(h-i)/2;break;case"right":l=n?0:h-i}for(l+=this.pathStartOffset*(n?-1:1),c=n?j.length-1:0;n?c>=0:c<j.length;n?c--:c++)f=k[c],l>h?l%=h:l<0&&(l+=h),this._setGraphemeOnPath(l,f,g),l+=f.kernedWidth}return{width:i,numOfSpaces:0}},_setGraphemeOnPath:function(a,c,d){var e=a+c.kernedWidth/2,f=this.path,g=b.util.getPointOnPath(f.path,e,f.segmentsInfo);c.renderLeft=g.x-d.x,c.renderTop=g.y-d.y,c.angle=g.angle+("right"===this.pathSide?Math.PI:0)},_getGraphemeBox:function(a,b,c,d,e){var f,g=this.getCompleteStyleDeclaration(b,c),h=d?this.getCompleteStyleDeclaration(b,c-1):{},i=this._measureChar(a,g,d,h),j=i.kernedWidth,k=i.width;0!==this.charSpacing&&(k+=f=this._getWidthOfCharSpacing(),j+=f);var l={width:k,left:0,height:g.fontSize,kernedWidth:j,deltaY:g.deltaY};if(c>0&&!e){var m=this.__charBounds[b][c-1];l.left=m.left+m.width+i.kernedWidth-i.width}return l},getHeightOfLine:function(a){if(this.__lineHeights[a])return this.__lineHeights[a];for(var b=this._textLines[a],c=this.getHeightOfChar(a,0),d=1,e=b.length;d<e;d++)c=Math.max(this.getHeightOfChar(a,d),c);return this.__lineHeights[a]=c*this.lineHeight*this._fontSizeMult},calcTextHeight:function(){for(var a,b=0,c=0,d=this._textLines.length;c<d;c++)a=this.getHeightOfLine(c),b+=c===d-1?a/this.lineHeight:a;return b},_getLeftOffset:function(){return"ltr"===this.direction?-this.width/2:this.width/2},_getTopOffset:function(){return-this.height/2},_renderTextCommon:function(a,b){a.save();for(var c=0,d=this._getLeftOffset(),e=this._getTopOffset(),f=0,g=this._textLines.length;f<g;f++){var h=this.getHeightOfLine(f),i=h/this.lineHeight,j=this._getLineLeftOffset(f);this._renderTextLine(b,a,this._textLines[f],d+j,e+c+i,f),c+=h}a.restore()},_renderTextFill:function(a){(this.fill||this.styleHas("fill"))&&this._renderTextCommon(a,"fillText")},_renderTextStroke:function(a){(!this.stroke||0===this.strokeWidth)&&this.isEmptyStyles()||(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(a),a.save(),this._setLineDash(a,this.strokeDashArray),a.beginPath(),this._renderTextCommon(a,"strokeText"),a.closePath(),a.restore())},_renderChars:function(a,c,d,e,f,g){var h,i,j,k,l,m=this.getHeightOfLine(g),n=-1!==this.textAlign.indexOf("justify"),o="",p=0,q=this.path,r=!n&&0===this.charSpacing&&this.isEmptyStyles(g)&&!q,s="ltr"===this.direction,t="ltr"===this.direction?1:-1,u=c.canvas.getAttribute("dir");if(c.save(),u!==this.direction&&(c.canvas.setAttribute("dir",s?"ltr":"rtl"),c.direction=s?"ltr":"rtl",c.textAlign=s?"left":"right"),f-=m*this._fontSizeFraction/this.lineHeight,r){this._renderChar(a,c,g,0,d.join(""),e,f,m),c.restore();return}for(var v=0,w=d.length-1;v<=w;v++)k=v===w||this.charSpacing||q,o+=d[v],j=this.__charBounds[g][v],0===p?(e+=t*(j.kernedWidth-j.width),p+=j.width):p+=j.kernedWidth,n&&!k&&this._reSpaceAndTab.test(d[v])&&(k=!0),k||(h=h||this.getCompleteStyleDeclaration(g,v),i=this.getCompleteStyleDeclaration(g,v+1),k=b.util.hasStyleChanged(h,i,!1)),k&&(q?(c.save(),c.translate(j.renderLeft,j.renderTop),c.rotate(j.angle),this._renderChar(a,c,g,v,o,-p/2,0,m),c.restore()):(l=e,this._renderChar(a,c,g,v,o,l,f,m)),o="",h=i,e+=t*p,p=0);c.restore()},_applyPatternGradientTransformText:function(a){var c,d=b.util.createCanvasElement(),e=this.width+this.strokeWidth,f=this.height+this.strokeWidth;return d.width=e,d.height=f,(c=d.getContext("2d")).beginPath(),c.moveTo(0,0),c.lineTo(e,0),c.lineTo(e,f),c.lineTo(0,f),c.closePath(),c.translate(e/2,f/2),c.fillStyle=a.toLive(c),this._applyPatternGradientTransform(c,a),c.fill(),c.createPattern(d,"no-repeat")},handleFiller:function(a,b,c){var d,e;if(c.toLive)if("percentage"===c.gradientUnits||c.gradientTransform||c.patternTransform)return d=-this.width/2,e=-this.height/2,a.translate(d,e),a[b]=this._applyPatternGradientTransformText(c),{offsetX:d,offsetY:e};else return a[b]=c.toLive(a,this),this._applyPatternGradientTransform(a,c);return a[b]=c,{offsetX:0,offsetY:0}},_setStrokeStyles:function(a,b){return a.lineWidth=b.strokeWidth,a.lineCap=this.strokeLineCap,a.lineDashOffset=this.strokeDashOffset,a.lineJoin=this.strokeLineJoin,a.miterLimit=this.strokeMiterLimit,this.handleFiller(a,"strokeStyle",b.stroke)},_setFillStyles:function(a,b){return this.handleFiller(a,"fillStyle",b.fill)},_renderChar:function(a,b,c,d,e,f,g){var h,i,j=this._getStyleDeclaration(c,d),k=this.getCompleteStyleDeclaration(c,d),l="fillText"===a&&k.fill,m="strokeText"===a&&k.stroke&&k.strokeWidth;(m||l)&&(b.save(),l&&(h=this._setFillStyles(b,k)),m&&(i=this._setStrokeStyles(b,k)),b.font=this._getFontDeclaration(k),j&&j.textBackgroundColor&&this._removeShadow(b),j&&j.deltaY&&(g+=j.deltaY),l&&b.fillText(e,f-h.offsetX,g-h.offsetY),m&&b.strokeText(e,f-i.offsetX,g-i.offsetY),b.restore())},setSuperscript:function(a,b){return this._setScript(a,b,this.superscript)},setSubscript:function(a,b){return this._setScript(a,b,this.subscript)},_setScript:function(a,b,c){var d=this.get2DCursorLocation(a,!0),e=this.getValueOfPropertyAt(d.lineIndex,d.charIndex,"fontSize"),f=this.getValueOfPropertyAt(d.lineIndex,d.charIndex,"deltaY"),g={fontSize:e*c.size,deltaY:f+e*c.baseline};return this.setSelectionStyles(g,a,b),this},_getLineLeftOffset:function(a){var b,c=this.getLineWidth(a),d=this.width-c,e=this.textAlign,f=this.direction,g=0,b=this.isEndOfWrapping(a);return"justify"!==e&&("justify-center"!==e||b)&&("justify-right"!==e||b)&&("justify-left"!==e||b)?("center"===e&&(g=d/2),"right"===e&&(g=d),"justify-center"===e&&(g=d/2),"justify-right"===e&&(g=d),"rtl"===f&&(g-=d),g):0},_clearCache:function(){this.__lineWidths=[],this.__lineHeights=[],this.__charBounds=[]},_shouldClearDimensionCache:function(){var a=this._forceClearCache;return a||(a=this.hasStateChanged("_dimensionAffectingProps")),a&&(this.dirty=!0,this._forceClearCache=!1),a},getLineWidth:function(a){if(void 0!==this.__lineWidths[a])return this.__lineWidths[a];var b=this.measureLine(a).width;return this.__lineWidths[a]=b,b},_getWidthOfCharSpacing:function(){return 0!==this.charSpacing?this.fontSize*this.charSpacing/1e3:0},getValueOfPropertyAt:function(a,b,c){var d=this._getStyleDeclaration(a,b);return d&&void 0!==d[c]?d[c]:this[c]},_renderTextDecoration:function(a,b){if(this[b]||this.styleHas(b)){a.save(),("overline"===b||"linethrough"===b)&&this._removeShadow(a);for(var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s=this._getLeftOffset(),t=this._getTopOffset(),u=this.path,v=this._getWidthOfCharSpacing(),w=this.offsets[b],x=0,y=this._textLines.length;x<y;x++){if(c=this.getHeightOfLine(x),!this[b]&&!this.styleHas(b,x)){t+=c;continue}i=this._textLines[x],p=c/this.lineHeight,f=this._getLineLeftOffset(x),l=0,m=0,j=this.getValueOfPropertyAt(x,0,b),r=this.getValueOfPropertyAt(x,0,"fill"),k=t+p*(1-this._fontSizeFraction),d=this.getHeightOfChar(x,0),g=this.getValueOfPropertyAt(x,0,"deltaY");for(var z=0,A=i.length;z<A;z++)if(n=this.__charBounds[x][z],o=this.getValueOfPropertyAt(x,z,b),q=this.getValueOfPropertyAt(x,z,"fill"),e=this.getHeightOfChar(x,z),h=this.getValueOfPropertyAt(x,z,"deltaY"),u&&o&&q)a.save(),a.fillStyle=r,a.translate(n.renderLeft,n.renderTop),a.rotate(n.angle),a.fillRect(-n.kernedWidth/2,w*e+h,n.kernedWidth,this.fontSize/15),a.restore();else if((o!==j||q!==r||e!==d||h!==g)&&m>0){var B=s+f+l;"rtl"===this.direction&&(B=this.width-B-m),j&&r&&(a.fillStyle=r,a.fillRect(B,k+w*d+g,m,this.fontSize/15)),l=n.left,m=n.width,j=o,r=q,d=e,g=h}else m+=n.kernedWidth;var B=s+f+l;"rtl"===this.direction&&(B=this.width-B-m),a.fillStyle=q,o&&q&&a.fillRect(B,k+w*d+g,m-v,this.fontSize/15),t+=c}a.restore()}},_getFontDeclaration:function(a,c){var d=a||this,e=this.fontFamily,f=b.Text.genericFonts.indexOf(e.toLowerCase())>-1,g=void 0===e||e.indexOf("'")>-1||e.indexOf(",")>-1||e.indexOf('"')>-1||f?d.fontFamily:'"'+d.fontFamily+'"';return[b.isLikelyNode?d.fontWeight:d.fontStyle,b.isLikelyNode?d.fontStyle:d.fontWeight,c?this.CACHE_FONT_SIZE+"px":d.fontSize+"px",g].join(" ")},render:function(a){!this.visible||(!this.canvas||!this.canvas.skipOffscreen||this.group||this.isOnScreen())&&(this._shouldClearDimensionCache()&&this.initDimensions(),this.callSuper("render",a))},_splitTextIntoLines:function(a){for(var c=a.split(this._reNewline),d=Array(c.length),e=["\n"],f=[],g=0;g<c.length;g++)d[g]=b.util.string.graphemeSplit(c[g]),f=f.concat(d[g],e);return f.pop(),{_unwrappedLines:d,lines:c,graphemeText:f,graphemeLines:d}},toObject:function(a){var c=d.concat(a),e=this.callSuper("toObject",c);return e.styles=b.util.stylesToArray(this.styles,this.text),e.path&&(e.path=this.path.toObject()),e},set:function(a,b){this.callSuper("set",a,b);var c=!1,d=!1;if("object"==typeof a)for(var e in a)"path"===e&&this.setPathInfo(),c=c||-1!==this._dimensionAffectingProps.indexOf(e),d=d||"path"===e;else c=-1!==this._dimensionAffectingProps.indexOf(a),d="path"===a;return d&&this.setPathInfo(),c&&(this.initDimensions(),this.setCoords()),this},complexity:function(){return 1}}),b.Text.ATTRIBUTE_NAMES=b.SHARED_ATTRIBUTES.concat("x y dx dy font-family font-style font-weight font-size letter-spacing text-decoration text-anchor".split(" ")),b.Text.DEFAULT_SVG_FONT_SIZE=16,b.Text.fromElement=function(a,d,e){if(!a)return d(null);var f=b.parseAttributes(a,b.Text.ATTRIBUTE_NAMES),g=f.textAnchor||"left";if((e=b.util.object.extend(e?c(e):{},f)).top=e.top||0,e.left=e.left||0,f.textDecoration){var h=f.textDecoration;-1!==h.indexOf("underline")&&(e.underline=!0),-1!==h.indexOf("overline")&&(e.overline=!0),-1!==h.indexOf("line-through")&&(e.linethrough=!0),delete e.textDecoration}"dx"in f&&(e.left+=f.dx),"dy"in f&&(e.top+=f.dy),"fontSize"in e||(e.fontSize=b.Text.DEFAULT_SVG_FONT_SIZE);var i="";"textContent"in a?i=a.textContent:"firstChild"in a&&null!==a.firstChild&&"data"in a.firstChild&&null!==a.firstChild.data&&(i=a.firstChild.data),i=i.replace(/^\s+|\s+$|\n+/g,"").replace(/\s+/g," ");var j=e.strokeWidth;e.strokeWidth=0;var k=new b.Text(i,e),l=k.getScaledHeight()/k.height,m=(k.height+k.strokeWidth)*k.lineHeight-k.height,n=k.getScaledHeight()+m*l,o=0;"center"===g&&(o=k.getScaledWidth()/2),"right"===g&&(o=k.getScaledWidth()),k.set({left:k.left-o,top:k.top-(n-k.fontSize*(.07+k._fontSizeFraction))/k.lineHeight,strokeWidth:void 0!==j?j:1}),d(k)},b.Text.fromObject=function(a,d){var e=c(a),f=a.path;return delete e.path,b.Object._fromObject("Text",e,function(c){c.styles=b.util.stylesFromArray(a.styles,a.text),f?b.Object._fromObject("Path",f,function(a){c.set("path",a),d(c)},"path"):d(c)},"text")},b.Text.genericFonts=["sans-serif","serif","cursive","fantasy","monospace"],b.util.createAccessors&&b.util.createAccessors(b.Text)}(c),H.util.object.extend(H.Text.prototype,{isEmptyStyles:function(a){if(!this.styles||void 0!==a&&!this.styles[a])return!0;var b=void 0===a?this.styles:{line:this.styles[a]};for(var c in b)for(var d in b[c])for(var e in b[c][d])return!1;return!0},styleHas:function(a,b){if(!this.styles||!a||""===a||void 0!==b&&!this.styles[b])return!1;var c=void 0===b?this.styles:{0:this.styles[b]};for(var d in c)for(var e in c[d])if(void 0!==c[d][e][a])return!0;return!1},cleanStyle:function(a){if(!this.styles||!a||""===a)return!1;var b,c,d,e=this.styles,f=0,g=!0,h=0;for(var i in e){for(var j in b=0,e[i]){var d=e[i][j],k=d.hasOwnProperty(a);f++,k?(c?d[a]!==c&&(g=!1):c=d[a],d[a]===this[a]&&delete d[a]):g=!1,0!==Object.keys(d).length?b++:delete e[i][j]}0===b&&delete e[i]}for(var l=0;l<this._textLines.length;l++)h+=this._textLines[l].length;g&&f===h&&(this[a]=c,this.removeStyle(a))},removeStyle:function(a){if(this.styles&&a&&""!==a){var b,c,d,e=this.styles;for(c in e){for(d in b=e[c])delete b[d][a],0===Object.keys(b[d]).length&&delete b[d];0===Object.keys(b).length&&delete e[c]}}},_extendStyles:function(a,b){var c=this.get2DCursorLocation(a);this._getLineStyle(c.lineIndex)||this._setLineStyle(c.lineIndex),this._getStyleDeclaration(c.lineIndex,c.charIndex)||this._setStyleDeclaration(c.lineIndex,c.charIndex,{}),H.util.object.extend(this._getStyleDeclaration(c.lineIndex,c.charIndex),b)},get2DCursorLocation:function(a,b){void 0===a&&(a=this.selectionStart);for(var c=b?this._unwrappedTextLines:this._textLines,d=c.length,e=0;e<d;e++){if(a<=c[e].length)return{lineIndex:e,charIndex:a};a-=c[e].length+this.missingNewlineOffset(e,b)}return{lineIndex:e-1,charIndex:c[e-1].length<a?c[e-1].length:a}},getSelectionStyles:function(a,b,c){void 0===a&&(a=this.selectionStart||0),void 0===b&&(b=this.selectionEnd||a);for(var d=[],e=a;e<b;e++)d.push(this.getStyleAtPosition(e,c));return d},getStyleAtPosition:function(a,b){var c=this.get2DCursorLocation(a);return(b?this.getCompleteStyleDeclaration(c.lineIndex,c.charIndex):this._getStyleDeclaration(c.lineIndex,c.charIndex))||{}},setSelectionStyles:function(a,b,c){void 0===b&&(b=this.selectionStart||0),void 0===c&&(c=this.selectionEnd||b);for(var d=b;d<c;d++)this._extendStyles(d,a);return this._forceClearCache=!0,this},_getStyleDeclaration:function(a,b){var c=this.styles&&this.styles[a];return c?c[b]:null},getCompleteStyleDeclaration:function(a,b){for(var c,d=this._getStyleDeclaration(a,b)||{},e={},f=0;f<this._styleProperties.length;f++)e[c=this._styleProperties[f]]=void 0===d[c]?this[c]:d[c];return e},_setStyleDeclaration:function(a,b,c){this.styles[a][b]=c},_deleteStyleDeclaration:function(a,b){delete this.styles[a][b]},_getLineStyle:function(a){return!!this.styles[a]},_setLineStyle:function(a){this.styles[a]={}},_deleteLineStyle:function(a){delete this.styles[a]}}),H.IText=H.util.createClass(H.Text,H.Observable,{type:"i-text",selectionStart:0,selectionEnd:0,selectionColor:"rgba(17,119,255,0.3)",isEditing:!1,editable:!0,editingBorderColor:"rgba(102,153,255,0.25)",cursorWidth:2,cursorColor:"",cursorDelay:1e3,cursorDuration:600,caching:!0,hiddenTextareaContainer:null,_reSpace:/\s|\n/,_currentCursorOpacity:0,_selectionDirection:null,_abortCursorAnimation:!1,__widthOfSpace:[],inCompositionMode:!1,initialize:function(a,b){this.callSuper("initialize",a,b),this.initBehavior()},setSelectionStart:function(a){a=Math.max(a,0),this._updateAndFire("selectionStart",a)},setSelectionEnd:function(a){a=Math.min(a,this.text.length),this._updateAndFire("selectionEnd",a)},_updateAndFire:function(a,b){this[a]!==b&&(this._fireSelectionChanged(),this[a]=b),this._updateTextarea()},_fireSelectionChanged:function(){this.fire("selection:changed"),this.canvas&&this.canvas.fire("text:selection:changed",{target:this})},initDimensions:function(){this.isEditing&&this.initDelayedCursor(),this.clearContextTop(),this.callSuper("initDimensions")},render:function(a){this.clearContextTop(),this.callSuper("render",a),this.cursorOffsetCache={},this.renderCursorOrSelection()},_render:function(a){this.callSuper("_render",a)},clearContextTop:function(a){if(this.isEditing&&this.canvas&&this.canvas.contextTop){var b=this.canvas.contextTop,c=this.canvas.viewportTransform;b.save(),b.transform(c[0],c[1],c[2],c[3],c[4],c[5]),this.transform(b),this._clearTextArea(b),a||b.restore()}},renderCursorOrSelection:function(){if(this.isEditing&&this.canvas&&this.canvas.contextTop){var a=this._getCursorBoundaries(),b=this.canvas.contextTop;this.clearContextTop(!0),this.selectionStart===this.selectionEnd?this.renderCursor(a,b):this.renderSelection(a,b),b.restore()}},_clearTextArea:function(a){var b=this.width+4,c=this.height+4;a.clearRect(-b/2,-c/2,b,c)},_getCursorBoundaries:function(a){void 0===a&&(a=this.selectionStart);var b=this._getLeftOffset(),c=this._getTopOffset(),d=this._getCursorBoundariesOffsets(a);return{left:b,top:c,leftOffset:d.left,topOffset:d.top}},_getCursorBoundariesOffsets:function(a){if(this.cursorOffsetCache&&"top"in this.cursorOffsetCache)return this.cursorOffsetCache;var b,c,d,e,f=0,g=0,h=this.get2DCursorLocation(a);d=h.charIndex,c=h.lineIndex;for(var i=0;i<c;i++)f+=this.getHeightOfLine(i);b=this._getLineLeftOffset(c);var j=this.__charBounds[c][d];return j&&(g=j.left),0!==this.charSpacing&&d===this._textLines[c].length&&(g-=this._getWidthOfCharSpacing()),e={top:f,left:b+(g>0?g:0)},"rtl"===this.direction&&(e.left*=-1),this.cursorOffsetCache=e,this.cursorOffsetCache},renderCursor:function(a,b){var c=this.get2DCursorLocation(),d=c.lineIndex,e=c.charIndex>0?c.charIndex-1:0,f=this.getValueOfPropertyAt(d,e,"fontSize"),g=this.scaleX*this.canvas.getZoom(),h=this.cursorWidth/g,i=a.topOffset,j=this.getValueOfPropertyAt(d,e,"deltaY");i+=(1-this._fontSizeFraction)*this.getHeightOfLine(d)/this.lineHeight-f*(1-this._fontSizeFraction),this.inCompositionMode&&this.renderSelection(a,b),b.fillStyle=this.cursorColor||this.getValueOfPropertyAt(d,e,"fill"),b.globalAlpha=this.__isMousedown?1:this._currentCursorOpacity,b.fillRect(a.left+a.leftOffset-h/2,i+a.top+j,h,f)},renderSelection:function(a,b){for(var c=this.inCompositionMode?this.hiddenTextarea.selectionStart:this.selectionStart,d=this.inCompositionMode?this.hiddenTextarea.selectionEnd:this.selectionEnd,e=-1!==this.textAlign.indexOf("justify"),f=this.get2DCursorLocation(c),g=this.get2DCursorLocation(d),h=f.lineIndex,i=g.lineIndex,j=f.charIndex<0?0:f.charIndex,k=g.charIndex<0?0:g.charIndex,l=h;l<=i;l++){var m=this._getLineLeftOffset(l)||0,n=this.getHeightOfLine(l),o=0,p=0,q=0;if(l===h&&(p=this.__charBounds[h][j].left),l>=h&&l<i)q=e&&!this.isEndOfWrapping(l)?this.width:this.getLineWidth(l)||5;else if(l===i)if(0===k)q=this.__charBounds[i][k].left;else{var r=this._getWidthOfCharSpacing();q=this.__charBounds[i][k-1].left+this.__charBounds[i][k-1].width-r}o=n,(this.lineHeight<1||l===i&&this.lineHeight>1)&&(n/=this.lineHeight);var s=a.left+m+p,t=q-p,u=n,v=0;this.inCompositionMode?(b.fillStyle=this.compositionColor||"black",u=1,v=n):b.fillStyle=this.selectionColor,"rtl"===this.direction&&(s=this.width-s-t),b.fillRect(s,a.top+a.topOffset+v,t,u),a.topOffset+=o}},getCurrentCharFontSize:function(){var a=this._getCurrentCharIndex();return this.getValueOfPropertyAt(a.l,a.c,"fontSize")},getCurrentCharColor:function(){var a=this._getCurrentCharIndex();return this.getValueOfPropertyAt(a.l,a.c,"fill")},_getCurrentCharIndex:function(){var a=this.get2DCursorLocation(this.selectionStart,!0),b=a.charIndex>0?a.charIndex-1:0;return{l:a.lineIndex,c:b}}}),H.IText.fromObject=function(a,b){var c=H.util.stylesFromArray(a.styles,a.text),d=Object.assign({},a,{styles:c});if(delete d.path,ah(d),d.styles)for(var e in d.styles)for(var f in d.styles[e])ah(d.styles[e][f]);H.Object._fromObject("IText",d,function(c){a.path?H.Object._fromObject("Path",a.path,function(a){c.set("path",a),b(c)},"path"):b(c)},"text")},B=H.util.object.clone,H.util.object.extend(H.IText.prototype,{initBehavior:function(){this.initAddedHandler(),this.initRemovedHandler(),this.initCursorSelectionHandlers(),this.initDoubleClickSimulation(),this.mouseMoveHandler=this.mouseMoveHandler.bind(this)},onDeselect:function(){this.isEditing&&this.exitEditing(),this.selected=!1},initAddedHandler:function(){var a=this;this.on("added",function(){var b=a.canvas;b&&(b._hasITextHandlers||(b._hasITextHandlers=!0,a._initCanvasHandlers(b)),b._iTextInstances=b._iTextInstances||[],b._iTextInstances.push(a))})},initRemovedHandler:function(){var a=this;this.on("removed",function(){var b=a.canvas;b&&(b._iTextInstances=b._iTextInstances||[],H.util.removeFromArray(b._iTextInstances,a),0===b._iTextInstances.length&&(b._hasITextHandlers=!1,a._removeCanvasHandlers(b)))})},_initCanvasHandlers:function(a){a._mouseUpITextHandler=function(){a._iTextInstances&&a._iTextInstances.forEach(function(a){a.__isMousedown=!1})},a.on("mouse:up",a._mouseUpITextHandler)},_removeCanvasHandlers:function(a){a.off("mouse:up",a._mouseUpITextHandler)},_tick:function(){this._currentTickState=this._animateCursor(this,1,this.cursorDuration,"_onTickComplete")},_animateCursor:function(a,b,c,d){var e;return e={isAborted:!1,abort:function(){this.isAborted=!0}},a.animate("_currentCursorOpacity",b,{duration:c,onComplete:function(){e.isAborted||a[d]()},onChange:function(){a.canvas&&a.selectionStart===a.selectionEnd&&a.renderCursorOrSelection()},abort:function(){return e.isAborted}}),e},_onTickComplete:function(){var a=this;this._cursorTimeout1&&clearTimeout(this._cursorTimeout1),this._cursorTimeout1=setTimeout(function(){a._currentTickCompleteState=a._animateCursor(a,0,this.cursorDuration/2,"_tick")},100)},initDelayedCursor:function(a){var b=this,c=a?0:this.cursorDelay;this.abortCursorAnimation(),this._currentCursorOpacity=1,this._cursorTimeout2=setTimeout(function(){b._tick()},c)},abortCursorAnimation:function(){var a=this._currentTickState||this._currentTickCompleteState,b=this.canvas;this._currentTickState&&this._currentTickState.abort(),this._currentTickCompleteState&&this._currentTickCompleteState.abort(),clearTimeout(this._cursorTimeout1),clearTimeout(this._cursorTimeout2),this._currentCursorOpacity=0,a&&b&&b.clearContext(b.contextTop||b.contextContainer)},selectAll:function(){return this.selectionStart=0,this.selectionEnd=this._text.length,this._fireSelectionChanged(),this._updateTextarea(),this},getSelectedText:function(){return this._text.slice(this.selectionStart,this.selectionEnd).join("")},findWordBoundaryLeft:function(a){var b=0,c=a-1;if(this._reSpace.test(this._text[c]))for(;this._reSpace.test(this._text[c]);)b++,c--;for(;/\S/.test(this._text[c])&&c>-1;)b++,c--;return a-b},findWordBoundaryRight:function(a){var b=0,c=a;if(this._reSpace.test(this._text[c]))for(;this._reSpace.test(this._text[c]);)b++,c++;for(;/\S/.test(this._text[c])&&c<this._text.length;)b++,c++;return a+b},findLineBoundaryLeft:function(a){for(var b=0,c=a-1;!/\n/.test(this._text[c])&&c>-1;)b++,c--;return a-b},findLineBoundaryRight:function(a){for(var b=0,c=a;!/\n/.test(this._text[c])&&c<this._text.length;)b++,c++;return a+b},searchWordBoundary:function(a,b){for(var c=this._text,d=this._reSpace.test(c[a])?a-1:a,e=c[d],f=H.reNonWord;!f.test(e)&&d>0&&d<c.length;)d+=b,e=c[d];return f.test(e)&&(d+=+(1!==b)),d},selectWord:function(a){a=a||this.selectionStart;var b=this.searchWordBoundary(a,-1),c=this.searchWordBoundary(a,1);this.selectionStart=b,this.selectionEnd=c,this._fireSelectionChanged(),this._updateTextarea(),this.renderCursorOrSelection()},selectLine:function(a){a=a||this.selectionStart;var b=this.findLineBoundaryLeft(a),c=this.findLineBoundaryRight(a);return this.selectionStart=b,this.selectionEnd=c,this._fireSelectionChanged(),this._updateTextarea(),this},enterEditing:function(a){if(!this.isEditing&&this.editable)return this.canvas&&(this.canvas.calcOffset(),this.exitEditingOnOthers(this.canvas)),this.isEditing=!0,this.initHiddenTextarea(a),this.hiddenTextarea.focus(),this.hiddenTextarea.value=this.text,this._updateTextarea(),this._saveEditingProps(),this._setEditingProps(),this._textBeforeEdit=this.text,this._tick(),this.fire("editing:entered"),this._fireSelectionChanged(),this.canvas&&(this.canvas.fire("text:editing:entered",{target:this}),this.initMouseMoveHandler(),this.canvas.requestRenderAll()),this},exitEditingOnOthers:function(a){a._iTextInstances&&a._iTextInstances.forEach(function(a){a.selected=!1,a.isEditing&&a.exitEditing()})},initMouseMoveHandler:function(){this.canvas.on("mouse:move",this.mouseMoveHandler)},mouseMoveHandler:function(a){if(this.__isMousedown&&this.isEditing){document.activeElement!==this.hiddenTextarea&&this.hiddenTextarea.focus();var b=this.getSelectionStartFromPointer(a.e),c=this.selectionStart,d=this.selectionEnd;(b===this.__selectionStartOnMouseDown&&c!==d||c!==b&&d!==b)&&(b>this.__selectionStartOnMouseDown?(this.selectionStart=this.__selectionStartOnMouseDown,this.selectionEnd=b):(this.selectionStart=b,this.selectionEnd=this.__selectionStartOnMouseDown),(this.selectionStart!==c||this.selectionEnd!==d)&&(this.restartCursorIfNeeded(),this._fireSelectionChanged(),this._updateTextarea(),this.renderCursorOrSelection()))}},_setEditingProps:function(){this.hoverCursor="text",this.canvas&&(this.canvas.defaultCursor=this.canvas.moveCursor="text"),this.borderColor=this.editingBorderColor,this.hasControls=this.selectable=!1,this.lockMovementX=this.lockMovementY=!0},fromStringToGraphemeSelection:function(a,b,c){var d=c.slice(0,a),e=H.util.string.graphemeSplit(d).length;if(a===b)return{selectionStart:e,selectionEnd:e};var f=c.slice(a,b);return{selectionStart:e,selectionEnd:e+H.util.string.graphemeSplit(f).length}},fromGraphemeToStringSelection:function(a,b,c){var d=c.slice(0,a).join("").length;return a===b?{selectionStart:d,selectionEnd:d}:{selectionStart:d,selectionEnd:d+c.slice(a,b).join("").length}},_updateTextarea:function(){if(this.cursorOffsetCache={},this.hiddenTextarea){if(!this.inCompositionMode){var a=this.fromGraphemeToStringSelection(this.selectionStart,this.selectionEnd,this._text);this.hiddenTextarea.selectionStart=a.selectionStart,this.hiddenTextarea.selectionEnd=a.selectionEnd}this.updateTextareaPosition()}},updateFromTextArea:function(){if(this.hiddenTextarea){this.cursorOffsetCache={},this.text=this.hiddenTextarea.value,this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords());var a=this.fromStringToGraphemeSelection(this.hiddenTextarea.selectionStart,this.hiddenTextarea.selectionEnd,this.hiddenTextarea.value);this.selectionEnd=this.selectionStart=a.selectionEnd,this.inCompositionMode||(this.selectionStart=a.selectionStart),this.updateTextareaPosition()}},updateTextareaPosition:function(){if(this.selectionStart===this.selectionEnd){var a=this._calcTextareaPosition();this.hiddenTextarea.style.left=a.left,this.hiddenTextarea.style.top=a.top}},_calcTextareaPosition:function(){if(!this.canvas)return{x:1,y:1};var a=this.inCompositionMode?this.compositionStart:this.selectionStart,b=this._getCursorBoundaries(a),c=this.get2DCursorLocation(a),d=c.lineIndex,e=c.charIndex,f=this.getValueOfPropertyAt(d,e,"fontSize")*this.lineHeight,g=b.leftOffset,h=this.calcTransformMatrix(),i={x:b.left+g,y:b.top+b.topOffset+f},j=this.canvas.getRetinaScaling(),k=this.canvas.upperCanvasEl,l=k.width/j,m=k.height/j,n=l-f,o=m-f,p=k.clientWidth/l,q=k.clientHeight/m;return i=H.util.transformPoint(i,h),i=H.util.transformPoint(i,this.canvas.viewportTransform),i.x*=p,i.y*=q,i.x<0&&(i.x=0),i.x>n&&(i.x=n),i.y<0&&(i.y=0),i.y>o&&(i.y=o),i.x+=this.canvas._offset.left,i.y+=this.canvas._offset.top,{left:i.x+"px",top:i.y+"px",fontSize:f+"px",charHeight:f}},_saveEditingProps:function(){this._savedProps={hasControls:this.hasControls,borderColor:this.borderColor,lockMovementX:this.lockMovementX,lockMovementY:this.lockMovementY,hoverCursor:this.hoverCursor,selectable:this.selectable,defaultCursor:this.canvas&&this.canvas.defaultCursor,moveCursor:this.canvas&&this.canvas.moveCursor}},_restoreEditingProps:function(){this._savedProps&&(this.hoverCursor=this._savedProps.hoverCursor,this.hasControls=this._savedProps.hasControls,this.borderColor=this._savedProps.borderColor,this.selectable=this._savedProps.selectable,this.lockMovementX=this._savedProps.lockMovementX,this.lockMovementY=this._savedProps.lockMovementY,this.canvas&&(this.canvas.defaultCursor=this._savedProps.defaultCursor,this.canvas.moveCursor=this._savedProps.moveCursor))},exitEditing:function(){var a=this._textBeforeEdit!==this.text,b=this.hiddenTextarea;return this.selected=!1,this.isEditing=!1,this.selectionEnd=this.selectionStart,b&&(b.blur&&b.blur(),b.parentNode&&b.parentNode.removeChild(b)),this.hiddenTextarea=null,this.abortCursorAnimation(),this._restoreEditingProps(),this._currentCursorOpacity=0,this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this.fire("editing:exited"),a&&this.fire("modified"),this.canvas&&(this.canvas.off("mouse:move",this.mouseMoveHandler),this.canvas.fire("text:editing:exited",{target:this}),a&&this.canvas.fire("object:modified",{target:this})),this},_removeExtraneousStyles:function(){for(var a in this.styles)this._textLines[a]||delete this.styles[a]},removeStyleFromTo:function(a,b){var c,d,e=this.get2DCursorLocation(a,!0),f=this.get2DCursorLocation(b,!0),g=e.lineIndex,h=e.charIndex,i=f.lineIndex,j=f.charIndex;if(g!==i){if(this.styles[g])for(c=h;c<this._unwrappedTextLines[g].length;c++)delete this.styles[g][c];if(this.styles[i])for(c=j;c<this._unwrappedTextLines[i].length;c++)(d=this.styles[i][c])&&(this.styles[g]||(this.styles[g]={}),this.styles[g][h+c-j]=d);for(c=g+1;c<=i;c++)delete this.styles[c];this.shiftLineStyles(i,g-i)}else if(this.styles[g]){d=this.styles[g];var k,l,m=j-h;for(c=h;c<j;c++)delete d[c];for(l in this.styles[g])(k=parseInt(l,10))>=j&&(d[k-m]=d[l],delete d[l])}},shiftLineStyles:function(a,b){var c=B(this.styles);for(var d in this.styles){var e=parseInt(d,10);e>a&&(this.styles[e+b]=c[e],c[e-b]||delete this.styles[e])}},restartCursorIfNeeded:function(){(!this._currentTickState||this._currentTickState.isAborted||!this._currentTickCompleteState||this._currentTickCompleteState.isAborted)&&this.initDelayedCursor()},insertNewlineStyleObject:function(a,b,c,d){var e,f={},g=!1,h=this._unwrappedTextLines[a].length,i=h===b;for(var j in c||(c=1),this.shiftLineStyles(a,c),this.styles[a]&&(e=this.styles[a][0===b?b:b-1]),this.styles[a]){var k=parseInt(j,10);k>=b&&(g=!0,f[k-b]=this.styles[a][j],i&&0===b||delete this.styles[a][j])}var l=!1;for(g&&!i&&(this.styles[a+c]=f,l=!0),(l||h>b)&&c--;c>0;)d&&d[c-1]?this.styles[a+c]={0:B(d[c-1])}:e?this.styles[a+c]={0:B(e)}:delete this.styles[a+c],c--;this._forceClearCache=!0},insertCharStyleObject:function(a,b,c,d){this.styles||(this.styles={});var e=this.styles[a],f=e?B(e):{};for(var g in c||(c=1),f){var h=parseInt(g,10);h>=b&&(e[h+c]=f[h],f[h-c]||delete e[h])}if(this._forceClearCache=!0,d){for(;c--;)Object.keys(d[c]).length&&(this.styles[a]||(this.styles[a]={}),this.styles[a][b+c]=B(d[c]));return}if(e)for(var i=e[b?b-1:1];i&&c--;)this.styles[a][b+c]=B(i)},insertNewStyleBlock:function(a,b,c){for(var d=this.get2DCursorLocation(b,!0),e=[0],f=0,g=0;g<a.length;g++)"\n"===a[g]?e[++f]=0:e[f]++;e[0]>0&&(this.insertCharStyleObject(d.lineIndex,d.charIndex,e[0],c),c=c&&c.slice(e[0]+1)),f&&this.insertNewlineStyleObject(d.lineIndex,d.charIndex+e[0],f);for(var g=1;g<f;g++)e[g]>0?this.insertCharStyleObject(d.lineIndex+g,0,e[g],c):c&&this.styles[d.lineIndex+g]&&c[0]&&(this.styles[d.lineIndex+g][0]=c[0]),c=c&&c.slice(e[g]+1);e[g]>0&&this.insertCharStyleObject(d.lineIndex+g,0,e[g],c)},setSelectionStartEndWithShift:function(a,b,c){c<=a?(b===a?this._selectionDirection="left":"right"===this._selectionDirection&&(this._selectionDirection="left",this.selectionEnd=a),this.selectionStart=c):c>a&&c<b?"right"===this._selectionDirection?this.selectionEnd=c:this.selectionStart=c:(b===a?this._selectionDirection="right":"left"===this._selectionDirection&&(this._selectionDirection="right",this.selectionStart=b),this.selectionEnd=c)},setSelectionInBoundaries:function(){var a=this.text.length;this.selectionStart>a?this.selectionStart=a:this.selectionStart<0&&(this.selectionStart=0),this.selectionEnd>a?this.selectionEnd=a:this.selectionEnd<0&&(this.selectionEnd=0)}}),H.util.object.extend(H.IText.prototype,{initDoubleClickSimulation:function(){this.__lastClickTime=+new Date,this.__lastLastClickTime=+new Date,this.__lastPointer={},this.on("mousedown",this.onMouseDown)},onMouseDown:function(a){if(this.canvas){this.__newClickTime=+new Date;var b=a.pointer;this.isTripleClick(b)&&(this.fire("tripleclick",a),this._stopEvent(a.e)),this.__lastLastClickTime=this.__lastClickTime,this.__lastClickTime=this.__newClickTime,this.__lastPointer=b,this.__lastIsEditing=this.isEditing,this.__lastSelected=this.selected}},isTripleClick:function(a){return this.__newClickTime-this.__lastClickTime<500&&this.__lastClickTime-this.__lastLastClickTime<500&&this.__lastPointer.x===a.x&&this.__lastPointer.y===a.y},_stopEvent:function(a){a.preventDefault&&a.preventDefault(),a.stopPropagation&&a.stopPropagation()},initCursorSelectionHandlers:function(){this.initMousedownHandler(),this.initMouseupHandler(),this.initClicks()},doubleClickHandler:function(a){this.isEditing&&this.selectWord(this.getSelectionStartFromPointer(a.e))},tripleClickHandler:function(a){this.isEditing&&this.selectLine(this.getSelectionStartFromPointer(a.e))},initClicks:function(){this.on("mousedblclick",this.doubleClickHandler),this.on("tripleclick",this.tripleClickHandler)},_mouseDownHandler:function(a){this.canvas&&this.editable&&(!a.e.button||1===a.e.button)&&(this.__isMousedown=!0,this.selected&&(this.inCompositionMode=!1,this.setCursorByClick(a.e)),this.isEditing&&(this.__selectionStartOnMouseDown=this.selectionStart,this.selectionStart===this.selectionEnd&&this.abortCursorAnimation(),this.renderCursorOrSelection()))},_mouseDownHandlerBefore:function(a){this.canvas&&this.editable&&(!a.e.button||1===a.e.button)&&(this.selected=this===this.canvas._activeObject)},initMousedownHandler:function(){this.on("mousedown",this._mouseDownHandler),this.on("mousedown:before",this._mouseDownHandlerBefore)},initMouseupHandler:function(){this.on("mouseup",this.mouseUpHandler)},mouseUpHandler:function(a){if(this.__isMousedown=!1,this.editable&&!this.group&&(!a.transform||!a.transform.actionPerformed)&&(!a.e.button||1===a.e.button)){if(this.canvas){var b=this.canvas._activeObject;if(b&&b!==this)return}this.__lastSelected&&!this.__corner?(this.selected=!1,this.__lastSelected=!1,this.enterEditing(a.e),this.selectionStart===this.selectionEnd?this.initDelayedCursor(!0):this.renderCursorOrSelection()):this.selected=!0}},setCursorByClick:function(a){var b=this.getSelectionStartFromPointer(a),c=this.selectionStart,d=this.selectionEnd;a.shiftKey?this.setSelectionStartEndWithShift(c,d,b):(this.selectionStart=b,this.selectionEnd=b),this.isEditing&&(this._fireSelectionChanged(),this._updateTextarea())},getSelectionStartFromPointer:function(a){for(var b,c=this.getLocalPointer(a),d=0,e=0,f=0,g=0,h=0,i=0,j=this._textLines.length;i<j;i++)if(f<=c.y)f+=this.getHeightOfLine(i)*this.scaleY,h=i,i>0&&(g+=this._textLines[i-1].length+this.missingNewlineOffset(i-1));else break;e=this._getLineLeftOffset(h)*this.scaleX,b=this._textLines[h],"rtl"===this.direction&&(c.x=this.width*this.scaleX-c.x+e);for(var k=0,l=b.length;k<l;k++)if(d=e,(e+=this.__charBounds[h][k].kernedWidth*this.scaleX)<=c.x)g++;else break;return this._getNewSelectionStartFromOffset(c,d,e,g,l)},_getNewSelectionStartFromOffset:function(a,b,c,d,e){var f=a.x-b,g=c-a.x,h=d+(g>f||g<0?0:1);return this.flipX&&(h=e-h),h>this._text.length&&(h=this._text.length),h}}),H.util.object.extend(H.IText.prototype,{initHiddenTextarea:function(){this.hiddenTextarea=H.document.createElement("textarea"),this.hiddenTextarea.setAttribute("autocapitalize","off"),this.hiddenTextarea.setAttribute("autocorrect","off"),this.hiddenTextarea.setAttribute("autocomplete","off"),this.hiddenTextarea.setAttribute("spellcheck","false"),this.hiddenTextarea.setAttribute("data-fabric-hiddentextarea",""),this.hiddenTextarea.setAttribute("wrap","off");var a=this._calcTextareaPosition();this.hiddenTextarea.style.cssText="position: absolute; top: "+a.top+"; left: "+a.left+"; z-index: -999; opacity: 0; width: 1px; height: 1px; font-size: 1px; padding-top: "+a.fontSize+";",this.hiddenTextareaContainer?this.hiddenTextareaContainer.appendChild(this.hiddenTextarea):H.document.body.appendChild(this.hiddenTextarea),H.util.addListener(this.hiddenTextarea,"keydown",this.onKeyDown.bind(this)),H.util.addListener(this.hiddenTextarea,"keyup",this.onKeyUp.bind(this)),H.util.addListener(this.hiddenTextarea,"input",this.onInput.bind(this)),H.util.addListener(this.hiddenTextarea,"copy",this.copy.bind(this)),H.util.addListener(this.hiddenTextarea,"cut",this.copy.bind(this)),H.util.addListener(this.hiddenTextarea,"paste",this.paste.bind(this)),H.util.addListener(this.hiddenTextarea,"compositionstart",this.onCompositionStart.bind(this)),H.util.addListener(this.hiddenTextarea,"compositionupdate",this.onCompositionUpdate.bind(this)),H.util.addListener(this.hiddenTextarea,"compositionend",this.onCompositionEnd.bind(this)),!this._clickHandlerInitialized&&this.canvas&&(H.util.addListener(this.canvas.upperCanvasEl,"click",this.onClick.bind(this)),this._clickHandlerInitialized=!0)},keysMap:{9:"exitEditing",27:"exitEditing",33:"moveCursorUp",34:"moveCursorDown",35:"moveCursorRight",36:"moveCursorLeft",37:"moveCursorLeft",38:"moveCursorUp",39:"moveCursorRight",40:"moveCursorDown"},keysMapRtl:{9:"exitEditing",27:"exitEditing",33:"moveCursorUp",34:"moveCursorDown",35:"moveCursorLeft",36:"moveCursorRight",37:"moveCursorRight",38:"moveCursorUp",39:"moveCursorLeft",40:"moveCursorDown"},ctrlKeysMapUp:{67:"copy",88:"cut"},ctrlKeysMapDown:{65:"selectAll"},onClick:function(){this.hiddenTextarea&&this.hiddenTextarea.focus()},onKeyDown:function(a){if(this.isEditing){var b="rtl"===this.direction?this.keysMapRtl:this.keysMap;if(a.keyCode in b)this[b[a.keyCode]](a);else{if(!(a.keyCode in this.ctrlKeysMapDown)||!a.ctrlKey&&!a.metaKey)return;this[this.ctrlKeysMapDown[a.keyCode]](a)}a.stopImmediatePropagation(),a.preventDefault(),a.keyCode>=33&&a.keyCode<=40?(this.inCompositionMode=!1,this.clearContextTop(),this.renderCursorOrSelection()):this.canvas&&this.canvas.requestRenderAll()}},onKeyUp:function(a){if(!this.isEditing||this._copyDone||this.inCompositionMode){this._copyDone=!1;return}a.keyCode in this.ctrlKeysMapUp&&(a.ctrlKey||a.metaKey)&&(this[this.ctrlKeysMapUp[a.keyCode]](a),a.stopImmediatePropagation(),a.preventDefault(),this.canvas&&this.canvas.requestRenderAll())},onInput:function(a){var b=this.fromPaste;if(this.fromPaste=!1,a&&a.stopPropagation(),this.isEditing){var c,d,e,f,g,h=this._splitTextIntoLines(this.hiddenTextarea.value).graphemeText,i=this._text.length,j=h.length,k=j-i,l=this.selectionStart,m=this.selectionEnd,n=l!==m;if(""===this.hiddenTextarea.value){this.styles={},this.updateFromTextArea(),this.fire("changed"),this.canvas&&(this.canvas.fire("text:changed",{target:this}),this.canvas.requestRenderAll());return}var o=this.fromStringToGraphemeSelection(this.hiddenTextarea.selectionStart,this.hiddenTextarea.selectionEnd,this.hiddenTextarea.value),p=l>o.selectionStart;n?(c=this._text.slice(l,m),k+=m-l):j<i&&(c=p?this._text.slice(m+k,m):this._text.slice(l,l-k)),d=h.slice(o.selectionEnd-k,o.selectionEnd),c&&c.length&&(d.length&&(e=this.getSelectionStyles(l,l+1,!1),e=d.map(function(){return e[0]})),n?(f=l,g=m):p?(f=m-c.length,g=m):(f=m,g=m+c.length),this.removeStyleFromTo(f,g)),d.length&&(b&&d.join("")===H.copiedText&&!H.disableStyleCopyPaste&&(e=H.copiedTextStyle),this.insertNewStyleBlock(d,l,e)),this.updateFromTextArea(),this.fire("changed"),this.canvas&&(this.canvas.fire("text:changed",{target:this}),this.canvas.requestRenderAll())}},onCompositionStart:function(){this.inCompositionMode=!0},onCompositionEnd:function(){this.inCompositionMode=!1},onCompositionUpdate:function(a){this.compositionStart=a.target.selectionStart,this.compositionEnd=a.target.selectionEnd,this.updateTextareaPosition()},copy:function(){this.selectionStart!==this.selectionEnd&&(H.copiedText=this.getSelectedText(),H.disableStyleCopyPaste?H.copiedTextStyle=null:H.copiedTextStyle=this.getSelectionStyles(this.selectionStart,this.selectionEnd,!0),this._copyDone=!0)},paste:function(){this.fromPaste=!0},_getClipboardData:function(a){return a&&a.clipboardData||H.window.clipboardData},_getWidthBeforeCursor:function(a,b){var c,d=this._getLineLeftOffset(a);return b>0&&(d+=(c=this.__charBounds[a][b-1]).left+c.width),d},getDownCursorOffset:function(a,b){var c=this._getSelectionForOffset(a,b),d=this.get2DCursorLocation(c),e=d.lineIndex;if(e===this._textLines.length-1||a.metaKey||34===a.keyCode)return this._text.length-c;var f=d.charIndex,g=this._getWidthBeforeCursor(e,f),h=this._getIndexOnLine(e+1,g);return this._textLines[e].slice(f).length+h+1+this.missingNewlineOffset(e)},_getSelectionForOffset:function(a,b){return a.shiftKey&&this.selectionStart!==this.selectionEnd&&b?this.selectionEnd:this.selectionStart},getUpCursorOffset:function(a,b){var c=this._getSelectionForOffset(a,b),d=this.get2DCursorLocation(c),e=d.lineIndex;if(0===e||a.metaKey||33===a.keyCode)return-c;var f=d.charIndex,g=this._getWidthBeforeCursor(e,f),h=this._getIndexOnLine(e-1,g),i=this._textLines[e].slice(0,f),j=this.missingNewlineOffset(e-1);return-this._textLines[e-1].length+h-i.length+(1-j)},_getIndexOnLine:function(a,b){for(var c,d,e=this._textLines[a],f=this._getLineLeftOffset(a),g=0,h=0,i=e.length;h<i;h++)if((f+=c=this.__charBounds[a][h].width)>b){d=!0;var j=Math.abs(f-c-b);g=Math.abs(f-b)<j?h:h-1;break}return d||(g=e.length-1),g},moveCursorDown:function(a){this.selectionStart>=this._text.length&&this.selectionEnd>=this._text.length||this._moveCursorUpOrDown("Down",a)},moveCursorUp:function(a){(0!==this.selectionStart||0!==this.selectionEnd)&&this._moveCursorUpOrDown("Up",a)},_moveCursorUpOrDown:function(a,b){var c=this["get"+a+"CursorOffset"](b,"right"===this._selectionDirection);b.shiftKey?this.moveCursorWithShift(c):this.moveCursorWithoutShift(c),0!==c&&(this.setSelectionInBoundaries(),this.abortCursorAnimation(),this._currentCursorOpacity=1,this.initDelayedCursor(),this._fireSelectionChanged(),this._updateTextarea())},moveCursorWithShift:function(a){var b="left"===this._selectionDirection?this.selectionStart+a:this.selectionEnd+a;return this.setSelectionStartEndWithShift(this.selectionStart,this.selectionEnd,b),0!==a},moveCursorWithoutShift:function(a){return a<0?(this.selectionStart+=a,this.selectionEnd=this.selectionStart):(this.selectionEnd+=a,this.selectionStart=this.selectionEnd),0!==a},moveCursorLeft:function(a){(0!==this.selectionStart||0!==this.selectionEnd)&&this._moveCursorLeftOrRight("Left",a)},_move:function(a,b,c){var d;if(a.altKey)d=this["findWordBoundary"+c](this[b]);else{if(!a.metaKey&&35!==a.keyCode&&36!==a.keyCode)return this[b]+="Left"===c?-1:1,!0;d=this["findLineBoundary"+c](this[b])}if(void 0!==d&&this[b]!==d)return this[b]=d,!0},_moveLeft:function(a,b){return this._move(a,b,"Left")},_moveRight:function(a,b){return this._move(a,b,"Right")},moveCursorLeftWithoutShift:function(a){var b=!0;return this._selectionDirection="left",this.selectionEnd===this.selectionStart&&0!==this.selectionStart&&(b=this._moveLeft(a,"selectionStart")),this.selectionEnd=this.selectionStart,b},moveCursorLeftWithShift:function(a){return"right"===this._selectionDirection&&this.selectionStart!==this.selectionEnd?this._moveLeft(a,"selectionEnd"):0!==this.selectionStart?(this._selectionDirection="left",this._moveLeft(a,"selectionStart")):void 0},moveCursorRight:function(a){this.selectionStart>=this._text.length&&this.selectionEnd>=this._text.length||this._moveCursorLeftOrRight("Right",a)},_moveCursorLeftOrRight:function(a,b){var c="moveCursor"+a+"With";this._currentCursorOpacity=1,b.shiftKey?c+="Shift":c+="outShift",this[c](b)&&(this.abortCursorAnimation(),this.initDelayedCursor(),this._fireSelectionChanged(),this._updateTextarea())},moveCursorRightWithShift:function(a){return"left"===this._selectionDirection&&this.selectionStart!==this.selectionEnd?this._moveRight(a,"selectionStart"):this.selectionEnd!==this._text.length?(this._selectionDirection="right",this._moveRight(a,"selectionEnd")):void 0},moveCursorRightWithoutShift:function(a){var b=!0;return this._selectionDirection="right",this.selectionStart===this.selectionEnd?(b=this._moveRight(a,"selectionStart"),this.selectionEnd=this.selectionStart):this.selectionStart=this.selectionEnd,b},removeChars:function(a,b){void 0===b&&(b=a+1),this.removeStyleFromTo(a,b),this._text.splice(a,b-a),this.text=this._text.join(""),this.set("dirty",!0),this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this._removeExtraneousStyles()},insertChars:function(a,b,c,d){void 0===d&&(d=c),d>c&&this.removeStyleFromTo(c,d);var e=H.util.string.graphemeSplit(a);this.insertNewStyleBlock(e,c,b),this._text=[].concat(this._text.slice(0,c),e,this._text.slice(d)),this.text=this._text.join(""),this.set("dirty",!0),this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this._removeExtraneousStyles()}}),C=H.util.toFixed,D=H.util.radiansToDegrees,E=H.util.calcRotateMatrix,F=H.util.transformPoint,G=/  +/g,H.util.object.extend(H.Text.prototype,{_toSVG:function(){var a=this._getSVGLeftTopOffsets(),b=this._getSVGTextAndBg(a.textTop,a.textLeft);return this._wrapSVGTextAndBg(b)},toSVG:function(a){var b=this._createBaseSVGMarkup(this._toSVG(),{reviver:a,noStyle:!0,withShadow:!0}),c=this.path;return c?b+c._createBaseSVGMarkup(c._toSVG(),{reviver:a,withShadow:!0}):b},_getSVGLeftTopOffsets:function(){return{textLeft:-this.width/2,textTop:-this.height/2,lineTop:this.getHeightOfLine(0)}},_wrapSVGTextAndBg:function(a){var b=this.getSvgTextDecoration(this);return[a.textBgRects.join(""),'		<text xml:space="preserve" ',this.fontFamily?'font-family="'+this.fontFamily.replace(/"/g,"'")+'" ':"",this.fontSize?'font-size="'+this.fontSize+'" ':"",this.fontStyle?'font-style="'+this.fontStyle+'" ':"",this.fontWeight?'font-weight="'+this.fontWeight+'" ':"",b?'text-decoration="'+b+'" ':"",'style="',this.getSvgStyles(!0),'"',this.addPaintOrder()," >",a.textSpans.join(""),"</text>\n"]},_getSVGTextAndBg:function(a,b){var c,d=[],e=[],f=a;this._setSVGBg(e);for(var g=0,h=this._textLines.length;g<h;g++)c=this._getLineLeftOffset(g),(this.textBackgroundColor||this.styleHas("textBackgroundColor",g))&&this._setSVGTextLineBg(e,g,b+c,f),this._setSVGTextLineText(d,g,b+c,f),f+=this.getHeightOfLine(g);return{textSpans:d,textBgRects:e}},_createTextCharSpan:function(a,b,c,d,e){var f=a!==a.trim()||a.match(G),g=this.getSvgSpanStyles(b,f),h=b.deltaY,i="",j=H.Object.NUM_FRACTION_DIGITS,k="";if(h&&(i=' dy="'+C(h,j)+'" '),void 0!==e.renderLeft){var l=e.angle;k=' rotate="'+C(D(l),H.Object.NUM_FRACTION_DIGITS)+'" ';var m=e.width/2,n=E({angle:D(l)});n[4]=e.renderLeft,n[5]=e.renderTop;var o=F({x:-m,y:0},n);c=o.x,d=o.y}return'<tspan x="'+C(c,j)+'" y="'+C(d,j)+'" '+i+(g?'style="'+g+'"':"")+k+">"+H.util.string.escapeXml(a)+"</tspan>"},_setSVGTextLineText:function(a,b,c,d){var e,f,g,h,i,j=this.getHeightOfLine(b),k=-1!==this.textAlign.indexOf("justify"),l="",m=0,n=this._textLines[b];d+=j*(1-this._fontSizeFraction)/this.lineHeight;for(var o=0,p=n.length-1;o<=p;o++)i=o===p||this.charSpacing||this.path,l+=n[o],g=this.__charBounds[b][o],0===m?(c+=g.kernedWidth-g.width,m+=g.width):m+=g.kernedWidth,k&&!i&&this._reSpaceAndTab.test(n[o])&&(i=!0),i||(e=e||this.getCompleteStyleDeclaration(b,o),f=this.getCompleteStyleDeclaration(b,o+1),i=H.util.hasStyleChanged(e,f,!0)),i&&(h=this._getStyleDeclaration(b,o)||{},a.push(this._createTextCharSpan(l,h,c,d,g)),l="",e=f,c+=m,m=0)},_pushTextBgRect:function(a,b,c,d,e,f){var g=H.Object.NUM_FRACTION_DIGITS;a.push("		<rect ",this._getFillAttributes(b),' x="',C(c,g),'" y="',C(d,g),'" width="',C(e,g),'" height="',C(f,g),'"></rect>\n')},_setSVGTextLineBg:function(a,b,c,d){for(var e,f,g=this._textLines[b],h=this.getHeightOfLine(b)/this.lineHeight,i=0,j=0,k=this.getValueOfPropertyAt(b,0,"textBackgroundColor"),l=0,m=g.length;l<m;l++)e=this.__charBounds[b][l],(f=this.getValueOfPropertyAt(b,l,"textBackgroundColor"))!==k?(k&&this._pushTextBgRect(a,k,c+j,d,i,h),j=e.left,i=e.width,k=f):i+=e.kernedWidth;f&&this._pushTextBgRect(a,f,c+j,d,i,h)},_getFillAttributes:function(a){var b=a&&"string"==typeof a?new H.Color(a):"";return b&&b.getSource()&&1!==b.getAlpha()?'opacity="'+b.getAlpha()+'" fill="'+b.setAlpha(1).toRgb()+'"':'fill="'+a+'"'},_getSVGLineTopOffset:function(a){for(var b=0,c=0,d=0;d<a;d++)b+=this.getHeightOfLine(d);return c=this.getHeightOfLine(d),{lineTop:b,offset:(this._fontSizeMult-this._fontSizeFraction)*c/(this.lineHeight*this._fontSizeMult)}},getSvgStyles:function(a){return H.Object.prototype.getSvgStyles.call(this,a)+" white-space: pre;"}}),function(a){"use strict";var b=a.fabric||(a.fabric={});b.Textbox=b.util.createClass(b.IText,b.Observable,{type:"textbox",minWidth:20,dynamicMinWidth:2,__cachedLines:null,lockScalingFlip:!0,noScaleCache:!1,_dimensionAffectingProps:b.Text.prototype._dimensionAffectingProps.concat("width"),_wordJoiners:/[ \t\r]/,splitByGrapheme:!1,initDimensions:function(){this.__skipDimension||(this.isEditing&&this.initDelayedCursor(),this.clearContextTop(),this._clearCache(),this.dynamicMinWidth=0,this._styleMap=this._generateStyleMap(this._splitText()),this.dynamicMinWidth>this.width&&this._set("width",this.dynamicMinWidth),-1!==this.textAlign.indexOf("justify")&&this.enlargeSpaces(),this.height=this.calcTextHeight(),this.saveState({propertySet:"_dimensionAffectingProps"}))},_generateStyleMap:function(a){for(var b=0,c=0,d=0,e={},f=0;f<a.graphemeLines.length;f++)"\n"===a.graphemeText[d]&&f>0?(c=0,d++,b++):!this.splitByGrapheme&&this._reSpaceAndTab.test(a.graphemeText[d])&&f>0&&(c++,d++),e[f]={line:b,offset:c},d+=a.graphemeLines[f].length,c+=a.graphemeLines[f].length;return e},styleHas:function(a,c){if(this._styleMap&&!this.isWrapping){var d=this._styleMap[c];d&&(c=d.line)}return b.Text.prototype.styleHas.call(this,a,c)},isEmptyStyles:function(a){if(!this.styles)return!0;var b,c,d=0,e=!1,f=this._styleMap[a],g=this._styleMap[a+1];for(var h in f&&(a=f.line,d=f.offset),g&&(e=g.line===a,b=g.offset),c=void 0===a?this.styles:{line:this.styles[a]})for(var i in c[h])if(i>=d&&(!e||i<b))for(var j in c[h][i])return!1;return!0},_getStyleDeclaration:function(a,b){if(this._styleMap&&!this.isWrapping){var c=this._styleMap[a];if(!c)return null;a=c.line,b=c.offset+b}return this.callSuper("_getStyleDeclaration",a,b)},_setStyleDeclaration:function(a,b,c){var d=this._styleMap[a];a=d.line,b=d.offset+b,this.styles[a][b]=c},_deleteStyleDeclaration:function(a,b){var c=this._styleMap[a];a=c.line,b=c.offset+b,delete this.styles[a][b]},_getLineStyle:function(a){var b=this._styleMap[a];return!!this.styles[b.line]},_setLineStyle:function(a){var b=this._styleMap[a];this.styles[b.line]={}},_wrapText:function(a,b){var c,d=[];for(c=0,this.isWrapping=!0;c<a.length;c++)d=d.concat(this._wrapLine(a[c],c,b));return this.isWrapping=!1,d},_measureWord:function(a,b,c){var d,e=0;c=c||0;for(var f=0,g=a.length;f<g;f++)e+=this._getGraphemeBox(a[f],b,f+c,d,!0).kernedWidth,d=a[f];return e},_wrapLine:function(a,c,d,e){var f=0,g=this.splitByGrapheme,h=[],i=[],j=g?b.util.string.graphemeSplit(a):a.split(this._wordJoiners),k="",l=0,m=g?"":" ",n=0,o=0,p=0,q=!0,r=this._getWidthOfCharSpacing(),e=e||0;0===j.length&&j.push([]),d-=e;for(var s=0;s<j.length;s++)k=g?j[s]:b.util.string.graphemeSplit(j[s]),n=this._measureWord(k,c,l),l+=k.length,(f+=o+n-r)>d&&!q?(h.push(i),i=[],f=n,q=!0):f+=r,q||g||i.push(m),i=i.concat(k),o=g?0:this._measureWord([m],c,l),l++,q=!1,n>p&&(p=n);return s&&h.push(i),p+e>this.dynamicMinWidth&&(this.dynamicMinWidth=p-r+e),h},isEndOfWrapping:function(a){return!this._styleMap[a+1]||this._styleMap[a+1].line!==this._styleMap[a].line},missingNewlineOffset:function(a,b){return this.splitByGrapheme&&!b?+!!this.isEndOfWrapping(a):1},_splitTextIntoLines:function(a){for(var c=b.Text.prototype._splitTextIntoLines.call(this,a),d=this._wrapText(c.lines,this.width),e=Array(d.length),f=0;f<d.length;f++)e[f]=d[f].join("");return c.lines=e,c.graphemeLines=d,c},getMinWidth:function(){return Math.max(this.minWidth,this.dynamicMinWidth)},_removeExtraneousStyles:function(){var a={};for(var b in this._styleMap)this._textLines[b]&&(a[this._styleMap[b].line]=1);for(var b in this.styles)a[b]||delete this.styles[b]},toObject:function(a){return this.callSuper("toObject",["minWidth","splitByGrapheme"].concat(a))}}),b.Textbox.fromObject=function(a,c){var d=b.util.stylesFromArray(a.styles,a.text),e=Object.assign({},a,{styles:d});return delete e.path,b.Object._fromObject("Textbox",e,function(d){a.path?b.Object._fromObject("Path",a.path,function(a){d.set("path",a),c(d)},"path"):c(d)},"text")}}(c),function(){var a=H.controlsUtils,b=a.scaleSkewCursorStyleHandler,c=a.scaleCursorStyleHandler,d=a.scalingEqually,e=a.scalingYOrSkewingX,f=a.scalingXOrSkewingY,g=a.scaleOrSkewActionName,h=H.Object.prototype.controls;if(h.ml=new H.Control({x:-.5,y:0,cursorStyleHandler:b,actionHandler:f,getActionName:g}),h.mr=new H.Control({x:.5,y:0,cursorStyleHandler:b,actionHandler:f,getActionName:g}),h.mb=new H.Control({x:0,y:.5,cursorStyleHandler:b,actionHandler:e,getActionName:g}),h.mt=new H.Control({x:0,y:-.5,cursorStyleHandler:b,actionHandler:e,getActionName:g}),h.tl=new H.Control({x:-.5,y:-.5,cursorStyleHandler:c,actionHandler:d}),h.tr=new H.Control({x:.5,y:-.5,cursorStyleHandler:c,actionHandler:d}),h.bl=new H.Control({x:-.5,y:.5,cursorStyleHandler:c,actionHandler:d}),h.br=new H.Control({x:.5,y:.5,cursorStyleHandler:c,actionHandler:d}),h.mtr=new H.Control({x:0,y:-.5,actionHandler:a.rotationWithSnapping,cursorStyleHandler:a.rotationStyleHandler,offsetY:-40,withConnection:!0,actionName:"rotate"}),H.Textbox){var i=H.Textbox.prototype.controls={};i.mtr=h.mtr,i.tr=h.tr,i.br=h.br,i.tl=h.tl,i.bl=h.bl,i.mt=h.mt,i.mb=h.mb,i.mr=new H.Control({x:.5,y:0,actionHandler:a.changeWidth,cursorStyleHandler:b,actionName:"resizing"}),i.ml=new H.Control({x:-.5,y:0,actionHandler:a.changeWidth,cursorStyleHandler:b,actionName:"resizing"})}}()},41979,a=>{"use strict";var b=a.i(87924),c=a.i(72131),d=a.i(30553),e="Progress",[f,g]=function(a,d=[]){let e=[],f=()=>{let b=e.map(a=>c.createContext(a));return function(d){let e=d?.[a]||b;return c.useMemo(()=>({[`__scope${a}`]:{...d,[a]:e}}),[d,e])}};return f.scopeName=a,[function(d,f){let g=c.createContext(f),h=e.length;function i(d){let{scope:e,children:f,...i}=d,j=e?.[a][h]||g,k=c.useMemo(()=>i,Object.values(i));return(0,b.jsx)(j.Provider,{value:k,children:f})}return e=[...e,f],i.displayName=d+"Provider",[i,function(b,e){let i=e?.[a][h]||g,j=c.useContext(i);if(j)return j;if(void 0!==f)return f;throw Error(`\`${b}\` must be used within \`${d}\``)}]},function(...a){let b=a[0];if(1===a.length)return b;let d=()=>{let d=a.map(a=>({useScope:a(),scopeName:a.scopeName}));return function(a){let e=d.reduce((b,{useScope:c,scopeName:d})=>{let e=c(a)[`__scope${d}`];return{...b,...e}},{});return c.useMemo(()=>({[`__scope${b.scopeName}`]:e}),[e])}};return d.scopeName=b.scopeName,d}(f,...d)]}(e),[h,i]=f(e),j=c.forwardRef((a,c)=>{var e,f;let{__scopeProgress:g,value:i=null,max:j,getValueLabel:k=m,...l}=a;(j||0===j)&&!p(j)&&console.error((e=`${j}`,`Invalid prop \`max\` of value \`${e}\` supplied to \`Progress\`. Only numbers greater than 0 are valid max values. Defaulting to \`100\`.`));let r=p(j)?j:100;null===i||q(i,r)||console.error((f=`${i}`,`Invalid prop \`value\` of value \`${f}\` supplied to \`Progress\`. The \`value\` prop must be:
  - a positive number
  - less than the value passed to \`max\` (or 100 if no \`max\` prop is set)
  - \`null\` or \`undefined\` if the progress is indeterminate.

Defaulting to \`null\`.`));let s=q(i,r)?i:null,t=o(s)?k(s,r):void 0;return(0,b.jsx)(h,{scope:g,value:s,max:r,children:(0,b.jsx)(d.Primitive.div,{"aria-valuemax":r,"aria-valuemin":0,"aria-valuenow":o(s)?s:void 0,"aria-valuetext":t,role:"progressbar","data-state":n(s,r),"data-value":s??void 0,"data-max":r,...l,ref:c})})});j.displayName=e;var k="ProgressIndicator",l=c.forwardRef((a,c)=>{let{__scopeProgress:e,...f}=a,g=i(k,e);return(0,b.jsx)(d.Primitive.div,{"data-state":n(g.value,g.max),"data-value":g.value??void 0,"data-max":g.max,...f,ref:c})});function m(a,b){return`${Math.round(a/b*100)}%`}function n(a,b){return null==a?"indeterminate":a===b?"complete":"loading"}function o(a){return"number"==typeof a}function p(a){return o(a)&&!isNaN(a)&&a>0}function q(a,b){return o(a)&&!isNaN(a)&&a<=b&&a>=0}l.displayName=k;var r=a.i(68114);let s=c.forwardRef(({className:a,value:c,...d},e)=>(0,b.jsx)(j,{ref:e,className:(0,r.cn)("relative h-4 w-full overflow-hidden rounded-full bg-secondary",a),...d,children:(0,b.jsx)(l,{className:"h-full w-full flex-1 bg-primary transition-all",style:{transform:`translateX(-${100-(c||0)}%)`}})}));s.displayName=j.displayName;let t=({currentStep:a})=>(0,b.jsxs)("div",{className:"mb-10",children:[(0,b.jsx)("div",{className:"max-w-xs mx-auto mb-8",children:(0,b.jsx)(s,{value:(()=>{switch(a){case"preferences":default:return 33;case"design":return 66;case"options":return 100}})(),className:"h-2"})}),(0,b.jsxs)("div",{className:"flex justify-between items-center",children:[(0,b.jsxs)("div",{className:"flex flex-col items-center",children:[(0,b.jsx)("div",{className:`w-12 h-12 rounded-full flex items-center justify-center ${"preferences"===a?"bg-blue-600 text-white":"bg-white border-2 border-gray-200 text-gray-700"}`,children:"1"}),(0,b.jsx)("span",{className:"mt-2 text-sm font-medium",children:"Preferences"})]}),(0,b.jsxs)("div",{className:"flex flex-col items-center",children:[(0,b.jsx)("div",{className:`w-12 h-12 rounded-full flex items-center justify-center ${"design"===a?"bg-blue-600 text-white":"bg-white border-2 border-gray-200 text-gray-700"}`,children:"2"}),(0,b.jsx)("span",{className:"mt-2 text-sm font-medium",children:"Design"})]}),(0,b.jsxs)("div",{className:"flex flex-col items-center",children:[(0,b.jsx)("div",{className:`w-12 h-12 rounded-full flex items-center justify-center ${"options"===a?"bg-blue-600 text-white":"bg-white border-2 border-gray-200 text-gray-700"}`,children:"3"}),(0,b.jsx)("span",{className:"mt-2 text-sm font-medium",children:"Options"})]})]})]});var u=a.i(14574),v=a.i(99570);let w=({open:a,answers:c,onClose:d,onConfirm:e,onEdit:f})=>(console.log("ConfirmationDialog displaying answers:",c),(0,b.jsx)(u.Dialog,{open:a,onOpenChange:d,children:(0,b.jsxs)(u.DialogContent,{className:"sm:max-w-md",children:[(0,b.jsx)(u.DialogHeader,{children:(0,b.jsx)(u.DialogTitle,{children:"Confirm Your Design Preferences"})}),(0,b.jsxs)("div",{className:"py-4",children:[(0,b.jsx)("p",{className:"text-gray-600 mb-4",children:"Please review your design preferences before continuing:"}),(0,b.jsx)("div",{className:"space-y-2 border rounded-md p-4",children:0===c.length?(0,b.jsx)("p",{className:"text-gray-500",children:"No preferences selected."}):c.map((a,c)=>(0,b.jsxs)("div",{className:"flex flex-col sm:flex-row sm:justify-between gap-1 pb-2 border-b last:border-0 last:pb-0",children:[(0,b.jsx)("span",{className:"text-gray-600 font-medium",children:a.question}),(0,b.jsx)("span",{className:"text-right",children:a.answer})]},c))})]}),(0,b.jsxs)(u.DialogFooter,{className:"flex flex-col-reverse sm:flex-row sm:justify-between sm:space-x-2",children:[(0,b.jsx)(v.Button,{variant:"outline",onClick:f,children:"Edit Preferences"}),(0,b.jsx)(v.Button,{onClick:e,children:"Confirm & Continue"})]})]})}));var x=a.i(20444),y=a.i(35475),z=a.i(75368);let A={BLACK:"#000000",WHITE:"#FFFFFF",RED:"#DC2626",GREY:"#8A898C",BLUE:"#1EAEDB"},B={"#000000":z.tshirtColors.black,"#FFFFFF":z.tshirtColors.white,"#DC2626":z.tshirtColors.red,"#8A898C":z.tshirtColors.grey,"#1EAEDB":z.tshirtColors.blue};A.WHITE;var C=a.i(50944),D=a.i(74167),E=a.i(69769),F=a.i(54614);class G{static logs=[];static maxLogs=100;static log(a,b,c){let d={id:crypto.randomUUID(),timestamp:new Date,error:a,context:b,metadata:c};this.logs.unshift(d),this.logs.length>this.maxLogs&&(this.logs=this.logs.slice(0,this.maxLogs)),console.error(`[ErrorLogger] ${b}:`,a,c),this.isCriticalError(b)&&this.showUserError(a,b)}static isCriticalError(a){return["DesignGeneration","DesignSave","Authentication","CanvasRender"].some(b=>a.includes(b))}static showUserError(a,b){let c=Object.entries({DesignGeneration:"Failed to generate design. Please try again.",DesignSave:"Failed to save design. Please check your connection and try again.",Authentication:"Authentication error. Please sign in again.",CanvasRender:"Canvas rendering error. Please refresh the page."}).find(([a])=>b.includes(a))?.[1]||"An unexpected error occurred. Please try again.";(0,F.toast)({variant:"destructive",title:"Error",description:c})}static getLogs(){return[...this.logs]}static clearLogs(){this.logs=[]}}function H(a){return"string"!=typeof a?"":a.replace(/<[^>]*>/g,"").replace(/[^A-Za-z0-9 .,!?;:'"()\-_/@#&%+\[\]]+/g," ").trim().replace(/\s{2,}/g," ")}a.s([],65704),a.i(65704);let I=({message:a="Loading..."})=>(0,b.jsxs)("div",{className:"flex justify-center items-center h-64",children:[(0,b.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"}),(0,b.jsx)("span",{className:"ml-3",children:a})]});var J=a.i(91119),K=globalThis?.document?c.useLayoutEffect:()=>{};a.i(35412);var L=c[" useInsertionEffect ".trim().toString()]||K;function M(a,b){if("function"==typeof a)return a(b);null!=a&&(a.current=b)}Symbol("RADIX:SYNC_STATE"),a.i(35112);var N=Symbol("radix.slottable");function O(a){return c.isValidElement(a)&&"function"==typeof a.type&&"__radixId"in a.type&&a.type.__radixId===N}var P=["a","button","div","form","h2","h3","img","input","label","li","nav","ol","p","select","span","svg","ul"].reduce((a,d)=>{var e,f;let g,h,i,j=(f=e=`Primitive.${d}`,(g=c.forwardRef((a,b)=>{let{children:d,...e}=a;if(c.isValidElement(d)){var f;let a,g,h=(f=d,(g=(a=Object.getOwnPropertyDescriptor(f.props,"ref")?.get)&&"isReactWarning"in a&&a.isReactWarning)?f.ref:(g=(a=Object.getOwnPropertyDescriptor(f,"ref")?.get)&&"isReactWarning"in a&&a.isReactWarning)?f.props.ref:f.props.ref||f.ref),i=function(a,b){let c={...b};for(let d in b){let e=a[d],f=b[d];/^on[A-Z]/.test(d)?e&&f?c[d]=(...a)=>{let b=f(...a);return e(...a),b}:e&&(c[d]=e):"style"===d?c[d]={...e,...f}:"className"===d&&(c[d]=[e,f].filter(Boolean).join(" "))}return{...a,...c}}(e,d.props);return d.type!==c.Fragment&&(i.ref=b?function(...a){return b=>{let c=!1,d=a.map(a=>{let d=M(a,b);return c||"function"!=typeof d||(c=!0),d});if(c)return()=>{for(let b=0;b<d.length;b++){let c=d[b];"function"==typeof c?c():M(a[b],null)}}}}(b,h):h),c.cloneElement(d,i)}return c.Children.count(d)>1?c.Children.only(null):null})).displayName=`${f}.SlotClone`,h=g,(i=c.forwardRef((a,d)=>{let{children:e,...f}=a,g=c.Children.toArray(e),i=g.find(O);if(i){let a=i.props.children,e=g.map(b=>b!==i?b:c.Children.count(a)>1?c.Children.only(null):c.isValidElement(a)?a.props.children:null);return(0,b.jsx)(h,{...f,ref:d,children:c.isValidElement(a)?c.cloneElement(a,void 0,e):null})}return(0,b.jsx)(h,{...f,ref:d,children:e})})).displayName=`${e}.Slot`,i),k=c.forwardRef((a,c)=>{let{asChild:e,...f}=a;return(0,b.jsx)(e?j:d,{...f,ref:c})});return k.displayName=`Primitive.${d}`,{...a,[d]:k}},{}),Q="Toggle",R=c.forwardRef((a,d)=>{let{pressed:e,defaultPressed:f,onPressedChange:g,...h}=a,[i,j]=function({prop:a,defaultProp:b,onChange:d=()=>{},caller:e}){let[f,g,h]=function({defaultProp:a,onChange:b}){let[d,e]=c.useState(a),f=c.useRef(d),g=c.useRef(b);return L(()=>{g.current=b},[b]),c.useEffect(()=>{f.current!==d&&(g.current?.(d),f.current=d)},[d,f]),[d,e,g]}({defaultProp:b,onChange:d}),i=void 0!==a,j=i?a:f;{let b=c.useRef(void 0!==a);c.useEffect(()=>{let a=b.current;if(a!==i){let b=i?"controlled":"uncontrolled";console.warn(`${e} is changing from ${a?"controlled":"uncontrolled"} to ${b}. Components should not switch from controlled to uncontrolled (or vice versa). Decide between using a controlled or uncontrolled value for the lifetime of the component.`)}b.current=i},[i,e])}return[j,c.useCallback(b=>{if(i){let c="function"==typeof b?b(a):b;c!==a&&h.current?.(c)}else g(b)},[i,a,g,h])]}({prop:e,onChange:g,defaultProp:f??!1,caller:Q});return(0,b.jsx)(P.button,{type:"button","aria-pressed":i,"data-state":i?"on":"off","data-disabled":a.disabled?"":void 0,...h,ref:d,onClick:function(a,b,{checkForDefaultPrevented:c=!0}={}){return function(d){if(a?.(d),!1===c||!d.defaultPrevented)return b?.(d)}}(a.onClick,()=>{a.disabled||j(!i)})})});R.displayName=Q;let S=(0,a.i(187).cva)("inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground",{variants:{variant:{default:"bg-transparent",outline:"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground"},size:{default:"h-10 px-3",sm:"h-9 px-2.5",lg:"h-11 px-5"}},defaultVariants:{variant:"default",size:"default"}}),T=c.forwardRef(({className:a,variant:c,size:d,...e},f)=>(0,b.jsx)(R,{ref:f,className:(0,r.cn)(S({variant:c,size:d,className:a})),...e}));T.displayName=R.displayName;let U=["All","Artistic","Minimal","Nature","Abstract","Typography"],V=[{id:1,name:"Travel",description:"Capture your wanderlust",color:"#00BCD4",category:["Artistic"],image:"/uploads/1fb8d5ab-666d-49a1-b349-c0a086a816fa.png"},{id:2,name:"Music",description:"Express your rhythm",color:"#9C27B0",category:["Abstract","Artistic"],image:"/uploads/754dd742-8aea-49d6-ac83-97af6c757084.png"},{id:3,name:"Vintage",description:"Classic retro style",color:"#A67C52",category:["Artistic"],image:"/uploads/6676f311-43f9-47ee-86aa-e7bd93150976.png"},{id:4,name:"Nature",description:"Connect with the outdoors",color:"#8BC34A",category:["Nature"],image:"/uploads/3de9e312-dbc0-48a8-ad72-5f348b474fb9.png"},{id:5,name:"Abstract",description:"Bold geometric patterns",color:"#FF1493",category:["Abstract"],image:"/uploads/3390f772-94a3-49ac-9380-6d8e091a4c65.png"},{id:6,name:"Artistic",description:"Expressive and creative",color:"#00E5B2",category:["Artistic"],image:"/uploads/0a1a3611-6080-4670-a291-9e87b4247dec.png"},{id:7,name:"Cyberpunk",description:"Futuristic neon aesthetics",color:"#E91E63",category:["Abstract"],image:"/uploads/8398eed3-bd38-4e5f-9278-00f9f2ca7c7a.png"},{id:8,name:"Funny",description:"Lighthearted and humorous",color:"#FFC107",category:["Typography"],image:"/uploads/a864a361-eb88-4887-ae3b-93c9731c347a.png"}],W=({onThemeSelect:a})=>{let[d,e]=(0,c.useState)("All"),[f,g]=(0,c.useState)([]),h="All"===d?V:V.filter(a=>a.category.includes(d));return(0,b.jsxs)("div",{className:"py-6",children:[(0,b.jsxs)("div",{className:"mb-8",children:[(0,b.jsxs)("h2",{className:"text-2xl font-bold mb-2 flex items-center",children:[(0,b.jsx)("span",{className:"inline-flex items-center justify-center w-8 h-8 mr-2 bg-blue-100 text-blue-800 rounded-full",children:(0,b.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:(0,b.jsx)("path",{d:"M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"})})}),"Choose Your Design Themes"]}),(0,b.jsx)("p",{className:"text-gray-600",children:"Select up to 3 themes that best match the style you're looking for."})]}),(0,b.jsxs)("div",{className:"mb-6",children:[(0,b.jsx)("h3",{className:"text-sm uppercase font-semibold text-gray-500 mb-3",children:"FILTER BY CATEGORY"}),(0,b.jsx)("div",{className:"flex flex-wrap gap-2",children:U.map(a=>(0,b.jsx)(T,{variant:"outline",pressed:d===a,onPressedChange:()=>e(a),className:`rounded-full px-4 py-2 text-sm ${d===a?"bg-blue-50 text-blue-800 border-blue-200":"bg-gray-50 text-gray-700"}`,children:a},a))})]}),(0,b.jsx)("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4",children:h.map(a=>{let c;return(0,b.jsxs)(J.Card,{className:`overflow-hidden cursor-pointer transition-all ${(c=a.id,f.includes(c))?"ring-2 ring-blue-600 ring-offset-2":"hover:shadow-md"}`,onClick:()=>{var b;return b=a.id,void(f.includes(b)?g(f.filter(a=>a!==b)):f.length<3&&g([...f,b]))},children:[(0,b.jsx)("div",{className:"h-36 relative overflow-hidden",children:(0,b.jsx)("img",{src:a.image,alt:a.name,className:"w-full h-full object-cover"})}),(0,b.jsxs)(J.CardContent,{className:"p-4",children:[(0,b.jsx)("h3",{className:"font-medium mb-1",children:a.name}),(0,b.jsx)("p",{className:"text-gray-600 text-sm",children:a.description})]})]},a.id)})}),(0,b.jsx)("div",{className:"mt-8 text-right",children:(0,b.jsx)(v.Button,{onClick:()=>{let b=V.find(a=>a.id===f[0]);b&&a(b)},disabled:0===f.length,className:"px-6",children:"Continue"})})]})};var X=a.i(66718),Y=a.i(48468),Z=a.i(70430);let $=c.forwardRef(({className:a,...c},d)=>(0,b.jsx)("textarea",{className:(0,r.cn)("flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",a),ref:d,...c}));$.displayName="Textarea";let _=({selectedTheme:a,onComplete:d,onBack:e})=>{let[f,g]=(0,c.useState)(0),[h,i]=(0,c.useState)([]),[j,k]=(0,c.useState)(""),l=(0,c.useMemo)(()=>[{id:1,question:"What's the main message you want on your t-shirt?",type:"text"},{id:2,question:"What style are you looking for?",type:"radio",options:["Casual","Formal","Sporty","Vintage","Minimal"]},{id:3,question:"What's the occasion for this t-shirt?",type:"radio",options:["Everyday wear","Special event","Gift","Team/Group","Casual wear"]},{id:4,question:"Any additional details you'd like to include in your design?",type:"textarea"}],[]);(0,c.useEffect)(()=>{let a=h.find(a=>a.question===l[f].question);a?k(a.answer):k("")},[f,h,l]);let m=()=>{if(!j.trim())return;let a=l[f];console.log(`Saving answer for question: ${a.question}, answer: ${j}`);let b=[...h],c=h.findIndex(b=>b.question===a.question);c>=0?b[c]={question:a.question,answer:j}:b.push({question:a.question,answer:j}),i(b)},n=l[f],o=(f+1)/l.length*100;return(0,b.jsxs)("div",{className:"py-6",children:[(0,b.jsxs)("div",{className:"mb-8",children:[(0,b.jsx)("h2",{className:"text-2xl font-bold mb-4",children:"Create Your T-Shirt Design"}),(0,b.jsxs)("p",{className:"text-gray-600 mb-4",children:["Question ",f+1," of ",l.length]}),(0,b.jsx)(s,{value:o,className:"h-2"})]}),(0,b.jsxs)("div",{className:"mb-8",children:[(0,b.jsx)("h2",{className:"text-xl font-medium mb-6",children:n.question}),(()=>{switch(n.type){case"text":return(0,b.jsx)(X.Input,{value:j,onChange:a=>k(a.target.value),className:"w-full text-lg p-4 h-auto",placeholder:"Enter your text here"});case"radio":return(0,b.jsx)(Y.RadioGroup,{value:j,onValueChange:k,className:"space-y-3",children:n.options?.map(a=>(0,b.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,b.jsx)(Y.RadioGroupItem,{value:a,id:a}),(0,b.jsx)(Z.Label,{htmlFor:a,children:a})]},a))});case"textarea":return(0,b.jsx)($,{value:j,onChange:a=>k(a.target.value),placeholder:"Enter your details here",className:"min-h-32"});default:return null}})()]}),(0,b.jsxs)("div",{className:"flex justify-between",children:[(0,b.jsxs)(v.Button,{variant:"outline",onClick:()=>{j.trim()&&m(),f>0?g(a=>a-1):e()},className:"flex items-center gap-2",children:[(0,b.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:(0,b.jsx)("path",{d:"M15 18l-6-6 6-6"})}),0===f?"Back to Themes":"Previous Question"]}),(0,b.jsxs)(v.Button,{onClick:()=>{if(j.trim())if(m(),f<l.length-1)g(a=>a+1);else{let a=[...h],b=l[f],c=h.findIndex(a=>a.question===b.question);c>=0?a[c]={question:b.question,answer:j}:a.push({question:b.question,answer:j}),console.log("All questions answered:",a),d(a)}},disabled:!j.trim(),children:[f===l.length-1?"Complete":"Next Question",(0,b.jsx)("svg",{className:"ml-2",xmlns:"http://www.w3.org/2000/svg",width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:(0,b.jsx)("path",{d:"M9 18l6-6-6-6"})})]})]})]})},aa=({color:a="#FFFFFF",designImage:d})=>{let[e,f]=(0,c.useState)(!0),[g,h]=(0,c.useState)(!1),[i,j]=(0,c.useState)(!1),k=B[a]||B["#FFFFFF"];return(0,b.jsxs)("div",{className:"relative w-full max-w-md mx-auto",children:[(0,b.jsxs)("div",{className:"relative w-full aspect-[4/5]",children:[g?(0,b.jsx)("div",{className:"w-full h-full rounded-lg shadow-lg relative flex items-center justify-center border border-gray-200",style:{backgroundColor:a},children:(0,b.jsxs)("svg",{className:"w-full h-full",viewBox:"0 0 400 500",fill:"none",preserveAspectRatio:"xMidYMid meet",children:[(0,b.jsx)("path",{d:"M150 50 L100 100 L100 400 L300 400 L300 100 L250 50 L220 80 L200 90 L180 80 L150 50Z",stroke:"#00000033",strokeWidth:"3",fill:a}),(0,b.jsx)("path",{d:"M100 100 L50 80 L75 150 L100 140",stroke:"#00000033",strokeWidth:"3",fill:a}),(0,b.jsx)("path",{d:"M300 100 L350 80 L325 150 L300 140",stroke:"#00000033",strokeWidth:"3",fill:a}),(0,b.jsx)("ellipse",{cx:"200",cy:"75",rx:"20",ry:"15",fill:"none",stroke:"#00000033",strokeWidth:"2"})]})}):(0,b.jsx)("img",{src:"string"==typeof k?k:k.src,alt:`T-shirt in ${a}`,className:"w-full h-full object-contain filter drop-shadow-lg",onLoad:()=>{f(!1),h(!1)},onError:()=>{console.error("Failed to load t-shirt image:",k),h(!0),f(!1)},style:{filter:"drop-shadow(0 4px 8px rgba(0,0,0,0.1))"}}),(0,b.jsx)("div",{className:"absolute inset-0 flex items-center justify-center",children:(0,b.jsx)("div",{className:"relative",style:{marginTop:"8%"},children:(0,b.jsx)("div",{className:"w-44 h-44 flex items-center justify-center",children:d&&!i?(0,b.jsx)("img",{src:d,alt:"T-shirt design",className:"max-w-full max-h-full object-contain",style:{filter:"drop-shadow(0 2px 6px rgba(0,0,0,0.15))",borderRadius:"6px",boxShadow:`inset 0 0 0 2px ${"#FFFFFF"===a?"rgba(255,255,255,0.8)":a+"80"}`,background:`linear-gradient(145deg, ${a}20, transparent)`,backdropFilter:"blur(0.5px)"},onError:()=>{console.error("Failed to load design image:",d),j(!0)}}):(0,b.jsx)("div",{className:"w-36 h-36 border-2 border-dashed border-gray-400 rounded-md flex items-center justify-center bg-white/20 backdrop-blur-sm",children:(0,b.jsx)("span",{className:"text-xs text-gray-600 text-center p-1 font-medium",children:d&&i?"Failed to load":"Design preview"})})})})})]}),(0,b.jsxs)("div",{className:"mt-4 flex items-center justify-center gap-3",children:[(0,b.jsx)("div",{className:"w-5 h-5 rounded-full border-2 border-white shadow-lg ring-1 ring-gray-200",style:{backgroundColor:a}}),(0,b.jsx)("span",{className:"text-sm text-gray-700 font-medium capitalize",children:{"#000000":"Black","#FFFFFF":"White","#DC2626":"Red","#8A898C":"Grey","#1EAEDB":"Blue"}[a]||"Custom"})]}),e&&!g&&(0,b.jsx)("div",{className:"absolute inset-0 flex items-center justify-center bg-white/80 rounded-lg backdrop-blur-sm",children:(0,b.jsxs)("div",{className:"flex flex-col items-center gap-3",children:[(0,b.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"}),(0,b.jsx)("span",{className:"text-sm text-gray-600",children:"Loading preview..."})]})})]})},ab=({selectedTheme:a,tshirtColor:c,onThemeSelect:d,onQuestionFlowComplete:e,onBackToThemes:f})=>(0,b.jsx)(b.Fragment,{children:a?(0,b.jsxs)("div",{className:"flex flex-col md:flex-row md:gap-8",children:[(0,b.jsx)("div",{className:"md:w-3/5",children:(0,b.jsx)(_,{selectedTheme:a,onComplete:e,onBack:f})}),(0,b.jsxs)("div",{className:"md:w-2/5 mt-8 md:mt-0",children:[(0,b.jsx)("h3",{className:"text-lg font-medium mb-4 text-center",children:"Preview"}),(0,b.jsx)(aa,{color:c}),(0,b.jsx)("div",{className:"mt-4 text-center",children:(0,b.jsx)("p",{className:"text-sm text-gray-500",children:"Complete the questions to generate your custom AI design"})})]})]}):(0,b.jsx)(W,{onThemeSelect:d})});var ac=a.i(80701),ad=a.i(5084),ae=a.i(70106);let af=(0,ae.default)("Save",[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]]);var ag=a.i(96221),ah=a.i(34980);let ai=({width:a=300,height:d=300,backgroundColor:e="#f0f0f0",onCanvasReady:f,onDesignChange:g,initialImage:h,isDrawingMode:i=!1,brushSize:j=2})=>{let k=(0,c.useRef)(null),l=(0,c.useRef)(null),[m,n]=(0,c.useState)(!1),o=(0,c.useRef)("");return(0,c.useEffect)(()=>{if(k.current&&!m){console.log("Initializing SimplifiedCanvas");try{let b,c=new ah.fabric.Canvas(k.current,{width:a,height:d,backgroundColor:e}),h=new ah.fabric.Rect({width:a-20,height:d-20,left:10,top:10,stroke:"#5cb85c",strokeDashArray:[5,5],fill:"transparent",selectable:!1,evented:!1,name:"safetyArea"});c.add(h),c.freeDrawingBrush&&(c.freeDrawingBrush.color="#000000",c.freeDrawingBrush.width=j),l.current=c,n(!0),f(c);let i=()=>{clearTimeout(b),b=window.setTimeout(()=>{if(g&&c){let a=c.toDataURL({format:"png",quality:1,multiplier:2});g(a)}},300)};return c.on("object:modified",i),c.on("object:added",a=>{a.target?.name!=="safetyArea"&&i()}),c.on("object:removed",i),c.on("path:created",i),()=>{clearTimeout(b),c.dispose()}}catch(a){console.error("Error initializing canvas:",a)}}},[a,d,e,f,g,j,m]),(0,c.useEffect)(()=>{let a=l.current;a&&(a.isDrawingMode=i,a.freeDrawingBrush&&(a.freeDrawingBrush.width=j))},[i,j]),(0,c.useEffect)(()=>{let b=l.current;if(!b||!h||h===o.current)return;console.log("Loading initial image:",h),o.current=h;let c=b.getObjects().find(a=>"placeholderText"===a.name);c&&b.remove(c),ah.fabric.Image.fromURL(h,c=>{if(!b)return;let e=Math.min((a-40)/(c.width||1),(d-40)/(c.height||1));c.set({left:a/2,top:d/2,originX:"center",originY:"center",scaleX:e,scaleY:e,name:"mainImage"}),b.add(c),b.bringToFront(c);let f=b.getObjects().find(a=>"safetyArea"===a.name);f&&b.sendToBack(f),b.renderAll(),g&&g(b.toDataURL({format:"png",quality:1,multiplier:2}))},{crossOrigin:"anonymous"})},[h,a,d,g]),(0,c.useEffect)(()=>{let b=l.current;if(!b||h)return;let c=new ah.fabric.Text("Upload your design",{left:a/2,top:d/2,originX:"center",originY:"center",fontFamily:"Arial",fontSize:18,fill:"#999999",selectable:!1,evented:!1,name:"placeholderText"});b.add(c),b.renderAll()},[a,d,h]),(0,b.jsx)("canvas",{ref:k,className:"border border-gray-200 rounded-lg"})};var aj=a.i(30656),ak=a.i(7554),al=a.i(70121),am=a.i(50104),an=a.i(25152),ao=a.i(7827),ap=a.i(77994),aq=a.i(3688),ar=a.i(37738),as=["PageUp","PageDown"],at=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],au={"from-left":["Home","PageDown","ArrowDown","ArrowLeft"],"from-right":["Home","PageDown","ArrowDown","ArrowRight"],"from-bottom":["Home","PageDown","ArrowDown","ArrowLeft"],"from-top":["Home","PageDown","ArrowUp","ArrowLeft"]},av="Slider",[aw,ax,ay]=(0,ar.createCollection)(av),[az,aA]=(0,am.createContextScope)(av,[ay]),[aB,aC]=az(av),aD=c.forwardRef((a,d)=>{let{name:e,min:f=0,max:g=100,step:h=1,orientation:i="horizontal",disabled:j=!1,minStepsBetweenThumbs:k=0,defaultValue:l=[f],value:m,onValueChange:n=()=>{},onValueCommit:o=()=>{},inverted:p=!1,form:q,...r}=a,s=c.useRef(new Set),t=c.useRef(0),u="horizontal"===i,[v=[],w]=(0,an.useControllableState)({prop:m,defaultProp:l,onChange:a=>{let b=[...s.current];b[t.current]?.focus(),n(a)}}),x=c.useRef(v);function y(a,b,{commit:c}={commit:!1}){let d,e=(String(h).split(".")[1]||"").length,i=Math.round((Math.round((a-f)/h)*h+f)*(d=Math.pow(10,e)))/d,j=(0,aj.clamp)(i,[f,g]);w((a=[])=>{let d=function(a=[],b,c){let d=[...a];return d[c]=b,d.sort((a,b)=>a-b)}(a,j,b);if(!function(a,b){if(b>0)return Math.min(...a.slice(0,-1).map((b,c)=>a[c+1]-b))>=b;return!0}(d,k*h))return a;{t.current=d.indexOf(j);let b=String(d)!==String(a);return b&&c&&o(d),b?d:a}})}return(0,b.jsx)(aB,{scope:a.__scopeSlider,name:e,disabled:j,min:f,max:g,valueIndexToChangeRef:t,thumbs:s.current,values:v,orientation:i,form:q,children:(0,b.jsx)(aw.Provider,{scope:a.__scopeSlider,children:(0,b.jsx)(aw.Slot,{scope:a.__scopeSlider,children:(0,b.jsx)(u?aG:aH,{"aria-disabled":j,"data-disabled":j?"":void 0,...r,ref:d,onPointerDown:(0,ak.composeEventHandlers)(r.onPointerDown,()=>{j||(x.current=v)}),min:f,max:g,inverted:p,onSlideStart:j?void 0:function(a){let b=function(a,b){if(1===a.length)return 0;let c=a.map(a=>Math.abs(a-b)),d=Math.min(...c);return c.indexOf(d)}(v,a);y(a,b)},onSlideMove:j?void 0:function(a){y(a,t.current)},onSlideEnd:j?void 0:function(){let a=x.current[t.current];v[t.current]!==a&&o(v)},onHomeKeyDown:()=>!j&&y(f,0,{commit:!0}),onEndKeyDown:()=>!j&&y(g,v.length-1,{commit:!0}),onStepKeyDown:({event:a,direction:b})=>{if(!j){let c=as.includes(a.key)||a.shiftKey&&at.includes(a.key),d=t.current;y(v[d]+h*(c?10:1)*b,d,{commit:!0})}}})})})})});aD.displayName=av;var[aE,aF]=az(av,{startEdge:"left",endEdge:"right",size:"width",direction:1}),aG=c.forwardRef((a,d)=>{let{min:e,max:f,dir:g,inverted:h,onSlideStart:i,onSlideMove:j,onSlideEnd:k,onStepKeyDown:l,...m}=a,[n,o]=c.useState(null),p=(0,al.useComposedRefs)(d,a=>o(a)),q=c.useRef(),r=(0,ao.useDirection)(g),s="ltr"===r,t=s&&!h||!s&&h;function u(a){let b=q.current||n.getBoundingClientRect(),c=aS([0,b.width],t?[e,f]:[f,e]);return q.current=b,c(a-b.left)}return(0,b.jsx)(aE,{scope:a.__scopeSlider,startEdge:t?"left":"right",endEdge:t?"right":"left",direction:t?1:-1,size:"width",children:(0,b.jsx)(aI,{dir:r,"data-orientation":"horizontal",...m,ref:p,style:{...m.style,"--radix-slider-thumb-transform":"translateX(-50%)"},onSlideStart:a=>{let b=u(a.clientX);i?.(b)},onSlideMove:a=>{let b=u(a.clientX);j?.(b)},onSlideEnd:()=>{q.current=void 0,k?.()},onStepKeyDown:a=>{let b=au[t?"from-left":"from-right"].includes(a.key);l?.({event:a,direction:b?-1:1})}})})}),aH=c.forwardRef((a,d)=>{let{min:e,max:f,inverted:g,onSlideStart:h,onSlideMove:i,onSlideEnd:j,onStepKeyDown:k,...l}=a,m=c.useRef(null),n=(0,al.useComposedRefs)(d,m),o=c.useRef(),p=!g;function q(a){let b=o.current||m.current.getBoundingClientRect(),c=aS([0,b.height],p?[f,e]:[e,f]);return o.current=b,c(a-b.top)}return(0,b.jsx)(aE,{scope:a.__scopeSlider,startEdge:p?"bottom":"top",endEdge:p?"top":"bottom",size:"height",direction:p?1:-1,children:(0,b.jsx)(aI,{"data-orientation":"vertical",...l,ref:n,style:{...l.style,"--radix-slider-thumb-transform":"translateY(50%)"},onSlideStart:a=>{let b=q(a.clientY);h?.(b)},onSlideMove:a=>{let b=q(a.clientY);i?.(b)},onSlideEnd:()=>{o.current=void 0,j?.()},onStepKeyDown:a=>{let b=au[p?"from-bottom":"from-top"].includes(a.key);k?.({event:a,direction:b?-1:1})}})})}),aI=c.forwardRef((a,c)=>{let{__scopeSlider:e,onSlideStart:f,onSlideMove:g,onSlideEnd:h,onHomeKeyDown:i,onEndKeyDown:j,onStepKeyDown:k,...l}=a,m=aC(av,e);return(0,b.jsx)(d.Primitive.span,{...l,ref:c,onKeyDown:(0,ak.composeEventHandlers)(a.onKeyDown,a=>{"Home"===a.key?(i(a),a.preventDefault()):"End"===a.key?(j(a),a.preventDefault()):as.concat(at).includes(a.key)&&(k(a),a.preventDefault())}),onPointerDown:(0,ak.composeEventHandlers)(a.onPointerDown,a=>{let b=a.target;b.setPointerCapture(a.pointerId),a.preventDefault(),m.thumbs.has(b)?b.focus():f(a)}),onPointerMove:(0,ak.composeEventHandlers)(a.onPointerMove,a=>{a.target.hasPointerCapture(a.pointerId)&&g(a)}),onPointerUp:(0,ak.composeEventHandlers)(a.onPointerUp,a=>{let b=a.target;b.hasPointerCapture(a.pointerId)&&(b.releasePointerCapture(a.pointerId),h(a))})})}),aJ="SliderTrack",aK=c.forwardRef((a,c)=>{let{__scopeSlider:e,...f}=a,g=aC(aJ,e);return(0,b.jsx)(d.Primitive.span,{"data-disabled":g.disabled?"":void 0,"data-orientation":g.orientation,...f,ref:c})});aK.displayName=aJ;var aL="SliderRange",aM=c.forwardRef((a,e)=>{let{__scopeSlider:f,...g}=a,h=aC(aL,f),i=aF(aL,f),j=c.useRef(null),k=(0,al.useComposedRefs)(e,j),l=h.values.length,m=h.values.map(a=>aR(a,h.min,h.max)),n=l>1?Math.min(...m):0,o=100-Math.max(...m);return(0,b.jsx)(d.Primitive.span,{"data-orientation":h.orientation,"data-disabled":h.disabled?"":void 0,...g,ref:k,style:{...a.style,[i.startEdge]:n+"%",[i.endEdge]:o+"%"}})});aM.displayName=aL;var aN="SliderThumb",aO=c.forwardRef((a,d)=>{let e=ax(a.__scopeSlider),[f,g]=c.useState(null),h=(0,al.useComposedRefs)(d,a=>g(a)),i=c.useMemo(()=>f?e().findIndex(a=>a.ref.current===f):-1,[e,f]);return(0,b.jsx)(aP,{...a,ref:h,index:i})}),aP=c.forwardRef((a,e)=>{var f,g,h,i,j;let k,l,{__scopeSlider:m,index:n,name:o,...p}=a,q=aC(aN,m),r=aF(aN,m),[s,t]=c.useState(null),u=(0,al.useComposedRefs)(e,a=>t(a)),v=!s||q.form||!!s.closest("form"),w=(0,aq.useSize)(s),x=q.values[n],y=void 0===x?0:aR(x,q.min,q.max),z=(f=n,(g=q.values.length)>2?`Value ${f+1} of ${g}`:2===g?["Minimum","Maximum"][f]:void 0),A=w?.[r.size],B=A?(h=A,i=y,j=r.direction,l=aS([0,50],[0,k=h/2]),(k-l(i)*j)*j):0;return c.useEffect(()=>{if(s)return q.thumbs.add(s),()=>{q.thumbs.delete(s)}},[s,q.thumbs]),(0,b.jsxs)("span",{style:{transform:"var(--radix-slider-thumb-transform)",position:"absolute",[r.startEdge]:`calc(${y}% + ${B}px)`},children:[(0,b.jsx)(aw.ItemSlot,{scope:a.__scopeSlider,children:(0,b.jsx)(d.Primitive.span,{role:"slider","aria-label":a["aria-label"]||z,"aria-valuemin":q.min,"aria-valuenow":x,"aria-valuemax":q.max,"aria-orientation":q.orientation,"data-orientation":q.orientation,"data-disabled":q.disabled?"":void 0,tabIndex:q.disabled?void 0:0,...p,ref:u,style:void 0===x?{display:"none"}:a.style,onFocus:(0,ak.composeEventHandlers)(a.onFocus,()=>{q.valueIndexToChangeRef.current=n})})}),v&&(0,b.jsx)(aQ,{name:o??(q.name?q.name+(q.values.length>1?"[]":""):void 0),form:q.form,value:x},n)]})});aO.displayName=aN;var aQ=a=>{let{value:d,...e}=a,f=c.useRef(null),g=(0,ap.usePrevious)(d);return c.useEffect(()=>{let a=f.current,b=Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype,"value").set;if(g!==d&&b){let c=new Event("input",{bubbles:!0});b.call(a,d),a.dispatchEvent(c)}},[g,d]),(0,b.jsx)("input",{style:{display:"none"},...e,ref:f,defaultValue:d})};function aR(a,b,c){return(0,aj.clamp)(100/(c-b)*(a-b),[0,100])}function aS(a,b){return c=>{if(a[0]===a[1]||b[0]===b[1])return b[0];let d=(b[1]-b[0])/(a[1]-a[0]);return b[0]+d*(c-a[0])}}let aT=c.forwardRef(({className:a,...c},d)=>(0,b.jsxs)(aD,{ref:d,className:(0,r.cn)("relative flex w-full touch-none select-none items-center",a),...c,children:[(0,b.jsx)(aK,{className:"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary",children:(0,b.jsx)(aM,{className:"absolute h-full bg-primary"})}),(0,b.jsx)(aO,{className:"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50"})]}));aT.displayName=aD.displayName;let aU=({canvas:a,isDrawingMode:d,onDrawingModeChange:e,brushSize:f,onBrushSizeChange:g})=>{let[h,i]=(0,c.useState)("Sample Text"),[j,k]=(0,c.useState)("#000000");return(0,b.jsxs)("div",{className:"flex flex-col gap-4 p-4 bg-gray-50 rounded-lg",children:[(0,b.jsxs)("div",{className:"flex flex-wrap gap-2",children:[(0,b.jsx)(v.Button,{variant:d?"default":"outline",size:"sm",onClick:()=>e(!d),children:d?"Exit Draw":"Draw"}),(0,b.jsx)(v.Button,{variant:"outline",size:"sm",onClick:()=>{if(!a)return;let b=new ah.fabric.Text(h,{left:150,top:100,fontFamily:"Arial",fontSize:20,fill:j,name:"userText"});a.add(b),a.setActiveObject(b),a.renderAll()},children:"Add Text"}),(0,b.jsx)(v.Button,{variant:"outline",size:"sm",onClick:()=>{if(!a)return;let b=new ah.fabric.Rect({left:100,top:100,fill:j,width:80,height:60,name:"userShape"});a.add(b),a.setActiveObject(b),a.renderAll()},children:"Rectangle"}),(0,b.jsx)(v.Button,{variant:"outline",size:"sm",onClick:()=>{if(!a)return;let b=new ah.fabric.Circle({left:100,top:100,fill:j,radius:40,name:"userShape"});a.add(b),a.setActiveObject(b),a.renderAll()},children:"Circle"}),(0,b.jsx)(v.Button,{variant:"destructive",size:"sm",onClick:()=>{if(!a)return;let b=a.getActiveObject();b&&"safetyArea"!==b.name&&"mainImage"!==b.name&&(a.remove(b),a.renderAll())},children:"Delete"}),(0,b.jsx)(v.Button,{variant:"secondary",size:"sm",onClick:()=>{a&&(a.getObjects().forEach(b=>{"safetyArea"!==b.name&&"mainImage"!==b.name&&a.remove(b)}),a.renderAll())},children:"Clear All"})]}),(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)("label",{className:"text-sm font-medium",children:"Color:"}),(0,b.jsx)("input",{type:"color",value:j,onChange:a=>k(a.target.value),className:"w-8 h-8 rounded border"}),(0,b.jsx)(v.Button,{variant:"outline",size:"sm",onClick:()=>{if(!a)return;let b=a.getActiveObject();b&&"safetyArea"!==b.name&&"mainImage"!==b.name&&(b.set("fill",j),a.renderAll())},children:"Apply Color"})]}),(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)("label",{className:"text-sm font-medium",children:"Text:"}),(0,b.jsx)(X.Input,{value:h,onChange:a=>i(a.target.value),placeholder:"Enter text...",className:"flex-1"})]}),d&&(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)("label",{className:"text-sm font-medium",children:"Brush Size:"}),(0,b.jsx)(aT,{value:[f],onValueChange:a=>g(a[0]),max:20,min:1,step:1,className:"flex-1"}),(0,b.jsxs)("span",{className:"text-sm text-gray-500",children:[f,"px"]})]})]})},aV=({tshirtColor:a,initialImage:d,onDesignChange:e})=>{let f=(0,c.useRef)(null),[g,h]=(0,c.useState)(!1),[i,j]=(0,c.useState)(2),k=(0,c.useCallback)(a=>{console.log("Canvas ready in ModernCanvasManager"),f.current=a},[]),l=(0,c.useCallback)(a=>{console.log("Design changed, notifying parent"),e&&e(a)},[e]),m=(0,c.useCallback)(a=>{h(a)},[]),n=(0,c.useCallback)(a=>{j(a)},[]);return(0,b.jsxs)("div",{className:"flex flex-col gap-4",children:[(0,b.jsx)("div",{className:"flex justify-center",children:(0,b.jsx)(ai,{width:300,height:300,backgroundColor:"#f8f9fa",onCanvasReady:k,onDesignChange:l,initialImage:d,isDrawingMode:g,brushSize:i})}),(0,b.jsx)(aU,{canvas:f.current,isDrawingMode:g,onDrawingModeChange:m,brushSize:i,onBrushSizeChange:n})]})};var aW=c,aX=a.i(69520);let aY=(0,ae.default)("TriangleAlert",[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]]);class aZ extends aW.Component{constructor(a){super(a),this.state={hasError:!1}}static getDerivedStateFromError(a){return{hasError:!0,error:a}}componentDidCatch(a,b){G.log(a,`ErrorBoundary:${this.props.context}`,{componentStack:b.componentStack,errorBoundary:this.props.context})}handleRetry=()=>{this.setState({hasError:!1,error:void 0})};render(){return this.state.hasError?this.props.fallback?this.props.fallback:(0,b.jsxs)("div",{className:"flex flex-col items-center justify-center p-8 text-center",children:[(0,b.jsx)(aY,{className:"h-12 w-12 text-red-500 mb-4"}),(0,b.jsx)("h2",{className:"text-xl font-semibold mb-2",children:"Something went wrong"}),(0,b.jsxs)("p",{className:"text-gray-600 mb-4",children:["An error occurred in the ",this.props.context," component."]}),(0,b.jsxs)(v.Button,{onClick:this.handleRetry,className:"flex items-center gap-2",children:[(0,b.jsx)(aX.RefreshCw,{className:"h-4 w-4"}),"Try Again"]})]}):this.props.children}}var a$=a.i(92e3);let a_=({onRetry:a})=>(0,b.jsxs)("div",{className:"flex flex-col items-center justify-center h-64 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300",children:[(0,b.jsx)(a$.AlertCircle,{className:"h-8 w-8 text-orange-500 mb-2"}),(0,b.jsx)("h3",{className:"font-medium text-gray-800 mb-1",children:"Canvas Error"}),(0,b.jsx)("p",{className:"text-sm text-gray-600 mb-3 text-center",children:"The design canvas failed to load properly."}),(0,b.jsxs)(v.Button,{onClick:a||(()=>window.location.reload()),size:"sm",className:"flex items-center gap-2",children:[(0,b.jsx)(aX.RefreshCw,{className:"h-4 w-4"}),"Retry"]})]}),a0=({children:a,onRetry:c})=>(0,b.jsx)(aZ,{context:"Canvas",fallback:(0,b.jsx)(a_,{onRetry:c}),children:a});var a1=a.i(38784),a2=a.i(35911);let a3=({designImage:a,tshirtColor:d,selectedSize:e="M",designName:f,answers:g,onSaveDesign:h})=>{let{isAuthenticated:i}=(0,y.useUser)(),{addCustomDesignToCart:j}=(0,a2.useCart)(),[k,l]=(0,c.useState)(!1),m=async()=>{if(!a)return void E.toast.error("Please create a design first");if(!i)return void E.toast.error("Please login to add items to cart");l(!0);try{h&&await h();let b={design_name:f||"Custom Design",design_image:a,tshirt_color:d,selected_size:e,base_price:2499,theme_name:g.find(a=>a.question?.includes("theme"))?.answer||"Custom",answers:g,design_data:{}};await j(b),E.toast.success("Design added to cart!")}catch(a){console.error("Error adding to cart:",a),E.toast.error("Failed to add to cart. Please try again.")}finally{l(!1)}};return(0,b.jsxs)(v.Button,{onClick:m,disabled:k||!a,className:"w-full flex items-center justify-center gap-2",variant:"outline",children:[(0,b.jsx)(a1.ShoppingCart,{className:"h-4 w-4"}),k?"Adding...":"Add to Cart"]})};var a4=a.i(11156);let a5=({designImage:a,tshirtColor:d,selectedSize:e="M",designName:f,answers:g,onSaveDesign:h})=>{let{isAuthenticated:i}=(0,y.useUser)(),{addCustomDesignToCart:j}=(0,a2.useCart)(),k=(0,C.useRouter)(),[l,m]=(0,c.useState)(!1),n=async()=>{if(!a)return void E.toast.error("Please create a design first");if(!i)return void E.toast.error("Please login to place an order");m(!0);try{h&&await h();let b={design_name:f||"Custom Design",design_image:a,tshirt_color:d,selected_size:e,base_price:2499,theme_name:g.find(a=>a.question.includes("theme"))?.answer||"Custom",answers:g,design_data:{}};await j(b),E.toast.success("Design added to cart! Redirecting to checkout..."),setTimeout(()=>{k.push("/checkout")},1500)}catch(a){console.error("Error placing order:",a),E.toast.error("Failed to place order. Please try again.")}finally{m(!1)}};return(0,b.jsx)("div",{className:"flex gap-3",children:(0,b.jsxs)(v.Button,{onClick:n,disabled:l||!a,className:"flex-1 flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700",size:"lg",children:[(0,b.jsx)(a4.CreditCard,{className:"h-5 w-5"}),l?"Processing...":"Place Order"]})})},a6=({answers:a,tshirtColor:c,designImage:d,isSaving:e,isGenerating:f,tshirtColors:g,designName:h,selectedSize:i="M",onDesignNameChange:j,onColorChange:k,onSizeChange:l,onDesignChange:m,onSaveDesign:n})=>{let o=Object.entries(g).map(([a,b])=>({name:a.charAt(0)+a.slice(1).toLowerCase(),value:b}));return(0,b.jsxs)("div",{className:"py-6",children:[(0,b.jsx)("div",{className:"mb-6",children:(0,b.jsx)(X.Input,{id:"design-name",placeholder:"My Awesome Design",value:h,onChange:a=>{j&&j(a.target.value)},className:"text-lg font-medium w-full max-w-xs",disabled:f})}),(0,b.jsxs)("div",{className:"flex flex-col space-y-8",children:[(0,b.jsxs)("div",{className:"flex flex-col lg:flex-row lg:gap-6",children:[(0,b.jsx)("div",{className:"w-full lg:w-1/2 mb-6 lg:mb-0",children:(0,b.jsxs)("div",{className:"bg-white rounded-lg p-4 shadow-sm",children:[(0,b.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,b.jsx)("h3",{className:"font-medium text-lg",children:"Design Tools"}),(0,b.jsxs)("div",{className:"flex items-center gap-4",children:[(0,b.jsxs)("div",{className:"flex items-center",children:[(0,b.jsx)("label",{className:"text-sm font-medium text-gray-700 mr-2",children:"T-Shirt Color:"}),(0,b.jsxs)(ac.Select,{value:c,onValueChange:k,disabled:f,children:[(0,b.jsx)(ac.SelectTrigger,{className:"bg-white w-36",children:(0,b.jsx)(ac.SelectValue,{placeholder:"Select a color"})}),(0,b.jsx)(ac.SelectContent,{children:o.map(a=>(0,b.jsx)(ac.SelectItem,{value:a.value,children:(0,b.jsxs)("div",{className:"flex items-center",children:[(0,b.jsx)("div",{className:"w-4 h-4 rounded-full mr-2 border border-gray-300",style:{backgroundColor:a.value}}),a.name]})},a.name))})]})]}),(0,b.jsxs)("div",{className:"flex items-center",children:[(0,b.jsx)("label",{className:"text-sm font-medium text-gray-700 mr-2",children:"Size:"}),(0,b.jsxs)(ac.Select,{value:i,onValueChange:l,disabled:f,children:[(0,b.jsx)(ac.SelectTrigger,{className:"bg-white w-24",children:(0,b.jsx)(ac.SelectValue,{placeholder:"Select size"})}),(0,b.jsx)(ac.SelectContent,{children:[{name:"XS",value:"XS"},{name:"S",value:"S"},{name:"M",value:"M"},{name:"L",value:"L"},{name:"XL",value:"XL"},{name:"XXL",value:"XXL"}].map(a=>(0,b.jsx)(ac.SelectItem,{value:a.value,children:a.name},a.value))})]})]})]})]}),(0,b.jsx)("div",{className:"mb-4",children:(0,b.jsx)(a0,{children:(0,b.jsx)(aV,{tshirtColor:c,onDesignChange:a=>{console.log(" Design change from canvas:",a.slice(0,50)+"..."),m(a)},initialImage:d})})})]})}),(0,b.jsx)("div",{className:"w-full lg:w-1/2",children:(0,b.jsxs)("div",{className:"bg-white rounded-lg p-4 shadow-sm h-full",children:[(0,b.jsx)("h3",{className:"font-medium text-lg mb-4",children:"T-Shirt Preview"}),(0,b.jsxs)("div",{className:"relative flex items-center justify-center",children:[(0,b.jsx)(aZ,{context:"TshirtPreview",children:(0,b.jsx)(aa,{color:c,designImage:d})}),f&&(0,b.jsxs)("div",{className:"absolute inset-0 flex flex-col items-center justify-center bg-white/80 rounded-lg",children:[(0,b.jsx)(ag.Loader2,{className:"h-12 w-12 animate-spin text-blue-600"}),(0,b.jsx)("p",{className:"mt-4 text-blue-800 font-medium",children:"Generating your design..."}),(0,b.jsx)("p",{className:"text-sm text-gray-500 mt-2",children:"This may take a few moments"})]})]}),(0,b.jsxs)("div",{className:"mt-6 space-y-3",children:[(0,b.jsx)(v.Button,{onClick:n,disabled:e||!d||f,className:"w-full flex items-center justify-center gap-2",variant:"outline",children:e?(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(ag.Loader2,{className:"h-4 w-4 animate-spin"}),"Saving..."]}):(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(af,{className:"h-4 w-4"}),"Save Design"]})}),(0,b.jsx)(a3,{designImage:d,tshirtColor:c,selectedSize:i,designName:h,answers:a,onSaveDesign:n}),(0,b.jsx)(a5,{designImage:d,tshirtColor:c,selectedSize:i,designName:h,answers:a,onSaveDesign:n})]})]})})]}),(0,b.jsxs)("div",{className:"bg-white rounded-lg p-4 shadow-sm",children:[(0,b.jsx)("h3",{className:"font-medium text-lg mb-4",children:"Design Preferences"}),(0,b.jsx)("div",{className:"border rounded-md p-3 bg-gray-50",children:a.length>0?a.map((c,d)=>(0,b.jsxs)("div",{className:"py-2",children:[(0,b.jsx)("p",{className:"text-sm font-medium",children:c.question}),(0,b.jsx)("p",{className:"text-sm text-gray-600",children:c.answer}),d<a.length-1&&(0,b.jsx)(ad.Separator,{className:"my-2"})]},d)):(0,b.jsx)("p",{className:"text-sm text-gray-500",children:"No design preferences set."})})]})]})]})};var a7=a.i(81010);let a8=()=>{let a=(0,C.useRouter)();return(0,b.jsx)("div",{className:"flex flex-col items-center justify-center min-h-[400px] p-8 text-center",children:(0,b.jsxs)("div",{className:"bg-red-50 rounded-lg p-6 max-w-md",children:[(0,b.jsx)("h2",{className:"text-xl font-semibold text-red-800 mb-2",children:"Design Tool Error"}),(0,b.jsx)("p",{className:"text-red-600 mb-4",children:"There was an issue with the design interface. This might be due to a canvas rendering problem or data loading issue."}),(0,b.jsxs)("div",{className:"flex gap-2 justify-center",children:[(0,b.jsxs)(v.Button,{onClick:()=>window.location.reload(),variant:"outline",className:"flex items-center gap-2",children:[(0,b.jsx)(aX.RefreshCw,{className:"h-4 w-4"}),"Reload Page"]}),(0,b.jsxs)(v.Button,{onClick:()=>a.push("/"),className:"flex items-center gap-2",children:[(0,b.jsx)(a7.Home,{className:"h-4 w-4"}),"Go Home"]})]})]})})},a9=({children:a})=>(0,b.jsx)(aZ,{context:"Design",fallback:(0,b.jsx)(a8,{}),children:a});function ba(){let a,d,e,f,g,h,i,{currentStep:j,currentStage:k,selectedTheme:l,answers:m,showConfirmation:n,showLoginDialog:o,tshirtColor:p,selectedSize:q,designImage:r,isSaving:s,isGenerating:u,isLoading:v,designName:z,setShowConfirmation:B,setShowLoginDialog:J,setTshirtColor:K,setSelectedSize:L,setDesignName:M,handleThemeSelect:N,handleQuestionFlowComplete:O,handleConfirmDesign:P,handleLoginSuccess:Q,handleBackToThemes:R,handleDesignChange:S,handleSaveDesign:T}=(d=function(a){let{user:b}=(0,y.useUser)(),[d,e]=(0,c.useState)(null),[f,g]=(0,c.useState)([]),[h,i]=(0,c.useState)(null),[j,k]=(0,c.useState)(""),[l,m]=(0,c.useState)(A.WHITE),[n,o]=(0,c.useState)(void 0),[p,q]=(0,c.useState)("M"),[r,s]=(0,c.useState)(!1),t=(0,C.useRouter)(),u=(0,C.useSearchParams)(),v=(0,c.useCallback)(async b=>{try{s(!0);let{data:c,error:d}=await D.supabase.from("designs").select("id, name, t_shirt_color, preview_url, design_data").eq("id",b).single();if(d)throw d;if(!c){E.toast.error("Design not found"),t.push("/dashboard/designs");return}if(console.log("Fetched design data:",c),k(c.name||"Untitled Design"),m(c.t_shirt_color||A.WHITE),o(c.preview_url),c.design_data){let a="string"==typeof c.design_data?JSON.parse(c.design_data):c.design_data;if(console.log("Parsed design data:",a),a.answers&&g(a.answers),a.theme_id)try{let b=a.theme_id;if("number"==typeof b)console.log("Converting numeric theme_id to UUID:",b),console.warn("Numeric theme_id detected, skipping theme fetch to prevent UUID errors");else if("string"==typeof b&&b.length>0){let{data:a,error:c}=await D.supabase.from("themes").select("id, name, description, category, is_active, thumbnail_url, created_at").eq("id",b).single();c?console.error("Error fetching theme:",c):a&&e(a)}}catch(a){console.error("Error processing theme:",a)}}a(),E.toast.success("Design loaded successfully",{description:"You can now continue editing your design."})}catch(a){console.error("Error fetching design:",a),E.toast.error("Failed to load design",{description:"Please try again later."})}finally{s(!1)}},[a,t]);(0,c.useEffect)(()=>{let a=u.get("id");if(a&&a!==h)i(a),v(a);else if(!a&&!j){let a=new Date;k(`Design ${a.toLocaleString("en-US",{month:"short",day:"numeric",hour:"numeric",minute:"numeric"})}`)}},[u,h,j]);let w=async(a,b,c)=>{try{if(!c)return;let{data:e,error:g}=await D.supabase.from("designs").insert({user_id:c,name:j.replace(/<[^>]*>/g,"").trim(),t_shirt_color:l.replace(/<[^>]*>/g,"").trim(),preview_url:a,design_data:JSON.stringify({answers:(f||[]).map(a=>({question:String(a?.question||"").replace(/<[^>]*>/g,"").trim(),answer:String(a?.answer||"").replace(/<[^>]*>/g,"").trim()})),theme_id:d?.id,prompt:String(b||"").replace(/<[^>]*>/g,"").trim()})}).select("id");if(g)throw g;e&&e.length>0&&i(e[0].id)}catch(a){console.error("Error saving AI design to database:",a)}};return{selectedTheme:d,answers:f,designId:h,designName:j,tshirtColor:l,selectedSize:p,designImage:n,isLoading:r,setSelectedTheme:e,setAnswers:g,setDesignId:i,setDesignName:k,setTshirtColor:m,setSelectedSize:q,setDesignImage:o,setIsLoading:s,fetchDesignData:v,handleDesignChange:a=>{console.log("Design canvas updated"),o(a)},saveDesignToDatabase:w}}((a=function(){let{isAuthenticated:a}=(0,y.useUser)(),[b,d]=(0,c.useState)("preferences"),[e,f]=(0,c.useState)("theme-selection"),[g,h]=(0,c.useState)(!1),[i,j]=(0,c.useState)(!1);return{currentStep:b,currentStage:e,showConfirmation:g,showLoginDialog:i,setCurrentStep:d,setCurrentStage:f,setShowConfirmation:h,setShowLoginDialog:j,handleThemeSelect:(a,b)=>{console.log("Theme selected:",a),b(a),f("question-flow")},handleQuestionFlowComplete:(a,b)=>{console.log("Question flow complete with answers:",a),b(a),h(!0)},handleConfirmDesign:b=>{if(console.log("Design confirmed"),h(!1),!a){console.log("User not authenticated, showing login dialog"),j(!0);return}b()},handleLoginSuccess:a=>{console.log("Login success callback in Design page"),j(!1),a()},handleBackToThemes:a=>{console.log("Going back to themes"),f("theme-selection"),a(null)},proceedToDesignStage:(a,b,c,e)=>{console.log("Proceeding to design stage"),d("design"),f("customization"),a&&b.length>0?c().catch(a=>{console.error("Error generating AI design:",a),e(void 0)}):e(void 0)},setDesignStage:()=>{console.log("Setting design stage for loaded design"),d("design"),f("customization")}}}()).setDesignStage),e=function(){let{user:a,isAuthenticated:b}=(0,y.useUser)(),[d,e]=(0,c.useState)(!1),f=async(c,d,f,g)=>{if(!c||0===d.length){let a=Error("Theme and answers are required to generate design");G.log(a,"DesignGeneration:Validation",{hasTheme:!!c,answersLength:d.length}),(0,F.toast)({variant:"destructive",title:"Error",description:"Theme and answers are required to generate design"});return}try{e(!0),(0,F.toast)({title:"Generating design...",description:"Creating your custom t-shirt design with AI"}),console.log("CLIENT: Authentication status:",b),console.log(" CLIENT: User data:",a?`ID: ${a.id}`:"No user");let h=d.filter(a=>a&&"string"==typeof a.question&&"string"==typeof a.answer);if(0===h.length)throw Error("No valid answers provided");let i=c?{...c,name:H(c.name)}:null,j=function(a=[]){return a.filter(a=>a&&"string"==typeof a.question&&"string"==typeof a.answer).map(a=>({question:H(a.question),answer:H(a.answer)}))}(h),k={theme:i,answers:j,userId:a?.id||null};console.log("CLIENT: Invoking generate-ai-design function with:",{theme:c.name,answersCount:h.length,userId:a?.id||"not provided"});let l=Date.now(),{data:{session:m}}=await D.supabase.auth.getSession();console.log(" CLIENT: Session available:",!!m),console.log(" CLIENT: Calling supabase.functions.invoke now...");let{data:n,error:o}=await D.supabase.functions.invoke("generate-ai-design",{body:k,headers:m?{Authorization:`Bearer ${m.access_token}`}:void 0});if(console.log(` CLIENT: Function invocation completed in ${Date.now()-l}ms`),o)throw console.error(" CLIENT: Function returned error:",o),G.log(Error(o.message),"DesignGeneration:AIFunction",{functionError:o,theme:c.name,userId:a?.id}),Error(o.message);if(console.log(" CLIENT: AI response received:",{hasImageUrl:!!n?.imageUrl,promptLength:n?.prompt?.length||0,responseSize:JSON.stringify(n).length}),!n||!n.imageUrl)throw console.error(" CLIENT: Missing image URL in response"),G.log(Error("No design image was generated"),"DesignGeneration:MissingImage",{response:n,theme:c.name}),Error("No design image was generated");f(n.imageUrl),a&&await g(n.imageUrl,n.prompt||"",a.id),(0,F.toast)({title:n.fallback?"Design created with fallback":"Your design is ready!",description:n.fallback?"We used a simplified design due to content restrictions.":"We've created a custom t-shirt design based on your preferences."})}catch(e){console.error(" CLIENT: Error generating design with AI:",e),console.error(" CLIENT: Error details:",{message:e.message,stack:e.stack,name:e.name}),G.log(e,"DesignGeneration:GeneralError",{theme:c?.name,answersCount:d.length,userId:a?.id,isAuthenticated:b}),(0,F.toast)({variant:"destructive",title:"Failed to generate design",description:"Please try again with different preferences."}),f("/assets/images/design/placeholder.svg")}finally{e(!1)}};return{isGenerating:d,setIsGenerating:e,generateDesignWithAI:f}}(),f=function(){let{user:a,isAuthenticated:b}=(0,y.useUser)(),{saveDesignToDatabase:d}=function(){let{user:a}=(0,y.useUser)(),[b,d]=(0,c.useState)(!1),e=(0,C.useRouter)(),f=(0,C.useSearchParams)();return{saveDesignToDatabase:async(b,c,g,h,i,j,k,l,m)=>{try{let n;if(!a)return console.log("No user logged in, cannot save design"),null;d(!0),console.log("Saving design to database:",{designId:j,designName:k,tshirtColor:i,imageUrl:b?.substring(0,50)+"..."});let o=a=>a.replace(/<[^>]*>/g,"").trim(),p={user_id:a.id,name:o(k),t_shirt_color:o(i),preview_url:b,design_data:{answers:(g||[]).map(a=>({question:o(String(a?.question||"")),answer:o(String(a?.answer||""))})),theme_id:h?.id,prompt:o(c)}};j?(console.log("Updating existing design:",j),n=await D.supabase.from("designs").update(p).eq("id",j).select("id")):(console.log("Creating new design"),n=await D.supabase.from("designs").insert(p).select("id"));let{data:q,error:r}=n;if(r)throw console.error("Database error when saving design:",r),r;return q&&q.length>0?(console.log("Design saved successfully with ID:",q[0].id),l(q[0].id),f.get("id")!==q[0].id&&e.replace(`/design?id=${q[0].id}`)):console.warn("No data returned when saving design"),m(!1),q?.[0]?.id}catch(a){throw console.error("Error saving design to database:",a),a}finally{d(!1)}},isSaving:b}}(),[e,f]=(0,c.useState)(!1),g=async(c,e,g,h,i,j,k)=>{if(!b)return console.log("User not authenticated for save"),!1;if(!c||!a)return G.log(Error("Cannot save design - missing image or user"),"DesignSave:Validation",{hasImage:!!c,hasUser:!!a}),(0,F.toast)({variant:"destructive",title:"Cannot save design",description:"Please complete your design before saving"}),!1;try{return f(!0),console.log("Starting design save process"),await d(c,"",j,i,h,e,g,k,()=>{}),(0,F.toast)({title:"Design saved successfully!",description:"You can find it in your saved designs."}),!0}catch(b){return console.error("Error saving design:",b),G.log(b,"DesignSave:DatabaseError",{designId:e,designName:g,userId:a?.id}),(0,F.toast)({variant:"destructive",title:"Failed to save design",description:"Please try again later."}),!1}finally{f(!1)}};return{isSaving:e,setIsSaving:f,handleSaveDesign:g}}(),g=async()=>{a.proceedToDesignStage(d.selectedTheme,d.answers,h,d.setDesignImage)},h=async()=>{await e.generateDesignWithAI(d.selectedTheme,d.answers,d.setDesignImage,d.saveDesignToDatabase)},i=async()=>{!a.showLoginDialog&&!f.isSaving&&(await f.handleSaveDesign(d.designImage,d.designId,d.designName,d.tshirtColor,d.selectedTheme,d.answers,d.setDesignId)||a.showLoginDialog||a.setShowLoginDialog(!0))},{currentStep:a.currentStep,currentStage:a.currentStage,selectedTheme:d.selectedTheme,answers:d.answers,designId:d.designId,designName:d.designName,tshirtColor:d.tshirtColor,selectedSize:d.selectedSize,designImage:d.designImage,showConfirmation:a.showConfirmation,showLoginDialog:a.showLoginDialog,isSaving:f.isSaving,isGenerating:e.isGenerating,isLoading:d.isLoading,setShowConfirmation:a.setShowConfirmation,setShowLoginDialog:a.setShowLoginDialog,setTshirtColor:d.setTshirtColor,setSelectedSize:d.setSelectedSize,setDesignName:d.setDesignName,handleThemeSelect:b=>{a.handleThemeSelect(b,d.setSelectedTheme)},handleQuestionFlowComplete:b=>{a.handleQuestionFlowComplete(b,d.setAnswers)},handleConfirmDesign:()=>{a.handleConfirmDesign(g)},handleLoginSuccess:()=>{a.handleLoginSuccess(g)},handleBackToThemes:()=>{a.handleBackToThemes(d.setSelectedTheme)},handleDesignChange:d.handleDesignChange,handleSaveDesign:i,generateDesignWithAI:h});return(0,b.jsx)(a9,{children:(0,b.jsxs)("div",{className:"container mx-auto px-4 py-8",children:[(0,b.jsx)(aZ,{context:"DesignStepper",children:(0,b.jsx)("section",{className:"max-w-5xl mx-auto text-center mb-8",children:(0,b.jsx)(t,{currentStep:j})})}),(0,b.jsx)("section",{className:"max-w-5xl mx-auto bg-white rounded-lg shadow-sm p-6",children:v?(0,b.jsx)(I,{message:"Loading design..."}):(0,b.jsx)(aZ,{context:"DesignContent",children:"theme-selection"===k||"question-flow"===k?(0,b.jsx)(ab,{selectedTheme:l,tshirtColor:p,onThemeSelect:N,onQuestionFlowComplete:O,onBackToThemes:R}):"customization"===k&&(0,b.jsx)(a6,{answers:m,tshirtColor:p,selectedSize:q,designImage:r,isSaving:s,isGenerating:u,tshirtColors:A,designName:z,onDesignNameChange:M,onColorChange:K,onSizeChange:L,onDesignChange:S,onSaveDesign:T})})}),(0,b.jsxs)(aZ,{context:"DesignDialogs",children:[(0,b.jsx)(w,{open:n,answers:m,onClose:()=>B(!1),onConfirm:P,onEdit:()=>B(!1)}),(0,b.jsx)(x.default,{open:o,onClose:()=>J(!1),onSuccess:Q})]})]})})}function bb(){return(0,b.jsx)(c.Suspense,{fallback:(0,b.jsx)(I,{message:"Loading..."}),children:(0,b.jsx)(ba,{})})}a.s(["default",()=>bb],41979)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__d3e3358c._.js.map